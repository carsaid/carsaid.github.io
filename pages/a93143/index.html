<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>个人模拟考试 | 某不知名博客</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="安全技术博客,专注安全领域学习与总结。渗透测试,工具开发,国外优秀安全文章翻译,知识库,漏洞库,全球安全事件统计等技术分享。">
    <meta name="keywords" content="漏洞猫,vulcat,个人技术博客,某不知名博客,安全团队,渗透测试,安全,网络安全,安全工具开发,云安全,学习,面试,Python,Golang,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.cdd53b27.css" as="style"><link rel="preload" href="/assets/js/app.6d8810e1.js" as="script"><link rel="preload" href="/assets/js/2.b3e685a4.js" as="script"><link rel="preload" href="/assets/js/204.67111065.js" as="script"><link rel="prefetch" href="/assets/js/10.00f092a3.js"><link rel="prefetch" href="/assets/js/100.979c27c0.js"><link rel="prefetch" href="/assets/js/101.99d8a752.js"><link rel="prefetch" href="/assets/js/102.f474f721.js"><link rel="prefetch" href="/assets/js/103.7c9d83c1.js"><link rel="prefetch" href="/assets/js/104.a2215e97.js"><link rel="prefetch" href="/assets/js/105.f0524c67.js"><link rel="prefetch" href="/assets/js/106.1b160ea1.js"><link rel="prefetch" href="/assets/js/107.1ba97c80.js"><link rel="prefetch" href="/assets/js/108.d348d44b.js"><link rel="prefetch" href="/assets/js/109.c18d1a5b.js"><link rel="prefetch" href="/assets/js/11.4dbe13dc.js"><link rel="prefetch" href="/assets/js/110.d203511e.js"><link rel="prefetch" href="/assets/js/111.4cbfa89a.js"><link rel="prefetch" href="/assets/js/112.98c3049e.js"><link rel="prefetch" href="/assets/js/113.9b3a83b6.js"><link rel="prefetch" href="/assets/js/114.66236686.js"><link rel="prefetch" href="/assets/js/115.b485e87e.js"><link rel="prefetch" href="/assets/js/116.c5b4f8a3.js"><link rel="prefetch" href="/assets/js/117.1bd7c5c2.js"><link rel="prefetch" href="/assets/js/118.be75d223.js"><link rel="prefetch" href="/assets/js/119.a2899673.js"><link rel="prefetch" href="/assets/js/12.ee84c5f8.js"><link rel="prefetch" href="/assets/js/120.89c02cf6.js"><link rel="prefetch" href="/assets/js/121.3813376d.js"><link rel="prefetch" href="/assets/js/122.7d16bb94.js"><link rel="prefetch" href="/assets/js/123.9c62e662.js"><link rel="prefetch" href="/assets/js/124.eb1a1bfd.js"><link rel="prefetch" href="/assets/js/125.c9b24746.js"><link rel="prefetch" href="/assets/js/126.83e29a51.js"><link rel="prefetch" href="/assets/js/127.33311ecc.js"><link rel="prefetch" href="/assets/js/128.db3830df.js"><link rel="prefetch" href="/assets/js/129.1e36ef7f.js"><link rel="prefetch" href="/assets/js/13.397cf062.js"><link rel="prefetch" href="/assets/js/130.aa054506.js"><link rel="prefetch" href="/assets/js/131.ca49aa84.js"><link rel="prefetch" href="/assets/js/132.01b3177f.js"><link rel="prefetch" href="/assets/js/133.f3e1f458.js"><link rel="prefetch" href="/assets/js/134.608c85c2.js"><link rel="prefetch" href="/assets/js/135.41f0022e.js"><link rel="prefetch" href="/assets/js/136.aaa4bdd9.js"><link rel="prefetch" href="/assets/js/137.6ece8897.js"><link rel="prefetch" href="/assets/js/138.a69631df.js"><link rel="prefetch" href="/assets/js/139.79d5a4d5.js"><link rel="prefetch" href="/assets/js/14.7d08f32b.js"><link rel="prefetch" href="/assets/js/140.3b7aba2c.js"><link rel="prefetch" href="/assets/js/141.503090cd.js"><link rel="prefetch" href="/assets/js/142.c53ae88c.js"><link rel="prefetch" href="/assets/js/143.48561ba5.js"><link rel="prefetch" href="/assets/js/144.82b7c665.js"><link rel="prefetch" href="/assets/js/145.fcb67137.js"><link rel="prefetch" href="/assets/js/146.4472526f.js"><link rel="prefetch" href="/assets/js/147.6b6d0f31.js"><link rel="prefetch" href="/assets/js/148.cf988b82.js"><link rel="prefetch" href="/assets/js/149.f4a141f6.js"><link rel="prefetch" href="/assets/js/15.1bbe497c.js"><link rel="prefetch" href="/assets/js/150.ce1b9d60.js"><link rel="prefetch" href="/assets/js/151.6349b6e8.js"><link rel="prefetch" href="/assets/js/152.98757ba9.js"><link rel="prefetch" href="/assets/js/153.949bb690.js"><link rel="prefetch" href="/assets/js/154.f328fe35.js"><link rel="prefetch" href="/assets/js/155.6c47f579.js"><link rel="prefetch" href="/assets/js/156.88e855bf.js"><link rel="prefetch" href="/assets/js/157.46c2041e.js"><link rel="prefetch" href="/assets/js/158.ea92ade4.js"><link rel="prefetch" href="/assets/js/159.dbb6caa4.js"><link rel="prefetch" href="/assets/js/16.823d0c7e.js"><link rel="prefetch" href="/assets/js/160.5b558835.js"><link rel="prefetch" href="/assets/js/161.7a605f44.js"><link rel="prefetch" href="/assets/js/162.b18d8fca.js"><link rel="prefetch" href="/assets/js/163.591a0254.js"><link rel="prefetch" href="/assets/js/164.2d8276a8.js"><link rel="prefetch" href="/assets/js/165.2ac7dc23.js"><link rel="prefetch" href="/assets/js/166.74a29f94.js"><link rel="prefetch" href="/assets/js/167.757501fc.js"><link rel="prefetch" href="/assets/js/168.2961cae1.js"><link rel="prefetch" href="/assets/js/169.a2d3f3f9.js"><link rel="prefetch" href="/assets/js/17.aed2ce3f.js"><link rel="prefetch" href="/assets/js/170.e2a6496c.js"><link rel="prefetch" href="/assets/js/171.b7a60c23.js"><link rel="prefetch" href="/assets/js/172.3f9ef4fe.js"><link rel="prefetch" href="/assets/js/173.632e8356.js"><link rel="prefetch" href="/assets/js/174.018b972d.js"><link rel="prefetch" href="/assets/js/175.c81ddf47.js"><link rel="prefetch" href="/assets/js/176.98d1b056.js"><link rel="prefetch" href="/assets/js/177.9db73282.js"><link rel="prefetch" href="/assets/js/178.b44da21c.js"><link rel="prefetch" href="/assets/js/179.d67e6595.js"><link rel="prefetch" href="/assets/js/18.339c7ec0.js"><link rel="prefetch" href="/assets/js/180.55513010.js"><link rel="prefetch" href="/assets/js/181.1986dd19.js"><link rel="prefetch" href="/assets/js/182.cabd8791.js"><link rel="prefetch" href="/assets/js/183.d4e9a543.js"><link rel="prefetch" href="/assets/js/184.d392a566.js"><link rel="prefetch" href="/assets/js/185.f101976a.js"><link rel="prefetch" href="/assets/js/186.7a1b862a.js"><link rel="prefetch" href="/assets/js/187.282b6fd6.js"><link rel="prefetch" href="/assets/js/188.dde1e7c6.js"><link rel="prefetch" href="/assets/js/189.1e711a5f.js"><link rel="prefetch" href="/assets/js/19.63b2d090.js"><link rel="prefetch" href="/assets/js/190.a022b842.js"><link rel="prefetch" href="/assets/js/191.f49a7780.js"><link rel="prefetch" href="/assets/js/192.59d4c163.js"><link rel="prefetch" href="/assets/js/193.b657dbd4.js"><link rel="prefetch" href="/assets/js/194.7c7c65e6.js"><link rel="prefetch" href="/assets/js/195.2bd41323.js"><link rel="prefetch" href="/assets/js/196.3112261f.js"><link rel="prefetch" href="/assets/js/197.a80566de.js"><link rel="prefetch" href="/assets/js/198.edd76152.js"><link rel="prefetch" href="/assets/js/199.30a66baf.js"><link rel="prefetch" href="/assets/js/20.10500d8d.js"><link rel="prefetch" href="/assets/js/200.25d3e98f.js"><link rel="prefetch" href="/assets/js/201.c55824db.js"><link rel="prefetch" href="/assets/js/202.351ffe25.js"><link rel="prefetch" href="/assets/js/203.b9fb8235.js"><link rel="prefetch" href="/assets/js/205.a8210e19.js"><link rel="prefetch" href="/assets/js/206.92aa4225.js"><link rel="prefetch" href="/assets/js/207.a7b40c0e.js"><link rel="prefetch" href="/assets/js/208.2ccdec72.js"><link rel="prefetch" href="/assets/js/21.10b4dc58.js"><link rel="prefetch" href="/assets/js/22.4bf9ac80.js"><link rel="prefetch" href="/assets/js/23.c3eb10e7.js"><link rel="prefetch" href="/assets/js/24.6049e66b.js"><link rel="prefetch" href="/assets/js/25.740eae60.js"><link rel="prefetch" href="/assets/js/26.6508672a.js"><link rel="prefetch" href="/assets/js/27.b62436ba.js"><link rel="prefetch" href="/assets/js/28.0fcd8b09.js"><link rel="prefetch" href="/assets/js/29.cdf8e6e1.js"><link rel="prefetch" href="/assets/js/3.adb8ff64.js"><link rel="prefetch" href="/assets/js/30.d746df2e.js"><link rel="prefetch" href="/assets/js/31.1658d987.js"><link rel="prefetch" href="/assets/js/32.cbcd2285.js"><link rel="prefetch" href="/assets/js/33.b47f9ed5.js"><link rel="prefetch" href="/assets/js/34.652f0348.js"><link rel="prefetch" href="/assets/js/35.34c73735.js"><link rel="prefetch" href="/assets/js/36.5b8a9240.js"><link rel="prefetch" href="/assets/js/37.7adb41e1.js"><link rel="prefetch" href="/assets/js/38.a5cc37a6.js"><link rel="prefetch" href="/assets/js/39.311ec358.js"><link rel="prefetch" href="/assets/js/4.d1b60869.js"><link rel="prefetch" href="/assets/js/40.f9bc911b.js"><link rel="prefetch" href="/assets/js/41.a6c06b2b.js"><link rel="prefetch" href="/assets/js/42.5b61ef0d.js"><link rel="prefetch" href="/assets/js/43.d880f6c0.js"><link rel="prefetch" href="/assets/js/44.0caecaed.js"><link rel="prefetch" href="/assets/js/45.4510b119.js"><link rel="prefetch" href="/assets/js/46.1a160be2.js"><link rel="prefetch" href="/assets/js/47.16b3ce9f.js"><link rel="prefetch" href="/assets/js/48.4f922b8f.js"><link rel="prefetch" href="/assets/js/49.71d8b5e6.js"><link rel="prefetch" href="/assets/js/5.0f529a65.js"><link rel="prefetch" href="/assets/js/50.22dc8142.js"><link rel="prefetch" href="/assets/js/51.1069fb04.js"><link rel="prefetch" href="/assets/js/52.f8e3caf4.js"><link rel="prefetch" href="/assets/js/53.bcf6fa24.js"><link rel="prefetch" href="/assets/js/54.3150717b.js"><link rel="prefetch" href="/assets/js/55.09a73d17.js"><link rel="prefetch" href="/assets/js/56.21f2c3bc.js"><link rel="prefetch" href="/assets/js/57.669e6cb3.js"><link rel="prefetch" href="/assets/js/58.ea5236df.js"><link rel="prefetch" href="/assets/js/59.db63bf83.js"><link rel="prefetch" href="/assets/js/6.d7378514.js"><link rel="prefetch" href="/assets/js/60.9e9c4d91.js"><link rel="prefetch" href="/assets/js/61.161af03a.js"><link rel="prefetch" href="/assets/js/62.63fb20e3.js"><link rel="prefetch" href="/assets/js/63.ca919568.js"><link rel="prefetch" href="/assets/js/64.cbea0d2d.js"><link rel="prefetch" href="/assets/js/65.ab77ea26.js"><link rel="prefetch" href="/assets/js/66.f6ea7ab6.js"><link rel="prefetch" href="/assets/js/67.d5441cfc.js"><link rel="prefetch" href="/assets/js/68.5fe6bb1c.js"><link rel="prefetch" href="/assets/js/69.459c6a23.js"><link rel="prefetch" href="/assets/js/7.75533db5.js"><link rel="prefetch" href="/assets/js/70.e4212df6.js"><link rel="prefetch" href="/assets/js/71.159214f8.js"><link rel="prefetch" href="/assets/js/72.3f04f919.js"><link rel="prefetch" href="/assets/js/73.3dfd3590.js"><link rel="prefetch" href="/assets/js/74.f56c1f9b.js"><link rel="prefetch" href="/assets/js/75.59313a46.js"><link rel="prefetch" href="/assets/js/76.c051ff7e.js"><link rel="prefetch" href="/assets/js/77.78159be6.js"><link rel="prefetch" href="/assets/js/78.27138678.js"><link rel="prefetch" href="/assets/js/79.c8f6359c.js"><link rel="prefetch" href="/assets/js/8.ca5a883b.js"><link rel="prefetch" href="/assets/js/80.6bd6870d.js"><link rel="prefetch" href="/assets/js/81.6f775180.js"><link rel="prefetch" href="/assets/js/82.059d817e.js"><link rel="prefetch" href="/assets/js/83.2ce7e449.js"><link rel="prefetch" href="/assets/js/84.8e1b5d6b.js"><link rel="prefetch" href="/assets/js/85.c6c35d8e.js"><link rel="prefetch" href="/assets/js/86.3a9e6e9d.js"><link rel="prefetch" href="/assets/js/87.6e14f903.js"><link rel="prefetch" href="/assets/js/88.1e626988.js"><link rel="prefetch" href="/assets/js/89.944ef5f5.js"><link rel="prefetch" href="/assets/js/9.05040702.js"><link rel="prefetch" href="/assets/js/90.eb545609.js"><link rel="prefetch" href="/assets/js/91.df9eeac5.js"><link rel="prefetch" href="/assets/js/92.bb099835.js"><link rel="prefetch" href="/assets/js/93.ecad1db4.js"><link rel="prefetch" href="/assets/js/94.83d767ff.js"><link rel="prefetch" href="/assets/js/95.65f62b01.js"><link rel="prefetch" href="/assets/js/96.72eafffb.js"><link rel="prefetch" href="/assets/js/97.526ae33e.js"><link rel="prefetch" href="/assets/js/98.493e7e81.js"><link rel="prefetch" href="/assets/js/99.094f232d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cdd53b27.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="某不知名博客" class="logo"> <span class="site-name can-hide">某不知名博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><!----> <span class="title" style="display:;">文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/vulcat/" class="nav-link">《vulcat文档》</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="个人学习历程" class="dropdown-title"><!----> <span class="title" style="display:;">个人学习历程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>云原生安全</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/cloud-native-security/docker/command-lists/" class="nav-link">《Docker命令大全》</a></li><li class="dropdown-subitem"><a href="/cloud-native-security/kubernetes/cks/" class="nav-link">《CKS考试学习指南》</a></li><li class="dropdown-subitem"><a href="/cloud-native-security/kubernetes/preface/" class="nav-link">《旧-Kubernetes教程》</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/vuln-db/" class="nav-link">漏洞库</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="知识库" class="dropdown-title"><a href="/knowledge/" class="link-title">知识库</a> <span class="title" style="display:none;">知识库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/knowledge/tools/homepage/" class="nav-link">《渗透工具大全》</a></li><li class="dropdown-item"><!----> <a href="/knowledge/cloud-security/concept/" class="nav-link">《云安全》</a></li></ul></div></div><div class="nav-item"><a href="/security-events/" class="nav-link">事件库</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/carsaid/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://avatars.githubusercontent.com/u/78483995"> <div class="blogger-info"><h3>Carsaid</h3> <span>安全界的小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><!----> <span class="title" style="display:;">文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/vulcat/" class="nav-link">《vulcat文档》</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="个人学习历程" class="dropdown-title"><!----> <span class="title" style="display:;">个人学习历程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>云原生安全</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/cloud-native-security/docker/command-lists/" class="nav-link">《Docker命令大全》</a></li><li class="dropdown-subitem"><a href="/cloud-native-security/kubernetes/cks/" class="nav-link">《CKS考试学习指南》</a></li><li class="dropdown-subitem"><a href="/cloud-native-security/kubernetes/preface/" class="nav-link">《旧-Kubernetes教程》</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/vuln-db/" class="nav-link">漏洞库</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="知识库" class="dropdown-title"><a href="/knowledge/" class="link-title">知识库</a> <span class="title" style="display:none;">知识库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/knowledge/tools/homepage/" class="nav-link">《渗透工具大全》</a></li><li class="dropdown-item"><!----> <a href="/knowledge/cloud-security/concept/" class="nav-link">《云安全》</a></li></ul></div></div><div class="nav-item"><a href="/security-events/" class="nav-link">事件库</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/carsaid/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>CKA认证备考经验分享</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>能够用到的资料</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>2022年考题复习</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/6f18ed/" class="sidebar-link">2022年考题收集</a></li><li><a href="/pages/02d0fb/" class="sidebar-link">考题复习-1</a></li><li><a href="/pages/5f216a/" class="sidebar-link">考题复习-2</a></li><li><a href="/pages/31456b/" class="sidebar-link">考题复习-3</a></li><li><a href="/pages/a93143/" aria-current="page" class="active sidebar-link">个人模拟考试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/a93143/#考前设置" class="sidebar-link">考前设置</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a93143/#命令行" class="sidebar-link">命令行</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#vim" class="sidebar-link">vim</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a93143/#模拟考题" class="sidebar-link">模拟考题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-1-集群上下文" class="sidebar-link">考题-1 | 集群上下文</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-2-调度控制平面节点上的pod" class="sidebar-link">考题-2 | 调度控制平面节点上的Pod</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-2" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-3-缩减-statefulset" class="sidebar-link">考题-3 | 缩减 StatefulSet</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-3" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-4-pod就绪-如果服务可达" class="sidebar-link">考题-4 | Pod就绪（如果服务可达）</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-4" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-5-kubectl排序" class="sidebar-link">考题-5 | Kubectl排序</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-5" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-6-储存、pv、pvc、pod挂载" class="sidebar-link">考题-6 | 储存、PV、PVC、Pod挂载</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-6" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-7-node和pod资源使用情况" class="sidebar-link">考题-7 | Node和Pod资源使用情况</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-7" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-8-获取控制平面信息" class="sidebar-link">考题-8 | 获取控制平面信息</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-8" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-9-杀死调度器-手动调度" class="sidebar-link">考题-9 | 杀死调度器，手动调度</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-9" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#暂停调度器" class="sidebar-link">暂停调度器</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#创建pod" class="sidebar-link">创建Pod</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#手动调度pod" class="sidebar-link">手动调度Pod</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#再次启动调度程序" class="sidebar-link">再次启动调度程序</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-10-rbac-serviceaccount-role-rolebinding" class="sidebar-link">考题-10 | RBAC ServiceAccount Role RoleBinding</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-10" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#让我们稍微讨论一下rbac资源" class="sidebar-link">让我们稍微讨论一下RBAC资源</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#前往解决方案" class="sidebar-link">前往解决方案</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-11-所有节点上的daemonset" class="sidebar-link">考题-11 | 所有节点上的DaemonSet</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-11" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-12-所有节点上的deployment" class="sidebar-link">考题-12 | 所有节点上的Deployment</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-12" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#podantiaffinity" class="sidebar-link">PodAntiAffinity</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#topologyspreadconstraints" class="sidebar-link">TopologySpreadConstraints</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#应用并运行" class="sidebar-link">应用并运行</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-13-多容器-pod-共享卷" class="sidebar-link">考题-13 | 多容器 Pod 共享卷</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-13" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-14-了解群集信息" class="sidebar-link">考题-14 | 了解群集信息</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-14" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#有多少控制平面和工作节点可用" class="sidebar-link">有多少控制平面和工作节点可用？</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#服务的-cidr-网段-是多少" class="sidebar-link">服务的 CIDR（网段）是多少？</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#配置了哪个网络-或-cni-插件-其配置文件在哪里" class="sidebar-link">配置了哪个网络（或 CNI 插件），其配置文件在哪里？</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#在-cluster1-node1-上运行的静态-pod-会有哪个后缀" class="sidebar-link">在 cluster1-node1 上运行的静态 pod 会有哪个后缀？</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#结果" class="sidebar-link">结果</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-15-群集事件日志记录" class="sidebar-link">考题-15 | 群集事件日志记录</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-15" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-16-命名空间和api资源" class="sidebar-link">考题-16 | 命名空间和API资源</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-16" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#命名空间和资源" class="sidebar-link">命名空间和资源</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#最多role的命名空间" class="sidebar-link">最多Role的命名空间</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-17-找到pod的容器并检查信息" class="sidebar-link">考题-17 | 找到Pod的容器并检查信息</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-17" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-18-修复kubelet" class="sidebar-link">考题-18 | 修复Kubelet</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-18" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-19-创建secret并挂载到pod" class="sidebar-link">考题-19 | 创建Secret并挂载到Pod</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-19" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-20-更新kubernetes版本并加入集群" class="sidebar-link">考题-20 | 更新Kubernetes版本并加入集群</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-20" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#升级-kubernetes-到符合cluster3-controlplane1的版本。" class="sidebar-link">升级 Kubernetes 到符合cluster3-controlplane1的版本。</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#将cluster-3-node2添加到集群" class="sidebar-link">将cluster 3-node2添加到集群</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-21-创建静态pod和服务" class="sidebar-link">考题-21 | 创建静态Pod和服务</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-21" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-22-检查证书的有效期" class="sidebar-link">考题-22 | 检查证书的有效期</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-22" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-23-kubelet-客户端-服务器证书信息" class="sidebar-link">考题-23 | Kubelet 客户端/服务器证书信息</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-23" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-24-networkpolicy" class="sidebar-link">考题-24 | NetworkPolicy</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-24" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#正确实现" class="sidebar-link">正确实现</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#错误的例子" class="sidebar-link">错误的例子</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#创建网络策略" class="sidebar-link">创建网络策略</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#考题-25-etcd快照保存和恢复" class="sidebar-link">考题-25 | Etcd快照保存和恢复</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-25" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#etcd备份" class="sidebar-link">Etcd备份</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#etcd恢复" class="sidebar-link">Etcd恢复</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a93143/#附加题目" class="sidebar-link">附加题目</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a93143/#附题-1-查找需要第一个终止的pod" class="sidebar-link">附题-1 | 查找需要第一个终止的Pod</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-26" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#附题-2-curl-手动联系-api" class="sidebar-link">附题-2 | Curl 手动联系 API</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-27" class="sidebar-link">解答</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/a93143/#预习题目" class="sidebar-link">预习题目</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/a93143/#预览题-1" class="sidebar-link">预览题-1</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-28" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#查询etcd信息" class="sidebar-link">查询ETCD信息</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#创建etcd快照" class="sidebar-link">创建etcd快照</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#预览题-2" class="sidebar-link">预览题-2</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-29" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#创建pod-2" class="sidebar-link">创建Pod</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#创建服务" class="sidebar-link">创建服务</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#确认kube-proxy正在运行并且正在使用iptables" class="sidebar-link">确认kube-proxy正在运行并且正在使用iptables</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#检查kube-proxy是否正在创建iptables规则" class="sidebar-link">检查kube-proxy是否正在创建iptables规则</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#删除服务并确认iptables规则已消失" class="sidebar-link">删除服务并确认iptables规则已消失</a></li><li class="sidebar-sub-header level3"><a href="/pages/a93143/#预览题-3" class="sidebar-link">预览题-3</a></li><li class="sidebar-sub-header level4"><a href="/pages/a93143/#解答-30" class="sidebar-link">解答</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#给予一点时间-让-kube-apiserver-和管理器重新启动" class="sidebar-link">给予一点时间，让 kube-apiserver 和管理器重新启动</a></li><li class="sidebar-sub-header level5"><a href="/pages/a93143/#给予它一点时间让调度程序重新启动。" class="sidebar-link">给予它一点时间让调度程序重新启动。</a></li></ul></li></ul></li></ul></section></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=%E6%9D%82%E8%AE%B0" title="分类" data-v-06225672>杂记</a></li><li data-v-06225672><a href="/categories/?category=CKA%E8%AE%A4%E8%AF%81%E5%A4%87%E8%80%83%E7%BB%8F%E9%AA%8C%E5%88%86%E4%BA%AB" title="分类" data-v-06225672>CKA认证备考经验分享</a></li><li data-v-06225672><a href="/categories/?category=2022%E5%B9%B4%E8%80%83%E9%A2%98%E5%A4%8D%E4%B9%A0" title="分类" data-v-06225672>2022年考题复习</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/carsaid" target="_blank" title="作者" class="beLink" data-v-06225672>carsaid</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-11-29</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">个人模拟考试<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="个人模拟考试"><a href="#个人模拟考试" class="header-anchor">#</a> 个人模拟考试</h1> <p>这是我在 2023 年 1 月份做的一次 CKA 模拟考试，基于 kubernetes v1.26 版本。</p> <p>这次模拟考试提供了 25 道题目（总分 125 分）、以及 2 道附加题目、3 道预习题目。（真实考试是 15~20 道题，总分 100 分）</p> <p>模拟考试比真实的认证更难，如果你能够通过模拟考试，则说明你有了挑战真实考试的水平。</p> <p>以下是模拟考试的内容：</p> <h2 id="考前设置"><a href="#考前设置" class="header-anchor">#</a> 考前设置</h2> <h3 id="命令行"><a href="#命令行" class="header-anchor">#</a> 命令行</h3> <p>一旦你获得了对终端的访问权，花 1 分钟来设置你的环境可能是明智的。你可以设置这些：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">alias</span> <span class="token assign-left variable">k</span><span class="token operator">=</span>kubectl                         <span class="token comment"># will already be pre-configured</span>

<span class="token builtin class-name">export</span> <span class="token assign-left variable">do</span><span class="token operator">=</span><span class="token string">&quot;--dry-run=client -o yaml&quot;</span>    <span class="token comment"># k create deploy nginx --image=nginx $do</span>

<span class="token builtin class-name">export</span> <span class="token assign-left variable">now</span><span class="token operator">=</span><span class="token string">&quot;--force --grace-period 0&quot;</span>   <span class="token comment"># k delete pod x $now</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="vim"><a href="#vim" class="header-anchor">#</a> vim</h3> <p>以下设置已在真实环境的<code>~/.vimrc</code>中进行配置。但是，输入这些内容永远不会有什么坏处：</p> <div class="language-conf line-numbers-mode"><pre class="language-text"><code>set tabstop=2

set expandtab

set shiftwidth=2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>更多的设置建议在提示部分。</p> <h2 id="模拟考题"><a href="#模拟考题" class="header-anchor">#</a> 模拟考题</h2> <h3 id="考题-1-集群上下文"><a href="#考题-1-集群上下文" class="header-anchor">#</a> 考题-1 | 集群上下文</h3> <p>任务权重：1%</p> <p>你可以通过<code>kubectl</code>从主终端访问多个集群上下文。将所有这些上下文名称写入<code>/opt/course/1/contexts</code>。</p> <p>接下来，在<code>/opt/course/1/context_default_kubectl.sh</code>中写入一个命令以显示当前上下文，该命令应该使用<code>kubectl</code>。</p> <p>最后，将执行相同操作的第二个命令写入<code>/opt/course/1/context_default_no_kubectl.sh</code>，但不使用<code>kubectl</code>。</p> <h4 id="解答"><a href="#解答" class="header-anchor">#</a> 解答</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k config get-contexts <span class="token comment"># 手动复制</span>

k config get-contexts <span class="token parameter variable">-o</span> name <span class="token operator">&gt;</span> /opt/course/1/contexts
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后，内容应该如下所示：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/1/contexts</span>
k8s-c1-H
k8s-c2-AC
k8s-c3-CCC
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>接下来创建第一个命令：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/1/context_default_kubectl.sh</span>
kubectl config current-context
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">sh</span> /opt/course/1/context_default_kubectl.sh
k8s-c1-H
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>第二个：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/1/context_default_no_kubectl.sh</span>
<span class="token function">cat</span> ~/.kube/config <span class="token operator">|</span> <span class="token function">grep</span> current <span class="token operator">|</span> <span class="token function">sed</span> <span class="token parameter variable">-e</span> <span class="token string">&quot;s/current-context: //&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">sh</span> /opt/course/1/context_default_no_kubectl.sh
k8s-c1-H
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="考题-2-调度控制平面节点上的pod"><a href="#考题-2-调度控制平面节点上的pod" class="header-anchor">#</a> 考题-2 | 调度控制平面节点上的Pod</h3> <p>任务权重：3%</p> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>在 Namespace <code>default</code>中创建镜像为<code>httpd:2.4.41-alpine</code>的单个 Pod。这个 Pod 应该被命名为<code>pod1</code>，容器应该被命名为<code>pod1-container</code>。这个 Pod 应该<b>只</b>调度在控制平面节点上，不要在任何节点上添加新标签。</p> <h4 id="解答-2"><a href="#解答-2" class="header-anchor">#</a> 解答</h4> <p>首先，我们找到控制平面节点及其污点：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k get <span class="token function">node</span> <span class="token comment"># 找到控制平面节点</span>

k describe <span class="token function">node</span> cluster1-controlplane1 <span class="token operator">|</span> <span class="token function">grep</span> Taint <span class="token parameter variable">-A1</span> <span class="token comment"># 获取控制平面节点的污点</span>

k get <span class="token function">node</span> cluster1-controlplane1 --show-labels <span class="token comment"># 获取控制平面节点的标签</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>接下来我们创建 Pod 模板：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 检查本文档最顶部的建议，以便我们可以使用 $do</span>
k run pod1 <span class="token parameter variable">--image</span><span class="token operator">=</span>httpd:2.4.41-alpine <span class="token variable">$do</span> <span class="token operator">&gt;</span> <span class="token number">2</span>.yaml

<span class="token function">vim</span> <span class="token number">2</span>.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>手动执行必要的更改。使用 Kubernetes 文档并搜索 tolerations 和 nodeSelector 以查找示例：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 2.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> pod1
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> httpd<span class="token punctuation">:</span>2.4.41<span class="token punctuation">-</span>alpine
    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod1<span class="token punctuation">-</span>container                       <span class="token comment"># change</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>                                 <span class="token comment"># add</span>
  <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule                         <span class="token comment"># add</span>
    <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/control<span class="token punctuation">-</span>plane <span class="token comment"># add</span>
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>                                <span class="token comment"># add</span>
    <span class="token key atrule">node-role.kubernetes.io/control-plane</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>  <span class="token comment"># add</span>
<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>这里很重要，要添加在控制平面节点上运行的容限，还要添加 nodeSelector，以确保它只在控制平面节点上运行。如果我们只指定一个容忍，则 Pod 会被调度在控制平面 或 工作节点上。</p> <p>现在我们创建它：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-f</span> <span class="token number">2</span>.yaml create
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>让我们检查一下 pod 是否已被调度：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get pod pod1 <span class="token parameter variable">-o</span> wide
NAME   READY   STATUS    RESTARTS   <span class="token punctuation">..</span>.    NODE                     NOMINATED NODE
pod1   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          <span class="token punctuation">..</span>.    cluster1-controlplane1   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="考题-3-缩减-statefulset"><a href="#考题-3-缩减-statefulset" class="header-anchor">#</a> 考题-3 | 缩减 StatefulSet</h3> <p>任务权重：1%</p> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>在命名空间<code>project-c13</code>中有两个名为<code>o3db-*</code>的 Pod。现在 C13 管理层要求您将 Pod 缩减到一个副本以节省资源。</p> <h4 id="解答-3"><a href="#解答-3" class="header-anchor">#</a> 解答</h4> <p>找出 StatefulSet：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k <span class="token parameter variable">-n</span> project-c13 get pod <span class="token operator">|</span> <span class="token function">grep</span> o3db
o3db-0                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          52s
o3db-1                                  <span class="token number">1</span>/1     Running   <span class="token number">0</span>          42s

➜ k <span class="token parameter variable">-n</span> project-c13 get deploy,ds,sts <span class="token operator">|</span> <span class="token function">grep</span> o3db
statefulset.apps/o3db   <span class="token number">2</span>/2     2m56s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>要完成任务，我们只需运行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k <span class="token parameter variable">-n</span> project-c13 scale sts o3db <span class="token parameter variable">--replicas</span> <span class="token number">1</span>
statefulset.apps/o3db scaled

➜ k <span class="token parameter variable">-n</span> project-c13 get sts o3db
NAME   READY   AGE
o3db   <span class="token number">1</span>/1     4m39s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>C13 管理层再次感到高兴。</p> <h3 id="考题-4-pod就绪-如果服务可达"><a href="#考题-4-pod就绪-如果服务可达" class="header-anchor">#</a> 考题-4 | Pod就绪（如果服务可达）</h3> <p>任务权重：4%</p> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>在命名空间<code>default</code>中执行以下操作。创建一个名为<code>ready-if-service-ready</code>镜像为<code>nginx:1.16.1-alpine</code>的 pod 。配置一个 LivenessProbe，它只执行命令<code>true</code>。还要配置一个 ReadinessProbe，它会检查 url <code>http://service-am-i-ready:80</code>是否可访问，为此可以使用<code>wget -T2 -O- http://service-am-i-ready:80</code>。启动 Pod 并确认它尚未准备就绪，因为 ReadinessProbe 的存在。</p> <p>创建第二个名为<code>am-i-ready</code>的 pod，镜像为<code>nginx:1.16.1-alpine</code>，标签为<code>id: cross-server-ready</code>。已经存在的 Service <code>service-am-i-ready</code>现在应该将第二个 Pod 作为端点。</p> <h4 id="解答-4"><a href="#解答-4" class="header-anchor">#</a> 解答</h4> <p>一个 Pod 使用探测器检查另一个 Pod 是否准备好是一种反模式，因此通常可用的<code>readinessProbe.httpGet</code><b>不适用</b>于绝对远程 url。尽管如此，此任务中请求的解决方法应显示探测器和 Pod&lt;-&gt;Service 通信的工作原理。</p> <p>首先，我们创建第一个 Pod：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k run ready-if-service-ready <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx:1.16.1-alpine <span class="token variable">$do</span> <span class="token operator">&gt;</span> 4_pod1.yaml

<span class="token function">vim</span> 4_pod1.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接下来手动执行必要的添加：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 4_pod1.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> ready<span class="token punctuation">-</span>if<span class="token punctuation">-</span>service<span class="token punctuation">-</span>ready
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ready<span class="token punctuation">-</span>if<span class="token punctuation">-</span>service<span class="token punctuation">-</span>ready
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.16.1<span class="token punctuation">-</span>alpine
    <span class="token key atrule">name</span><span class="token punctuation">:</span> ready<span class="token punctuation">-</span>if<span class="token punctuation">-</span>service<span class="token punctuation">-</span>ready
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>                                      <span class="token comment"># 从这里开始添加</span>
      <span class="token key atrule">exec</span><span class="token punctuation">:</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token string">'true'</span>
    <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">exec</span><span class="token punctuation">:</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> sh
        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
        <span class="token punctuation">-</span> <span class="token string">'wget -T2 -O- http://service-am-i-ready:80'</span>   <span class="token comment"># 一直到这里</span>
  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>然后创建 Pod，并确认它处于非就绪状态：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-f</span> 4_pod1.yaml create

➜ k get pod ready-if-service-ready
NAME                     READY   STATUS    RESTARTS   AGE
ready-if-service-ready   <span class="token number">0</span>/1     Running   <span class="token number">0</span>          7s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>现在我们创建第二个 Pod：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k run am-i-ready <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx:1.16.1-alpine <span class="token parameter variable">--labels</span><span class="token operator">=</span><span class="token string">&quot;id=cross-server-ready&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>已经存在的 Service <code>service-am-i-ready</code>现在应该会提供一个端点：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k describe svc service-am-i-ready
k get ep <span class="token comment"># 也是可能的</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>这将导致我们的第一个 Pod 准备就绪，只需给它一分钟时间让 Readiness 探测器再次检查：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get pod ready-if-service-ready
NAME                     READY   STATUS    RESTARTS   AGE
ready-if-service-ready   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          53s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>看看这些 Pod 的协同工作！</p> <h3 id="考题-5-kubectl排序"><a href="#考题-5-kubectl排序" class="header-anchor">#</a> 考题-5 | Kubectl排序</h3> <p>任务权重：1%</p> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>所有命名空间中都有各种 Pod。在<code>/opt/course/5/find_pods.sh</code>中写入一个命令，其中列出了按 AGE（<code>metadata.creationTimestamp</code>）排序的所有 Pod。</p> <p>在<code>/opt/course/5/find_pods_uid.sh</code>中写入第二个命令，其中列出了按字段<code>metadata.uid</code>排序的所有 Pod。对这两个命令都使用<code>kubectl</code>排序。</p> <h4 id="解答-5"><a href="#解答-5" class="header-anchor">#</a> 解答</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/5/find_pods.sh</span>
kubectl get pod <span class="token parameter variable">-A</span> --sort-by<span class="token operator">=</span>.metadata.creationTimestamp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对于第二个命令：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/5/find_pods_uid.sh</span>
kubectl get pod <span class="token parameter variable">-A</span> --sort-by<span class="token operator">=</span>.metadata.uid
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="考题-6-储存、pv、pvc、pod挂载"><a href="#考题-6-储存、pv、pvc、pod挂载" class="header-anchor">#</a> 考题-6 | 储存、PV、PVC、Pod挂载</h3> <p>任务权重：8%</p> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>创建一个名为<code>safari-pv</code>的新 PersistentVolume。它的容量应为 2Gi、访问模式为 ReadWriteOnce、hostPath 为<code>/Volumes/Data</code>，并且未定义 storageClassName。</p> <p>接下来，在命名空间<code>project-tiger</code>中创建一个名为<code>safari-pvc</code>的新 PersistentVolumeClaim。它应该请求 2Gi 存储、访问模式 ReadWriteOnce，并且不应定义 storageClassName。PVC 应正确绑定到 PV。</p> <p>最后，在命名空间<code>project-tiger</code>中创建一个名为<code>safari</code>的新 Deployment，它将该卷挂载到<code>/tmp/safari-data</code>。该 Deployment 的 Pod 镜像应为<code>httpd:2.4.41-alpine</code>。</p> <h4 id="解答-6"><a href="#解答-6" class="header-anchor">#</a> 解答</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> 6_pv.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 6_pv.yaml</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
 <span class="token key atrule">name</span><span class="token punctuation">:</span> safari<span class="token punctuation">-</span>pv
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
 <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
  <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi
 <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteOnce
 <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
  <span class="token key atrule">path</span><span class="token punctuation">:</span> <span class="token string">&quot;/Volumes/Data&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>然后创建它：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-f</span> 6_pv.yaml create
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 6_pvc.yaml</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> safari<span class="token punctuation">-</span>pvc
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>tiger
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
     <span class="token key atrule">storage</span><span class="token punctuation">:</span> 2Gi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-f</span> 6_pvc.yaml create
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>并检查两者是否都具有 Bound 状态：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k <span class="token parameter variable">-n</span> project-tiger get pv,pvc
NAME                         CAPACITY  <span class="token punctuation">..</span>. STATUS   CLAIM                    <span class="token punctuation">..</span>.
persistentvolume/safari-pv   2Gi       <span class="token punctuation">..</span>. Bound    project-tiger/safari-pvc <span class="token punctuation">..</span>.

NAME                               STATUS   VOLUME      CAPACITY <span class="token punctuation">..</span>.
persistentvolumeclaim/safari-pvc   Bound    safari-pv   2Gi      <span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>接下来，我们创建一个 Deployment 并挂载该卷：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-n</span> project-tiger create deploy safari <span class="token punctuation">\</span>
  <span class="token parameter variable">--image</span><span class="token operator">=</span>httpd:2.4.41-alpine <span class="token variable">$do</span> <span class="token operator">&gt;</span> 6_dep.yaml

<span class="token function">vim</span> 6_dep.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 6_dep.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> safari
  <span class="token key atrule">name</span><span class="token punctuation">:</span> safari
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>tiger
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> safari
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> safari
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>                                      <span class="token comment"># add</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data                                  <span class="token comment"># add</span>
        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>                      <span class="token comment"># add</span>
          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> safari<span class="token punctuation">-</span>pvc                     <span class="token comment"># add</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> httpd<span class="token punctuation">:</span>2.4.41<span class="token punctuation">-</span>alpine
        <span class="token key atrule">name</span><span class="token punctuation">:</span> container
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>                               <span class="token comment"># add</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data                                <span class="token comment"># add</span>
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp/safari<span class="token punctuation">-</span>data               <span class="token comment"># add</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-f</span> 6_dep.yaml create

➜ k <span class="token parameter variable">-n</span> project-tiger describe pod safari-5cbf46d6d-mjhsb  <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-A2</span> Mounts:   
    Mounts:
      /tmp/safari-data from data <span class="token punctuation">(</span>rw<span class="token punctuation">)</span> <span class="token comment"># there it is</span>
      /var/run/secrets/kubernetes.io/serviceaccount from default-token-n2sjj <span class="token punctuation">(</span>ro<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="考题-7-node和pod资源使用情况"><a href="#考题-7-node和pod资源使用情况" class="header-anchor">#</a> 考题-7 | Node和Pod资源使用情况</h3> <p>任务权重：1%</p> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>metrics-server 已安装在集群中。你的学院想知道 kubectl 命令：</p> <ol><li>显示节点资源使用情况</li> <li>显示 Pod 及其容器资源使用情况</li></ol> <p>请将命令写入<code>/opt/course/7/node.sh</code>和<code>/opt/course/7/pod.sh</code>。</p> <h4 id="解答-7"><a href="#解答-7" class="header-anchor">#</a> 解答</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/7/node.sh</span>
kubectl <span class="token function">top</span> <span class="token function">node</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/7/pod.sh</span>
kubectl <span class="token function">top</span> pod <span class="token parameter variable">--containers</span><span class="token operator">=</span>true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="考题-8-获取控制平面信息"><a href="#考题-8-获取控制平面信息" class="header-anchor">#</a> 考题-8 | 获取控制平面信息</h3> <p>任务权重：2%</p> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>使用<code>ssh cluster1-controlplane1</code>通过 SSH 连接到控制平面节点。检查控制平面组件的 kubelet、kube-apiserver、kube-scheduler、kube-controller-manager 和 etcd 是如何在控制平面节点上启动 / 安装的。此外，找出 DNS 应用程序的名称以及它在控制平面节点上的启动 / 安装方式。</p> <p>将您的发现写入文件<code>/opt/course/8/controlplane-components.txt</code>。该文件的结构应如下所示：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/8/controlplane-components.txt</span>
kubelet: <span class="token punctuation">[</span>TYPE<span class="token punctuation">]</span>
kube-apiserver: <span class="token punctuation">[</span>TYPE<span class="token punctuation">]</span>
kube-scheduler: <span class="token punctuation">[</span>TYPE<span class="token punctuation">]</span>
kube-controller-manager: <span class="token punctuation">[</span>TYPE<span class="token punctuation">]</span>
etcd: <span class="token punctuation">[</span>TYPE<span class="token punctuation">]</span>
dns: <span class="token punctuation">[</span>TYPE<span class="token punctuation">]</span> <span class="token punctuation">[</span>NAME<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><code>[TYPE]</code>选项包括：<code>not-installed</code>、<code>process</code>、<code>static-pod</code>、<code>pod</code></p> <h4 id="解答-8"><a href="#解答-8" class="header-anchor">#</a> 解答</h4> <p>我们可以从查找请求组件的进程开始，尤其是 kubelet：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster1-controlplane1

root@cluster1-controlplane1:~<span class="token comment"># ps aux | grep kubelet # shows kubelet process</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>我们可以查看<code>/etc/systemd/system</code>目录，查看通过 systemd 控制哪些组件：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster1-controlplane1:~<span class="token comment"># find /etc/systemd/system/ | grep kube</span>
/etc/systemd/system/kubelet.service.d
/etc/systemd/system/kubelet.service.d/10-kubeadm.conf
/etc/systemd/system/multi-user.target.wants/kubelet.service

➜ root@cluster1-controlplane1:~<span class="token comment"># find /etc/systemd/system/ | grep etcd</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>这表明 kubelet 是通过 systemd 控制的，但没有其他名为 kube 或 etcd 的服务。看起来这个集群是使用 kubeadm 设置的，所以我们检查默认的 manifests 目录：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster1-controlplane1:~<span class="token comment"># find /etc/kubernetes/manifests/</span>
/etc/kubernetes/manifests/
/etc/kubernetes/manifests/kube-controller-manager.yaml
/etc/kubernetes/manifests/etcd.yaml
/etc/kubernetes/manifests/kube-apiserver.yaml
/etc/kubernetes/manifests/kube-scheduler.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>（kubelet 也可以通过其 systemd 启动配置中的参数<code>--pod-manifest-path</code>指定不同的清单目录）</p> <p>这意味着主要的 4 个控制平面服务被设置为静态 Pod。实际上，让我们检查一下在控制平面节点上的<code>kube-system</code>命名空间中运行的所有 Pod：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster1-controlplane1:~<span class="token comment"># kubectl -n kube-system get pod -o wide | grep controlplane1</span>
coredns-5644d7b6d9-c4f68                            <span class="token number">1</span>/1     Running            <span class="token punctuation">..</span>.   cluster1-controlplane1
coredns-5644d7b6d9-t84sc                            <span class="token number">1</span>/1     Running            <span class="token punctuation">..</span>.   cluster1-controlplane1
etcd-cluster1-controlplane1                         <span class="token number">1</span>/1     Running            <span class="token punctuation">..</span>.   cluster1-controlplane1
kube-apiserver-cluster1-controlplane1               <span class="token number">1</span>/1     Running            <span class="token punctuation">..</span>.   cluster1-controlplane1
kube-controller-manager-cluster1-controlplane1      <span class="token number">1</span>/1     Running            <span class="token punctuation">..</span>.   cluster1-controlplane1
kube-proxy-q955p                                    <span class="token number">1</span>/1     Running            <span class="token punctuation">..</span>.   cluster1-controlplane1
kube-scheduler-cluster1-controlplane1               <span class="token number">1</span>/1     Running            <span class="token punctuation">..</span>.   cluster1-controlplane1
weave-net-mwj47                                     <span class="token number">2</span>/2     Running            <span class="token punctuation">..</span>.   cluster1-controlplane1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在那里，我们看到 5 个静态 pod，后缀为<code>-cluster1-controlplane1</code>。</p> <p>我们也看到 dns 应用程序似乎是 coredns，但它是如何控制的呢？</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster1-controlplane1$ kubectl <span class="token parameter variable">-n</span> kube-system get ds
NAME         DESIRED   CURRENT   <span class="token punctuation">..</span>.   NODE SELECTOR            AGE
kube-proxy   <span class="token number">3</span>         <span class="token number">3</span>         <span class="token punctuation">..</span>.   kubernetes.io/os<span class="token operator">=</span>linux   155m
weave-net    <span class="token number">3</span>         <span class="token number">3</span>         <span class="token punctuation">..</span>.   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>                   155m

➜ root@cluster1-controlplane1$ kubectl <span class="token parameter variable">-n</span> kube-system get deploy
NAME      READY   UP-TO-DATE   AVAILABLE   AGE
coredns   <span class="token number">2</span>/2     <span class="token number">2</span>            <span class="token number">2</span>           155m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>coredns 似乎是通过 Deployment 控制的。我们将我们的发现合并到所需的文件中：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/8/controlplane-components.txt</span>
kubelet: process
kube-apiserver: static-pod
kube-scheduler: static-pod
kube-controller-manager: static-pod
etcd: static-pod
dns: pod coredns
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>您应该能够轻松地调查正在运行的集群，了解如何设置集群 及其 部署服务的不同方法，并能够进行故障排除和查找错误源。</p> <h3 id="考题-9-杀死调度器-手动调度"><a href="#考题-9-杀死调度器-手动调度" class="header-anchor">#</a> 考题-9 | 杀死调度器，手动调度</h3> <p>任务权重：5%</p> <p>切换集群：<code>kubectl config use-context k8s-c2-AC</code></p> <p>使用<code>ssh cluster2-controlplane1</code>通过 SSH 连接到控制平面节点。<b>暂时</b>停止 kube-scheduler，这意味着您可以在之后再次启动它。</p> <p>创建一个名为<code>manual-schedule</code>且镜像为<code>httpd:2.4-alpine</code>的 Pod，确认它已创建但未在任何节点上调度。</p> <p>现在假设你是调度器，并拥有它的所有功能，在节点 cluster2-controlplane1 上手动调度该 Pod。确保它正在运行。</p> <p>再次启动 kube-scheduler 并创建镜像为<code>httpd:2.4-alpine</code>的第二个名为<code>manual-schedule2</code>的 Pod 来确认它运行正常，并检查它是否在 cluster2-node1 上运行。</p> <h4 id="解答-9"><a href="#解答-9" class="header-anchor">#</a> 解答</h4> <h5 id="暂停调度器"><a href="#暂停调度器" class="header-anchor">#</a> 暂停调度器</h5> <p>首先，我们找到控制平面节点：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get <span class="token function">node</span>
NAME                     STATUS   ROLES           AGE   VERSION
cluster2-controlplane1   Ready    control-plane   26h   v1.26.0
cluster2-node1           Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          26h   v1.26.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后我们连接并检查调度程序是否正在运行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster2-controlplane1

➜ root@cluster2-controlplane1:~<span class="token comment"># kubectl -n kube-system get pod | grep schedule</span>
kube-scheduler-cluster2-controlplane1            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          6s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>杀死调度器（暂时）：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster2-controlplane1:~<span class="token comment"># cd /etc/kubernetes/manifests/</span>

➜ root@cluster2-controlplane1:~<span class="token comment"># mv kube-scheduler.yaml ..</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>它应该已被停止：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster2-controlplane1:~<span class="token comment"># kubectl -n kube-system get pod | grep schedule</span>

➜ root@cluster2-controlplane1:~<span class="token comment"># </span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="创建pod"><a href="#创建pod" class="header-anchor">#</a> 创建Pod</h5> <p>现在我们创建Pod：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k run manual-schedule <span class="token parameter variable">--image</span><span class="token operator">=</span>httpd:2.4-alpine
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>并确认它没有分配节点：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get pod manual-schedule <span class="token parameter variable">-o</span> wide
NAME              READY   STATUS    <span class="token punctuation">..</span>.   NODE     NOMINATED NODE
manual-schedule   <span class="token number">0</span>/1     Pending   <span class="token punctuation">..</span>.   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>   
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="手动调度pod"><a href="#手动调度pod" class="header-anchor">#</a> 手动调度Pod</h5> <p>让我们现在充当调度程序：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k get pod manual-schedule <span class="token parameter variable">-o</span> yaml <span class="token operator">&gt;</span> <span class="token number">9</span>.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 9.yaml</span>
<span class="token punctuation">...</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">nodeName</span><span class="token punctuation">:</span> cluster2<span class="token punctuation">-</span>controlplane1        <span class="token comment"># 添加控制平面节点的名称</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> httpd<span class="token punctuation">:</span>2.4<span class="token punctuation">-</span>alpine
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">name</span><span class="token punctuation">:</span> manual<span class="token punctuation">-</span>schedule
    <span class="token punctuation">...</span>
<span class="token punctuation">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>调度程序唯一做的事情就是为 Pod 声明设置 nodeName。它如何找到正确的节点进行调度，这是一个非常复杂的问题，需要考虑许多变量。</p> <p>由于我们不能<code>kubectl apply</code>或<code>kubectl edit</code>，在这种情况下，我们需要删除然后重新创建，或者使用替换：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-f</span> <span class="token number">9</span>.yaml replace <span class="token parameter variable">--force</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>看起来怎么样？</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get pod manual-schedule <span class="token parameter variable">-o</span> wide
NAME              READY   STATUS    <span class="token punctuation">..</span>.   NODE            
manual-schedule   <span class="token number">1</span>/1     Running   <span class="token punctuation">..</span>.   cluster2-controlplane1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>看起来我们的 Pod 现在正在按要求在控制平面上运行，尽管没有指定容忍度。只有调度程序在查找正确的节点名时才会考虑 tains/tolerations/affinity。这就是为什么仍然可以直接手动将 Pod 分配给控制平面节点并跳过调度程序。</p> <h5 id="再次启动调度程序"><a href="#再次启动调度程序" class="header-anchor">#</a> 再次启动调度程序</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster2-controlplane1

➜ root@cluster2-controlplane1:~<span class="token comment"># cd /etc/kubernetes/manifests/</span>

➜ root@cluster2-controlplane1:~<span class="token comment"># mv ../kube-scheduler.yaml .</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>检查它正在运行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster2-controlplane1:~<span class="token comment"># kubectl -n kube-system get pod | grep schedule</span>
kube-scheduler-cluster2-controlplane1            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          16s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>调度第二个测试 Pod：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k run manual-schedule2 <span class="token parameter variable">--image</span><span class="token operator">=</span>httpd:2.4-alpine

➜ k get pod <span class="token parameter variable">-o</span> wide <span class="token operator">|</span> <span class="token function">grep</span> schedule
manual-schedule    <span class="token number">1</span>/1     Running   <span class="token punctuation">..</span>.   cluster2-controlplane1
manual-schedule2   <span class="token number">1</span>/1     Running   <span class="token punctuation">..</span>.   cluster2-node1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>恢复正常。</p> <h3 id="考题-10-rbac-serviceaccount-role-rolebinding"><a href="#考题-10-rbac-serviceaccount-role-rolebinding" class="header-anchor">#</a> 考题-10 | RBAC ServiceAccount Role RoleBinding</h3> <p>任务权重：6%</p> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>在命名空间<code>project-hamster</code>中创建新的 ServiceAccount <code>processor</code>。创建一个 Role 和 RoleBinding，这两个名称也都命名为<code>processor</code>。这些应该允许新的 SA 只在该命名空间中创建 Secret 和 ConfigMap。</p> <h4 id="解答-10"><a href="#解答-10" class="header-anchor">#</a> 解答</h4> <h5 id="让我们稍微讨论一下rbac资源"><a href="#让我们稍微讨论一下rbac资源" class="header-anchor">#</a> 让我们稍微讨论一下RBAC资源</h5> <p>ClusterRole|Role 定义了一组权限及其<b>可用范围</b>，是在整个集群中 还是 仅在单个命名空间中。</p> <p>ClusterRoleBinding|RoleBinding 将一组权限与帐户连接起来，并定义<b>应用权限的位置</b>，是在整个群集中还是仅在单个命名空间中。</p> <p>因此，有 4 种不同的 RBAC 组合和 3 种有效的组合：</p> <ol><li>Role + RoleBinding（可在单个空间中使用，在单个命名空间中应用）</li> <li>ClusterRole + ClusterRoleBinding（群集范围内可用，群集范围内应用）</li> <li>ClusterRole + RoleBinding（群集范围内可用，应用于单个命名空间）</li> <li>Role + ClusterRoleBinding（<b>不可能</b>：在单个命名空间中可用，在群集范围内应用）</li></ol> <h5 id="前往解决方案"><a href="#前往解决方案" class="header-anchor">#</a> 前往解决方案</h5> <p>我们首先创建 ServiceAccount 和 Role：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k <span class="token parameter variable">-n</span> project-hamster create sa processor
serviceaccount/processor created

k <span class="token parameter variable">-n</span> project-hamster create role processor <span class="token punctuation">\</span>
  <span class="token parameter variable">--verb</span><span class="token operator">=</span>create <span class="token punctuation">\</span>
  <span class="token parameter variable">--resource</span><span class="token operator">=</span>secret <span class="token punctuation">\</span>
  <span class="token parameter variable">--resource</span><span class="token operator">=</span>configmap
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>这将创建一个角色，例如：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># kubectl -n project-hamster create role processor --verb=create --resource=secret --resource=configmap</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> processor
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>hamster
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> secrets
  <span class="token punctuation">-</span> configmaps
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> create
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>现在我们将 Role 绑定到 ServiceAccount：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-n</span> project-hamster create rolebinding processor <span class="token punctuation">\</span>
  <span class="token parameter variable">--role</span> processor <span class="token punctuation">\</span>
  <span class="token parameter variable">--serviceaccount</span> project-hamster:processor
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这将创建一个 RoleBinding，如下所示：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># kubectl -n project-hamster create rolebinding processor --role processor --serviceaccount project-hamster:processor</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> processor
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>hamster
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> processor
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> processor
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>hamster
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>想要测试我们的 RBAC 设置，我们可以使用<code>kubectl auth can-i</code>：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k <span class="token parameter variable">-n</span> project-hamster auth can-i create secret <span class="token punctuation">\</span>
  <span class="token parameter variable">--as</span> system:serviceaccount:project-hamster:processor
<span class="token function">yes</span>

➜ k <span class="token parameter variable">-n</span> project-hamster auth can-i create configmap <span class="token punctuation">\</span>
  <span class="token parameter variable">--as</span> system:serviceaccount:project-hamster:processor
<span class="token function">yes</span>

➜ k <span class="token parameter variable">-n</span> project-hamster auth can-i create pod <span class="token punctuation">\</span>
  <span class="token parameter variable">--as</span> system:serviceaccount:project-hamster:processor
no

➜ k <span class="token parameter variable">-n</span> project-hamster auth can-i delete secret <span class="token punctuation">\</span>
  <span class="token parameter variable">--as</span> system:serviceaccount:project-hamster:processor
no

➜ k <span class="token parameter variable">-n</span> project-hamster auth can-i get configmap <span class="token punctuation">\</span>
  <span class="token parameter variable">--as</span> system:serviceaccount:project-hamster:processor
no
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="考题-11-所有节点上的daemonset"><a href="#考题-11-所有节点上的daemonset" class="header-anchor">#</a> 考题-11 | 所有节点上的DaemonSet</h3> <p>任务权重：4%</p> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>将命名空间<code>project-tiger</code>用于以下目的。创建一个名为<code>ds-important</code>的 DaemonSet，其镜像为<code>httpd:2.4-alpine</code>，标签为<code>id=ds-important</code>和<code>uuid=18426a0b-5f59-4e10-923f-c0e078e82462</code>。它创建的 Pod 应该请求 10 毫核 cpu 和 10 兆字节内存。该 DaemonSet 的 Pod 应该在所有节点上运行，包括控制平面。</p> <h4 id="解答-11"><a href="#解答-11" class="header-anchor">#</a> 解答</h4> <p>到目前为止，我们还不能直接使用<code>kubectl</code>创建 DaemonSet，因此我们创建了一个 Deployment 并对其进行更改：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-n</span> project-tiger create deployment <span class="token parameter variable">--image</span><span class="token operator">=</span>httpd:2.4-alpine ds-important <span class="token variable">$do</span> <span class="token operator">&gt;</span> <span class="token number">11</span>.yaml

<span class="token function">vim</span> <span class="token number">11</span>.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后我们调整 yaml 为：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 11.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet                                     <span class="token comment"># change from Deployment to Daemonset</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>                                           <span class="token comment"># add</span>
    <span class="token key atrule">id</span><span class="token punctuation">:</span> ds<span class="token punctuation">-</span>important                                <span class="token comment"># add</span>
    <span class="token key atrule">uuid</span><span class="token punctuation">:</span> 18426a0b<span class="token punctuation">-</span>5f59<span class="token punctuation">-</span>4e10<span class="token punctuation">-</span>923f<span class="token punctuation">-</span>c0e078e82462      <span class="token comment"># add</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ds<span class="token punctuation">-</span>important
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>tiger                          <span class="token comment"># important</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment">#replicas: 1                                      # remove</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">id</span><span class="token punctuation">:</span> ds<span class="token punctuation">-</span>important                              <span class="token comment"># add</span>
      <span class="token key atrule">uuid</span><span class="token punctuation">:</span> 18426a0b<span class="token punctuation">-</span>5f59<span class="token punctuation">-</span>4e10<span class="token punctuation">-</span>923f<span class="token punctuation">-</span>c0e078e82462    <span class="token comment"># add</span>
  <span class="token comment">#strategy: {}                                     # remove</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">id</span><span class="token punctuation">:</span> ds<span class="token punctuation">-</span>important                            <span class="token comment"># add</span>
        <span class="token key atrule">uuid</span><span class="token punctuation">:</span> 18426a0b<span class="token punctuation">-</span>5f59<span class="token punctuation">-</span>4e10<span class="token punctuation">-</span>923f<span class="token punctuation">-</span>c0e078e82462  <span class="token comment"># add</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> httpd<span class="token punctuation">:</span>2.4<span class="token punctuation">-</span>alpine
        <span class="token key atrule">name</span><span class="token punctuation">:</span> ds<span class="token punctuation">-</span>important
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>                                 <span class="token comment"># add</span>
            <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 10m                                <span class="token comment"># add</span>
            <span class="token key atrule">memory</span><span class="token punctuation">:</span> 10Mi                            <span class="token comment"># add</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>                                  <span class="token comment"># add</span>
      <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule                          <span class="token comment"># add</span>
        <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/control<span class="token punctuation">-</span>plane  <span class="token comment"># add</span>
<span class="token comment">#status: {}                                         # remove</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>要求 DaemonSet 在所有节点上运行，因此我们需要为此指定容忍度。</p> <p>让我们确认一下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-f</span> <span class="token number">11</span>.yaml create

➜ k <span class="token parameter variable">-n</span> project-tiger get ds
NAME           DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
ds-important   <span class="token number">3</span>         <span class="token number">3</span>         <span class="token number">3</span>       <span class="token number">3</span>            <span class="token number">3</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          8s

➜ k <span class="token parameter variable">-n</span> project-tiger get pod <span class="token parameter variable">-l</span> <span class="token assign-left variable">id</span><span class="token operator">=</span>ds-important <span class="token parameter variable">-o</span> wide
NAME                      READY   STATUS          NODE
ds-important-6pvgm        <span class="token number">1</span>/1     Running   <span class="token punctuation">..</span>.   cluster1-node1
ds-important-lh5ts        <span class="token number">1</span>/1     Running   <span class="token punctuation">..</span>.   cluster1-controlplane1
ds-important-qhjcq        <span class="token number">1</span>/1     Running   <span class="token punctuation">..</span>.   cluster1-node2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="考题-12-所有节点上的deployment"><a href="#考题-12-所有节点上的deployment" class="header-anchor">#</a> 考题-12 | 所有节点上的Deployment</h3> <p>任务权重：6%</p> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>将命名空间<code>project-tiger</code>用于以下目的。创建一个名为<code>deploy-important</code>的 Deployment，标签为<code>id=very-important</code>（<code>Pods</code>也应该有这个标签）和 3 个副本。它应该包含两个容器，第一个名为<code>container1</code>，镜像为<code>nginx:1.17.6-alpine</code>，第二个名为<code>container2</code>，镜像为<code>kubernetes/pause</code>。</p> <p>该 Deployment 的单个 Pod 应该只在一个工作节点上运行。我们有两个工作节点：<code>cluster1-node1</code>和<code>cluster1-node2</code>。因为 Deployment 有三个副本，所以结果应该是在两个节点上都运行着一个 Pod。除非添加新的工作节点，否则不会调度第三个 Pod。</p> <p>在某种程度上，我们在这里模拟了 <b>DaemonSet</b> 的行为，但使用了 <b>Deployment</b> 和固定数量的副本。</p> <h4 id="解答-12"><a href="#解答-12" class="header-anchor">#</a> 解答</h4> <p>有两种可能的方法，一种使用<code>podAntiAffinity</code>，另一种使用<code>topologySpreadConstraint</code>。</p> <h5 id="podantiaffinity"><a href="#podantiaffinity" class="header-anchor">#</a> PodAntiAffinity</h5> <p>这里的想法是，我们创建了一个 “Pod 之间的反亲和性” ，它允许我们让一个 Pod 应该只调度在一个节点上，而另一个特定标签（这里是同一个标签）的 Pod 还没有运行。</p> <p>让我们从创建 Deployment 模板开始开始：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-n</span> project-tiger create deployment <span class="token punctuation">\</span>
  <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx:1.17.6-alpine deploy-important <span class="token variable">$do</span> <span class="token operator">&gt;</span> <span class="token number">12</span>.yaml

<span class="token function">vim</span> <span class="token number">12</span>.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 12.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">id</span><span class="token punctuation">:</span> very<span class="token punctuation">-</span>important                  <span class="token comment"># change</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>important
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>tiger              <span class="token comment"># important</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>                           <span class="token comment"># change</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">id</span><span class="token punctuation">:</span> very<span class="token punctuation">-</span>important                <span class="token comment"># change</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">id</span><span class="token punctuation">:</span> very<span class="token punctuation">-</span>important              <span class="token comment"># change</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.6<span class="token punctuation">-</span>alpine
        <span class="token key atrule">name</span><span class="token punctuation">:</span> container1                <span class="token comment"># change</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> kubernetes/pause         <span class="token comment"># add</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> container2                <span class="token comment"># add</span>
      <span class="token key atrule">affinity</span><span class="token punctuation">:</span>                                             <span class="token comment"># add</span>
        <span class="token key atrule">podAntiAffinity</span><span class="token punctuation">:</span>                                    <span class="token comment"># add</span>
          <span class="token key atrule">requiredDuringSchedulingIgnoredDuringExecution</span><span class="token punctuation">:</span>   <span class="token comment"># add</span>
          <span class="token punctuation">-</span> <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>                                  <span class="token comment"># add</span>
              <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>                             <span class="token comment"># add</span>
              <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> id                                     <span class="token comment"># add</span>
                <span class="token key atrule">operator</span><span class="token punctuation">:</span> In                                <span class="token comment"># add</span>
                <span class="token key atrule">values</span><span class="token punctuation">:</span>                                     <span class="token comment"># add</span>
                <span class="token punctuation">-</span> very<span class="token punctuation">-</span>important                            <span class="token comment"># add</span>
            <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname             <span class="token comment"># add</span>
<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>指定一个 topologyKey，这是一个预填充的 Kubernetes 标签，你可以通过描述节点来找到它。</p> <h5 id="topologyspreadconstraints"><a href="#topologyspreadconstraints" class="header-anchor">#</a> TopologySpreadConstraints</h5> <p>我们可以用<code>topologySpreadConstraints</code>实现同样的目标。最好同时尝试一下两者。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 12.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">id</span><span class="token punctuation">:</span> very<span class="token punctuation">-</span>important                  <span class="token comment"># change</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>important
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>tiger              <span class="token comment"># important</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>                           <span class="token comment"># change</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">id</span><span class="token punctuation">:</span> very<span class="token punctuation">-</span>important                <span class="token comment"># change</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">id</span><span class="token punctuation">:</span> very<span class="token punctuation">-</span>important              <span class="token comment"># change</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.6<span class="token punctuation">-</span>alpine
        <span class="token key atrule">name</span><span class="token punctuation">:</span> container1                <span class="token comment"># change</span>
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> kubernetes/pause         <span class="token comment"># add</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> container2                <span class="token comment"># add</span>
      <span class="token key atrule">topologySpreadConstraints</span><span class="token punctuation">:</span>                 <span class="token comment"># add</span>
      <span class="token punctuation">-</span> <span class="token key atrule">maxSkew</span><span class="token punctuation">:</span> <span class="token number">1</span>                               <span class="token comment"># add</span>
        <span class="token key atrule">topologyKey</span><span class="token punctuation">:</span> kubernetes.io/hostname      <span class="token comment"># add</span>
        <span class="token key atrule">whenUnsatisfiable</span><span class="token punctuation">:</span> DoNotSchedule         <span class="token comment"># add</span>
        <span class="token key atrule">labelSelector</span><span class="token punctuation">:</span>                           <span class="token comment"># add</span>
          <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>                           <span class="token comment"># add</span>
            <span class="token key atrule">id</span><span class="token punctuation">:</span> very<span class="token punctuation">-</span>important                   <span class="token comment"># add</span>
<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h5 id="应用并运行"><a href="#应用并运行" class="header-anchor">#</a> 应用并运行</h5> <p>让我们运行它，然后我们检查 Deployment 状态，其中显示 2/3 就绪计数：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-f</span> <span class="token number">12</span>.yaml create

➜ k <span class="token parameter variable">-n</span> project-tiger get deploy <span class="token parameter variable">-l</span> <span class="token assign-left variable">id</span><span class="token operator">=</span>very-important
NAME               READY   UP-TO-DATE   AVAILABLE   AGE
deploy-important   <span class="token number">2</span>/3     <span class="token number">3</span>            <span class="token number">2</span>           2m35s

➜ k <span class="token parameter variable">-n</span> project-tiger get pod <span class="token parameter variable">-o</span> wide <span class="token parameter variable">-l</span> <span class="token assign-left variable">id</span><span class="token operator">=</span>very-important
NAME                                READY   STATUS    <span class="token punctuation">..</span>.   NODE             
deploy-important-58db9db6fc-9ljpw   <span class="token number">2</span>/2     Running   <span class="token punctuation">..</span>.   cluster1-node1
deploy-important-58db9db6fc-lnxdb   <span class="token number">0</span>/2     Pending   <span class="token punctuation">..</span>.   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          
deploy-important-58db9db6fc-p2rz8   <span class="token number">2</span>/2     Running   <span class="token punctuation">..</span>.   cluster1-node2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>如果我们 kubectl 描述 Pod <code>deploy-important-58db9db6fc-lnxdb</code>，它将向我们展示不调度的原因是我们实现的<code>podAntiAffinity</code>规则：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Warning  FailedScheduling  63s (x3 over 65s)  default-scheduler  0/3 nodes are available: 1 node(s) had taint {node-role.kubernetes.io/control-plane: }, that the pod didn't tolerate, 2 node(s) didn't match pod affinity/anti-affinity, 2 node(s) didn't satisfy existing pods anti-affinity rules.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或者我们的拓扑约束：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>Warning  FailedScheduling  16s   default-scheduler  0/3 nodes are available: 1 node(s) had taint {node-role.kubernetes.io/control-plane: }, that the pod didn't tolerate, 2 node(s) didn't match pod topology spread constraints.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="考题-13-多容器-pod-共享卷"><a href="#考题-13-多容器-pod-共享卷" class="header-anchor">#</a> 考题-13 | 多容器 Pod 共享卷</h3> <p>任务权重：4%</p> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>在命名空间<code>default</code>中创建一个名为<code>multi-container-playground</code>的 Pod，其中包含三个容器，分别名为<code>c1</code>、<code>c2</code>和<code>c3</code>。应该有一个卷附加到该 Pod 并挂载到每个容器中，但该卷不应持久化或与其他 Pod 共享。</p> <p>容器<code>c1</code>的镜像应为<code>nginx:1.17.6-alpine</code>，并且运行该 Pod 的节点名称可作为环境变量<code>MY_NODE_NAME</code>。</p> <p>容器<code>c2</code>的镜像应为<code>busybox:1.31.1</code>，并且每秒将<code>date</code>命令的输出写入共享卷中的<code>date.log</code>文件。您可以使用<code>while true; do date &gt;&gt; /your/vol/path/date.log; sleep 1; done</code>来完成。</p> <p>容器<code>c3</code>的镜像应为<code>busybox:1.31.1</code>，并不断将文件<code>date.log</code>的内容从共享卷发送到标准输出。为此，您可以使用<code>tail -f /your/vol/path/date.log</code>来完成。</p> <p>检查容器<code>c3</code>的日志以确认设置正确。</p> <h4 id="解答-13"><a href="#解答-13" class="header-anchor">#</a> 解答</h4> <p>首先我们创建 Pod 模板：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k run multi-container-playground <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx:1.17.6-alpine <span class="token variable">$do</span> <span class="token operator">&gt;</span> <span class="token number">13</span>.yaml

<span class="token function">vim</span> <span class="token number">13</span>.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 13.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> multi<span class="token punctuation">-</span>container<span class="token punctuation">-</span>playground
  <span class="token key atrule">name</span><span class="token punctuation">:</span> multi<span class="token punctuation">-</span>container<span class="token punctuation">-</span>playground
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.6<span class="token punctuation">-</span>alpine
    <span class="token key atrule">name</span><span class="token punctuation">:</span> c1                                                                      <span class="token comment"># change</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>                                                                          <span class="token comment"># add</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MY_NODE_NAME                                                          <span class="token comment"># add</span>
      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                                                                  <span class="token comment"># add</span>
        <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>                                                                 <span class="token comment"># add</span>
          <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> spec.nodeName                                                <span class="token comment"># add</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>                                                                 <span class="token comment"># add</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> vol                                                                   <span class="token comment"># add</span>
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /vol                                                             <span class="token comment"># add</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>1.31.1                                                         <span class="token comment"># add</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> c2                                                                      <span class="token comment"># add</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;sh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;while true; do date &gt;&gt; /vol/date.log; sleep 1; done&quot;</span><span class="token punctuation">]</span>  <span class="token comment"># add</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>                                                                 <span class="token comment"># add</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> vol                                                                   <span class="token comment"># add</span>
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /vol                                                             <span class="token comment"># add</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>1.31.1                                                         <span class="token comment"># add</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> c3                                                                      <span class="token comment"># add</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;sh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;tail -f /vol/date.log&quot;</span><span class="token punctuation">]</span>                                <span class="token comment"># add</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>                                                                 <span class="token comment"># add</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> vol                                                                   <span class="token comment"># add</span>
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /vol                                                             <span class="token comment"># add</span>
  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>                                                                        <span class="token comment"># add</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> vol                                                                   <span class="token comment"># add</span>
      <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>                                                                <span class="token comment"># add</span>
<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>哦，天哪，很多要求的东西。我们检查 Pod 是否一切正常：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-f</span> <span class="token number">13</span>.yaml create

➜ k get pod multi-container-playground
NAME                         READY   STATUS    RESTARTS   AGE
multi-container-playground   <span class="token number">3</span>/3     Running   <span class="token number">0</span>          95s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>很好，然后我们检查容器 c1 是否将请求的节点名称作为 env 变量：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k <span class="token builtin class-name">exec</span> multi-container-playground <span class="token parameter variable">-c</span> c1 -- <span class="token function">env</span> <span class="token operator">|</span> <span class="token function">grep</span> MY
<span class="token assign-left variable">MY_NODE_NAME</span><span class="token operator">=</span>cluster1-node2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>最后，我们检查日志：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k logs multi-container-playground <span class="token parameter variable">-c</span> c3
Sat Dec  <span class="token number">7</span> <span class="token number">16</span>:05:10 UTC <span class="token number">2077</span>
Sat Dec  <span class="token number">7</span> <span class="token number">16</span>:05:11 UTC <span class="token number">2077</span>
Sat Dec  <span class="token number">7</span> <span class="token number">16</span>:05:12 UTC <span class="token number">2077</span>
Sat Dec  <span class="token number">7</span> <span class="token number">16</span>:05:13 UTC <span class="token number">2077</span>
Sat Dec  <span class="token number">7</span> <span class="token number">16</span>:05:14 UTC <span class="token number">2077</span>
Sat Dec  <span class="token number">7</span> <span class="token number">16</span>:05:15 UTC <span class="token number">2077</span>
Sat Dec  <span class="token number">7</span> <span class="token number">16</span>:05:16 UTC <span class="token number">2077</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="考题-14-了解群集信息"><a href="#考题-14-了解群集信息" class="header-anchor">#</a> 考题-14 | 了解群集信息</h3> <p>任务权重：2%</p> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>系统会要求您了解有关集群<code>k8s-c1-H</code>的以下信息：</p> <ol><li>有多少控制平面节点可用？</li> <li>有多少工作节点可用？</li> <li>服务的 CIDR（网段）是多少？</li> <li>配置了哪个网络（或 CNI 插件），其配置文件在哪里？</li> <li>在 cluster1-node1 上运行的静态 pod 会有哪个后缀？</li></ol> <p>将答案写入文件<code>/opt/course/14/cluster-info</code>，结构如下：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/14/cluster-info</span>
<span class="token number">1</span>: <span class="token punctuation">[</span>ANSWER<span class="token punctuation">]</span>
<span class="token number">2</span>: <span class="token punctuation">[</span>ANSWER<span class="token punctuation">]</span>
<span class="token number">3</span>: <span class="token punctuation">[</span>ANSWER<span class="token punctuation">]</span>
<span class="token number">4</span>: <span class="token punctuation">[</span>ANSWER<span class="token punctuation">]</span>
<span class="token number">5</span>: <span class="token punctuation">[</span>ANSWER<span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h4 id="解答-14"><a href="#解答-14" class="header-anchor">#</a> 解答</h4> <h5 id="有多少控制平面和工作节点可用"><a href="#有多少控制平面和工作节点可用" class="header-anchor">#</a> 有多少控制平面和工作节点可用？</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get <span class="token function">node</span>
NAME                    STATUS   ROLES          AGE   VERSION
cluster1-controlplane1  Ready    control-plane  27h   v1.26.0
cluster1-node1          Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>         27h   v1.26.0
cluster1-node2          Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>         27h   v1.26.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>我们看到一个控制平面和两个 worker。</p> <h5 id="服务的-cidr-网段-是多少"><a href="#服务的-cidr-网段-是多少" class="header-anchor">#</a> 服务的 CIDR（网段）是多少？</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster1-controlplane1

➜ root@cluster1-controlplane1:~<span class="token comment"># cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep range</span>
    - --service-cluster-ip-range<span class="token operator">=</span><span class="token number">10.96</span>.0.0/12
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="配置了哪个网络-或-cni-插件-其配置文件在哪里"><a href="#配置了哪个网络-或-cni-插件-其配置文件在哪里" class="header-anchor">#</a> 配置了哪个网络（或 CNI 插件），其配置文件在哪里？</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster1-controlplane1:~<span class="token comment"># find /etc/cni/net.d/</span>
/etc/cni/net.d/
/etc/cni/net.d/10-weave.conflist

➜ root@cluster1-controlplane1:~<span class="token comment"># cat /etc/cni/net.d/10-weave.conflist</span>
<span class="token punctuation">{</span>
    <span class="token string">&quot;cniVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;0.3.0&quot;</span>,
    <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;weave&quot;</span>,
<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>默认情况下，kubelet 会检测<code>/etc/cni/net.d</code>以发现 CNI 插件。这在每个控制平面和工作器节点上都是相同的。</p> <h5 id="在-cluster1-node1-上运行的静态-pod-会有哪个后缀"><a href="#在-cluster1-node1-上运行的静态-pod-会有哪个后缀" class="header-anchor">#</a> 在 cluster1-node1 上运行的静态 pod 会有哪个后缀？</h5> <p>后缀是带有前导连字符的节点主机名。在早期的 Kubernetes 版本中，它曾经是<code>-static</code>。</p> <h5 id="结果"><a href="#结果" class="header-anchor">#</a> 结果</h5> <p>生成的<code>/opt/course/14/cluster-info</code>可能如下所示：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/14/cluster-info</span>

<span class="token comment"># How many controlplane nodes are available?</span>
<span class="token number">1</span>: <span class="token number">1</span>

<span class="token comment"># How many worker nodes are available?</span>
<span class="token number">2</span>: <span class="token number">2</span>

<span class="token comment"># What is the Service CIDR?</span>
<span class="token number">3</span>: <span class="token number">10.96</span>.0.0/12

<span class="token comment"># Which Networking (or CNI Plugin) is configured and where is its config file?</span>
<span class="token number">4</span>: Weave, /etc/cni/net.d/10-weave.conflist

<span class="token comment"># Which suffix will static pods have that run on cluster1-node1?</span>
<span class="token number">5</span>: -cluster1-node1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="考题-15-群集事件日志记录"><a href="#考题-15-群集事件日志记录" class="header-anchor">#</a> 考题-15 | 群集事件日志记录</h3> <p>任务权重：3%</p> <p>切换集群：<code>kubectl config use-context k8s-c2-AC</code></p> <p>在<code>/opt/course/15/cluster_events.sh</code>中写入一个命令，该命令显示整个集群中按时间排序的最新事件 （<code>metadata.creationTimestamp</code>）。使用<code>kubectl</code>来获取它。</p> <p>现在终止在节点 cluster2-node1 上运行的 Pod <code>kube-proxy</code>，并将这导致的事件写入<code>/opt/course/15/pod_kill.log</code>。</p> <p>最后，在节点 cluster2-node1 上杀死 Pod <code>kube-proxy</code>的 containerd 容器，并将事件写入<code>/opt/course/15/container_kill.log</code>。</p> <p>你是否注意到这两种行为引起的事件的不同之处？</p> <h4 id="解答-15"><a href="#解答-15" class="header-anchor">#</a> 解答</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/15/cluster_events.sh</span>
kubectl get events <span class="token parameter variable">-A</span> --sort-by<span class="token operator">=</span>.metadata.creationTimestamp
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>现在我们杀死 kube-proxy Pod：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-n</span> kube-system get pod <span class="token parameter variable">-o</span> wide <span class="token operator">|</span> <span class="token function">grep</span> proxy <span class="token comment"># find pod running on cluster2-node1</span>

k <span class="token parameter variable">-n</span> kube-system delete pod kube-proxy-z64cg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在检查事件：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sh</span> /opt/course/15/cluster_events.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>将停止引起的事件写入<code>/opt/course/15/pod_kill.log</code>：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/15/pod_kill.log</span>
kube-system   9s          Normal    Killing           pod/kube-proxy-jsv7t   <span class="token punctuation">..</span>.
kube-system   3s          Normal    SuccessfulCreate  daemonset/kube-proxy   <span class="token punctuation">..</span>.
kube-system   <span class="token operator">&lt;</span>unknown<span class="token operator">&gt;</span>   Normal    Scheduled         pod/kube-proxy-m52sx   <span class="token punctuation">..</span>.
default       2s          Normal    Starting          node/cluster2-node1  <span class="token punctuation">..</span>.
kube-system   2s          Normal    Created           pod/kube-proxy-m52sx   <span class="token punctuation">..</span>.
kube-system   2s          Normal    Pulled            pod/kube-proxy-m52sx   <span class="token punctuation">..</span>.
kube-system   2s          Normal    Started           pod/kube-proxy-m52sx   <span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>最后，我们将尝试通过杀死属于 kube-proxy Pod 的容器来引发事件：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster2-node1

➜ root@cluster2-node1:~<span class="token comment"># crictl ps | grep kube-proxy</span>
1e020b43c4423   36c4ebbc9d979   About an hour ago   Running   kube-proxy     <span class="token punctuation">..</span>.

➜ root@cluster2-node1:~<span class="token comment"># crictl rm 1e020b43c4423</span>
1e020b43c4423

➜ root@cluster2-node1:~<span class="token comment"># crictl ps | grep kube-proxy</span>
0ae4245707910   36c4ebbc9d979   <span class="token number">17</span> seconds ago      Running   kube-proxy     <span class="token punctuation">..</span>.     
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>我们终止了主容器（1e020b43c4423），但也注意到直接创建了一个新容器（0ae4245707910）。谢谢 Kubernetes！</p> <p>现在我们看看这是否再次引起了事件，并将其写入第二个文件：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">sh</span> /opt/course/15/cluster_events.sh
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/15/container_kill.log</span>
kube-system   13s         Normal    Created      pod/kube-proxy-m52sx    <span class="token punctuation">..</span>.
kube-system   13s         Normal    Pulled       pod/kube-proxy-m52sx    <span class="token punctuation">..</span>.
kube-system   13s         Normal    Started      pod/kube-proxy-m52sx    <span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>比较这些事件，我们看到，当我们删除整个 Pod 时，有更多的事情要做，因此有更多的事件。例如，游戏中的 DaemonSet 用于重新创建丢失的 Pod。当我们手动杀死 Pod 的主容器时，Pod 仍然存在，但只需要重新创建它的容器，因此事件更少。</p> <h3 id="考题-16-命名空间和api资源"><a href="#考题-16-命名空间和api资源" class="header-anchor">#</a> 考题-16 | 命名空间和API资源</h3> <p>任务权重：2%</p> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>将所有命名空间的 Kubernetes 资源（如 Pod、Secret、ConfigMap 等）的名称写入<code>/opt/course/16/resources.txt</code>。</p> <p>找到定义了最多 Role 数量的<code>project-*</code>命名空间，并将其名称和角色数量写入<code>/opt/course/16/crowded-namespace.txt</code>。</p> <h4 id="解答-16"><a href="#解答-16" class="header-anchor">#</a> 解答</h4> <h5 id="命名空间和资源"><a href="#命名空间和资源" class="header-anchor">#</a> 命名空间和资源</h5> <p>现在我们可以得到所有资源的列表，如：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k api-resources    <span class="token comment"># shows all</span>

k api-resources <span class="token parameter variable">-h</span> <span class="token comment"># help always good</span>

k api-resources <span class="token parameter variable">--namespaced</span> <span class="token parameter variable">-o</span> name <span class="token operator">&gt;</span> /opt/course/16/resources.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这将导致文件：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/16/resources.txt</span>
bindings
configmaps
endpoints
events
limitranges
persistentvolumeclaims
pods
podtemplates
replicationcontrollers
resourcequotas
secrets
serviceaccounts
services
controllerrevisions.apps
daemonsets.apps
deployments.apps
replicasets.apps
statefulsets.apps
localsubjectaccessreviews.authorization.k8s.io
horizontalpodautoscalers.autoscaling
cronjobs.batch
jobs.batch
leases.coordination.k8s.io
events.events.k8s.io
ingresses.extensions
ingresses.networking.k8s.io
networkpolicies.networking.k8s.io
poddisruptionbudgets.policy
rolebindings.rbac.authorization.k8s.io
roles.rbac.authorization.k8s.io
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h5 id="最多role的命名空间"><a href="#最多role的命名空间" class="header-anchor">#</a> 最多Role的命名空间</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k <span class="token parameter variable">-n</span> project-c13 get role --no-headers <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span>
No resources found <span class="token keyword">in</span> project-c13 namespace.
<span class="token number">0</span>

➜ k <span class="token parameter variable">-n</span> project-c14 get role --no-headers <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span>
<span class="token number">300</span>

➜ k <span class="token parameter variable">-n</span> project-hamster get role --no-headers <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span>
No resources found <span class="token keyword">in</span> project-hamster namespace.
<span class="token number">0</span>

➜ k <span class="token parameter variable">-n</span> project-snake get role --no-headers <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span>
No resources found <span class="token keyword">in</span> project-snake namespace.
<span class="token number">0</span>

➜ k <span class="token parameter variable">-n</span> project-tiger get role --no-headers <span class="token operator">|</span> <span class="token function">wc</span> <span class="token parameter variable">-l</span>
No resources found <span class="token keyword">in</span> project-tiger namespace.
<span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>最后，我们将名称和数量写入文件：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/16/crowded-namespace.txt</span>
project-c14 with <span class="token number">300</span> resources
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="考题-17-找到pod的容器并检查信息"><a href="#考题-17-找到pod的容器并检查信息" class="header-anchor">#</a> 考题-17 | 找到Pod的容器并检查信息</h3> <p>任务权重：3%</p> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>在命名空间<code>project-tiger</code>中，创建一个名为<code>tigers-reunite</code>的 Pod，其镜像为<code>httpd:2.4.41-alpine</code>，标签为<code>pod=container</code>和<code>container=pod</code>。找出 Pod 被调度在哪个节点上。通过 SSH 连接到该节点并找到属于该 Pod 的 containerd 容器。</p> <p>使用命令<code>crictl</code>：</p> <ol><li>将容器的 ID 和<code>info.runtimeType</code>写入<code>/opt/course/17/pod-container.txt</code></li> <li>将容器的日志写入<code>/opt/course/17/pod-container.log</code></li></ol> <h4 id="解答-17"><a href="#解答-17" class="header-anchor">#</a> 解答</h4> <p>首先，我们创建 Pod：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-n</span> project-tiger run tigers-reunite <span class="token punctuation">\</span>
  <span class="token parameter variable">--image</span><span class="token operator">=</span>httpd:2.4.41-alpine <span class="token punctuation">\</span>
  <span class="token parameter variable">--labels</span> <span class="token string">&quot;pod=container,container=pod&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>接下来，我们找出它被调度的节点：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-n</span> project-tiger get pod <span class="token parameter variable">-o</span> wide

<span class="token comment"># or fancy:</span>
k <span class="token parameter variable">-n</span> project-tiger get pod tigers-reunite <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&quot;{.spec.nodeName}&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后我们通过 ssh 连接该节点并检查容器信息：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster1-node2

➜ root@cluster1-node2:~<span class="token comment"># crictl ps | grep tigers-reunite</span>
b01edbe6f89ed    54b0995a63052    <span class="token number">5</span> seconds ago    Running        tigers-reunite <span class="token punctuation">..</span>.

➜ root@cluster1-node2:~<span class="token comment"># crictl inspect b01edbe6f89ed | grep runtimeType</span>
    <span class="token string">&quot;runtimeType&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;io.containerd.runc.v2&quot;</span>,
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>然后我们填写请求的文件（在主终端上）：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/17/pod-container.txt</span>
b01edbe6f89ed io.containerd.runc.v2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>最后，我们在第二个文件中写入容器日志：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">ssh</span> cluster1-node2 <span class="token string">'crictl logs b01edbe6f89ed'</span> <span class="token operator">&amp;&gt;</span> /opt/course/17/pod-container.log
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>上述命令中的<code>&amp;&gt;</code>会重定向标准输出和标准错误。</p> <p>您也可以简单地在节点上运行<code>crictl logs</code>并手动复制内容（如果不是很多的话）。该文件应如下所示：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/17/pod-container.log</span>
AH00558: httpd: Could not reliably determine the server<span class="token string">'s fully qualified domain name, using 10.44.0.37. Set the '</span>ServerName<span class="token string">' directive globally to suppress this message
AH00558: httpd: Could not reliably determine the server'</span>s fully qualified domain name, using <span class="token number">10.44</span>.0.37. Set the <span class="token string">'ServerName'</span> directive globally to suppress this message
<span class="token punctuation">[</span>Mon Sep <span class="token number">13</span> <span class="token number">13</span>:32:18.555280 <span class="token number">2021</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>mpm_event:notice<span class="token punctuation">]</span> <span class="token punctuation">[</span>pid <span class="token number">1</span>:tid <span class="token number">139929534545224</span><span class="token punctuation">]</span> AH00489: Apache/2.4.41 <span class="token punctuation">(</span>Unix<span class="token punctuation">)</span> configured -- resuming normal operations
<span class="token punctuation">[</span>Mon Sep <span class="token number">13</span> <span class="token number">13</span>:32:18.555610 <span class="token number">2021</span><span class="token punctuation">]</span> <span class="token punctuation">[</span>core:notice<span class="token punctuation">]</span> <span class="token punctuation">[</span>pid <span class="token number">1</span>:tid <span class="token number">139929534545224</span><span class="token punctuation">]</span> AH00094: Command line: <span class="token string">'httpd -D FOREGROUND'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="考题-18-修复kubelet"><a href="#考题-18-修复kubelet" class="header-anchor">#</a> 考题-18 | 修复Kubelet</h3> <p>任务权重：8%</p> <p>切换集群：<code>kubectl config use-context k8s-c3-CCC</code></p> <p>kubelet 似乎存在问题，无法在<code>cluster3-node1</code>上运行。修复它，然后确认群集的节点<code>cluster3-node1</code>处于 “Ready” 状态。之后，您应该能够在<code>cluster3-node1</code>上调度一个 Pod。</p> <p>将问题的原因写入<code>/opt/course/18/reason.txt</code>。</p> <h4 id="解答-18"><a href="#解答-18" class="header-anchor">#</a> 解答</h4> <p>像这样的任务的过程应该是检查 kubelet 是否正在运行，如果没有则启动它，然后检查它的日志并纠正错误（如果有的话）。</p> <p>检查其他集群是否已经定义并运行了某些组件总是很有帮助的，这样您就可以复制和使用现有的配置文件。但在这种情况下，它可能不需要是必要的。</p> <p>检查节点状态：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get <span class="token function">node</span>
NAME                     STATUS     ROLES           AGE   VERSION
cluster3-controlplane1   Ready      control-plane   14d   v1.26.0
cluster3-node1           NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          14d   v1.26.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>首先，我们检查 kubelet 是否正在运行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster3-node1

➜ root@cluster3-node1:~<span class="token comment"># ps aux | grep kubelet</span>
root     <span class="token number">29294</span>  <span class="token number">0.0</span>  <span class="token number">0.2</span>  <span class="token number">14856</span>  <span class="token number">1016</span> pts/0    S+   <span class="token number">11</span>:30   <span class="token number">0</span>:00 <span class="token function">grep</span> <span class="token parameter variable">--color</span><span class="token operator">=</span>auto kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>没有，所以我们检查它是否使用 systemd 作为服务配置：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster3-node1:~<span class="token comment"># service kubelet status</span>
● kubelet.service - kubelet: The Kubernetes Node Agent
   Loaded: loaded <span class="token punctuation">(</span>/lib/systemd/system/kubelet.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
  Drop-In: /etc/systemd/system/kubelet.service.d
           └─10-kubeadm.conf
   Active: inactive <span class="token punctuation">(</span>dead<span class="token punctuation">)</span> since Sun <span class="token number">2019</span>-12-08 <span class="token number">11</span>:30:06 UTC<span class="token punctuation">;</span> 50min 52s ago
<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>是的，它在<code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code>中被配置为服务，但我们看到它处于非活动状态。让我们试着开始它：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster3-node1:~<span class="token comment"># service kubelet start</span>

➜ root@cluster3-node1:~<span class="token comment"># service kubelet status</span>
● kubelet.service - kubelet: The Kubernetes Node Agent
   Loaded: loaded <span class="token punctuation">(</span>/lib/systemd/system/kubelet.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
  Drop-In: /etc/systemd/system/kubelet.service.d
           └─10-kubeadm.conf
   Active: activating <span class="token punctuation">(</span>auto-restart<span class="token punctuation">)</span> <span class="token punctuation">(</span>Result: exit-code<span class="token punctuation">)</span> since Thu <span class="token number">2020</span>-04-30 <span class="token number">22</span>:03:10 UTC<span class="token punctuation">;</span> 3s ago
     Docs: https://kubernetes.io/docs/home/
  Process: <span class="token number">5989</span> <span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/local/bin/kubelet <span class="token variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="token variable">$KUBELET_CONFIG_ARGS</span> <span class="token variable">$KUBELET_KUBEADM_ARGS</span> <span class="token variable">$KUBELET_EXTRA_ARGS</span> <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">203</span>/EXEC<span class="token punctuation">)</span>
 Main PID: <span class="token number">5989</span> <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">203</span>/EXEC<span class="token punctuation">)</span>

Apr <span class="token number">30</span> <span class="token number">22</span>:03:10 cluster3-node1 systemd<span class="token punctuation">[</span><span class="token number">5989</span><span class="token punctuation">]</span>: kubelet.service: Failed at step EXEC spawning /usr/local/bin/kubelet: No such <span class="token function">file</span> or directory
Apr <span class="token number">30</span> <span class="token number">22</span>:03:10 cluster3-node1 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: kubelet.service: Main process exited, <span class="token assign-left variable">code</span><span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">203</span>/EXEC
Apr <span class="token number">30</span> <span class="token number">22</span>:03:10 cluster3-node1 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: kubelet.service: Failed with result <span class="token string">'exit-code'</span><span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>我们看到它正在尝试使用其服务配置文件中定义的一些参数执行<code>/usr/local/bin/kubelet</code>。查找错误和获取更多日志的一个好方法是手动运行命令（通常也使用其参数）。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster3-node1:~<span class="token comment"># /usr/local/bin/kubelet</span>
-bash: /usr/local/bin/kubelet: No such <span class="token function">file</span> or directory

➜ root@cluster3-node1:~<span class="token comment"># whereis kubelet</span>
kubelet: /usr/bin/kubelet
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>另一种方法是查看服务的扩展日志记录，例如使用<code>journalctl -u kubelet</code>。</p> <p>好吧，我们知道了，它指定了错误的路径。更正文件<code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code>中的路径并运行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> /etc/systemd/system/kubelet.service.d/10-kubeadm.conf <span class="token comment"># fix</span>

systemctl daemon-reload <span class="token operator">&amp;&amp;</span> systemctl restart kubelet

systemctl status kubelet  <span class="token comment"># should now show running</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>此外，该节点应该可供 api 服务器使用，请给它一点时间：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get <span class="token function">node</span>
NAME                     STATUS   ROLES           AGE   VERSION
cluster3-controlplane1   Ready    control-plane   14d   v1.26.0
cluster3-node1           Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          14d   v1.26.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>最后，我们将原因写入文件：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/18/reason.txt</span>
wrong path to kubelet binary specified <span class="token keyword">in</span> <span class="token function">service</span> config
（服务配置中指定的kubelet二进制文件的路径错误）
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="考题-19-创建secret并挂载到pod"><a href="#考题-19-创建secret并挂载到pod" class="header-anchor">#</a> 考题-19 | 创建Secret并挂载到Pod</h3> <p>任务权重：3%</p> <div class="custom-block warning"><p class="custom-block-title">注意</p> <p>只有当问题 18 或 20 已成功实现并且 k8s-c3-CCC 集群具有正常运行的工作节点时，才能解决此任务</p></div> <p>切换集群：<code>kubectl config use-context k8s-c3-CCC</code></p> <p>在新的命名空间<code>secret</code>中执行以下操作。创建一个名为<code>secret-pod</code>且镜像为<code>busybox:1.31.1</code>的 pod ，它应该会持续运行一段时间。</p> <p>在<code>/opt/course/19/secret1.yaml</code>中有一个现有的 Secret，在命名空间<code>secret</code>中创建它，并以只读方式将其挂载到 Pod 的<code>/tmp/secret1</code>中。</p> <p>在命名空间<code>secret</code>中创建一个名为<code>secret2</code>的新密钥，该密钥应包含<code>user=user1</code>和<code>pass=1234</code>。这些条目应该作为环境变量<code>APP_USER</code>和<code>APP_PASS</code>在 Pod 的容器中可用。</p> <p>确认一切正常。</p> <h4 id="解答-19"><a href="#解答-19" class="header-anchor">#</a> 解答</h4> <p>首先，我们创建一个共享空间和请求的 Secrets：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k create ns secret

<span class="token function">cp</span> /opt/course/19/secret1.yaml 19_secret1.yaml

<span class="token function">vim</span> 19_secret1.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 19_secret1.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">halt</span><span class="token punctuation">:</span> IyEgL2Jpbi9zaAo<span class="token punctuation">...</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret1
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> secret           <span class="token comment"># change</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-f</span> 19_secret1.yaml create
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>接下来我们创建第二个 Secret：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-n</span> secret create secret generic secret2 --from-literal<span class="token operator">=</span>user<span class="token operator">=</span>user1 --from-literal<span class="token operator">=</span>pass<span class="token operator">=</span><span class="token number">1234</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>现在我们创建 Pod 模板：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-n</span> secret run secret-pod <span class="token parameter variable">--image</span><span class="token operator">=</span>busybox:1.31.1 <span class="token variable">$do</span> -- <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;sleep 5d&quot;</span> <span class="token operator">&gt;</span> <span class="token number">19</span>.yaml

<span class="token function">vim</span> <span class="token number">19</span>.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 19.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> secret<span class="token punctuation">-</span>pod
  <span class="token key atrule">name</span><span class="token punctuation">:</span> secret<span class="token punctuation">-</span>pod
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> secret                       <span class="token comment"># add</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> sh
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
    <span class="token punctuation">-</span> sleep 1d
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span>1.31.1
    <span class="token key atrule">name</span><span class="token punctuation">:</span> secret<span class="token punctuation">-</span>pod
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>                                  <span class="token comment"># add</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> APP_USER                      <span class="token comment"># add</span>
      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                          <span class="token comment"># add</span>
        <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>                     <span class="token comment"># add</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> secret2                   <span class="token comment"># add</span>
          <span class="token key atrule">key</span><span class="token punctuation">:</span> user                       <span class="token comment"># add</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> APP_PASS                      <span class="token comment"># add</span>
      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>                          <span class="token comment"># add</span>
        <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>                     <span class="token comment"># add</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> secret2                   <span class="token comment"># add</span>
          <span class="token key atrule">key</span><span class="token punctuation">:</span> pass                       <span class="token comment"># add</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>                         <span class="token comment"># add</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> secret1                       <span class="token comment"># add</span>
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp/secret1             <span class="token comment"># add</span>
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>                      <span class="token comment"># add</span>
  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>                                <span class="token comment"># add</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> secret1                         <span class="token comment"># add</span>
    <span class="token key atrule">secret</span><span class="token punctuation">:</span>                               <span class="token comment"># add</span>
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> secret1                 <span class="token comment"># add</span>
<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>在当前的 K8s 版本中，可能没有必要指定<code>readOnly: true</code>，因为它无论如何都是默认设置。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-f</span> <span class="token number">19</span>.yaml create
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>最后，我们来看看是否一切都是正确的：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k <span class="token parameter variable">-n</span> secret <span class="token builtin class-name">exec</span> secret-pod -- <span class="token function">env</span> <span class="token operator">|</span> <span class="token function">grep</span> APP
<span class="token assign-left variable">APP_PASS</span><span class="token operator">=</span><span class="token number">1234</span>
<span class="token assign-left variable">APP_USER</span><span class="token operator">=</span>user1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k <span class="token parameter variable">-n</span> secret <span class="token builtin class-name">exec</span> secret-pod -- <span class="token function">find</span> /tmp/secret1
/tmp/secret1
/tmp/secret1/<span class="token punctuation">..</span>data
/tmp/secret1/halt
/tmp/secret1/<span class="token punctuation">..</span>2019_12_08_12_15_39.463036797
/tmp/secret1/<span class="token punctuation">..</span>2019_12_08_12_15_39.463036797/halt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k <span class="token parameter variable">-n</span> secret <span class="token builtin class-name">exec</span> secret-pod -- <span class="token function">cat</span> /tmp/secret1/halt
<span class="token comment">#! /bin/sh</span>
<span class="token comment">### BEGIN INIT INFO</span>
<span class="token comment"># Provides:          halt</span>
<span class="token comment"># Required-Start:</span>
<span class="token comment"># Required-Stop:</span>
<span class="token comment"># Default-Start:</span>
<span class="token comment"># Default-Stop:      0</span>
<span class="token comment"># Short-Description: Execute the halt command.</span>
<span class="token comment"># Description:</span>
<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>一切都很好。</p> <h3 id="考题-20-更新kubernetes版本并加入集群"><a href="#考题-20-更新kubernetes版本并加入集群" class="header-anchor">#</a> 考题-20 | 更新Kubernetes版本并加入集群</h3> <p>任务权重：10%</p> <p>切换集群：<code>kubectl config use-context k8s-c3-CCC</code></p> <p>你的同事说节点<code>cluster3-node2</code>运行的是较旧的 Kubernetes 版本，甚至不是集群的一部分。将该节点上的 Kubernetes 更新为<code>cluster3-controlplane1</code>上运行的确切版本。然后将此节点添加到群集中。为此，请使用 kubeadm。</p> <h4 id="解答-20"><a href="#解答-20" class="header-anchor">#</a> 解答</h4> <h5 id="升级-kubernetes-到符合cluster3-controlplane1的版本。"><a href="#升级-kubernetes-到符合cluster3-controlplane1的版本。" class="header-anchor">#</a> 升级 Kubernetes 到符合<code>cluster3-controlplane1</code>的版本。</h5> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get <span class="token function">node</span>
NAME                     STATUS   ROLES           AGE   VERSION
cluster3-controlplane1   Ready    control-plane   22h   v1.26.0
cluster3-node1           Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          22h   v1.26.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>控制平面节点似乎正在运行 Kubernetes 1.26.0，并且<code>cluster3-node2</code>还不是集群的一部分。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster3-node2

➜ root@cluster3-node2:~<span class="token comment"># kubeadm version</span>
kubeadm version: <span class="token operator">&amp;</span>version.Info<span class="token punctuation">{</span>Major:<span class="token string">&quot;1&quot;</span>, Minor:<span class="token string">&quot;26&quot;</span>, GitVersion:<span class="token string">&quot;v1.26.0&quot;</span>, GitCommit:<span class="token string">&quot;b46a3f887ca979b1a5d14fd39cb1af43e7e5d12d&quot;</span>, GitTreeState:<span class="token string">&quot;clean&quot;</span>, BuildDate:<span class="token string">&quot;2022-12-08T19:57:06Z&quot;</span>, GoVersion:<span class="token string">&quot;go1.19.4&quot;</span>, Compiler:<span class="token string">&quot;gc&quot;</span>, Platform:<span class="token string">&quot;linux/amd64&quot;</span><span class="token punctuation">}</span>

➜ root@cluster3-node2:~<span class="token comment"># kubectl version --short</span>
Client Version: v1.25.5
Kustomize Version: v4.5.7

➜ root@cluster3-node2:~<span class="token comment"># kubelet --version</span>
Kubernetes v1.25.5
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这里的 kubeadm 已经安装了预期的版本，所以我们不需要安装它。因此我们可以运行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster3-node2:~<span class="token comment"># kubeadm upgrade node</span>
couldn't create a Kubernetes client from <span class="token function">file</span> <span class="token string">&quot;/etc/kubernetes/kubelet.conf&quot;</span><span class="token builtin class-name">:</span> failed to load admin kubeconfig: <span class="token function">open</span> /etc/kubernetes/kubelet.conf: no such <span class="token function">file</span> or directory
To see the stack trace of this error execute with <span class="token parameter variable">--v</span><span class="token operator">=</span><span class="token number">5</span> or higher
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>这通常是升级节点的正确命令。但是这个错误意味着这个节点甚至从未被初始化过，所以这里没有什么要更新的。稍后将使用<code>kubeadm join</code>完成此操作。现在我们可以继续使用 kubelet 和 kubectl：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster3-node2:~<span class="token comment"># apt update</span>
<span class="token punctuation">..</span>.
Fetched <span class="token number">5,775</span> kB <span class="token keyword">in</span> 2s <span class="token punctuation">(</span><span class="token number">2,313</span> kB/s<span class="token punctuation">)</span>                               
Reading package lists<span class="token punctuation">..</span>. Done
Building dependency tree       
Reading state information<span class="token punctuation">..</span>. Done
<span class="token number">90</span> packages can be upgraded. Run <span class="token string">'apt list --upgradable'</span> to see them.

➜ root@cluster3-node2:~<span class="token comment"># apt show kubectl -a | grep 1.26</span>
Version: <span class="token number">1.26</span>.0-00

➜ root@cluster3-node2:~<span class="token comment"># apt install kubectl=1.26.0-00 kubelet=1.26.0-00</span>
Reading package lists<span class="token punctuation">..</span>. Done
Building dependency tree       
Reading state information<span class="token punctuation">..</span>. Done
The following packages will be upgraded:
  kubectl kubelet
<span class="token number">2</span> upgraded, <span class="token number">0</span> newly installed, <span class="token number">0</span> to remove and <span class="token number">135</span> not upgraded.
Need to get <span class="token number">30.5</span> MB of archives.
After this operation, <span class="token number">9,996</span> kB of additional disk space will be used.
Get:1 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubectl amd64 <span class="token number">1.26</span>.0-00 <span class="token punctuation">[</span><span class="token number">10.1</span> MB<span class="token punctuation">]</span>
Get:2 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubelet amd64 <span class="token number">1.26</span>.0-00 <span class="token punctuation">[</span><span class="token number">20.5</span> MB<span class="token punctuation">]</span>
Fetched <span class="token number">30.5</span> MB <span class="token keyword">in</span> 1s <span class="token punctuation">(</span><span class="token number">29.7</span> MB/s<span class="token punctuation">)</span>  
<span class="token punctuation">(</span>Reading database <span class="token punctuation">..</span>. <span class="token number">112508</span> files and directories currently installed.<span class="token punctuation">)</span>
Preparing to unpack <span class="token punctuation">..</span>./kubectl_1.26.0-00_amd64.deb <span class="token punctuation">..</span>.
Unpacking kubectl <span class="token punctuation">(</span><span class="token number">1.26</span>.0-00<span class="token punctuation">)</span> over <span class="token punctuation">(</span><span class="token number">1.25</span>.5-00<span class="token punctuation">)</span> <span class="token punctuation">..</span>.
Preparing to unpack <span class="token punctuation">..</span>./kubelet_1.26.0-00_amd64.deb <span class="token punctuation">..</span>.
Unpacking kubelet <span class="token punctuation">(</span><span class="token number">1.26</span>.0-00<span class="token punctuation">)</span> over <span class="token punctuation">(</span><span class="token number">1.25</span>.5-00<span class="token punctuation">)</span> <span class="token punctuation">..</span>.
Setting up kubectl <span class="token punctuation">(</span><span class="token number">1.26</span>.0-00<span class="token punctuation">)</span> <span class="token punctuation">..</span>.
Setting up kubelet <span class="token punctuation">(</span><span class="token number">1.26</span>.0-00<span class="token punctuation">)</span> <span class="token punctuation">..</span>.

➜ root@cluster3-node2:~<span class="token comment"># kubelet --version</span>
Kubernetes v1.26.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p>现在我们来看看 kubeadm、kubectl 和 kubelet。重启 kubelet：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster3-node2:~<span class="token comment"># service kubelet restart</span>

➜ root@cluster3-node2:~<span class="token comment"># service kubelet status</span>
● kubelet.service - kubelet: The Kubernetes Node Agent
     Loaded: loaded <span class="token punctuation">(</span>/lib/systemd/system/kubelet.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
    Drop-In: /etc/systemd/system/kubelet.service.d
             └─10-kubeadm.conf
     Active: activating <span class="token punctuation">(</span>auto-restart<span class="token punctuation">)</span> <span class="token punctuation">(</span>Result: exit-code<span class="token punctuation">)</span> since Wed <span class="token number">2022</span>-12-21 <span class="token number">16</span>:29:26 UTC<span class="token punctuation">;</span> 5s ago
       Docs: https://kubernetes.io/docs/home/
    Process: <span class="token number">32111</span> <span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/kubelet <span class="token variable">$KUBELET_KUBECONFIG_ARGS</span> <span class="token variable">$KUBELET_CONFIG_ARGS</span> <span class="token variable">$KUBELET_KUBEADM_ARGS</span> <span class="token variable">$KUBELET_EXTRA_ARGS</span> <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">1</span>/FAILURE<span class="token punctuation">)</span>
   Main PID: <span class="token number">32111</span> <span class="token punctuation">(</span>code<span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">1</span>/FAILURE<span class="token punctuation">)</span>

Dec <span class="token number">21</span> <span class="token number">16</span>:29:26 cluster3-node2 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: kubelet.service: Main process exited, <span class="token assign-left variable">code</span><span class="token operator">=</span>exited, <span class="token assign-left variable">status</span><span class="token operator">=</span><span class="token number">1</span>/FAILURE
Dec <span class="token number">21</span> <span class="token number">16</span>:29:26 cluster3-node2 systemd<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: kubelet.service: Failed with result <span class="token string">'exit-code'</span><span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>之所以出现这些错误，是因为我们仍然需要运行<code>kubeadm join</code>将节点加入集群。让我们在下一步中执行此操作。</p> <h5 id="将cluster-3-node2添加到集群"><a href="#将cluster-3-node2添加到集群" class="header-anchor">#</a> 将cluster 3-node2添加到集群</h5> <p>首先，我们登录到 controlplane1 并生成一个新的 TLS 引导令牌，同时打印出 join 命令：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster3-controlplane1

➜ root@cluster3-controlplane1:~<span class="token comment"># kubeadm token create --print-join-command</span>
kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.100.31:6443 <span class="token parameter variable">--token</span> rbhrjh.4o93r31o18an6dll --discovery-token-ca-cert-hash sha256:d94524f9ab1eed84417414c7def5c1608f84dbf04437d9f5f73eb6255dafdb18

➜ root@cluster3-controlplane1:~<span class="token comment"># kubeadm token list</span>
TOKEN                     TTL         EXPIRES                <span class="token punctuation">..</span>.
44dz0t.2lgmone0i1o5z9fe   <span class="token operator">&lt;</span>forever<span class="token operator">&gt;</span>   <span class="token operator">&lt;</span>never<span class="token operator">&gt;</span>
4u477f.nmpq48xmpjt6weje   1h          <span class="token number">2022</span>-12-21T18:14:30Z
rbhrjh.4o93r31o18an6dll   23h         <span class="token number">2022</span>-12-22T16:29:58Z
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以看到我们的 token 在 23 小时内到期，我们可以通过传递 ttl 参数来调整它。</p> <p>接下来，我们再次连接到 cluster3-node2 并简单地执行 join 命令：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster3-node2

➜ root@cluster3-node2:~<span class="token comment"># kubeadm join 192.168.100.31:6443 --token rbhrjh.4o93r31o18an6dll --discovery-token-ca-cert-hash sha256:d94524f9ab1eed84417414c7def5c1608f84dbf04437d9f5f73eb6255dafdb18</span>
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Running pre-flight checks
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> Reading configuration from the cluster<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>preflight<span class="token punctuation">]</span> FYI: You can <span class="token function">look</span> at this config <span class="token function">file</span> with <span class="token string">'kubectl -n kube-system get cm kubeadm-config -o yaml'</span>
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Writing kubelet configuration to <span class="token function">file</span> <span class="token string">&quot;/var/lib/kubelet/config.yaml&quot;</span>
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Writing kubelet environment <span class="token function">file</span> with flags to <span class="token function">file</span> <span class="token string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span>
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Starting the kubelet
<span class="token punctuation">[</span>kubelet-start<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> the kubelet to perform the TLS Bootstrap<span class="token punctuation">..</span>.

This <span class="token function">node</span> has joined the cluster:
* Certificate signing request was sent to apiserver and a response was received.
* The Kubelet was informed of the new secure connection details.

Run <span class="token string">'kubectl get nodes'</span> on the control-plane to see this <span class="token function">node</span> <span class="token function">join</span> the cluster.


➜ root@cluster3-node2:~<span class="token comment"># service kubelet status</span>
● kubelet.service - kubelet: The Kubernetes Node Agent
     Loaded: loaded <span class="token punctuation">(</span>/lib/systemd/system/kubelet.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
    Drop-In: /etc/systemd/system/kubelet.service.d
             └─10-kubeadm.conf
     Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Wed <span class="token number">2022</span>-12-21 <span class="token number">16</span>:32:19 UTC<span class="token punctuation">;</span> 1min 4s ago
       Docs: https://kubernetes.io/docs/home/
   Main PID: <span class="token number">32510</span> <span class="token punctuation">(</span>kubelet<span class="token punctuation">)</span>
      Tasks: <span class="token number">11</span> <span class="token punctuation">(</span>limit: <span class="token number">462</span><span class="token punctuation">)</span>
     Memory: <span class="token number">55</span>.2M
     CGroup: /system.slice/kubelet.service
             └─32510 /usr/bin/kubelet --bootstrap-kubeconfig<span class="token operator">=</span>/etc/kubernetes/bootstrap-kubelet.conf <span class="token parameter variable">--kubeconfig</span><span class="token operator">=</span>/etc/kubernetes/kubelet.conf <span class="token parameter variable">--config</span><span class="token operator">=</span>/var/lib/kubelet/config.yaml --container-runti<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>如果您在使用<code>kubeadm join</code>时遇到问题，您可能需要运行<code>kubeadm reset</code>。</p> <p>不过，对我们来说很不错。最后，我们回到主终端并检查节点状态：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get <span class="token function">node</span>
NAME                     STATUS     ROLES           AGE   VERSION
cluster3-controlplane1   Ready      control-plane   22h   v1.26.0
cluster3-node1           Ready      <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          22h   v1.26.0
cluster3-node2           NotReady   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          22h   v1.26.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>给予一点时间，直到节点准备好。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get <span class="token function">node</span>
NAME                     STATUS   ROLES           AGE   VERSION
cluster3-controlplane1   Ready    control-plane   22h   v1.26.0
cluster3-node1           Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          22h   v1.26.0
cluster3-node2           Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          22h   v1.26.0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>我们看到<code>cluster3-node2</code>现已可用且是最新的。</p> <h3 id="考题-21-创建静态pod和服务"><a href="#考题-21-创建静态pod和服务" class="header-anchor">#</a> 考题-21 | 创建静态Pod和服务</h3> <p>任务权重：2%</p> <p>切换集群：<code>kubectl config use-context k8s-c3-CCC</code></p> <p>在<code>cluster3-controlplane1</code>节点的命名空间<code>default</code>中创建一个名为<code>my-static-pod</code>的静态 Pod。它应该是镜像<code>nginx:1.16-alpine</code>，并且有<code>10m</code> CPU 和<code>20Mi</code>内存的资源请求。</p> <p>然后创建一个名为<code>static-pod-service</code>的<code>NodePort</code>服务，该服务在端口<code>80</code>上公开该静态 Pod，并检查它是否有端点，以及它是否可以通过<code>cluster3-controlplane1</code>内网 IP 地址访问。您可以从主终端连接到内网节点 IP。</p> <h4 id="解答-21"><a href="#解答-21" class="header-anchor">#</a> 解答</h4> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster3-controlplane1

➜ root@cluster1-controlplane1:~<span class="token comment"># cd /etc/kubernetes/manifests/</span>

➜ root@cluster1-controlplane1:~<span class="token comment"># kubectl run my-static-pod \</span>
    <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx:1.16-alpine <span class="token punctuation">\</span>
    <span class="token parameter variable">-o</span> yaml --dry-run<span class="token operator">=</span>client <span class="token operator">&gt;</span> my-static-pod.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># /etc/kubernetes/manifests/my-static-pod.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>static<span class="token punctuation">-</span>pod
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>static<span class="token punctuation">-</span>pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.16<span class="token punctuation">-</span>alpine
    <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>static<span class="token punctuation">-</span>pod
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">requests</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 10m
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 20Mi
  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>并确保它运行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get pod <span class="token parameter variable">-A</span> <span class="token operator">|</span> <span class="token function">grep</span> my-static
NAMESPACE     NAME                                   READY   STATUS   <span class="token punctuation">..</span>.   AGE
default       my-static-pod-cluster3-controlplane1   <span class="token number">1</span>/1     Running  <span class="token punctuation">..</span>.   22s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>现在我们公开静态 Pod：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k expose pod my-static-pod-cluster3-controlplane1 <span class="token punctuation">\</span>
  <span class="token parameter variable">--name</span> static-pod-service <span class="token punctuation">\</span>
  <span class="token parameter variable">--type</span><span class="token operator">=</span>NodePort <span class="token punctuation">\</span>
  <span class="token parameter variable">--port</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这将生成一个服务，如：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># kubectl expose pod my-static-pod-cluster3-controlplane1 --name static-pod-service --type=NodePort --port 80</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>static<span class="token punctuation">-</span>pod
  <span class="token key atrule">name</span><span class="token punctuation">:</span> static<span class="token punctuation">-</span>pod<span class="token punctuation">-</span>service
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>static<span class="token punctuation">-</span>pod
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
<span class="token key atrule">status</span><span class="token punctuation">:</span>
  <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>然后运行并测试：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get svc,ep <span class="token parameter variable">-l</span> <span class="token assign-left variable">run</span><span class="token operator">=</span>my-static-pod
NAME                         TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
service/static-pod-service   NodePort   <span class="token number">10.99</span>.168.252   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>:30352/TCP   30s

NAME                           ENDPOINTS      AGE
endpoints/static-pod-service   <span class="token number">10.32</span>.0.4:80   30s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>看起来不错。</p> <h3 id="考题-22-检查证书的有效期"><a href="#考题-22-检查证书的有效期" class="header-anchor">#</a> 考题-22 | 检查证书的有效期</h3> <p>任务权重：2%</p> <p>切换集群：<code>kubectl config use-context k8s-c2-AC</code></p> <p>检查 kube-apiserver 服务器证书在<code>cluster2-controlplane1</code>上的有效期。使用 openssl 或 cfssl 执行此操作。将 exipiration 日期写入<code>/opt/course/22/expiration</code>。</p> <p>此外，运行正确的<code>kubeadm</code>命令以列出到期日期，并确认两种方法显示相同的日期。</p> <p>将更新 apiserver 服务器证书的正确<code>kubeadm</code>命令写入<code>/opt/course/22/kubeadm-renew-certs.sh</code>中。</p> <h4 id="解答-22"><a href="#解答-22" class="header-anchor">#</a> 解答</h4> <p>首先，我们来看看这个证书：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster2-controlplane1

➜ root@cluster2-controlplane1:~<span class="token comment"># find /etc/kubernetes/pki | grep apiserver</span>
/etc/kubernetes/pki/apiserver.crt
/etc/kubernetes/pki/apiserver-etcd-client.crt
/etc/kubernetes/pki/apiserver-etcd-client.key
/etc/kubernetes/pki/apiserver-kubelet-client.crt
/etc/kubernetes/pki/apiserver.key
/etc/kubernetes/pki/apiserver-kubelet-client.key
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>接下来，我们使用 openssl 来找出到期日期：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster2-controlplane1:~<span class="token comment"># openssl x509  -noout -text -in /etc/kubernetes/pki/apiserver.crt | grep Validity -A2</span>
        Validity
            Not Before: Dec <span class="token number">20</span> <span class="token number">18</span>:05:20 <span class="token number">2022</span> GMT
            Not After <span class="token builtin class-name">:</span> Dec <span class="token number">20</span> <span class="token number">18</span>:05:20 <span class="token number">2023</span> GMT
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>我们有了它，所以我们把它写在主终端上所需的位置：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/22/expiration</span>
Dec <span class="token number">20</span> <span class="token number">18</span>:05:20 <span class="token number">2023</span> GMT
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>我们也使用 kubeadm 的功能来获取过期时间：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster2-controlplane1:~<span class="token comment"># kubeadm certs check-expiration | grep apiserver</span>
apiserver                Jan <span class="token number">14</span>, <span class="token number">2022</span> <span class="token number">18</span>:49 UTC   363d        ca               no      
apiserver-etcd-client    Jan <span class="token number">14</span>, <span class="token number">2022</span> <span class="token number">18</span>:49 UTC   363d        etcd-ca          no      
apiserver-kubelet-client Jan <span class="token number">14</span>, <span class="token number">2022</span> <span class="token number">18</span>:49 UTC   363d        ca               no 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>看起来不错最后，我们将更新所有证书的命令写入请求的位置：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/22/kubeadm-renew-certs.sh</span>
kubeadm certs renew apiserver
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="考题-23-kubelet-客户端-服务器证书信息"><a href="#考题-23-kubelet-客户端-服务器证书信息" class="header-anchor">#</a> 考题-23 | Kubelet 客户端/服务器证书信息</h3> <p>任务权重：2%</p> <p>切换集群：<code>kubectl config use-context k8s-c2-AC</code></p> <p>节点<code>cluster2-node1</code>已使用<code>kubeadm</code>和 TLS 引导添加到集群中。</p> <p>找到 cluster 2-node1 的 “Issuer” 和 “Extended Key Usage” 值：</p> <ol><li>kubelet 客户端证书，用于与 kube-apiserver 的传出连接。</li> <li>kubelet 服务器证书，用于从 kube-apiserver 传入连接的证书。</li></ol> <p>将信息写入文件<code>/opt/course/23/certificate-info.txt</code>。</p> <p>比较两个证书的 “Issuer” 和 “Extended Key Usage” 字段并理解它们。</p> <h4 id="解答-23"><a href="#解答-23" class="header-anchor">#</a> 解答</h4> <p>要找到正确的 kubelet 证书目录，我们可以查找 kubelet 的<code>--cert-dir</code>参数的默认值。为此，请在 Kubernetes 文档中搜索 “kubelet”：<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。我们可以使用<code>ps aux</code>或在<code>/etc/systemd/system/kubelet.service.d/10-kubeadm.conf</code>中检查是否配置了另一个证书目录。</p> <p>首先我们检查 kubelet 客户端证书：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster2-node1

➜ root@cluster2-node1:~<span class="token comment"># openssl x509  -noout -text -in /var/lib/kubelet/pki/kubelet-client-current.pem | grep Issuer</span>
        Issuer: CN <span class="token operator">=</span> kubernetes
        
➜ root@cluster2-node1:~<span class="token comment"># openssl x509  -noout -text -in /var/lib/kubelet/pki/kubelet-client-current.pem | grep &quot;Extended Key Usage&quot; -A1</span>
            X509v3 Extended Key Usage: 
                TLS Web Client Authentication
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>接下来我们检查 kubelet 服务器证书：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster2-node1:~<span class="token comment"># openssl x509  -noout -text -in /var/lib/kubelet/pki/kubelet.crt | grep Issuer</span>
          Issuer: CN <span class="token operator">=</span> cluster2-node1-ca@1588186506

➜ root@cluster2-node1:~<span class="token comment"># openssl x509  -noout -text -in /var/lib/kubelet/pki/kubelet.crt | grep &quot;Extended Key Usage&quot; -A1</span>
            X509v3 Extended Key Usage: 
                TLS Web Server Authentication
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>我们看到服务器证书是在工作节点本身上生成的，客户端证书是由 Kubernetes API 颁发的。“Extended Key Usage” 显示了它是用于客户端还是服务器身份验证。</p> <p>更多信息：<a href="https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="考题-24-networkpolicy"><a href="#考题-24-networkpolicy" class="header-anchor">#</a> 考题-24 | NetworkPolicy</h3> <p>任务权重：9%</p> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>发生了一起安全事件，入侵者能够从一个被黑客入侵的后端 Pod 访问整个集群。</p> <p>为了防止这种情况，请在命名空间<code>project-snake</code>中创建一个名为<code>np-backend</code>的 NetworkPolicy。它应该只允许后端 Pod 执行以下操作：</p> <ul><li>连接到<code>db1-*</code> Pods 的<code>1111</code>端口</li> <li>连接到<code>db2-*</code> Pods 的<code>2222</code>端口</li></ul> <p>在策略中使用 Pods 的<code>app</code>标签。</p> <p>在实现之后，从<code>backend-*</code> Pod 到<code>vault-*</code> Pod 在端口<code>3333</code>上的连接应该不再有效。</p> <h4 id="解答-24"><a href="#解答-24" class="header-anchor">#</a> 解答</h4> <h5 id="正确实现"><a href="#正确实现" class="header-anchor">#</a> 正确实现</h5> <p>首先，我们来看看现有的 Pod 及其标签：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k <span class="token parameter variable">-n</span> project-snake get pod
NAME        READY   STATUS    RESTARTS   AGE
backend-0   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8s
db1-0       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          8s
db2-0       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10s
vault-0     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          10s

➜ k <span class="token parameter variable">-n</span> project-snake get pod <span class="token parameter variable">-L</span> app
NAME        READY   STATUS    RESTARTS   AGE     APP
backend-0   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m15s   backend
db1-0       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m15s   db1
db2-0       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m17s   db2
vault-0     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          3m17s   vault
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>我们测试了当前的连接情况，发现没有任何限制：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k <span class="token parameter variable">-n</span> project-snake get pod <span class="token parameter variable">-o</span> wide
NAME        READY   STATUS    RESTARTS   AGE     IP          <span class="token punctuation">..</span>.
backend-0   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m14s   <span class="token number">10.44</span>.0.24  <span class="token punctuation">..</span>.
db1-0       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m14s   <span class="token number">10.44</span>.0.25  <span class="token punctuation">..</span>.
db2-0       <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m16s   <span class="token number">10.44</span>.0.23  <span class="token punctuation">..</span>.
vault-0     <span class="token number">1</span>/1     Running   <span class="token number">0</span>          4m16s   <span class="token number">10.44</span>.0.22  <span class="token punctuation">..</span>.

➜ k <span class="token parameter variable">-n</span> project-snake <span class="token builtin class-name">exec</span> backend-0 -- <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token number">10.44</span>.0.25:1111
database one

➜ k <span class="token parameter variable">-n</span> project-snake <span class="token builtin class-name">exec</span> backend-0 -- <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token number">10.44</span>.0.23:2222
database two

➜ k <span class="token parameter variable">-n</span> project-snake <span class="token builtin class-name">exec</span> backend-0 -- <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token number">10.44</span>.0.22:3333
vault secret storage
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>现在我们通过从 k8s 文档中复制并更改一个示例来创建 NP：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> 24_np.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 24_np.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> NetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> np<span class="token punctuation">-</span>backend
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>snake
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> backend
  <span class="token key atrule">policyTypes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Egress                    <span class="token comment"># policy is only about Egress</span>
  <span class="token key atrule">egress</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span>                           <span class="token comment"># first rule</span>
      <span class="token key atrule">to</span><span class="token punctuation">:</span>                           <span class="token comment"># first condition &quot;to&quot;</span>
      <span class="token punctuation">-</span> <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>
          <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
            <span class="token key atrule">app</span><span class="token punctuation">:</span> db1
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>                        <span class="token comment"># second condition &quot;port&quot;</span>
      <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">1111</span>
    <span class="token punctuation">-</span>                           <span class="token comment"># second rule</span>
      <span class="token key atrule">to</span><span class="token punctuation">:</span>                           <span class="token comment"># first condition &quot;to&quot;</span>
      <span class="token punctuation">-</span> <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>
          <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
            <span class="token key atrule">app</span><span class="token punctuation">:</span> db2
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>                        <span class="token comment"># second condition &quot;port&quot;</span>
      <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2222</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h5 id="错误的例子"><a href="#错误的例子" class="header-anchor">#</a> 错误的例子</h5> <p>现在让我们来看看一个错误的例子：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 错误</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> NetworkPolicy
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> np<span class="token punctuation">-</span>backend
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>snake
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> backend
  <span class="token key atrule">policyTypes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Egress
  <span class="token key atrule">egress</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span>                           <span class="token comment"># first rule</span>
      <span class="token key atrule">to</span><span class="token punctuation">:</span>                           <span class="token comment"># first condition &quot;to&quot;</span>
      <span class="token punctuation">-</span> <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>                    <span class="token comment"># first &quot;to&quot; possibility</span>
          <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
            <span class="token key atrule">app</span><span class="token punctuation">:</span> db1
      <span class="token punctuation">-</span> <span class="token key atrule">podSelector</span><span class="token punctuation">:</span>                    <span class="token comment"># second &quot;to&quot; possibility</span>
          <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
            <span class="token key atrule">app</span><span class="token punctuation">:</span> db2
      <span class="token key atrule">ports</span><span class="token punctuation">:</span>                        <span class="token comment"># second condition &quot;ports&quot;</span>
      <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP                   <span class="token comment"># first &quot;ports&quot; possibility</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">1111</span>
      <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP                   <span class="token comment"># second &quot;ports&quot; possibility</span>
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2222</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>如果使用了这个错误的 NP，则 <code>backend-*</code> Pod 仍然可以连接到<code>db2-*</code> Pod 上的端口<code>1111</code>，这应该被禁止。</p> <h5 id="创建网络策略"><a href="#创建网络策略" class="header-anchor">#</a> 创建网络策略</h5> <p>我们创建正确的 NP：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-f</span> 24_np.yaml create
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>再次测试：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k <span class="token parameter variable">-n</span> project-snake <span class="token builtin class-name">exec</span> backend-0 -- <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token number">10.44</span>.0.25:1111
database one

➜ k <span class="token parameter variable">-n</span> project-snake <span class="token builtin class-name">exec</span> backend-0 -- <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token number">10.44</span>.0.23:2222
database two

➜ k <span class="token parameter variable">-n</span> project-snake <span class="token builtin class-name">exec</span> backend-0 -- <span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token number">10.44</span>.0.22:3333
^C
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在 NP 上使用<code>kubectl describe</code>来查看 k8s 如何解释策略也很有帮助。</p> <p>很好，看起来更安全了。任务完成。</p> <h3 id="考题-25-etcd快照保存和恢复"><a href="#考题-25-etcd快照保存和恢复" class="header-anchor">#</a> 考题-25 | Etcd快照保存和恢复</h3> <p>任务权重：8%</p> <p>切换集群：<code>kubectl config use-context k8s-c3-CCC</code></p> <p>备份在<code>cluster3-controlplane1</code>上运行的 etcd，并将其保存在控制平面节点的<code>/tmp/etcd-backup.db</code>中。</p> <p>然后在集群中创建一个属于你的 Pod。</p> <p>最后恢复备份，确认集群仍在工作，并且创建的 Pod 不再与我们在一起。</p> <h4 id="解答-25"><a href="#解答-25" class="header-anchor">#</a> 解答</h4> <h5 id="etcd备份"><a href="#etcd备份" class="header-anchor">#</a> Etcd备份</h5> <p>首先，我们登录到控制平面，并尝试创建一个 etcd 的快照：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster3-controlplane1

➜ root@cluster3-controlplane1:~<span class="token comment"># ETCDCTL_API=3 etcdctl snapshot save /tmp/etcd-backup.db</span>
Error:  rpc error: code <span class="token operator">=</span> Unavailable desc <span class="token operator">=</span> transport is closing
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>但它失败了，因为我们需要验证自己。对于必要的信息，我们可以检查 etc 清单：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster3-controlplane1:~<span class="token comment"># vim /etc/kubernetes/manifests/etcd.yaml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们只检查<code>etcd.yaml</code>以获取必要的信息，我们不会更改它。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># /etc/kubernetes/manifests/etcd.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">component</span><span class="token punctuation">:</span> etcd
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> control<span class="token punctuation">-</span>plane
  <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> etcd
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>client<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//192.168.100.31<span class="token punctuation">:</span><span class="token number">2379</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cert<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/server.crt                           <span class="token comment"># use</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>client<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>auth=true
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>data<span class="token punctuation">-</span>dir=/var/lib/etcd
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>initial<span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>peer<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//192.168.100.31<span class="token punctuation">:</span><span class="token number">2380</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>initial<span class="token punctuation">-</span>cluster=cluster3<span class="token punctuation">-</span>controlplane1=https<span class="token punctuation">:</span>//192.168.100.31<span class="token punctuation">:</span><span class="token number">2380</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/server.key                            <span class="token comment"># use</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>listen<span class="token punctuation">-</span>client<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">2379</span><span class="token punctuation">,</span>https<span class="token punctuation">:</span>//192.168.100.31<span class="token punctuation">:</span><span class="token number">2379</span>   <span class="token comment"># use</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>listen<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>urls=http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">2381</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>listen<span class="token punctuation">-</span>peer<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//192.168.100.31<span class="token punctuation">:</span><span class="token number">2380</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>name=cluster3<span class="token punctuation">-</span>controlplane1
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/peer.crt
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>client<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>auth=true
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/peer.key
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>trusted<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/ca.crt                    <span class="token comment"># use</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>snapshot<span class="token punctuation">-</span>count=10000
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>trusted<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/ca.crt
    <span class="token key atrule">image</span><span class="token punctuation">:</span> k8s.gcr.io/etcd<span class="token punctuation">:</span>3.3.15<span class="token punctuation">-</span><span class="token number">0</span>
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
      <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">8</span>
      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
        <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /health
        <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">2381</span>
        <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP
      <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>
      <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/etcd
      <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>data
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kubernetes/pki/etcd
      <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>critical
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/kubernetes/pki/etcd
      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate
    <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs
  <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/etcd                                                     <span class="token comment"># important</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate
    <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>data
<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br></div></div><p>但是我们也知道 api-server 正在连接 etcd，所以我们可以检查它的 manifest 是如何配置的：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster3-controlplane1:~<span class="token comment"># cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep etcd</span>
    - --etcd-cafile<span class="token operator">=</span>/etc/kubernetes/pki/etcd/ca.crt
    - --etcd-certfile<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-etcd-client.crt
    - --etcd-keyfile<span class="token operator">=</span>/etc/kubernetes/pki/apiserver-etcd-client.key
    - --etcd-servers<span class="token operator">=</span>https://127.0.0.1:2379
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>我们使用身份验证信息并将其传递给 etcdctl：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster3-controlplane1:~<span class="token comment"># ETCDCTL_API=3 etcdctl snapshot save /tmp/etcd-backup.db \</span>
<span class="token parameter variable">--cacert</span> /etc/kubernetes/pki/etcd/ca.crt <span class="token punctuation">\</span>
<span class="token parameter variable">--cert</span> /etc/kubernetes/pki/etcd/server.crt <span class="token punctuation">\</span>
<span class="token parameter variable">--key</span> /etc/kubernetes/pki/etcd/server.key

Snapshot saved at /tmp/etcd-backup.db
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p>不要使用<code>snapshot status</code>，因为它可能会更改快照文件并使其无效。</p></div> <h5 id="etcd恢复"><a href="#etcd恢复" class="header-anchor">#</a> Etcd恢复</h5> <p>现在在集群中创建一个 Pod 并等待它运行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster3-controlplane1:~<span class="token comment"># kubectl run test --image=nginx</span>
pod/test created

➜ root@cluster3-controlplane1:~<span class="token comment"># kubectl get pod -l run=test -w</span>
NAME   READY   STATUS    RESTARTS   AGE
<span class="token builtin class-name">test</span>   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          60s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p>如果您没有解决问题 18 或 20，并且 cluster3 没有就绪的工作节点，则创建的 Pod 可能会保持 Pending 状态。对于此任务，这仍然可以。</p></div> <p>接下来，我们停止所有控制平面组件：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>root@cluster3-controlplane1:~<span class="token comment"># cd /etc/kubernetes/manifests/</span>

root@cluster3-controlplane1:/etc/kubernetes/manifests<span class="token comment"># mv * ..</span>

root@cluster3-controlplane1:/etc/kubernetes/manifests<span class="token comment"># watch crictl ps</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>现在我们将快照恢复到特定目录：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster3-controlplane1:~<span class="token comment"># ETCDCTL_API=3 etcdctl snapshot restore /tmp/etcd-backup.db \</span>
--data-dir /var/lib/etcd-backup <span class="token punctuation">\</span>
<span class="token parameter variable">--cacert</span> /etc/kubernetes/pki/etcd/ca.crt <span class="token punctuation">\</span>
<span class="token parameter variable">--cert</span> /etc/kubernetes/pki/etcd/server.crt <span class="token punctuation">\</span>
<span class="token parameter variable">--key</span> /etc/kubernetes/pki/etcd/server.key

<span class="token number">2020</span>-09-04 <span class="token number">16</span>:50:19.650804 I <span class="token operator">|</span> mvcc: restore compact to <span class="token number">9935</span>
<span class="token number">2020</span>-09-04 <span class="token number">16</span>:50:19.659095 I <span class="token operator">|</span> etcdserver/membership: added member 8e9e05c52164694d <span class="token punctuation">[</span>http://localhost:2380<span class="token punctuation">]</span> to cluster cdf818194e3a8c32
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>我们可以使用<code>etcdctl --endpoints http://IP</code>指定另一台主机进行备份，但这里我们只使用默认值：<code>http://127.0.0.1:2379,http://127.0.0.1:4001</code>。</p> <p>恢复的文件位于新文件夹<code>/var/lib/etcd-backup</code>中，现在我们必须告诉 etcd 使用该目录：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster3-controlplane1:~<span class="token comment"># vim /etc/kubernetes/etcd.yaml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># /etc/kubernetes/etcd.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">component</span><span class="token punctuation">:</span> etcd
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> control<span class="token punctuation">-</span>plane
  <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
<span class="token punctuation">...</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kubernetes/pki/etcd
      <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>critical
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/kubernetes/pki/etcd
      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate
    <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs
  <span class="token punctuation">-</span> <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/etcd<span class="token punctuation">-</span>backup                <span class="token comment"># change</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate
    <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>data
<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>现在，我们再次将所有控制平面 yaml 移动到 manifest 目录中。给予它一点时间（最多几分钟）让 etcd 重新启动，让 api-server 再次可以访问：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>root@cluster3-controlplane1:/etc/kubernetes/manifests<span class="token comment"># mv ../*.yaml .</span>

root@cluster3-controlplane1:/etc/kubernetes/manifests<span class="token comment"># watch crictl ps</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后我们再次检查 Pod：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster3-controlplane1:~<span class="token comment"># kubectl get pod -l run=test</span>
No resources found <span class="token keyword">in</span> default namespace.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>太棒了，备份和恢复成功工作了，因为我们的 Pod 不见了。</p> <h2 id="附加题目"><a href="#附加题目" class="header-anchor">#</a> 附加题目</h2> <h3 id="附题-1-查找需要第一个终止的pod"><a href="#附题-1-查找需要第一个终止的pod" class="header-anchor">#</a> 附题-1 | 查找需要第一个终止的Pod</h3> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>检查命名空间<code>project-c13</code>中所有可用的 Pod，并找到那些在节点耗尽资源（cpu 或内存）来调度所有 Pod 时可能首先终止的 Pod 的名称。将 Pod 名称写入<code>/opt/course/e1/pods-not-stable.txt</code>。</p> <h4 id="解答-26"><a href="#解答-26" class="header-anchor">#</a> 解答</h4> <p>当节点上的可用 CPU 或内存资源达到极限时，Kubernetes 将查找使用比请求更多资源的 Pod。他们将是第一批被解雇的候选人。如果某些 Pod 容器没有设置资源请求 / 限制，那么默认情况下，这些容器被认为使用了超过请求的资源。</p> <p>Kubernetes 根据定义的资源和限制为 Pod 分配服务质量类，请在此处阅读更多内容：<a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>因此，我们应该寻找没有定义资源请求的 Pod，我们可以通过手动方法来做到这一点：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-n</span> project-c13 describe pod <span class="token operator">|</span> <span class="token function">less</span> <span class="token parameter variable">-p</span> Requests <span class="token comment"># describe all pods and highlight Requests</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>或者我们这样做：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-n</span> project-c13 describe pod <span class="token operator">|</span> <span class="token function">egrep</span> <span class="token string">&quot;^(Name:|    Requests:)&quot;</span> <span class="token parameter variable">-A1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们看到 Deployment <code>c13-3cc-runner-heavy</code>的 Pod 没有指定任何资源请求。因此，我们的答案是：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/e1/pods-not-stable.txt</span>
c13-3cc-runner-heavy-65588d7d6-djtv9map
c13-3cc-runner-heavy-65588d7d6-v8kf5map
c13-3cc-runner-heavy-65588d7d6-wwpb4map
o3db-0
o3db-1 <span class="token comment"># 如果已通过先前的方案删除，则可能不存在</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>要自动化这个过程，你可以像这样使用 jsonpath：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k <span class="token parameter variable">-n</span> project-c13 get pod <span class="token punctuation">\</span>
  <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&quot;{range .items[*]} {.metadata.name}{.spec.containers[*].resources}{'<span class="token entity" title="\n">\n</span>'}&quot;</span>

 c13-2x3-api-86784557bd-cgs8gmap<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:50m memory:20Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 c13-2x3-api-86784557bd-lnxvjmap<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:50m memory:20Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 c13-2x3-api-86784557bd-mnp77map<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:50m memory:20Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 c13-2x3-web-769c989898-6hbgtmap<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:50m memory:10Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 c13-2x3-web-769c989898-g57nqmap<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:50m memory:10Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 c13-2x3-web-769c989898-hfd5vmap<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:50m memory:10Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 c13-2x3-web-769c989898-jfx64map<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:50m memory:10Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 c13-2x3-web-769c989898-r89mgmap<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:50m memory:10Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 c13-2x3-web-769c989898-wtgxlmap<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:50m memory:10Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 c13-3cc-runner-98c8b5469-dzqhrmap<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:30m memory:10Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 c13-3cc-runner-98c8b5469-hbtdvmap<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:30m memory:10Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 c13-3cc-runner-98c8b5469-n9lswmap<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:30m memory:10Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 c13-3cc-runner-heavy-65588d7d6-djtv9map<span class="token punctuation">[</span><span class="token punctuation">]</span>
 c13-3cc-runner-heavy-65588d7d6-v8kf5map<span class="token punctuation">[</span><span class="token punctuation">]</span>
 c13-3cc-runner-heavy-65588d7d6-wwpb4map<span class="token punctuation">[</span><span class="token punctuation">]</span>
 c13-3cc-web-675456bcd-glpq6map<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:50m memory:10Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 c13-3cc-web-675456bcd-knlpxmap<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:50m memory:10Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 c13-3cc-web-675456bcd-nfhp9map<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:50m memory:10Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 c13-3cc-web-675456bcd-twn7mmap<span class="token punctuation">[</span>requests:map<span class="token punctuation">[</span>cpu:50m memory:10Mi<span class="token punctuation">]</span><span class="token punctuation">]</span>
 o3db-0<span class="token punctuation">{</span><span class="token punctuation">}</span>
 o3db-1<span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>这列出了所有 Pod 的名称及其请求 / 限制，因此我们看到了三个没有定义的 Pod。</p> <p>或者我们寻找服务质量类：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get pods <span class="token parameter variable">-n</span> project-c13 <span class="token punctuation">\</span>
  <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&quot;{range .items[*]}{.metadata.name} {.status.qosClass}{'<span class="token entity" title="\n">\n</span>'}&quot;</span>

c13-2x3-api-86784557bd-cgs8g Burstable
c13-2x3-api-86784557bd-lnxvj Burstable
c13-2x3-api-86784557bd-mnp77 Burstable
c13-2x3-web-769c989898-6hbgt Burstable
c13-2x3-web-769c989898-g57nq Burstable
c13-2x3-web-769c989898-hfd5v Burstable
c13-2x3-web-769c989898-jfx64 Burstable
c13-2x3-web-769c989898-r89mg Burstable
c13-2x3-web-769c989898-wtgxl Burstable
c13-3cc-runner-98c8b5469-dzqhr Burstable
c13-3cc-runner-98c8b5469-hbtdv Burstable
c13-3cc-runner-98c8b5469-n9lsw Burstable
c13-3cc-runner-heavy-65588d7d6-djtv9 BestEffort
c13-3cc-runner-heavy-65588d7d6-v8kf5 BestEffort
c13-3cc-runner-heavy-65588d7d6-wwpb4 BestEffort
c13-3cc-web-675456bcd-glpq6 Burstable
c13-3cc-web-675456bcd-knlpx Burstable
c13-3cc-web-675456bcd-nfhp9 Burstable
c13-3cc-web-675456bcd-twn7m Burstable
o3db-0 BestEffort
o3db-1 BestEffort
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>这里我们看到了三个 BestEffort，这些 Pod 没有定义任何内存或 CPU 限制/请求。</p> <p>一个好的做法是始终设置资源请求和限制。如果您不知道容器应该具有的值，则可以使用 Prometheus 等度量工具来了解这一点。您还可以在容器中使用<code>kubectl top pod</code>甚至<code>kubectl exec</code>，并使用和<code>top</code>类似的工具。</p> <h3 id="附题-2-curl-手动联系-api"><a href="#附题-2-curl-手动联系-api" class="header-anchor">#</a> 附题-2 | Curl 手动联系 API</h3> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>命名空间<code>project-hamster</code>中有一个现有的 ServiceAccount <code>secret-reader</code>。创建一个名为<code>tmp-api-contact</code>、镜像为<code>curlimages/curl:7.65.3</code>的 Pod，它使用此 ServiceAccount。确保容器保持运行。</p> <p>通过 Exec 进入 Pod 并使用<code>curl</code>手动访问该集群的 Kubernetes Api，并列出所有可用的 secret。您可以忽略不安全的 https 连接。将此命令写入文件<code>/opt/course/e4/list-secrets.sh</code>。</p> <h4 id="解答-27"><a href="#解答-27" class="header-anchor">#</a> 解答</h4> <p><a href="https://kubernetes.io/docs/tasks/run-application/access-api-from-pod" target="_blank" rel="noopener noreferrer">https://kubernetes.io/docs/tasks/run-application/access-api-from-pod<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>了解 Kubernetes API 的工作原理非常重要。为此，它有助于手动连接到 API，例如使用 curl。例如，您可以通过在 Kubernetes 文档中搜索 “curl API” 来快速查找该信息。</p> <p>首先，我们创建 Pod：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k run tmp-api-contact <span class="token punctuation">\</span>
  <span class="token parameter variable">--image</span><span class="token operator">=</span>curlimages/curl:7.65.3 <span class="token variable">$do</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--command</span> <span class="token operator">&gt;</span> e2.yaml -- <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">'sleep 1d'</span>

<span class="token function">vim</span> e2.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>添加服务帐户名称和命名空间：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># e2.yaml</span>
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: null
  labels:
    run: tmp-api-contact
  name: tmp-api-contact
  namespace: project-hamster          <span class="token comment"># add</span>
spec:
  serviceAccountName: secret-reader   <span class="token comment"># add</span>
  containers:
  - command:
    - <span class="token function">sh</span>
    - <span class="token parameter variable">-c</span>
    - <span class="token function">sleep</span> 1d
    image: curlimages/curl:7.65.3
    name: tmp-api-contact
    resources: <span class="token punctuation">{</span><span class="token punctuation">}</span>
  dnsPolicy: ClusterFirst
  restartPolicy: Always
status: <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>然后运行并执行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-f</span> <span class="token number">6</span>.yaml create

k <span class="token parameter variable">-n</span> project-hamster <span class="token builtin class-name">exec</span> tmp-api-contact <span class="token parameter variable">-it</span> -- <span class="token function">sh</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>进入容器后，我们可以尝试使用<code>curl</code>连接到 api，该 api 一般通过命名空间<code>default</code>中名为<code>kubernetes</code>的服务提供（您应该知道 dns 解析如何跨命名空间工作）。否则，我们可以通过运行<code>env</code>命令并从环境变量中找到端点 IP。</p> <p>现在我们可以做：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">curl</span> https://kubernetes.default
<span class="token function">curl</span> <span class="token parameter variable">-k</span> https://kubernetes.default <span class="token comment"># 忽略工单说明中允许的不安全</span>
<span class="token function">curl</span> <span class="token parameter variable">-k</span> https://kubernetes.default/api/v1/secrets <span class="token comment"># 显示禁止访问403</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>最后一个命令显示 403 禁止，这是因为我们没有向我们传递任何授权信息。Kubernetes Api 服务器认为我们以<code>system:anonymous</code>身份进行连接。我们想改变这一点，并使用名为<code>secret-reader</code>的 Pods ServiceAccount 进行连接。</p> <p>我们在<code>/var/run/secrets/kubernetes.io/serviceaccount</code>的挂载文件夹中找到了令牌，因此我们这样做：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token assign-left variable">TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> /var/run/secrets/kubernetes.io/serviceaccount/token<span class="token variable">)</span></span>
➜ <span class="token function">curl</span> <span class="token parameter variable">-k</span> https://kubernetes.default/api/v1/secrets <span class="token parameter variable">-H</span> <span class="token string">&quot;Authorization: Bearer <span class="token variable">${TOKEN}</span>&quot;</span>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  <span class="token number">0</span>     <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>    <span class="token number">0</span>     <span class="token number">0</span>      <span class="token number">0</span>      <span class="token number">0</span> --:--:-- --:--:-- --:--:--     <span class="token number">0</span><span class="token punctuation">{</span>
  <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;SecretList&quot;</span>,
  <span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;v1&quot;</span>,
  <span class="token string">&quot;metadata&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;selfLink&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/api/v1/secrets&quot;</span>,
    <span class="token string">&quot;resourceVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;10697&quot;</span>
  <span class="token punctuation">}</span>,
  <span class="token string">&quot;items&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token string">&quot;metadata&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span>
        <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;default-token-5zjbd&quot;</span>,
        <span class="token string">&quot;namespace&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;default&quot;</span>,
        <span class="token string">&quot;selfLink&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;/api/v1/namespaces/default/secrets/default-token-5zjbd&quot;</span>,
        <span class="token string">&quot;uid&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;315dbfd9-d235-482b-8bfc-c6167e7c1461&quot;</span>,
        <span class="token string">&quot;resourceVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;342&quot;</span>,
<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>现在，我们可以列出所有 Secret，我们的 Pod 在注册为 ServiceAccount 的<code>secret-reader</code>下运行。</p> <p>要使用加密的 https 连接，我们可以运行：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">CACERT</span><span class="token operator">=</span>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt
<span class="token function">curl</span> <span class="token parameter variable">--cacert</span> <span class="token variable">${CACERT}</span> https://kubernetes.default/api/v1/secrets <span class="token parameter variable">-H</span> <span class="token string">&quot;Authorization: Bearer <span class="token variable">${TOKEN}</span>&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>对于故障排除，我们还可以检查 ServiceAccount 是否能够使用以下命令列出 Secrets：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k auth can-i get secret <span class="token parameter variable">--as</span> system:serviceaccount:project-hamster:secret-reader
<span class="token function">yes</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>最后，将命令写入请求的位置：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/e4/list-secrets.sh</span>
<span class="token assign-left variable">TOKEN</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">cat</span> /var/run/secrets/kubernetes.io/serviceaccount/token<span class="token variable">)</span></span>
<span class="token function">curl</span> <span class="token parameter variable">-k</span> https://kubernetes.default/api/v1/secrets <span class="token parameter variable">-H</span> <span class="token string">&quot;Authorization: Bearer <span class="token variable">${TOKEN}</span>&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="预习题目"><a href="#预习题目" class="header-anchor">#</a> 预习题目</h2> <h3 id="预览题-1"><a href="#预览题-1" class="header-anchor">#</a> 预览题-1</h3> <p>切换集群：<code>kubectl config use-context k8s-c2-AC</code></p> <p>集群管理员要求您查找以下有关在<code>cluster2-controlplane1</code>上运行的 etcd 的信息：</p> <ul><li>服务器私钥位置</li> <li>服务器证书到期日期</li> <li>是否已启用客户端证书身份验证</li></ul> <p>将这些信息写入<code>/opt/course/p1/etcd-info.txt</code></p> <p>最后，系统会要求您在<code>cluster2-controlplane1</code>上的<code>/etc/etcd-snapshot.db</code>中保存一个 etcd 快照并显示其状态。</p> <h4 id="解答-28"><a href="#解答-28" class="header-anchor">#</a> 解答</h4> <h5 id="查询etcd信息"><a href="#查询etcd信息" class="header-anchor">#</a> 查询ETCD信息</h5> <p>让我们检查节点：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get <span class="token function">node</span>
NAME                     STATUS   ROLES           AGE    VERSION
cluster2-controlplane1   Ready    control-plane   89m   v1.23.1
cluster2-node1           Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          87m   v1.23.1

➜ <span class="token function">ssh</span> cluster2-controlplane1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>首先，我们来看看 etcd 是如何在这个集群中设置的：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster2-controlplane1:~<span class="token comment"># kubectl -n kube-system get pod</span>
NAME                                                READY   STATUS    RESTARTS   AGE
coredns-66bff467f8-k8f48                            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          26h
coredns-66bff467f8-rn8tr                            <span class="token number">1</span>/1     Running   <span class="token number">0</span>          26h
etcd-cluster2-controlplane1                         <span class="token number">1</span>/1     Running   <span class="token number">0</span>          26h
kube-apiserver-cluster2-controlplane1               <span class="token number">1</span>/1     Running   <span class="token number">0</span>          26h
kube-controller-manager-cluster2-controlplane1      <span class="token number">1</span>/1     Running   <span class="token number">0</span>          26h
kube-proxy-qthfg                                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          25h
kube-proxy-z55lp                                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>          26h
kube-scheduler-cluster2-controlplane1               <span class="token number">1</span>/1     Running   <span class="token number">1</span>          26h
weave-net-cqdvt                                     <span class="token number">2</span>/2     Running   <span class="token number">0</span>          26h
weave-net-dxzgh                                     <span class="token number">2</span>/2     Running   <span class="token number">1</span>          25h
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>我们看到它作为一个 Pod 运行，更具体地说，是一个静态 Pod。因此，我们检查静态清单的默认 kubelet 目录：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster2-controlplane1:~<span class="token comment"># find /etc/kubernetes/manifests/</span>
/etc/kubernetes/manifests/
/etc/kubernetes/manifests/kube-controller-manager.yaml
/etc/kubernetes/manifests/kube-apiserver.yaml
/etc/kubernetes/manifests/etcd.yaml
/etc/kubernetes/manifests/kube-scheduler.yaml

➜ root@cluster2-controlplane1:~<span class="token comment"># vim /etc/kubernetes/manifests/etcd.yaml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>因此，我们来看看 yaml 中 etcd 启动时使用的参数：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># /etc/kubernetes/manifests/etcd.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">component</span><span class="token punctuation">:</span> etcd
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> control<span class="token punctuation">-</span>plane
  <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> etcd
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>client<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//192.168.102.11<span class="token punctuation">:</span><span class="token number">2379</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cert<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/server.crt              <span class="token comment"># server certificate</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>client<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>auth=true                                      <span class="token comment"># enabled</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>data<span class="token punctuation">-</span>dir=/var/lib/etcd
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>initial<span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>peer<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//192.168.102.11<span class="token punctuation">:</span><span class="token number">2380</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>initial<span class="token punctuation">-</span>cluster=cluster2<span class="token punctuation">-</span>controlplane1=https<span class="token punctuation">:</span>//192.168.102.11<span class="token punctuation">:</span><span class="token number">2380</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/server.key               <span class="token comment"># server private key</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>listen<span class="token punctuation">-</span>client<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">2379</span><span class="token punctuation">,</span>https<span class="token punctuation">:</span>//192.168.102.11<span class="token punctuation">:</span><span class="token number">2379</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>listen<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>urls=http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span><span class="token number">2381</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>listen<span class="token punctuation">-</span>peer<span class="token punctuation">-</span>urls=https<span class="token punctuation">:</span>//192.168.102.11<span class="token punctuation">:</span><span class="token number">2380</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>name=cluster2<span class="token punctuation">-</span>controlplane1
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/peer.crt
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>client<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>auth=true
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/peer.key
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>peer<span class="token punctuation">-</span>trusted<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/ca.crt
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>snapshot<span class="token punctuation">-</span>count=10000
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>trusted<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/pki/etcd/ca.crt
<span class="token punctuation">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>我们看到客户端身份验证已启用，并且还请求了服务器私钥的路径，现在让我们看看服务器证书的过期时间：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster2-controlplane1:~<span class="token comment"># openssl x509  -noout -text -in /etc/kubernetes/pki/etcd/server.crt | grep Validity -A2</span>
        Validity
            Not Before: Sep <span class="token number">13</span> <span class="token number">13</span>:01:31 <span class="token number">2021</span> GMT
            Not After <span class="token builtin class-name">:</span> Sep <span class="token number">13</span> <span class="token number">13</span>:01:31 <span class="token number">2022</span> GMT
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这样就可以了。让我们将信息写入请求的文件：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># /opt/course/p1/etcd-info.txt</span>
Server private key location: /etc/kubernetes/pki/etcd/server.key
Server certificate expiration date: Sep <span class="token number">13</span> <span class="token number">13</span>:01:31 <span class="token number">2022</span> GMT
Is client certificate authentication enabled: <span class="token function">yes</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="创建etcd快照"><a href="#创建etcd快照" class="header-anchor">#</a> 创建etcd快照</h5> <p>首先，我们尝试：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl snapshot save /etc/etcd-snapshot.db
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们也从 yaml 中得到端点。但是我们需要指定更多的参数，所有这些我们都可以在上面的 yaml 声明中找到：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">ETCDCTL_API</span><span class="token operator">=</span><span class="token number">3</span> etcdctl snapshot save /etc/etcd-snapshot.db <span class="token punctuation">\</span>
<span class="token parameter variable">--cacert</span> /etc/kubernetes/pki/etcd/ca.crt <span class="token punctuation">\</span>
<span class="token parameter variable">--cert</span> /etc/kubernetes/pki/etcd/server.crt <span class="token punctuation">\</span>
<span class="token parameter variable">--key</span> /etc/kubernetes/pki/etcd/server.key
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这一招奏效了。现在我们可以输出备份文件的状态：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster2-controlplane1:~<span class="token comment"># ETCDCTL_API=3 etcdctl snapshot status /etc/etcd-snapshot.db</span>
4d4e953, <span class="token number">7213</span>, <span class="token number">1291</span>, <span class="token number">2.7</span> MB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>状态显示：</p> <ul><li>哈希: 4d4e953</li> <li>校订版本: 7213</li> <li>总数据量: 1291</li> <li>总大小: 2.7 MB</li></ul> <h3 id="预览题-2"><a href="#预览题-2" class="header-anchor">#</a> 预览题-2</h3> <p>切换集群：<code>kubectl config use-context k8s-c1-H</code></p> <p>系统会要求您确认 kube-proxy 在所有节点上都正常运行。为此，请在命名空间<code>project-hamster</code>中执行以下操作：</p> <p>创建一个名为<code>p2-pod</code>的新 Pod，其中包含两个容器，一个是镜像<code>nginx:1.21.3-alpine</code>，另一个是镜像<code>busybox:1.31</code>。确保 busybox 容器保持运行一段时间。</p> <p>创建一个名为<code>p2-service</code>的新 Service，该 Service 在集群内部的端口<code>3000-&gt;80</code>上公开该 Pod。</p> <p>在所有节点<code>cluster1-controlplane1</code>、<code>cluster1-node1</code>和<code>cluster1-node2</code>上找到 kube-proxy 容器，并确保它使用的是 iptables。为此，请使用命令<code>crictl</code>。</p> <p>将属于所创建服务<code>p2-service</code>的所有节点的 iptables 规则写入文件<code>/opt/course/p2/iptables.txt</code>。</p> <p>最后删除 Service 并确认 iptables 规则从所有节点中消失。</p> <h4 id="解答-29"><a href="#解答-29" class="header-anchor">#</a> 解答</h4> <h5 id="创建pod-2"><a href="#创建pod-2" class="header-anchor">#</a> 创建Pod</h5> <p>首先，我们创建 Pod：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># check out export statement on top which allows us to use $do</span>
k run p2-pod <span class="token parameter variable">--image</span><span class="token operator">=</span>nginx:1.21.3-alpine <span class="token variable">$do</span> <span class="token operator">&gt;</span> p2.yaml

<span class="token function">vim</span> p2.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># p2.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> p2<span class="token punctuation">-</span>pod
  <span class="token key atrule">name</span><span class="token punctuation">:</span> p2<span class="token punctuation">-</span>pod
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>hamster             <span class="token comment"># add</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.21.3<span class="token punctuation">-</span>alpine
    <span class="token key atrule">name</span><span class="token punctuation">:</span> p2<span class="token punctuation">-</span>pod
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.31</span>                  <span class="token comment"># add</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> c2                             <span class="token comment"># add</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;sh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sleep 1d&quot;</span><span class="token punctuation">]</span>    <span class="token comment"># add</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-f</span> p2.yaml create
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="创建服务"><a href="#创建服务" class="header-anchor">#</a> 创建服务</h5> <p>接下来我们创建服务：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-n</span> project-hamster expose pod p2-pod <span class="token parameter variable">--name</span> p2-service <span class="token parameter variable">--port</span> <span class="token number">3000</span> --target-port <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这将创建一个如下所示的 yaml：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">&quot;2020-04-30T20:58:14Z&quot;</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> p2<span class="token punctuation">-</span>pod
  <span class="token key atrule">managedFields</span><span class="token punctuation">:</span>
<span class="token punctuation">...</span>
    <span class="token key atrule">operation</span><span class="token punctuation">:</span> Update
    <span class="token key atrule">time</span><span class="token punctuation">:</span> <span class="token string">&quot;2020-04-30T20:58:14Z&quot;</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> p2<span class="token punctuation">-</span>service
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>hamster
  <span class="token key atrule">resourceVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;11071&quot;</span>
  <span class="token key atrule">selfLink</span><span class="token punctuation">:</span> /api/v1/namespaces/project<span class="token punctuation">-</span>hamster/services/p2<span class="token punctuation">-</span>service
  <span class="token key atrule">uid</span><span class="token punctuation">:</span> 2a1c0842<span class="token punctuation">-</span>7fb6<span class="token punctuation">-</span>4e94<span class="token punctuation">-</span>8cdb<span class="token punctuation">-</span>1602a3b1e7d2
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> 10.97.45.18
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3000</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">run</span><span class="token punctuation">:</span> p2<span class="token punctuation">-</span>pod
  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
<span class="token key atrule">status</span><span class="token punctuation">:</span>
  <span class="token key atrule">loadBalancer</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>我们应该确认 Pod 和服务是连接的，因此服务应该有端点。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-n</span> project-hamster get pod,svc,ep
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h5 id="确认kube-proxy正在运行并且正在使用iptables"><a href="#确认kube-proxy正在运行并且正在使用iptables" class="header-anchor">#</a> 确认kube-proxy正在运行并且正在使用iptables</h5> <p>首先，我们获取集群中的节点：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get <span class="token function">node</span>
NAME                     STATUS   ROLES           AGE   VERSION
cluster1-controlplane1   Ready    control-plane   98m   v1.23.1
cluster1-node1           Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          96m   v1.23.1
cluster1-node2           Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          95m   v1.23.1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这里的想法是登录到每个节点，找到 kube-proxy 容器并检查其日志：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster1-controlplane1

➜ root@cluster1-controlplane1$ crictl <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> kube-proxy
27b6a18c0f89c       36c4ebbc9d979       <span class="token number">3</span> hours ago         Running             kube-proxy

➜ root@cluster1-controlplane1~<span class="token comment"># crictl logs 27b6a18c0f89c</span>
<span class="token punctuation">..</span>.
I0913 <span class="token number">12</span>:53:03.096620       <span class="token number">1</span> server_others.go:212<span class="token punctuation">]</span> Using iptables Proxier.
<span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这应该在每个节点上重复，并产生相同的输出<code>Using iptables Proxier</code>。</p> <h5 id="检查kube-proxy是否正在创建iptables规则"><a href="#检查kube-proxy是否正在创建iptables规则" class="header-anchor">#</a> 检查kube-proxy是否正在创建iptables规则</h5> <p>现在，我们首先手动检查每个节点上的 iptables 规则：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster1-controlplane1 iptables-save <span class="token operator">|</span> <span class="token function">grep</span> p2-service
<span class="token parameter variable">-A</span> KUBE-SEP-6U447UXLLQIKP7BB <span class="token parameter variable">-s</span> <span class="token number">10.44</span>.0.20/32 <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;project-hamster/p2-service:&quot;</span> <span class="token parameter variable">-j</span> KUBE-MARK-MASQ
<span class="token parameter variable">-A</span> KUBE-SEP-6U447UXLLQIKP7BB <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;project-hamster/p2-service:&quot;</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">-j</span> DNAT --to-destination <span class="token number">10.44</span>.0.20:80
<span class="token parameter variable">-A</span> KUBE-SERVICES <span class="token operator">!</span> <span class="token parameter variable">-s</span> <span class="token number">10.244</span>.0.0/16 <span class="token parameter variable">-d</span> <span class="token number">10.97</span>.45.18/32 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;project-hamster/p2-service: cluster IP&quot;</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">3000</span> <span class="token parameter variable">-j</span> KUBE-MARK-MASQ
<span class="token parameter variable">-A</span> KUBE-SERVICES <span class="token parameter variable">-d</span> <span class="token number">10.97</span>.45.18/32 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;project-hamster/p2-service: cluster IP&quot;</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">3000</span> <span class="token parameter variable">-j</span> KUBE-SVC-2A6FNMCK6FDH7PJH
<span class="token parameter variable">-A</span> KUBE-SVC-2A6FNMCK6FDH7PJH <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;project-hamster/p2-service:&quot;</span> <span class="token parameter variable">-j</span> KUBE-SEP-6U447UXLLQIKP7BB

➜ <span class="token function">ssh</span> cluster1-node1 iptables-save <span class="token operator">|</span> <span class="token function">grep</span> p2-service
<span class="token parameter variable">-A</span> KUBE-SEP-6U447UXLLQIKP7BB <span class="token parameter variable">-s</span> <span class="token number">10.44</span>.0.20/32 <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;project-hamster/p2-service:&quot;</span> <span class="token parameter variable">-j</span> KUBE-MARK-MASQ
<span class="token parameter variable">-A</span> KUBE-SEP-6U447UXLLQIKP7BB <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;project-hamster/p2-service:&quot;</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">-j</span> DNAT --to-destination <span class="token number">10.44</span>.0.20:80
<span class="token parameter variable">-A</span> KUBE-SERVICES <span class="token operator">!</span> <span class="token parameter variable">-s</span> <span class="token number">10.244</span>.0.0/16 <span class="token parameter variable">-d</span> <span class="token number">10.97</span>.45.18/32 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;project-hamster/p2-service: cluster IP&quot;</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">3000</span> <span class="token parameter variable">-j</span> KUBE-MARK-MASQ
<span class="token parameter variable">-A</span> KUBE-SERVICES <span class="token parameter variable">-d</span> <span class="token number">10.97</span>.45.18/32 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;project-hamster/p2-service: cluster IP&quot;</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">3000</span> <span class="token parameter variable">-j</span> KUBE-SVC-2A6FNMCK6FDH7PJH
<span class="token parameter variable">-A</span> KUBE-SVC-2A6FNMCK6FDH7PJH <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;project-hamster/p2-service:&quot;</span> <span class="token parameter variable">-j</span> KUBE-SEP-6U447UXLLQIKP7BB

➜ <span class="token function">ssh</span> cluster1-node2 iptables-save <span class="token operator">|</span> <span class="token function">grep</span> p2-service
<span class="token parameter variable">-A</span> KUBE-SEP-6U447UXLLQIKP7BB <span class="token parameter variable">-s</span> <span class="token number">10.44</span>.0.20/32 <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;project-hamster/p2-service:&quot;</span> <span class="token parameter variable">-j</span> KUBE-MARK-MASQ
<span class="token parameter variable">-A</span> KUBE-SEP-6U447UXLLQIKP7BB <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;project-hamster/p2-service:&quot;</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">-j</span> DNAT --to-destination <span class="token number">10.44</span>.0.20:80
<span class="token parameter variable">-A</span> KUBE-SERVICES <span class="token operator">!</span> <span class="token parameter variable">-s</span> <span class="token number">10.244</span>.0.0/16 <span class="token parameter variable">-d</span> <span class="token number">10.97</span>.45.18/32 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;project-hamster/p2-service: cluster IP&quot;</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">3000</span> <span class="token parameter variable">-j</span> KUBE-MARK-MASQ
<span class="token parameter variable">-A</span> KUBE-SERVICES <span class="token parameter variable">-d</span> <span class="token number">10.97</span>.45.18/32 <span class="token parameter variable">-p</span> tcp <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;project-hamster/p2-service: cluster IP&quot;</span> <span class="token parameter variable">-m</span> tcp <span class="token parameter variable">--dport</span> <span class="token number">3000</span> <span class="token parameter variable">-j</span> KUBE-SVC-2A6FNMCK6FDH7PJH
<span class="token parameter variable">-A</span> KUBE-SVC-2A6FNMCK6FDH7PJH <span class="token parameter variable">-m</span> comment <span class="token parameter variable">--comment</span> <span class="token string">&quot;project-hamster/p2-service:&quot;</span> <span class="token parameter variable">-j</span> KUBE-SEP-6U447UXLLQIKP7BB
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>太好了现在让我们将这些日志写入请求的文件：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster1-controlplane1 iptables-save <span class="token operator">|</span> <span class="token function">grep</span> p2-service <span class="token operator">&gt;&gt;</span> /opt/course/p2/iptables.txt
➜ <span class="token function">ssh</span> cluster1-node1 iptables-save <span class="token operator">|</span> <span class="token function">grep</span> p2-service <span class="token operator">&gt;&gt;</span> /opt/course/p2/iptables.txt
➜ <span class="token function">ssh</span> cluster1-node2 iptables-save <span class="token operator">|</span> <span class="token function">grep</span> p2-service <span class="token operator">&gt;&gt;</span> /opt/course/p2/iptables.txt
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h5 id="删除服务并确认iptables规则已消失"><a href="#删除服务并确认iptables规则已消失" class="header-anchor">#</a> 删除服务并确认iptables规则已消失</h5> <p>删除服务：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k <span class="token parameter variable">-n</span> project-hamster delete svc p2-service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>并确认 iptables 规则已经消失：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster1-controlplane1 iptables-save <span class="token operator">|</span> <span class="token function">grep</span> p2-service
➜ <span class="token function">ssh</span> cluster1-node1 iptables-save <span class="token operator">|</span> <span class="token function">grep</span> p2-service
➜ <span class="token function">ssh</span> cluster1-node2 iptables-save <span class="token operator">|</span> <span class="token function">grep</span> p2-service
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>结束。</p> <p>Kubernetes 服务在所有节点上使用 iptables 规则（默认配置）实现。每当一个 Service 被修改、创建、删除或者一个 Service 的端点发生变化时，kube-apiserver 都会联系每个节点的 kube-proxy，根据当前状态更新 iptables 规则。</p> <h3 id="预览题-3"><a href="#预览题-3" class="header-anchor">#</a> 预览题-3</h3> <p>切换集群：<code>kubectl config use-context k8s-c2-AC</code></p> <p>在命名空间<code>default</code>中使用镜像<code>httpd:2.4.41-alpine</code>创建一个名为<code>check-ip</code>的 Pod。在端口 80 上将其公开为名为<code>check-ip-service</code>的 ClusterIP 服务。记住/输出该服务的 IP。</p> <p>将集群的服务 CIDR 更改为<code>11.96.0.0/12</code>。</p> <p>然后创建另一个名为<code>check-ip-service2</code>的 Service，指向同一个 Pod，以检查您的设置是否生效。最后，检查第一个服务的 IP 是否已更改。</p> <h4 id="解答-30"><a href="#解答-30" class="header-anchor">#</a> 解答</h4> <p>让我们创建Pod并公开它：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k run check-ip <span class="token parameter variable">--image</span><span class="token operator">=</span>httpd:2.4.41-alpine

k expose pod check-ip <span class="token parameter variable">--name</span> check-ip-service <span class="token parameter variable">--port</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>检查 Pod 和 Service ips：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get svc,ep <span class="token parameter variable">-l</span> <span class="token assign-left variable">run</span><span class="token operator">=</span>check-ip
NAME                       TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
service/check-ip-service   ClusterIP   <span class="token number">10.104</span>.3.45   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    8s

NAME                         ENDPOINTS      AGE
endpoints/check-ip-service   <span class="token number">10.44</span>.0.3:80   7s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>现在我们在 kube-apiserver 上更改 Service CIDR：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ <span class="token function">ssh</span> cluster2-controlplane1

➜ root@cluster2-controlplane1:~<span class="token comment"># vim /etc/kubernetes/manifests/kube-apiserver.yaml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># /etc/kubernetes/manifests/kube-apiserver.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">component</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>apiserver
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> control<span class="token punctuation">-</span>plane
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>apiserver
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> kube<span class="token punctuation">-</span>apiserver
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>address=192.168.100.21
<span class="token punctuation">...</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>service<span class="token punctuation">-</span>account<span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/pki/sa.pub
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>service<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>ip<span class="token punctuation">-</span>range=11.96.0.0/12             <span class="token comment"># change</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>tls<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>file=/etc/kubernetes/pki/apiserver.crt
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>tls<span class="token punctuation">-</span>private<span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/pki/apiserver.key
<span class="token punctuation">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><h5 id="给予一点时间-让-kube-apiserver-和管理器重新启动"><a href="#给予一点时间-让-kube-apiserver-和管理器重新启动" class="header-anchor">#</a> 给予一点时间，让 kube-apiserver 和管理器重新启动</h5> <p>等待 API 再次启动：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster2-controlplane1:~<span class="token comment"># kubectl -n kube-system get pod | grep api</span>
kube-apiserver-cluster2-controlplane1            <span class="token number">1</span>/1     Running   <span class="token number">0</span>              49s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>现在我们对控制管理器执行相同的操作：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster2-controlplane1:~<span class="token comment"># vim /etc/kubernetes/manifests/kube-controller-manager.yaml</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># /etc/kubernetes/manifests/kube-controller-manager.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">component</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
    <span class="token key atrule">tier</span><span class="token punctuation">:</span> control<span class="token punctuation">-</span>plane
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> kube<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>allocate<span class="token punctuation">-</span>node<span class="token punctuation">-</span>cidrs=true
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>authentication<span class="token punctuation">-</span>kubeconfig=/etc/kubernetes/controller<span class="token punctuation">-</span>manager.conf
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>authorization<span class="token punctuation">-</span>kubeconfig=/etc/kubernetes/controller<span class="token punctuation">-</span>manager.conf
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>bind<span class="token punctuation">-</span>address=127.0.0.1
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>client<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/pki/ca.crt
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>cidr=10.244.0.0/16
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>name=kubernetes
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>signing<span class="token punctuation">-</span>cert<span class="token punctuation">-</span>file=/etc/kubernetes/pki/ca.crt
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>signing<span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/pki/ca.key
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>controllers=*<span class="token punctuation">,</span>bootstrapsigner<span class="token punctuation">,</span>tokencleaner
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubeconfig=/etc/kubernetes/controller<span class="token punctuation">-</span>manager.conf
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>leader<span class="token punctuation">-</span>elect=true
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>node<span class="token punctuation">-</span>cidr<span class="token punctuation">-</span>mask<span class="token punctuation">-</span>size=24
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>requestheader<span class="token punctuation">-</span>client<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/pki/front<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>ca.crt
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>root<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/pki/ca.crt
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>service<span class="token punctuation">-</span>account<span class="token punctuation">-</span>private<span class="token punctuation">-</span>key<span class="token punctuation">-</span>file=/etc/kubernetes/pki/sa.key
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>service<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>ip<span class="token punctuation">-</span>range=11.96.0.0/12         <span class="token comment"># change</span>
    <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>use<span class="token punctuation">-</span>service<span class="token punctuation">-</span>account<span class="token punctuation">-</span>credentials=true
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h5 id="给予它一点时间让调度程序重新启动。"><a href="#给予它一点时间让调度程序重新启动。" class="header-anchor">#</a> 给予它一点时间让调度程序重新启动。</h5> <p>我们可以使用<code>crictl</code>检查它是否重新启动：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ root@cluster2-controlplane1:~<span class="token comment"># crictl ps | grep scheduler</span>
3d258934b9fd6    aca5ededae9c8    About a minute ago   Running    kube-scheduler <span class="token punctuation">..</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>再次检查我们现有的 Pod 和服务：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get pod,svc <span class="token parameter variable">-l</span> <span class="token assign-left variable">run</span><span class="token operator">=</span>check-ip
NAME           READY   STATUS    RESTARTS   AGE
pod/check-ip   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          21m

NAME                       TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
service/check-ip-service   ClusterIP   <span class="token number">10.99</span>.32.177   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    21m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>到目前为止没有任何变化。现在，我们像以前一样创建另一个服务：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>k expose pod check-ip <span class="token parameter variable">--name</span> check-ip-service2 <span class="token parameter variable">--port</span> <span class="token number">80</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>再检查一遍：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>➜ k get svc,ep <span class="token parameter variable">-l</span> <span class="token assign-left variable">run</span><span class="token operator">=</span>check-ip
NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
service/check-ip-service    ClusterIP   <span class="token number">10.109</span>.222.111   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    8m
service/check-ip-service2   ClusterIP   <span class="token number">11.111</span>.108.194   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">80</span>/TCP    6m32s

NAME                          ENDPOINTS      AGE
endpoints/check-ip-service    <span class="token number">10.44</span>.0.1:80   8m
endpoints/check-ip-service2   <span class="token number">10.44</span>.0.1:80   6m13s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>好了，新服务获得了分配的新指定范围的 ip。我们还看到，这两个 Service 都将我们的 Pod 作为端点。</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/carsaid/edit/master/docs/900.杂记/2222.CKA认证备考经验分享/2022.2022年考题复习/2222.个人模拟考试.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/31456b/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">考题复习-3</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/31456b/" class="prev">考题复习-3</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/cloud-native-security/kubernetes/cks/devopscube.com/configure-ingress-tls-kubernetes/"><div>
            如何为Ingress配置TLS、SSL证书
            <!----></div></a> <span class="date">12-04</span></dt></dl><dl><dd>02</dd> <dt><a href="/cloud-native-security/kubernetes/config/view/"><div>
            kubectl config view
            <!----></div></a> <span class="date">12-04</span></dt></dl><dl><dd>03</dd> <dt><a href="/cloud-native-security/kubernetes/kubectl/top/"><div>
            kubectl top
            <!----></div></a> <span class="date">12-04</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/carsaid" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2023
    <span>Carsaid | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6d8810e1.js" defer></script><script src="/assets/js/2.b3e685a4.js" defer></script><script src="/assets/js/204.67111065.js" defer></script>
  </body>
</html>
