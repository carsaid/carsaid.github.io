# 💛 Alibaba Nacos-未授权访问

### 1）漏洞信息

|漏洞名称	|受影响组件	|漏洞类型	|漏洞编号	|
|--	|--	|--	|--	|
|<p>阿里巴巴Nacos未授权访问</p><p>阿里巴巴Nacos身份认证绕过</p><p>阿里巴巴Nacos权限认证绕过</p>	|[Alibaba Nacos](https://github.com/alibaba/nacos)	|未授权访问	|CVE-2021-29441	|

|漏洞简介	|
|--	|
|<p>nacos在进行认证授权操作时，会判断请求的user-agent是否为”Nacos-Server”，如果是的话则不进行任何认证。</p><p>开发者原意是用来处理一些服务端对服务端的请求，但是由于配置的过于简单，并且将协商好的user-agent设置为Nacos-Server，直接硬编码在了代码里，这就导致了漏洞的出现。并且利用这个未授权漏洞，攻击者可以获取到用户名密码等敏感信息、可以添加登录账号并进入后台。</p>	|

|参考链接	|
|--	|
|<ol><li><a href="https://github.com/vulhub/vulhub/blob/master/nacos/CVE-2021-29441/README.zh-cn.md">https://github.com/vulhub/vulhub/blob/master/nacos/CVE-2021-29441/README.zh-cn.md</a></li></ol>	|

|补丁及修复方案	|
|--	|
|<ol><li>（官方）<a href="https://github.com/advisories/GHSA-36hp-jr8h-556f">https://github.com/advisories/GHSA-36hp-jr8h-556f</a></li><li><a href="https://nacos.io/zh-cn/docs/auth.html">https://nacos.io/zh-cn/docs/auth.html</a></li></ol>	|

### 2）漏洞环境

此处使用[vulhub](https://github.com/vulhub/vulhub)搭建漏洞环境

```
git clone https://github.com/vulhub/vulhub
cd vulhub/nacos/CVE-2021-29441
docker-compose up -d
```

启动环境后，访问8848端口即可看到Nacos页面
<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/alibaba/cve-2021-29441/01.png" alt=""><figcaption></figcaption></figure>

### 3）漏洞复现

```shell
python3 vulcat.py -u <URL> -a nacos -v cve-2021-29441

# 注意, vulcat-v2.0.0版本及以上, 应使用以下命令
python3 vulcat.py -u <URL> -v cve-2021-29441
```

<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/alibaba/cve-2021-29441/02.png" alt=""><figcaption></figcaption></figure>

你可以使用Request提供的数据包来查看用户列表
<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/alibaba/cve-2021-29441/03.png" alt=""><figcaption></figcaption></figure>

也可以自定义User-Agent头为Nacos-Server
然后直接访问漏洞URL，以此来查看用户列表
<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/alibaba/cve-2021-29441/04.png" alt=""><figcaption></figcaption></figure>

根据提供的Exploit
* 将数据包请求方式改为POST
* 然后访问nacos/v1/auth/users并指定用户名和密码，以此创建nacos登录账号

如果返回了状态码200 以及create user ok!
说明账号创建成功
<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/alibaba/cve-2021-29441/05.png" alt=""><figcaption></figcaption></figure>

接着来到登录页面，输入刚刚添加的用户名和密码
* hack
* 123456a!
<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/alibaba/cve-2021-29441/06.png" alt=""><figcaption></figcaption></figure>

点击提交并登录后，即可看到Nacos管理页面
<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/alibaba/cve-2021-29441/07.png" alt=""><figcaption></figcaption></figure>
