<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第6章-Pod生命周期与资源限制 | 某不知名博客</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="安全技术博客,专注安全领域学习与总结。渗透测试,工具开发,国外优秀安全文章翻译,知识库,漏洞库,全球安全事件统计等技术分享。">
    <meta name="keywords" content="漏洞猫,vulcat,个人技术博客,某不知名博客,安全团队,渗透测试,安全,网络安全,安全工具开发,云安全,学习,面试,Python,Golang,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.cdd53b27.css" as="style"><link rel="preload" href="/assets/js/app.e919b7aa.js" as="script"><link rel="preload" href="/assets/js/2.b3e685a4.js" as="script"><link rel="preload" href="/assets/js/19.23d067aa.js" as="script"><link rel="preload" href="/assets/js/3.a71cb994.js" as="script"><link rel="prefetch" href="/assets/js/10.81d14228.js"><link rel="prefetch" href="/assets/js/100.a9795f42.js"><link rel="prefetch" href="/assets/js/101.8a7f2412.js"><link rel="prefetch" href="/assets/js/102.06163e36.js"><link rel="prefetch" href="/assets/js/103.545f9213.js"><link rel="prefetch" href="/assets/js/104.41b6eb38.js"><link rel="prefetch" href="/assets/js/105.7d3d1459.js"><link rel="prefetch" href="/assets/js/106.8715f654.js"><link rel="prefetch" href="/assets/js/107.32511061.js"><link rel="prefetch" href="/assets/js/108.875cfc78.js"><link rel="prefetch" href="/assets/js/109.b015a66a.js"><link rel="prefetch" href="/assets/js/11.4dbe13dc.js"><link rel="prefetch" href="/assets/js/110.ac71693a.js"><link rel="prefetch" href="/assets/js/111.80c388c7.js"><link rel="prefetch" href="/assets/js/112.3719c30f.js"><link rel="prefetch" href="/assets/js/113.9c6c24f9.js"><link rel="prefetch" href="/assets/js/114.3b79c75c.js"><link rel="prefetch" href="/assets/js/115.986cb610.js"><link rel="prefetch" href="/assets/js/116.ddb7882f.js"><link rel="prefetch" href="/assets/js/117.d3f5c941.js"><link rel="prefetch" href="/assets/js/118.260fd29e.js"><link rel="prefetch" href="/assets/js/119.82be13fd.js"><link rel="prefetch" href="/assets/js/12.ee84c5f8.js"><link rel="prefetch" href="/assets/js/120.cfda05a9.js"><link rel="prefetch" href="/assets/js/121.b3e330e8.js"><link rel="prefetch" href="/assets/js/122.675a7165.js"><link rel="prefetch" href="/assets/js/123.7a4399db.js"><link rel="prefetch" href="/assets/js/124.4e2d371a.js"><link rel="prefetch" href="/assets/js/125.d9b98476.js"><link rel="prefetch" href="/assets/js/126.084f5aef.js"><link rel="prefetch" href="/assets/js/127.d1adca6e.js"><link rel="prefetch" href="/assets/js/128.8f475b6a.js"><link rel="prefetch" href="/assets/js/129.1f77b55c.js"><link rel="prefetch" href="/assets/js/13.0ee88d66.js"><link rel="prefetch" href="/assets/js/130.602eac12.js"><link rel="prefetch" href="/assets/js/131.810a1f35.js"><link rel="prefetch" href="/assets/js/132.826d4f34.js"><link rel="prefetch" href="/assets/js/133.178a8bd7.js"><link rel="prefetch" href="/assets/js/134.5f0beefa.js"><link rel="prefetch" href="/assets/js/135.1d1f115c.js"><link rel="prefetch" href="/assets/js/136.fa1e33d3.js"><link rel="prefetch" href="/assets/js/137.8f42bfcd.js"><link rel="prefetch" href="/assets/js/138.8e86686d.js"><link rel="prefetch" href="/assets/js/139.4f9617b5.js"><link rel="prefetch" href="/assets/js/14.212bcbe0.js"><link rel="prefetch" href="/assets/js/140.b95350e8.js"><link rel="prefetch" href="/assets/js/141.24e6782b.js"><link rel="prefetch" href="/assets/js/142.4d67711d.js"><link rel="prefetch" href="/assets/js/143.8f29e0a3.js"><link rel="prefetch" href="/assets/js/144.427e808b.js"><link rel="prefetch" href="/assets/js/145.81fc9699.js"><link rel="prefetch" href="/assets/js/146.df369d8e.js"><link rel="prefetch" href="/assets/js/147.7e4b2e8f.js"><link rel="prefetch" href="/assets/js/148.8744628d.js"><link rel="prefetch" href="/assets/js/149.dd4bf22a.js"><link rel="prefetch" href="/assets/js/15.ac777540.js"><link rel="prefetch" href="/assets/js/150.acf5a0f6.js"><link rel="prefetch" href="/assets/js/151.975d7c0e.js"><link rel="prefetch" href="/assets/js/152.c92f4b54.js"><link rel="prefetch" href="/assets/js/153.c178830c.js"><link rel="prefetch" href="/assets/js/154.667fce28.js"><link rel="prefetch" href="/assets/js/155.abd62679.js"><link rel="prefetch" href="/assets/js/156.d38bfeb9.js"><link rel="prefetch" href="/assets/js/157.e5521cf0.js"><link rel="prefetch" href="/assets/js/158.3d584ab7.js"><link rel="prefetch" href="/assets/js/159.fac1a717.js"><link rel="prefetch" href="/assets/js/16.7463f3f6.js"><link rel="prefetch" href="/assets/js/160.6bd18d53.js"><link rel="prefetch" href="/assets/js/161.a34cd546.js"><link rel="prefetch" href="/assets/js/162.d50ec10e.js"><link rel="prefetch" href="/assets/js/163.d28f9138.js"><link rel="prefetch" href="/assets/js/164.5e7803c3.js"><link rel="prefetch" href="/assets/js/165.c27797e9.js"><link rel="prefetch" href="/assets/js/166.08a6e510.js"><link rel="prefetch" href="/assets/js/167.107e8881.js"><link rel="prefetch" href="/assets/js/168.fca93681.js"><link rel="prefetch" href="/assets/js/169.73606cd2.js"><link rel="prefetch" href="/assets/js/17.ef7df638.js"><link rel="prefetch" href="/assets/js/170.df067bba.js"><link rel="prefetch" href="/assets/js/171.13b7b8bf.js"><link rel="prefetch" href="/assets/js/172.84aca80e.js"><link rel="prefetch" href="/assets/js/173.a7b73f9a.js"><link rel="prefetch" href="/assets/js/174.a3702fad.js"><link rel="prefetch" href="/assets/js/175.a34003d2.js"><link rel="prefetch" href="/assets/js/176.95d4688d.js"><link rel="prefetch" href="/assets/js/177.d0a7572d.js"><link rel="prefetch" href="/assets/js/178.1ca6106f.js"><link rel="prefetch" href="/assets/js/179.7ece4f09.js"><link rel="prefetch" href="/assets/js/18.7fab2d0c.js"><link rel="prefetch" href="/assets/js/180.a0a4c81b.js"><link rel="prefetch" href="/assets/js/181.49351c5b.js"><link rel="prefetch" href="/assets/js/182.d1ab3797.js"><link rel="prefetch" href="/assets/js/183.810d9261.js"><link rel="prefetch" href="/assets/js/184.a1005095.js"><link rel="prefetch" href="/assets/js/185.c5231470.js"><link rel="prefetch" href="/assets/js/186.cc4fa9d1.js"><link rel="prefetch" href="/assets/js/187.724934b4.js"><link rel="prefetch" href="/assets/js/188.4cc5b5d3.js"><link rel="prefetch" href="/assets/js/189.aadc93d7.js"><link rel="prefetch" href="/assets/js/190.c91ea047.js"><link rel="prefetch" href="/assets/js/191.8a173f7c.js"><link rel="prefetch" href="/assets/js/192.0ca7a899.js"><link rel="prefetch" href="/assets/js/193.7a74b236.js"><link rel="prefetch" href="/assets/js/194.2aee23fe.js"><link rel="prefetch" href="/assets/js/195.b76bbee3.js"><link rel="prefetch" href="/assets/js/196.3b532db5.js"><link rel="prefetch" href="/assets/js/197.c04f8f54.js"><link rel="prefetch" href="/assets/js/198.9f838dea.js"><link rel="prefetch" href="/assets/js/199.1f500719.js"><link rel="prefetch" href="/assets/js/20.30be4824.js"><link rel="prefetch" href="/assets/js/200.c8663997.js"><link rel="prefetch" href="/assets/js/201.235abd37.js"><link rel="prefetch" href="/assets/js/202.6939b77f.js"><link rel="prefetch" href="/assets/js/203.954faeeb.js"><link rel="prefetch" href="/assets/js/204.49b123b7.js"><link rel="prefetch" href="/assets/js/205.cc1a5436.js"><link rel="prefetch" href="/assets/js/206.e5406653.js"><link rel="prefetch" href="/assets/js/207.d54d757a.js"><link rel="prefetch" href="/assets/js/208.51044827.js"><link rel="prefetch" href="/assets/js/209.9d1d985f.js"><link rel="prefetch" href="/assets/js/21.a737b5d4.js"><link rel="prefetch" href="/assets/js/210.0e7ba874.js"><link rel="prefetch" href="/assets/js/211.151e9b9d.js"><link rel="prefetch" href="/assets/js/212.71180716.js"><link rel="prefetch" href="/assets/js/213.51619953.js"><link rel="prefetch" href="/assets/js/214.429e343a.js"><link rel="prefetch" href="/assets/js/215.6756a5f3.js"><link rel="prefetch" href="/assets/js/216.80157e3d.js"><link rel="prefetch" href="/assets/js/217.ad2ee185.js"><link rel="prefetch" href="/assets/js/218.9a2227e2.js"><link rel="prefetch" href="/assets/js/219.4a481036.js"><link rel="prefetch" href="/assets/js/22.3c886732.js"><link rel="prefetch" href="/assets/js/220.2755819b.js"><link rel="prefetch" href="/assets/js/221.eaf3b72d.js"><link rel="prefetch" href="/assets/js/222.2e8e35f6.js"><link rel="prefetch" href="/assets/js/223.e30cfe04.js"><link rel="prefetch" href="/assets/js/224.b0d20021.js"><link rel="prefetch" href="/assets/js/225.e5b384ab.js"><link rel="prefetch" href="/assets/js/226.6cb82a32.js"><link rel="prefetch" href="/assets/js/227.11dcf13c.js"><link rel="prefetch" href="/assets/js/228.d7cb8290.js"><link rel="prefetch" href="/assets/js/229.604c5bef.js"><link rel="prefetch" href="/assets/js/23.967e9d37.js"><link rel="prefetch" href="/assets/js/230.ada44e25.js"><link rel="prefetch" href="/assets/js/231.0beb6dff.js"><link rel="prefetch" href="/assets/js/232.e65780bc.js"><link rel="prefetch" href="/assets/js/233.9a4adcc1.js"><link rel="prefetch" href="/assets/js/24.fe797262.js"><link rel="prefetch" href="/assets/js/25.bdc4ca8f.js"><link rel="prefetch" href="/assets/js/26.974d2ac9.js"><link rel="prefetch" href="/assets/js/27.15397e64.js"><link rel="prefetch" href="/assets/js/28.61b607d7.js"><link rel="prefetch" href="/assets/js/29.b80e5b6e.js"><link rel="prefetch" href="/assets/js/30.975e57e8.js"><link rel="prefetch" href="/assets/js/31.26406726.js"><link rel="prefetch" href="/assets/js/32.cbcd2285.js"><link rel="prefetch" href="/assets/js/33.166438b9.js"><link rel="prefetch" href="/assets/js/34.7796e6be.js"><link rel="prefetch" href="/assets/js/35.34c73735.js"><link rel="prefetch" href="/assets/js/36.a429e2b5.js"><link rel="prefetch" href="/assets/js/37.298a3521.js"><link rel="prefetch" href="/assets/js/38.cf75ecd2.js"><link rel="prefetch" href="/assets/js/39.30f4d444.js"><link rel="prefetch" href="/assets/js/4.d1b60869.js"><link rel="prefetch" href="/assets/js/40.9dbbfc6b.js"><link rel="prefetch" href="/assets/js/41.617e7b90.js"><link rel="prefetch" href="/assets/js/42.2154fe51.js"><link rel="prefetch" href="/assets/js/43.3a331797.js"><link rel="prefetch" href="/assets/js/44.723b6724.js"><link rel="prefetch" href="/assets/js/45.22bea704.js"><link rel="prefetch" href="/assets/js/46.788ed0bd.js"><link rel="prefetch" href="/assets/js/47.969fa09d.js"><link rel="prefetch" href="/assets/js/48.87803ac5.js"><link rel="prefetch" href="/assets/js/49.71d8b5e6.js"><link rel="prefetch" href="/assets/js/5.70a5b3a8.js"><link rel="prefetch" href="/assets/js/50.ccfd0dad.js"><link rel="prefetch" href="/assets/js/51.796e7c34.js"><link rel="prefetch" href="/assets/js/52.9fbf4c76.js"><link rel="prefetch" href="/assets/js/53.76e96071.js"><link rel="prefetch" href="/assets/js/54.b8fb79af.js"><link rel="prefetch" href="/assets/js/55.6d8658b6.js"><link rel="prefetch" href="/assets/js/56.60eb9e34.js"><link rel="prefetch" href="/assets/js/57.2cca20a8.js"><link rel="prefetch" href="/assets/js/58.46f3cae7.js"><link rel="prefetch" href="/assets/js/59.fe54db8f.js"><link rel="prefetch" href="/assets/js/6.80c9dd98.js"><link rel="prefetch" href="/assets/js/60.b2089772.js"><link rel="prefetch" href="/assets/js/61.4faf2284.js"><link rel="prefetch" href="/assets/js/62.08566735.js"><link rel="prefetch" href="/assets/js/63.11f76d0c.js"><link rel="prefetch" href="/assets/js/64.d7bc172d.js"><link rel="prefetch" href="/assets/js/65.0c4e2b47.js"><link rel="prefetch" href="/assets/js/66.90c12a4b.js"><link rel="prefetch" href="/assets/js/67.bbd14a2b.js"><link rel="prefetch" href="/assets/js/68.7996c209.js"><link rel="prefetch" href="/assets/js/69.72dec4e3.js"><link rel="prefetch" href="/assets/js/7.38dce10d.js"><link rel="prefetch" href="/assets/js/70.4162a659.js"><link rel="prefetch" href="/assets/js/71.f846889d.js"><link rel="prefetch" href="/assets/js/72.2e13af20.js"><link rel="prefetch" href="/assets/js/73.ca5f827f.js"><link rel="prefetch" href="/assets/js/74.53696e66.js"><link rel="prefetch" href="/assets/js/75.42777466.js"><link rel="prefetch" href="/assets/js/76.cfecbecc.js"><link rel="prefetch" href="/assets/js/77.e7ff11d6.js"><link rel="prefetch" href="/assets/js/78.5266a05e.js"><link rel="prefetch" href="/assets/js/79.978f3b7c.js"><link rel="prefetch" href="/assets/js/8.56ca7763.js"><link rel="prefetch" href="/assets/js/80.94c50059.js"><link rel="prefetch" href="/assets/js/81.569dc7ea.js"><link rel="prefetch" href="/assets/js/82.4b5066ba.js"><link rel="prefetch" href="/assets/js/83.f3f31f7a.js"><link rel="prefetch" href="/assets/js/84.1a549643.js"><link rel="prefetch" href="/assets/js/85.20665980.js"><link rel="prefetch" href="/assets/js/86.f9cc6991.js"><link rel="prefetch" href="/assets/js/87.09b5a336.js"><link rel="prefetch" href="/assets/js/88.dadbb31d.js"><link rel="prefetch" href="/assets/js/89.329f34e9.js"><link rel="prefetch" href="/assets/js/9.e7e61cf2.js"><link rel="prefetch" href="/assets/js/90.b9befd81.js"><link rel="prefetch" href="/assets/js/91.dca97a2c.js"><link rel="prefetch" href="/assets/js/92.a77b4fcc.js"><link rel="prefetch" href="/assets/js/93.87ec43be.js"><link rel="prefetch" href="/assets/js/94.cffe2bfc.js"><link rel="prefetch" href="/assets/js/95.d79e30ed.js"><link rel="prefetch" href="/assets/js/96.12cc7d16.js"><link rel="prefetch" href="/assets/js/97.0790a0e6.js"><link rel="prefetch" href="/assets/js/98.38e032d0.js"><link rel="prefetch" href="/assets/js/99.3d622fc5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cdd53b27.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="某不知名博客" class="logo"> <span class="site-name can-hide">某不知名博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><!----> <span class="title" style="display:;">文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/vulcat/" class="nav-link">《vulcat文档》</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="个人学习历程" class="dropdown-title"><!----> <span class="title" style="display:;">个人学习历程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>云原生安全</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/cloud-native-security/docker/command-lists/" class="nav-link">《Docker命令大全》</a></li><li class="dropdown-subitem"><a href="/cloud-native-security/kubernetes/cks/" class="nav-link">《CKS考试学习指南》</a></li><li class="dropdown-subitem"><a href="/cloud-native-security/kubernetes/preface/" class="nav-link">《旧-Kubernetes教程》</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/vuln-db/" class="nav-link">漏洞库</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="知识库" class="dropdown-title"><a href="/knowledge/" class="link-title">知识库</a> <span class="title" style="display:none;">知识库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/knowledge/tools/homepage/" class="nav-link">《渗透工具大全》</a></li><li class="dropdown-item"><!----> <a href="/knowledge/cloud-security/concept/" class="nav-link">《云安全》</a></li></ul></div></div><div class="nav-item"><a href="/security-events/" class="nav-link">事件库</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/carsaid/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://avatars.githubusercontent.com/u/78483995"> <div class="blogger-info"><h3>Carsaid</h3> <span>安全界的小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><!----> <span class="title" style="display:;">文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/vulcat/" class="nav-link">《vulcat文档》</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="个人学习历程" class="dropdown-title"><!----> <span class="title" style="display:;">个人学习历程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>云原生安全</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/cloud-native-security/docker/command-lists/" class="nav-link">《Docker命令大全》</a></li><li class="dropdown-subitem"><a href="/cloud-native-security/kubernetes/cks/" class="nav-link">《CKS考试学习指南》</a></li><li class="dropdown-subitem"><a href="/cloud-native-security/kubernetes/preface/" class="nav-link">《旧-Kubernetes教程》</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/vuln-db/" class="nav-link">漏洞库</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="知识库" class="dropdown-title"><a href="/knowledge/" class="link-title">知识库</a> <span class="title" style="display:none;">知识库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/knowledge/tools/homepage/" class="nav-link">《渗透工具大全》</a></li><li class="dropdown-item"><!----> <a href="/knowledge/cloud-security/concept/" class="nav-link">《云安全》</a></li></ul></div></div><div class="nav-item"><a href="/security-events/" class="nav-link">事件库</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/carsaid/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前言</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>学习建议</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/cloud-native-security/docker/command-lists/" class="sidebar-link">Docker命令大全</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Kubernetes教程</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/cloud-native-security/kubernetes/preface/" class="sidebar-link">Kubernetes（K8s）学习教程 - 前言</a></li><li><a href="/cloud-native-security/kubernetes/01/" class="sidebar-link">第1章-Kubernetes集群部署</a></li><li><a href="/cloud-native-security/kubernetes/02/" class="sidebar-link">第2章-便捷性设置以及集群插件的安装</a></li><li><a href="/cloud-native-security/kubernetes/03/" class="sidebar-link">第3章-基础操作</a></li><li><a href="/cloud-native-security/kubernetes/04/" class="sidebar-link">第4章-集群升级</a></li><li><a href="/cloud-native-security/kubernetes/05/" class="sidebar-link">第5章-Pod</a></li><li><a href="/cloud-native-security/kubernetes/06/" aria-current="page" class="active sidebar-link">第6章-Pod生命周期与资源限制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/cloud-native-security/kubernetes/06/#_1-pod生命周期" class="sidebar-link">1. Pod生命周期</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#_1-1-概念" class="sidebar-link">1.1 概念</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/06/#_1-生命周期" class="sidebar-link">（1）生命周期</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/06/#_2-pod延期删除" class="sidebar-link">（2）Pod延期删除</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#_1-2-指定宽限期" class="sidebar-link">1.2 指定宽限期</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/cloud-native-security/kubernetes/06/#_2-pod-hook-钩子" class="sidebar-link">2 Pod hook（钩子）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#_2-1-钩子概念" class="sidebar-link">2.1 钩子概念</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#prestop钩子-结束钩子" class="sidebar-link">preStop钩子（结束钩子）</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#poststart钩子-启动钩子" class="sidebar-link">postStart钩子（启动钩子）</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/06/#_1-poststart正常运行" class="sidebar-link">（1）postStart正常运行</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/06/#_2-poststart运行错误" class="sidebar-link">（2）postStart运行错误</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/06/#_3-poststart阻塞" class="sidebar-link">（3）postStart阻塞</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#_2-4-钩子练习" class="sidebar-link">2.4 钩子练习</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/cloud-native-security/kubernetes/06/#_3-pod资源限制" class="sidebar-link">3. Pod资源限制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#_3-1-resources参数" class="sidebar-link">3.1 resources参数</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/06/#cpu-内存计量单位" class="sidebar-link">CPU/内存计量单位</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#_3-2-测试资源限制有效性" class="sidebar-link">3.2 测试资源限制有效性</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/06/#_1-下载容器镜像" class="sidebar-link">（1）下载容器镜像</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/06/#_2-下载cpu-内存压力测试工具" class="sidebar-link">（2）下载CPU/内存压力测试工具</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/06/#_3-没有资源限制时的压力测试" class="sidebar-link">（3）没有资源限制时的压力测试</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/06/#_4-存在资源限制时的压力测试" class="sidebar-link">（4）存在资源限制时的压力测试</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/cloud-native-security/kubernetes/06/#_4-通过limitrange进行资源限制" class="sidebar-link">4. 通过LimitRange进行资源限制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#_4-1-创建一个limitrange" class="sidebar-link">4.1 创建一个LimitRange</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#_4-2-删除limitrange" class="sidebar-link">4.2 删除LimitRange</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#_4-3-limitrange作用范围" class="sidebar-link">4.3 LimitRange作用范围</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#_4-4-limitrange作用对象" class="sidebar-link">4.4 LimitRange作用对象</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/cloud-native-security/kubernetes/06/#_5-通过resourcequota实现资源调度上限" class="sidebar-link">5. 通过ResourceQuota实现资源调度上限</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#_5-1-创建一个resourcequota" class="sidebar-link">5.1 创建一个ResourceQuota</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#_5-2-删除resourcequota" class="sidebar-link">5.2 删除ResourceQuota</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#_5-3-resourcequota作用范围" class="sidebar-link">5.3 ResourceQuota作用范围</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/cloud-native-security/kubernetes/06/#_6-kubectl-explain命令" class="sidebar-link">6. kubectl explain命令</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#_6-1-yaml文件的参数复杂性" class="sidebar-link">6.1 yaml文件的参数复杂性</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/06/#_6-2-yaml配置参数查询" class="sidebar-link">6.2 yaml配置参数查询</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/cloud-native-security/kubernetes/06/#_7-小结" class="sidebar-link">7. 小结</a></li></ul></li><li><a href="/cloud-native-security/kubernetes/07/" class="sidebar-link">第7章-Pod与节点</a></li><li><a href="/cloud-native-security/kubernetes/08/" class="sidebar-link">第8章-控制器Deployment</a></li><li><a href="/cloud-native-security/kubernetes/09/" class="sidebar-link">第9章-Deployment镜像变更和滚动更新</a></li><li><a href="/cloud-native-security/kubernetes/10/" class="sidebar-link">第10章-其他控制器-以及标签表达式</a></li><li><a href="/cloud-native-security/kubernetes/11/" class="sidebar-link">第11章-控制器与节点驱逐</a></li><li><a href="/cloud-native-security/kubernetes/999/" class="sidebar-link">暂缓更新</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>练习题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>常用命令及yaml配置</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CKS教程</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/cloud-native-security/#云原生安全" data-v-06225672>云原生安全</a></li><li data-v-06225672><a href="/cloud-native-security/#Kubernetes教程" data-v-06225672>Kubernetes教程</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/carsaid" target="_blank" title="作者" class="beLink" data-v-06225672>carsaid</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-11-05</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">第6章-Pod生命周期与资源限制<!----></h1>  <div class="theme-vdoing-content content__default"><div class="cardListContainer"><div class="card-list"><span class="card-item row-2" style="background-color:#F0DFB1;--random-color:#F0DFB1;color:#1078E6;"><div><p class="name">原创</p> <p class="desc">本博客原创文章，转载请注明出处</p></div></span></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 原创
  <span class="token key atrule">desc</span><span class="token punctuation">:</span> 本博客原创文章，转载请注明出处
  <span class="token key atrule">bgColor</span><span class="token punctuation">:</span> <span class="token string">'#F0DFB1'</span>
  <span class="token key atrule">textColor</span><span class="token punctuation">:</span> <span class="token string">'#1078E6'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div><h1 id="第6章-pod生命周期与资源限制"><a href="#第6章-pod生命周期与资源限制" class="header-anchor">#</a> 第6章-Pod生命周期与资源限制</h1> <table><thead><tr><th>本章要点</th></tr></thead> <tbody><tr><td>Pod 的生命周期（lifecycle）和钩子的使用</td></tr> <tr><td>Pod 的资源限制</td></tr> <tr><td>创建和删除 LimitRange</td></tr> <tr><td>创建和删除 ResourceQuota</td></tr></tbody></table> <h2 id="_1-pod生命周期"><a href="#_1-pod生命周期" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>1</span>1. Pod生命周期</h2> <h3 id="_1-1-概念"><a href="#_1-1-概念" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>1.1</span>1.1 概念</h3> <h4 id="_1-生命周期"><a href="#_1-生命周期" class="header-anchor">#</a> （1）生命周期</h4> <p>当 Pod 成功运行容器的那一刻起，这个 Pod 的生命周期就开始了，这是创建和启动 Pod。</p> <p>当 Pod 中的所有容器都终止运行了，那么这个 Pod 的生命周期也就结束了，这是停止和删除 Pod。</p> <h4 id="_2-pod延期删除"><a href="#_2-pod延期删除" class="header-anchor">#</a> （2）Pod延期删除</h4> <p>有时，删除 Pod 的时候如果不添加<code>--force</code>（强制删除）选项的话，删除 Pod 的时间就会明显变长。这是因为 k8s 在删除 Pod 的时候会有一个<b>延迟删除期</b>（<b>宽限期</b>），宽限的时间一般为<code>30</code>秒。</p> <p>（第一次画图，有点潦草，请见谅）</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/01.png" alt="Not Found Image"> <p>一个 Pod 正在处理某些任务，此时你发出了删除命令，有宽限期的情况下：</p> <ul><li>这个 Pod 并不会被立即删除，它的状态会被标记为 “terminating”</li> <li>然后等待这个 Pod 继续将手头上的任务处理完成</li> <li>如果在 30 秒内完成处理，则 Pod 会被自动删除</li> <li>如果处理超过了 30 秒，则 Pod 会被强制删除</li></ul> <p>如果没有宽限期：</p> <ul><li>这个 Pod 会被立即删除，而不管它是否正在处理任务</li> <li>可能会造成连接中断、数据丢失等影响</li></ul> <p>前者被称为 “优雅地删除 Pod”，后者被称为 “粗暴地删除 Pod”。作为一个优秀的 k8s 工程师，当然是想要前者了。</p> <div class="custom-block note"><p class="custom-block-title">学习更多</p> <p><a href="https://juejin.cn/post/7032577879712104456" target="_blank" rel="noopener noreferrer">什么是优雅关闭？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>举个例子：</p> <ul><li>优雅地关闭：通过 “关机” 按钮来关闭计算机</li> <li>粗暴地关闭：直接拔电源 或者 拆掉电池</li></ul></div> <h3 id="_1-2-指定宽限期"><a href="#_1-2-指定宽限期" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>1.2</span>1.2 指定宽限期</h3> <p>在创建 Pod 的 yaml 文件中，你可以通过<code>spec.terminationGracePeriodSeconds</code>参数来指定宽限时间，单位是 “秒”。</p> <p>（吐槽：这参数的名称为啥那么长，不好记啊）</p> <p>以下 yaml 文件指定宽限时间为 15 秒（默认为 30 秒），</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">...</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">15</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> alpine
	<span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;sh&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;-c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;echo hello &amp;&amp; sleep 9999&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">...</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>以上 Pod 在创建之后，会通过<code>echo</code>命令打印字符串 “hello”，然后通过<code>sleep</code>命令休眠 9999 秒。这意味着该 Pod 会在 9999 秒后终止，但是这超过了 15 秒的宽限时间，所以这个 Pod 会被强制删除。</p> <p>此外，如果你将宽限期设置为零的话（<code>spec.terminationGracePeriodSeconds: 0</code>），意味着没有宽限期（禁用宽限期），这会导致 Pod 被立即删除。</p> <h2 id="_2-pod-hook-钩子"><a href="#_2-pod-hook-钩子" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>2</span>2 Pod hook（钩子）</h2> <h3 id="_2-1-钩子概念"><a href="#_2-1-钩子概念" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>2.1</span>2.1 钩子概念</h3> <p>虽然可以为 Pod 指定宽限期，实现 “优雅地删除 Pod”。</p> <p>但是，某些运行在 Pod 中的服务进程，并不会使用这个宽限期。</p> <p>拿<code>nginx</code>容器来说，由于 nginx 进程处理信号的方式和 k8s 的处理方式不太一样，所以当你向 nginx 容器发出删除信号时，Pod 中的 nginx 进程会很快关闭，Pod 也会被直接删除。这个 Pod 并不会使用 k8s 提供的宽限期，由此造成了一个 “粗暴地删除 Pod”。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/02.png" alt="Not Found Image"> <p>nginx 容器通常用于处理客户端连接，如果在处理任务时被粗暴删除，则客户端可能会访问报错。而钩子可用于解决这类问题。</p> <p>在 Pod 生命周期中，k8s 提供了两个钩子：<code>postStart</code>和<code>preStop</code>。两个钩子在 yaml 文件中的参数路径：</p> <ul><li><code>spec.containers.lifecycle.postStart</code></li> <li><code>spec.containers.lifecycle.preStop</code></li></ul> <h3 id="prestop钩子-结束钩子"><a href="#prestop钩子-结束钩子" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>2.2</span>preStop钩子（结束钩子）</h3> <p>preStop 钩子会在容器关闭<b>之前</b>运行，只有当 preStop 运行完毕，容器/Pod 才会被关闭和删除。</p> <ul><li>preStop 中的任务也必须在延迟删除期（宽限期）之前完成处理，否则 Pod 一样会被强制删除</li></ul> <div class="custom-block note"><p class="custom-block-title">学习更多</p> <p><a href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/#discussion" target="_blank" rel="noopener noreferrer">官方文档中关于 preStop 的讨论<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <p>使用 preStop 钩子可以解决 “nginx容器无法优雅关闭” 的问题。</p> <p>创建以下 yaml 文件：</p> <ul><li><code>spec.containers.lifecycle.preStop</code>用于设置容器生命周期中的 preStop 钩子</li> <li><code>preStop.exec</code>：钩子要处理的任务项</li> <li><code>preStop.exec.command</code>：通过钩子在容器中执行命令，这和<code>spec.containers.command</code>是一样的</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> prestop<span class="token punctuation">-</span>pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">180</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">name</span><span class="token punctuation">:</span> prestop<span class="token punctuation">-</span>pod
    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
      <span class="token key atrule">preStop</span><span class="token punctuation">:</span>
        <span class="token key atrule">exec</span><span class="token punctuation">:</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'/usr/sbin/nginx -s quit'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>以上钩子在容器关闭之前运行命令<code>sh -c /usr/sbin/nginx -s quit</code>，这里直接通过 nginx 可执行程序运行了 “quit”（退出）指令，是一种优雅关闭 nginx 服务的方式。</p> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>退出命令<code>nginx -s quit</code>运行之后，会等待 nginx 处理完现有任务，然后再关闭 nginx 进程。</p> <p>除此之外，还有一个退出命令<code>nginx -s stop</code>（快速关闭 nginx），这是一种粗暴关闭 nginx 的方式，因为该命令不会等待 nginx，而是直接关闭它。</p></div> <p>创建这个 Pod。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/03.png" alt="Not Found Image"> <p>当你删除这个 Pod 的时候：</p> <ul><li>Pod 的状态会被标记为 “terminating”</li> <li>删除信号发送至 preStop 钩子，命令<code>sh -c /usr/sbin/nginx -s quit</code>会被执行</li> <li><code>nginx -s quit</code>执行后，会等待 nginx 处理完手头上的任务，然后再关闭 nginx 进程</li> <li>nginx 进程被关闭后，preStop 钩子的使命也完成了，Pod 会被继续删除</li></ul> <p>宽限期可以尽量设置的高一点（此处为 180 秒），好让 preStop 钩子有足够的时间去处理任务。</p> <h3 id="poststart钩子-启动钩子"><a href="#poststart钩子-启动钩子" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>2.3</span>postStart钩子（启动钩子）</h3> <p>postStart 钩子会在容器创建<b>之后</b>，跟随容器主进程一同运行，没有先后顺序之分（两者异步运行）。postStart 钩子有点类似于初始化容器，但它们有不同点。</p> <div class="custom-block note"><p class="custom-block-title">学习更多</p> <p><a href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/#discussion" target="_blank" rel="noopener noreferrer">官方文档中关于 postStart 的讨论<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <h4 id="_1-poststart正常运行"><a href="#_1-poststart正常运行" class="header-anchor">#</a> （1）postStart正常运行</h4> <p>创建以下 yaml 文件：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> poststart<span class="token punctuation">-</span>pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">name</span><span class="token punctuation">:</span> poststart<span class="token punctuation">-</span>pod
    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
      <span class="token key atrule">postStart</span><span class="token punctuation">:</span>
        <span class="token key atrule">exec</span><span class="token punctuation">:</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'echo &quot;Hello k8s, I am postStart&quot; &gt; /opt/hello.txt'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>以上钩子在容器启动的同时，使用<code>echo</code>命令将字符串 “Hello k8s, I am postStart” 输出到文件<code>/opt/hello.txt</code>中。</p> <p>创建 Pod 之后，通过<code>kubectl exec</code>获取容器的终端，在<code>/opt</code>目录下可以找到所生成的文件。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/04.png" alt="Not Found Image"> <p>这和初始化容器不太一样，初始化容器在普通容器之前运行，并且拥有一个独立的容器来运行初始化任务。只有当初始化容器全部完成运行，普通容器才会被创建和启动。初始化完毕后，初始化容器会被删除。</p> <p>postStart 钩子和当前容器一起被创建出来，并且和主进程一起在普通容器中运行，所做的操作和更改 会应用到当前容器中。</p> <h4 id="_2-poststart运行错误"><a href="#_2-poststart运行错误" class="header-anchor">#</a> （2）postStart运行错误</h4> <p>如果 postStart 钩子运行出错会发生什么？这里我故意将<code>echo</code>命令打错成<code>ehco</code>：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># poststart-error.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> poststart<span class="token punctuation">-</span>error
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">name</span><span class="token punctuation">:</span> poststart<span class="token punctuation">-</span>error
    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
      <span class="token key atrule">postStart</span><span class="token punctuation">:</span>
        <span class="token key atrule">exec</span><span class="token punctuation">:</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'ehco &quot;Hello k8s, I am postStart&quot; &gt; /opt/hello.txt'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>创建 Pod 后可以看到状态为 “PostStartHookError”（postStart钩子错误），由于 Pod 重启策略默认为 “Always”（遇到错误时总是重启），所以 Pod 会一直通过重启来试图解决错误。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/05.png" alt="Not Found Image"> <p>你以为我会说 “这和初始化容器一样”？</p> <p>其实不一样，还是有根本上的区别：</p> <ul><li>初始化容器 单独创建另一个容器 来执行任务，如果<b>初始化容器运行出错</b>，则后续的普通容器<b>不会</b>被创建和启动</li> <li>创建普通容器之后，postStart 会和主进程一起异步运行，由于 postStart 是在当前容器中执行的，所以 postStart 运行出错意味着<b>普通容器运行出错</b>。此时的容器其实<b>已经</b>被创建出来了，只不过运行期间出现了错误</li></ul> <h4 id="_3-poststart阻塞"><a href="#_3-poststart阻塞" class="header-anchor">#</a> （3）postStart阻塞</h4> <p>postStart 处理函数与容器的代码是异步执行的，但 Kubernetes 的容器管理逻辑会一直阻塞等待 postStart 处理函数执行完毕。只有 postStart 处理函数执行完毕，容器的状态才会变成 RUNNING。</p> <p>以上是官方文档中的一段话，我们通过以下 yaml 文件来验证这段话：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># poststart-sleep.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> poststart<span class="token punctuation">-</span>sleep
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">name</span><span class="token punctuation">:</span> poststart<span class="token punctuation">-</span>sleep
    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
      <span class="token key atrule">postStart</span><span class="token punctuation">:</span>
        <span class="token key atrule">exec</span><span class="token punctuation">:</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'sleep 15'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>以上钩子会在容器创建之后，使用<code>sleep</code>命令休眠 15 秒。</p> <p>从图中可以看到，在 15s 之前，Pod 状态为 “ContainerCreating”（容器创建），说明 k8s 正在等待 postStart 执行完毕。</p> <p>而在 15s 后，也就是 postStart 执行完毕之后，Pod 状态正常变为了 “RUNNING”。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/06.png" alt="Not Found Image"> <p>也是和初始化容器不太一样：</p> <ul><li>初始化容器没有运行完毕，则普通容器不会被创建和运行</li> <li>postStart 没有运行完毕，此时普通容器已经被创建，但它的状态会停留在 “ContainerCreating”，当 postStart 运行完毕之后才会变为 “RUNNING”。</li></ul> <h3 id="_2-4-钩子练习"><a href="#_2-4-钩子练习" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>2.4</span>2.4 钩子练习</h3> <p>以上两个钩子可以结合使用，下面来做个练习。</p> <p>创建以下 yaml 文件：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>life
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">120</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>life
    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
      <span class="token key atrule">postStart</span><span class="token punctuation">:</span>
        <span class="token key atrule">exec</span><span class="token punctuation">:</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'echo &quot;&lt;h1&gt;Hello nginx! I am postStart.&lt;/h1&gt;&quot; &gt; /usr/share/nginx/html/index.html'</span><span class="token punctuation">]</span>
      <span class="token key atrule">preStop</span><span class="token punctuation">:</span>
        <span class="token key atrule">exec</span><span class="token punctuation">:</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'/usr/sbin/nginx -s quit'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>postStart 钩子使用<code>echo</code>将字符串 “Hello nginx! I am postStart.” 输出到 nginx 的默认首页文件当中，这将会覆盖默认的 Web 页面内容。</p> <p>preStop 钩子则在删除 Pod 之前，通过 nginx 可执行程序运行退出命令，以优雅地关闭 nginx 进程。此外还给予了 120s 的宽限期，使钩子有足够的时间去完成关闭任务。</p> <p>创建 Pod 之后，通过<code>-o wide</code>选项查看这个 Pod 的 IP 地址。然后使用<code>curl</code>命令发送一个 HTTP 请求，以访问网站首页。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/07.png" alt="Not Found Image"> <p>最后教你一招，通过 yaml 文件一次性删除多个 Pod：</p> <ul><li><code>.</code>点表示当前目录下的所有文件名称</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl delete <span class="token parameter variable">-f</span> <span class="token builtin class-name">.</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>删除过程中遇到的错误会被忽略，不会影响后续删除的执行。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/08.png" alt="Not Found Image"> <h2 id="_3-pod资源限制"><a href="#_3-pod资源限制" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>3</span>3. Pod资源限制</h2> <p>Pod 中运行的是容器，由于默认没有资源限制，容器会毫无节制地使用物理机中的 CPU 和内存等资源。由此一来，物理机很容易卡顿甚至宕机，这是一个安全隐患。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/01.png" alt="Not Found Image"> <h3 id="_3-1-resources参数"><a href="#_3-1-resources参数" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>3.1</span>3.1 resources参数</h3> <p>以下 yaml 文件展示了通过<code>resources.limits</code>参数进行资源限制：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># pod-re.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>re
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>re
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 500Mi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>这里需要注意 CPU 和内存的计量单位。</p> <h4 id="cpu-内存计量单位"><a href="#cpu-内存计量单位" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>3.1.1</span>CPU/内存计量单位</h4> <p>如果 CPU 不带单位，例如<code>cpu: 2</code>则表示两个 CPU 核心，如果带单位例如<code>cpu: 500m</code>则表示 500 个 CPU 微核心。</p> <ul><li>1 核心等于 1000 微核心</li> <li>500m 相当于 0.5 个核心，250m 相当于 0.25 个核心</li> <li>你也可以不指定单位，直接用<code>cpu: 0.5</code>表示半个核心。但官方推荐你使用<code>cpu: 500m</code>，因为这更加精细</li></ul> <p>对于内存，你可以使用十进制的计算机存储单位<code>E</code>、<code>P</code>、<code>T</code>、<code>G</code>、<code>M</code>、<code>k</code>，它们分别表示 EB、PB、TB、GB、MB 和 kB。还可以使用二进制的存储单位<code>Ei</code>、<code>Pi</code>、<code>Ti</code>、<code>Gi</code>、<code>Mi</code>、<code>Ki</code>，分别表示 EiB、PiB、TiB、GiB、MiB 和 KiB。</p> <p><b>内存单位中间的 “i” 有啥区别？</b>不知道你是否买过 U 盘，存储容量总是缺斤少两，其实是生产 U 盘的厂商，使用了一种和计算机不同的存储计量方式：</p> <ul><li>我们平时说的 GB 指的是十进制存储单位：<code>1GB=1000MB</code>。U 盘采用的就是十进制存储单位，一个<code>32GB</code>的 U 盘大小是<code>32000 MB</code></li> <li>而计算机使用的是 GiB 二进制存储单位：<code>1GiB=1024MiB</code>。如果有的话，一个<code>32GiB</code>的 U 盘大小应该为<code>32768 MiB</code></li></ul> <p><del>然后一堆借口，说会有损耗啥啥啥的，导致 32GB 的 U 盘最后只剩下二十多......</del></p> <p>在 k8s 中，推荐使用带 “i” 的单位，因为这兼容计算机存储标准，不容易缺斤少两和产生错误。在以上 yaml 文件中，将资源限制为了<code>100</code>个 CPU 微核心（<code>0.1</code>个核心）以及<code>500 MiB</code>的内存。</p> <div class="custom-block note"><p class="custom-block-title">学习更多</p> <ul><li><a href="https://kubernetes.io/zh-cn/docs/concepts/configuration/manage-resources-containers/#meaning-of-cpu" target="_blank" rel="noopener noreferrer">官方文档-CPU资源单位<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://kubernetes.io/zh-cn/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory" target="_blank" rel="noopener noreferrer">官方文档-内存资源单位<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <h3 id="_3-2-测试资源限制有效性"><a href="#_3-2-测试资源限制有效性" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>3.2</span>3.2 测试资源限制有效性</h3> <p>为了测试资源限制的有效性，我们待会创建一个 Pod，在其中安装并运行 CPU 和内存压力测试工具，看看资源限制是否生效。</p> <h4 id="_1-下载容器镜像"><a href="#_1-下载容器镜像" class="header-anchor">#</a> （1）下载容器镜像</h4> <p>这里使用的镜像是<code>centos</code>，因为需要通过 Centos 系统中的 rpm 包管理软件来安装内存测试工具。你可以通过以下命令 提前拉取该镜像：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 下载速度可能较慢, 需要耐心等待</span>
ctr <span class="token parameter variable">-n</span> k8s.io i pull docker.io/library/centos:latest
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/02.png" alt="Not Found Image"> <p>查看镜像是否存在。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>ctr <span class="token parameter variable">-n</span> k8s.io i <span class="token function">ls</span> <span class="token operator">|</span> <span class="token function">grep</span> centos
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/03.png" alt="Not Found Image"> <h4 id="_2-下载cpu-内存压力测试工具"><a href="#_2-下载cpu-内存压力测试工具" class="header-anchor">#</a> （2）下载CPU/内存压力测试工具</h4> <p>CPU 压力测试工具可以在此处下载：<a href="https://pkgs.org/download/stress" target="_blank" rel="noopener noreferrer">https://pkgs.org/download/stress<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>刚刚下载的镜像系统版本是 Centos 8，我的电脑架构是 x86，所以点击中间的 “Centos 8 --&gt; EPEL x86_64” 进入详情页。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/04.png" alt="Not Found Image"> <p>进入详情页后，在 “Download” 栏目中找到安装包下载链接。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/05.png" alt="Not Found Image"> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 下载到 master 节点中</span>
<span class="token function">wget</span> https://dl.fedoraproject.org/pub/epel/8/Everything/x86_64/Packages/s/stress-1.0.4-24.el8.x86_64.rpm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>内存压力测试工具：<a href="../memload-7.0-1.r29766.x86_64.rpm">点我下载</a></p> <p>此处使用的工具是 memload，这工具贼难找，也不知道是不是绝迹了。在我的博客上面留个备份吧，反正也不大（6.5 KB）。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 下载到 master 节点中</span>
<span class="token function">wget</span> https://carsaid.github.io/cloud-native-security/kubernetes/memload-7.0-1.r29766.x86_64.rpm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>将这两个工具下载到 master 主机上。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/06.png" alt="Not Found Image"> <h4 id="_3-没有资源限制时的压力测试"><a href="#_3-没有资源限制时的压力测试" class="header-anchor">#</a> （3）没有资源限制时的压力测试</h4> <p>先创建一个<b>没有</b>资源限制的 Pod：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># pod-undo.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>undo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> centos
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>undo
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'sleep 9999999'</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>创建 Pod，将两个工具安装包拷贝到容器中。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> pod-undo.yaml

kubectl <span class="token function">cp</span> ./stress-1.0.4-24.el8.x86_64.rpm pod-undo:/opt/
kubectl <span class="token function">cp</span> ./memload-7.0-1.r29766.x86_64.rpm pod-undo:/opt/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/07.png" alt="Not Found Image"> <p>进入容器，然后通过<code>rpm</code>命令安装两个工具。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pod-undo -- <span class="token function">bash</span>

<span class="token builtin class-name">cd</span> /opt
<span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> stress-1.0.4-24.el8.x86_64.rpm
<span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> memload-7.0-1.r29766.x86_64.rpm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/08.png" alt="Not Found Image"> <p>在容器中运行<code>memload</code>工具，消耗 800M 内存进行压力测试，这将会模拟一个算力计算。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>memload <span class="token number">800</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/09.png" alt="Not Found Image"> <p>由于运行压力测试工具期间，终端窗口无法动弹。所以此处另外开一个窗口并连接到 master 节点上，查看 Pod 负载信息。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl <span class="token function">top</span> pods
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>从图中可以看到，实际资源占用情况为<code>996</code>个 CPU 微核心和<code>814</code> MiB 的内存。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/10.png" alt="Not Found Image"> <p>回到前一个终端窗口，通过组合键<code>Ctrl+C</code>终止<code>memload</code>工具的运行。然后使用<code>stress</code>工具来消耗 8 个 CPU 核心（如果有那么多的话）进行压力测试。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>stress <span class="token parameter variable">--cpu</span> <span class="token number">8</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/11.png" alt="Not Found Image"> <p>切换至另一个终端窗口，查看 Pod 负载信息。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl <span class="token function">top</span> pods
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>占用了<code>1946</code>个 CPU 微核心，大约等同于 2 个 CPU 核心。我这台虚拟机也才 2 个核心啊......</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/12.png" alt="Not Found Image"> <p>切换至 Pod 所在的节点，通过<code>top</code>命令查看资源使用情况，发现 CPU 使用率高达<code>99.3%</code>。</p> <p>这要是一台真的服务器，估计早炸了。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/13.png" alt="Not Found Image"> <h4 id="_4-存在资源限制时的压力测试"><a href="#_4-存在资源限制时的压力测试" class="header-anchor">#</a> （4）存在资源限制时的压力测试</h4> <p>在原有 Pod 的基础上，添加<code>resources.limits</code>参数：</p> <ul><li>限制 CPU 使用上限为<code>300</code>个微核心，也就是<code>0.3</code>个 CPU</li> <li>限制内存使用上限为<code>500</code> MiB</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># pod-do.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>do
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> centos
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>do
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'sh'</span><span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'sleep 9999999'</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 300m
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 500Mi
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>创建 Pod，将两个工具安装包拷贝到容器中。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> pod-do.yaml

kubectl <span class="token function">cp</span> ./stress-1.0.4-24.el8.x86_64.rpm pod-do:/opt/
kubectl <span class="token function">cp</span> ./memload-7.0-1.r29766.x86_64.rpm pod-do:/opt/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/14.png" alt="Not Found Image"> <p>进入容器，然后通过<code>rpm</code>命令安装两个工具。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pod-do -- <span class="token function">bash</span>

<span class="token builtin class-name">cd</span> /opt
<span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> stress-1.0.4-24.el8.x86_64.rpm
<span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> memload-7.0-1.r29766.x86_64.rpm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/15.png" alt="Not Found Image"> <p>在 pod-do 中运行内存压力测试工具，消耗 800M 内存：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>memload <span class="token number">800</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>执行以上命令之后，你会发现一直提示 “Killed”，并且工具被自动中断。</p> <p>这说明工具<code>memload</code>无法申请到 800M 的内存，内存限制生效了。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/16.png" alt="Not Found Image"> <p>降低内存量，改为消耗 450M 内存：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>memload <span class="token number">450</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这次执行成功了。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/17.png" alt="Not Found Image"> <p>切换至另一个 master 连接窗口，查看 Pod 负载信息。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl <span class="token function">top</span> pods
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>你会发现 CPU 一直被限制在<code>300m</code>，没有前一个 Pod 那么高的使用率。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/18.png" alt="Not Found Image"> <p>同样是 CPU 杀手：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>stress <span class="token parameter variable">--cpu</span> <span class="token number">8</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/19.png" alt="Not Found Image"> <p>CPU 使用率还是乖乖地待在<code>300m</code>附近，没有严重超出。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/20.png" alt="Not Found Image"> <p>在 Pod 所处节点上运行<code>top</code>命令，查看主机资源使用率。CPU 使用率稳定徘徊在<code>16%</code>左右，没有之前那夸张的 90+% 了。</p> <p>成功通过<code>resources</code>参数限制了 Pod/容器 的资源使用上限。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/21.png" alt="Not Found Image"> <h2 id="_4-通过limitrange进行资源限制"><a href="#_4-通过limitrange进行资源限制" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>4</span>4. 通过LimitRange进行资源限制</h2> <p>虽然可以通过<code>resources.limits</code>参数对 Pod 进行资源限制，但是该参数需要单独为每个容器进行配置。Pod 数量一旦多起来，不仅配置繁琐、修改麻烦，还容易出错，工作量很大。</p> <p>有没有一种办法，我只需要设置一次资源限制，就能自动应用到所有 Pod 当中呢？</p> <p>这时候就需要用到 kubernetes 中的另一种资源类型：LimitRange</p> <h3 id="_4-1-创建一个limitrange"><a href="#_4-1-创建一个limitrange" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>4.1</span>4.1 创建一个LimitRange</h3> <p>LimitRange 并不是某个参数，而是 k8s 中一个单独的资源类型，它也需要通过 yaml 文件来创建：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># limit1.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> LimitRange
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> limit<span class="token punctuation">-</span>range<span class="token punctuation">-</span><span class="token number">1</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">limits</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">max</span><span class="token punctuation">:</span>
      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 400m
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Container
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>和 Pod 一样，参数<code>apiVersion</code>用于指定 LimitRange 的 API 版本，一般也是固定的<code>v1</code>。</p> <p><code>kind</code>指定了当前 yaml 文件所要创建的 k8s 资源类型，此处为<code>LimitRange</code>。</p> <p><code>metadata.name</code>是当前资源的名称。</p> <p><code>spec.limits.max</code>用于限制资源使用上限。</p> <p><code>spec.limits.type</code>表示当前 LimitRange 限制的对象是谁，此处为<code>Container</code>，意思是对 “容器” 施加资源限制。</p> <p>LimitRange 的创建方式和 Pod 一样：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> limit1.yaml

kubectl get limitranges
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/01.png" alt="Not Found Image"> <p>然后我们通过命令行创建一个 Pod，并在其中安装内存压力测试工具：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl run pod-test <span class="token parameter variable">--image</span> centos --image-pull-policy<span class="token operator">=</span>IfNotPresent -- <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">&quot;sleep 9999999&quot;</span>
kubectl <span class="token function">cp</span> memload-7.0-1.r29766.x86_64.rpm pod-test:/opt
kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pod-test -- <span class="token function">bash</span>

<span class="token builtin class-name">cd</span> /opt
<span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> memload-7.0-1.r29766.x86_64.rpm
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/02.png" alt="Not Found Image"> <p>尝试消耗 800M 内存，失败。改为消耗 480M 内存。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>memload <span class="token number">800</span>

memload <span class="token number">480</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/03.png" alt="Not Found Image"> <p>切换至另一个 master 终端窗口，查看 Pod 负载信息。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl <span class="token function">top</span> pods
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>CPU 使用率被限制在<code>400m</code>。</p> <p>成功通过 LimitRange 限制了容器的资源使用上限。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/04.png" alt="Not Found Image"> <h3 id="_4-2-删除limitrange"><a href="#_4-2-删除limitrange" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>4.2</span>4.2 删除LimitRange</h3> <p>如果在 Pod 已经创建的情况下，把 LimitRange 给删除，资源限制策略还会存在吗？</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl delete limitranges limit-range-1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/05.png" alt="Not Found Image"> <p>删除 LimitRange 之后，再次进入 pod-test 运行<code>memload</code>工具消耗 800M 内存。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>memload <span class="token number">800</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>结果你会发现，消耗 800M 失败了！</p> <p>那改为消耗 470M。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/06.png" alt="Not Found Image"> <p>查看 Pod 负载信息，发现 CPU 使用率依旧被限制在<code>400m</code>。</p> <p>这说明，即使 LimitRange 被删除了，之前创建的 Pod 依然会受到限制。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/07.png" alt="Not Found Image"> <p>然后我新创建了一个 Pod，并尝试消耗 800M 内存，成功了。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/08.png" alt="Not Found Image"> <p>资源使用率也同样是飙升。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/09.png" alt="Not Found Image"> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>当 LimitRange 存在时，每一个<b>新创建</b>的 Pod 都会被施加资源限制策略。即使该 LimitRange 之后被删除了，资源限制策略也会一直作用于这些 Pod。</p></div> <p>LimitRange 只会对<b>新创建</b>的 Pod 施加资源限制策略，在 LimitRange 创建之前已经存在的 Pod 不会被施加策略。</p> <p>如图所示，<code>pod-after</code>在 LimitRange 之前就已经创建，但依然能够消耗 800M 的内存。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/10.png" alt="Not Found Image"> <h3 id="_4-3-limitrange作用范围"><a href="#_4-3-limitrange作用范围" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>4.3</span>4.3 LimitRange作用范围</h3> <p>上面创建的 LimitRange 位于命名空间<code>default</code>，它能否作用于其他命名空间呢？</p> <p>此时，命名空间<code>default</code>中已经创建了一个名为<code>limit-range-1</code>的 LimitRange。</p> <p>然后，在命名空间<code>ns1</code>中创建一个名为<code>pod-ns1</code>的新 Pod，看看资源限制策略能否应用到该 Pod 中。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl run pod-ns1 <span class="token parameter variable">--image</span> centos --image-pull-policy<span class="token operator">=</span>IfNotPresent <span class="token parameter variable">-n</span> ns1 -- <span class="token function">sh</span> <span class="token parameter variable">-c</span> <span class="token string">'sleep 999999'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/11.png" alt="Not Found Image"> <p>在 Pod 中安装内存压力测试工具，并尝试消耗 800M 内存。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl <span class="token function">cp</span> <span class="token parameter variable">-n</span> ns1 memload-7.0-1.r29766.x86_64.rpm pod-ns1:/opt
kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-n</span> ns1 <span class="token parameter variable">-it</span> pod-ns1 -- <span class="token function">bash</span>

<span class="token builtin class-name">cd</span> /opt
<span class="token function">rpm</span> <span class="token parameter variable">-ivh</span> memload-7.0-1.r29766.x86_64.rpm
memload <span class="token number">800</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>消耗成功了。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/12.png" alt="Not Found Image"> <p>可以看到<code>pod-ns1</code>没有被施加资源限制策略。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/13.png" alt="Not Found Image"> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>LimitRange 只能对当前命名空间中的 k8s 资源施加限制策略，对其他命名空间不起效果。</p></div> <p>最后，删除这个 LimitRange，防止影响后续实验。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl delete <span class="token parameter variable">-f</span> limit1.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/14.png" alt="Not Found Image"> <h3 id="_4-4-limitrange作用对象"><a href="#_4-4-limitrange作用对象" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>4.4</span>4.4 LimitRange作用对象</h3> <p>在以上 yaml 文件中，我们通过<code>spec.limits.type: Container</code>指定了资源限制对象为 “容器”。</p> <p>除了容器之外，LimitRange 还可以用于限制其他 k8s 资源对象。这将在后续的章节中进行介绍。</p> <h2 id="_5-通过resourcequota实现资源调度上限"><a href="#_5-通过resourcequota实现资源调度上限" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>5</span>5. 通过ResourceQuota实现资源调度上限</h2> <p>参数<code>spec.containers.resources</code>用于限制单个容器中的资源使用上限。</p> <p>集群 LimitRange 用于在单个命名空间中，限制某个集群对象的资源使用上限。</p> <p>而 ResourceQuota 用于在单个命名空间中，限制某个集群对象的数量。</p> <h3 id="_5-1-创建一个resourcequota"><a href="#_5-1-创建一个resourcequota" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>5.1</span>5.1 创建一个ResourceQuota</h3> <p>多说无益，来看个示例吧。创建以下 yaml 文件：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># re-quota.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ResourceQuota
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> re<span class="token punctuation">-</span>quota
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hard</span><span class="token punctuation">:</span>
    <span class="token key atrule">pods</span><span class="token punctuation">:</span> <span class="token number">2</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>参数<code>apiVersion</code>和<code>metadata.name</code>应该很熟悉了吧，不多讲。</p> <p><code>kind</code>指定当前 yaml 文件所要创建的集群资源类型，此处为<code>ResourceQuota</code>。</p> <p><code>spec.hard</code>用于设置集群资源调度上限。参数<code>pods: 2</code>的意思是——当前命名空间中，最多只能存在 2 个 Pod。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 创建ResourceQuota</span>
kubectl apply <span class="token parameter variable">-f</span> re-quota.yaml

kubectl get resourcequotas
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到条目<code>pods: 0/2</code>，意思是当前命名空间存在<code>0</code>个 Pod，上限为<code>2</code>个 Pod。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resource-quota/01.png" alt="Not Found Image"> <p>通过命令行创建两个 Pod：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl run pod1 <span class="token parameter variable">--image</span> nginx --image-pull-policy<span class="token operator">=</span>IfNotPresent
kubectl run pod2 <span class="token parameter variable">--image</span> nginx --image-pull-policy<span class="token operator">=</span>IfNotPresent
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>此时<code>re-quota</code>的上限来到了<code>2/2</code>，如果再创建一个 Pod 会发生什么？</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resource-quota/02.png" alt="Not Found Image"> <p>说干就干，创建第三个 Pod。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl run pod3 <span class="token parameter variable">--image</span> nginx --image-pull-policy<span class="token operator">=</span>IfNotPresent
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>创建失败，超出了<code>re-quota</code>的配额，上限为<code>pods=2</code>（最多两个 Pod）。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resource-quota/03.png" alt="Not Found Image"> <h3 id="_5-2-删除resourcequota"><a href="#_5-2-删除resourcequota" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>5.2</span>5.2 删除ResourceQuota</h3> <p>删除<code>re-quota</code>，并创建第三个 Pod。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl delete <span class="token parameter variable">-f</span> re-quota.yaml

kubectl run pod3 <span class="token parameter variable">--image</span> nginx --image-pull-policy<span class="token operator">=</span>IfNotPresent
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resource-quota/04.png" alt="Not Found Image"> <p>此时已经有三个 Pod 存在，如果再次创建<code>re-quota</code>并把 Pod 上限设置为<code>2</code>个，会发生什么？</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> re-quota.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到条目<code>pods: 3/2</code>，Pod 的数量超出了配额，但是 Pod 依然正常运行。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resource-quota/05.png" alt="Not Found Image"> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>和 LimitRange 一样，ResourceQuota 只会作用于后续新创建的 Pod，不会对已创建的 Pod 造成影响。</p></div> <h3 id="_5-3-resourcequota作用范围"><a href="#_5-3-resourcequota作用范围" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>5.3</span>5.3 ResourceQuota作用范围</h3> <p>和 LimitRange 一样，ResourceQuota 只在单个命名空间中生效。</p> <p>如果你想在其他命名空间中实现资源配额，则需要在对应的命名空间中创建新的 ResourceQuota。你可以在 yaml 文件中添加<code>metadata.spacename</code>参数来实现。例如：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ResourceQuota
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> quota<span class="token punctuation">-</span>ns1
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> ns1
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hard</span><span class="token punctuation">:</span>
    <span class="token key atrule">pods</span><span class="token punctuation">:</span> <span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resource-quota/06.png" alt="Not Found Image"> <p>最后，记得删除这些 ResourceQuota，防止影响后续实验。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl delete <span class="token parameter variable">-f</span> re-quota.yaml

<span class="token comment"># 如果有的话</span>
kubectl delete <span class="token parameter variable">-f</span> quota-ns1.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="_6-kubectl-explain命令"><a href="#_6-kubectl-explain命令" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>6</span>6. kubectl explain命令</h2> <p>现在介绍这个命令正合时宜。</p> <h3 id="_6-1-yaml文件的参数复杂性"><a href="#_6-1-yaml文件的参数复杂性" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>6.1</span>6.1 yaml文件的参数复杂性</h3> <p>上一章学习了 Pod，以及通过 yaml 文件创建 Pod 的方式，一个简单的 yaml 文件可能看起来像这样：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">name</span><span class="token punctuation">:</span> pod<span class="token punctuation">-</span>test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>虽然看起来简单，但是创建 Pod 的参数可不止那么一点，诸如<code>metadata.labels</code>、<code>metadata.namespace</code>之类的参数可能会经常用到。还有本章刚刚才学习过的<code>spec.container.lifecycle</code>和<code>spec.containers.resources</code>。</p> <p>除了 Pod 之外，本章又学习了两个新的集群资源，它们的 yaml 文件长这样：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 一个LimitRange</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> LimitRange
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>limit
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">limits</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">max</span><span class="token punctuation">:</span>
      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 300m
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1Gi
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Container
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># 一个ResourceQuota</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ResourceQuota
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>quota
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">hard</span><span class="token punctuation">:</span>
    <span class="token key atrule">pods</span><span class="token punctuation">:</span> <span class="token number">3</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>随着学习的深入，接触的集群资源和 yaml 文件参数也越来越多。</p> <ul><li>对于一个资深 k8s 专家来说，也许他可以记住所有的配置参数。</li> <li>但对于一个刚入门的小白来说，如何记住这么庞大的内容呢？</li></ul> <p>多学？多背？多练？多写写 yaml 文件？</p> <h3 id="_6-2-yaml配置参数查询"><a href="#_6-2-yaml配置参数查询" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>6.2</span>6.2 yaml配置参数查询</h3> <p>其实 k8s 提供了一个命令<code>kubectl explain</code>，可以用来查询 yaml 配置参数。</p> <p>例如，我想知道一个 Pod 的 yaml 文件是由哪几个部分组成的，可以运行以下命令：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl explain pod
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>列出了五个字段，字段名称的右边标注了字段类型。例如<code>apiVersion</code>是一个字符串，<code>metadata</code>是一个对象，<code>spec</code>是 Pod 策略。</p> <p>而在字段的上方，k8s 很贴心地标注了<code>KIND: Pod</code>和<code>VERSION: v1</code>，以此来提醒你资源类型应该写成<code>Pod</code>，而 API 版本应该写成<code>v1</code>。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/kubectl-explain/01.png" alt="Not Found Image"> <p>如果我想看 Pod 的<code>spec</code>字段下面有什么呢？只需要用点<code>.</code>隔开每个字段即可，就像这样：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl explain pod.spec
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>和上个命令一样，列出了<code>spec</code>下的所有可用字段。在其中我们可以看到熟悉的<code>spec.containers</code>。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/kubectl-explain/02.png" alt="Not Found Image"> <p>既然提到了<code>spec.containers</code>，那不妨来看看容器的生命周期：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl explain pod.spec.containers.lifecycle
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>噢，原来在容器的生命周期中，可以使用<code>postStart</code>和<code>preStop</code>钩子呀，差点忘了。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/kubectl-explain/04.png" alt="Not Found Image"> <p>命令<code>kubectl explain</code>可以无限嵌套，只要存在这个字段：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl explain pod.spec.containers.lifecycle.postStart
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>你可能会看见许多陌生的字段，不用着急，这些字段在后续的章节中都会一一讲解，你将会逐步掌握它们。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/kubectl-explain/05.png" alt="Not Found Image"> <p>你可能已经发现了，命令的格式是这样的：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl explain <span class="token operator">&lt;</span>资源类型<span class="token operator">&gt;</span>.<span class="token operator">&lt;</span>字段<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>看看 LimitRange 的<code>spec.limits</code>字段。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/kubectl-explain/06.png" alt="Not Found Image"> <p>看看 ResourceQuota 的<code>metadata</code>字段</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/kubectl-explain/07.png" alt="Not Found Image"> <p>你不必特意花费大量的时间去记 yaml 参数，只需要掌握<code>kubectl explain</code>命令，然后多做做练习题就可以了。</p> <h2 id="_7-小结"><a href="#_7-小结" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>7</span>7. 小结</h2> <p>本章对 Pod 生命周期做了一个简单的认识，然后学习了钩子的使用方法。还通过 yaml 文件中的参数字段以及外部集群资源对 Pod 施加了资源限制。通过本章的学习，你应该掌握以下技能：</p> <ul><li>宽限期的设置</li> <li>“启动钩子” 和 “结束钩子” 的使用</li> <li>通过 yaml 文件中的<code>resources</code>对容器施加资源限制</li> <li>通过 LimitRange 对集群对象施加资源限制</li> <li>通过 ResourceQuota 对命名空间施加资源调度限制</li> <li>使用<code>kubectl explain</code>命令查看 yaml 参数字段</li></ul> <p>如果你准备好了，可以试着去完成一些练习（<a href="/cloud-native-security/kubernetes/practice/04/">练习题-4</a>）。</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/carsaid/edit/master/docs/06.云原生安全/25.Kubernetes教程/2532.第6章-Pod生命周期与资源限制.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/cloud-native-security/kubernetes/05/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">第5章-Pod</div></a> <a href="/cloud-native-security/kubernetes/07/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">第7章-Pod与节点</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/cloud-native-security/kubernetes/05/" class="prev">第5章-Pod</a></span> <span class="next"><a href="/cloud-native-security/kubernetes/07/">第7章-Pod与节点</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/cloud-native-security/kubernetes/cks/devopscube.com/use-audit-logs-to-monitor-access/"><div>
            使用审计日志监控访问
            <!----></div></a> <span class="date">12-06</span></dt></dl><dl><dd>02</dd> <dt><a href="/cloud-native-security/kubernetes/cks/devopscube.com/ensure-immutability-of-containers-at-runtime/"><div>
            确保容器在运行时的不可变性
            <!----></div></a> <span class="date">12-06</span></dt></dl><dl><dd>03</dd> <dt><a href="/cloud-native-security/kubernetes/cks/devopscube.com/perform-deep-analytical-investigation/"><div>
            调查和识别环境中的不良行为
            <!----></div></a> <span class="date">12-06</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/carsaid" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2023
    <span>Carsaid | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.e919b7aa.js" defer></script><script src="/assets/js/2.b3e685a4.js" defer></script><script src="/assets/js/19.23d067aa.js" defer></script><script src="/assets/js/3.a71cb994.js" defer></script>
  </body>
</html>
