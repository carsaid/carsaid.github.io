<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第8章-控制器Deployment | 某不知名博客</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="安全技术博客,专注安全领域学习与总结。渗透测试,工具开发,国外优秀安全文章翻译,知识库,漏洞库,全球安全事件统计等技术分享。">
    <meta name="keywords" content="漏洞猫,vulcat,个人技术博客,某不知名博客,安全团队,渗透测试,安全,网络安全,安全工具开发,云安全,学习,面试,Python,Golang,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.cdd53b27.css" as="style"><link rel="preload" href="/assets/js/app.6d8810e1.js" as="script"><link rel="preload" href="/assets/js/2.b3e685a4.js" as="script"><link rel="preload" href="/assets/js/21.10b4dc58.js" as="script"><link rel="preload" href="/assets/js/3.adb8ff64.js" as="script"><link rel="prefetch" href="/assets/js/10.00f092a3.js"><link rel="prefetch" href="/assets/js/100.979c27c0.js"><link rel="prefetch" href="/assets/js/101.99d8a752.js"><link rel="prefetch" href="/assets/js/102.f474f721.js"><link rel="prefetch" href="/assets/js/103.7c9d83c1.js"><link rel="prefetch" href="/assets/js/104.a2215e97.js"><link rel="prefetch" href="/assets/js/105.f0524c67.js"><link rel="prefetch" href="/assets/js/106.1b160ea1.js"><link rel="prefetch" href="/assets/js/107.1ba97c80.js"><link rel="prefetch" href="/assets/js/108.d348d44b.js"><link rel="prefetch" href="/assets/js/109.c18d1a5b.js"><link rel="prefetch" href="/assets/js/11.4dbe13dc.js"><link rel="prefetch" href="/assets/js/110.d203511e.js"><link rel="prefetch" href="/assets/js/111.4cbfa89a.js"><link rel="prefetch" href="/assets/js/112.98c3049e.js"><link rel="prefetch" href="/assets/js/113.9b3a83b6.js"><link rel="prefetch" href="/assets/js/114.66236686.js"><link rel="prefetch" href="/assets/js/115.b485e87e.js"><link rel="prefetch" href="/assets/js/116.c5b4f8a3.js"><link rel="prefetch" href="/assets/js/117.1bd7c5c2.js"><link rel="prefetch" href="/assets/js/118.be75d223.js"><link rel="prefetch" href="/assets/js/119.a2899673.js"><link rel="prefetch" href="/assets/js/12.ee84c5f8.js"><link rel="prefetch" href="/assets/js/120.89c02cf6.js"><link rel="prefetch" href="/assets/js/121.3813376d.js"><link rel="prefetch" href="/assets/js/122.7d16bb94.js"><link rel="prefetch" href="/assets/js/123.9c62e662.js"><link rel="prefetch" href="/assets/js/124.eb1a1bfd.js"><link rel="prefetch" href="/assets/js/125.c9b24746.js"><link rel="prefetch" href="/assets/js/126.83e29a51.js"><link rel="prefetch" href="/assets/js/127.33311ecc.js"><link rel="prefetch" href="/assets/js/128.db3830df.js"><link rel="prefetch" href="/assets/js/129.1e36ef7f.js"><link rel="prefetch" href="/assets/js/13.397cf062.js"><link rel="prefetch" href="/assets/js/130.aa054506.js"><link rel="prefetch" href="/assets/js/131.ca49aa84.js"><link rel="prefetch" href="/assets/js/132.01b3177f.js"><link rel="prefetch" href="/assets/js/133.f3e1f458.js"><link rel="prefetch" href="/assets/js/134.608c85c2.js"><link rel="prefetch" href="/assets/js/135.41f0022e.js"><link rel="prefetch" href="/assets/js/136.aaa4bdd9.js"><link rel="prefetch" href="/assets/js/137.6ece8897.js"><link rel="prefetch" href="/assets/js/138.a69631df.js"><link rel="prefetch" href="/assets/js/139.79d5a4d5.js"><link rel="prefetch" href="/assets/js/14.7d08f32b.js"><link rel="prefetch" href="/assets/js/140.3b7aba2c.js"><link rel="prefetch" href="/assets/js/141.503090cd.js"><link rel="prefetch" href="/assets/js/142.c53ae88c.js"><link rel="prefetch" href="/assets/js/143.48561ba5.js"><link rel="prefetch" href="/assets/js/144.82b7c665.js"><link rel="prefetch" href="/assets/js/145.fcb67137.js"><link rel="prefetch" href="/assets/js/146.4472526f.js"><link rel="prefetch" href="/assets/js/147.6b6d0f31.js"><link rel="prefetch" href="/assets/js/148.cf988b82.js"><link rel="prefetch" href="/assets/js/149.f4a141f6.js"><link rel="prefetch" href="/assets/js/15.1bbe497c.js"><link rel="prefetch" href="/assets/js/150.ce1b9d60.js"><link rel="prefetch" href="/assets/js/151.6349b6e8.js"><link rel="prefetch" href="/assets/js/152.98757ba9.js"><link rel="prefetch" href="/assets/js/153.949bb690.js"><link rel="prefetch" href="/assets/js/154.f328fe35.js"><link rel="prefetch" href="/assets/js/155.6c47f579.js"><link rel="prefetch" href="/assets/js/156.88e855bf.js"><link rel="prefetch" href="/assets/js/157.46c2041e.js"><link rel="prefetch" href="/assets/js/158.ea92ade4.js"><link rel="prefetch" href="/assets/js/159.dbb6caa4.js"><link rel="prefetch" href="/assets/js/16.823d0c7e.js"><link rel="prefetch" href="/assets/js/160.5b558835.js"><link rel="prefetch" href="/assets/js/161.7a605f44.js"><link rel="prefetch" href="/assets/js/162.b18d8fca.js"><link rel="prefetch" href="/assets/js/163.591a0254.js"><link rel="prefetch" href="/assets/js/164.2d8276a8.js"><link rel="prefetch" href="/assets/js/165.2ac7dc23.js"><link rel="prefetch" href="/assets/js/166.74a29f94.js"><link rel="prefetch" href="/assets/js/167.757501fc.js"><link rel="prefetch" href="/assets/js/168.2961cae1.js"><link rel="prefetch" href="/assets/js/169.a2d3f3f9.js"><link rel="prefetch" href="/assets/js/17.aed2ce3f.js"><link rel="prefetch" href="/assets/js/170.e2a6496c.js"><link rel="prefetch" href="/assets/js/171.b7a60c23.js"><link rel="prefetch" href="/assets/js/172.3f9ef4fe.js"><link rel="prefetch" href="/assets/js/173.632e8356.js"><link rel="prefetch" href="/assets/js/174.018b972d.js"><link rel="prefetch" href="/assets/js/175.c81ddf47.js"><link rel="prefetch" href="/assets/js/176.98d1b056.js"><link rel="prefetch" href="/assets/js/177.9db73282.js"><link rel="prefetch" href="/assets/js/178.b44da21c.js"><link rel="prefetch" href="/assets/js/179.d67e6595.js"><link rel="prefetch" href="/assets/js/18.339c7ec0.js"><link rel="prefetch" href="/assets/js/180.55513010.js"><link rel="prefetch" href="/assets/js/181.1986dd19.js"><link rel="prefetch" href="/assets/js/182.cabd8791.js"><link rel="prefetch" href="/assets/js/183.d4e9a543.js"><link rel="prefetch" href="/assets/js/184.d392a566.js"><link rel="prefetch" href="/assets/js/185.f101976a.js"><link rel="prefetch" href="/assets/js/186.7a1b862a.js"><link rel="prefetch" href="/assets/js/187.282b6fd6.js"><link rel="prefetch" href="/assets/js/188.dde1e7c6.js"><link rel="prefetch" href="/assets/js/189.1e711a5f.js"><link rel="prefetch" href="/assets/js/19.63b2d090.js"><link rel="prefetch" href="/assets/js/190.a022b842.js"><link rel="prefetch" href="/assets/js/191.f49a7780.js"><link rel="prefetch" href="/assets/js/192.59d4c163.js"><link rel="prefetch" href="/assets/js/193.b657dbd4.js"><link rel="prefetch" href="/assets/js/194.7c7c65e6.js"><link rel="prefetch" href="/assets/js/195.2bd41323.js"><link rel="prefetch" href="/assets/js/196.3112261f.js"><link rel="prefetch" href="/assets/js/197.a80566de.js"><link rel="prefetch" href="/assets/js/198.edd76152.js"><link rel="prefetch" href="/assets/js/199.30a66baf.js"><link rel="prefetch" href="/assets/js/20.10500d8d.js"><link rel="prefetch" href="/assets/js/200.25d3e98f.js"><link rel="prefetch" href="/assets/js/201.c55824db.js"><link rel="prefetch" href="/assets/js/202.351ffe25.js"><link rel="prefetch" href="/assets/js/203.b9fb8235.js"><link rel="prefetch" href="/assets/js/204.67111065.js"><link rel="prefetch" href="/assets/js/205.a8210e19.js"><link rel="prefetch" href="/assets/js/206.92aa4225.js"><link rel="prefetch" href="/assets/js/207.a7b40c0e.js"><link rel="prefetch" href="/assets/js/208.2ccdec72.js"><link rel="prefetch" href="/assets/js/22.4bf9ac80.js"><link rel="prefetch" href="/assets/js/23.c3eb10e7.js"><link rel="prefetch" href="/assets/js/24.6049e66b.js"><link rel="prefetch" href="/assets/js/25.740eae60.js"><link rel="prefetch" href="/assets/js/26.6508672a.js"><link rel="prefetch" href="/assets/js/27.b62436ba.js"><link rel="prefetch" href="/assets/js/28.0fcd8b09.js"><link rel="prefetch" href="/assets/js/29.cdf8e6e1.js"><link rel="prefetch" href="/assets/js/30.d746df2e.js"><link rel="prefetch" href="/assets/js/31.1658d987.js"><link rel="prefetch" href="/assets/js/32.cbcd2285.js"><link rel="prefetch" href="/assets/js/33.b47f9ed5.js"><link rel="prefetch" href="/assets/js/34.652f0348.js"><link rel="prefetch" href="/assets/js/35.34c73735.js"><link rel="prefetch" href="/assets/js/36.5b8a9240.js"><link rel="prefetch" href="/assets/js/37.7adb41e1.js"><link rel="prefetch" href="/assets/js/38.a5cc37a6.js"><link rel="prefetch" href="/assets/js/39.311ec358.js"><link rel="prefetch" href="/assets/js/4.d1b60869.js"><link rel="prefetch" href="/assets/js/40.f9bc911b.js"><link rel="prefetch" href="/assets/js/41.a6c06b2b.js"><link rel="prefetch" href="/assets/js/42.5b61ef0d.js"><link rel="prefetch" href="/assets/js/43.d880f6c0.js"><link rel="prefetch" href="/assets/js/44.0caecaed.js"><link rel="prefetch" href="/assets/js/45.4510b119.js"><link rel="prefetch" href="/assets/js/46.1a160be2.js"><link rel="prefetch" href="/assets/js/47.16b3ce9f.js"><link rel="prefetch" href="/assets/js/48.4f922b8f.js"><link rel="prefetch" href="/assets/js/49.71d8b5e6.js"><link rel="prefetch" href="/assets/js/5.0f529a65.js"><link rel="prefetch" href="/assets/js/50.22dc8142.js"><link rel="prefetch" href="/assets/js/51.1069fb04.js"><link rel="prefetch" href="/assets/js/52.f8e3caf4.js"><link rel="prefetch" href="/assets/js/53.bcf6fa24.js"><link rel="prefetch" href="/assets/js/54.3150717b.js"><link rel="prefetch" href="/assets/js/55.09a73d17.js"><link rel="prefetch" href="/assets/js/56.21f2c3bc.js"><link rel="prefetch" href="/assets/js/57.669e6cb3.js"><link rel="prefetch" href="/assets/js/58.ea5236df.js"><link rel="prefetch" href="/assets/js/59.db63bf83.js"><link rel="prefetch" href="/assets/js/6.d7378514.js"><link rel="prefetch" href="/assets/js/60.9e9c4d91.js"><link rel="prefetch" href="/assets/js/61.161af03a.js"><link rel="prefetch" href="/assets/js/62.63fb20e3.js"><link rel="prefetch" href="/assets/js/63.ca919568.js"><link rel="prefetch" href="/assets/js/64.cbea0d2d.js"><link rel="prefetch" href="/assets/js/65.ab77ea26.js"><link rel="prefetch" href="/assets/js/66.f6ea7ab6.js"><link rel="prefetch" href="/assets/js/67.d5441cfc.js"><link rel="prefetch" href="/assets/js/68.5fe6bb1c.js"><link rel="prefetch" href="/assets/js/69.459c6a23.js"><link rel="prefetch" href="/assets/js/7.75533db5.js"><link rel="prefetch" href="/assets/js/70.e4212df6.js"><link rel="prefetch" href="/assets/js/71.159214f8.js"><link rel="prefetch" href="/assets/js/72.3f04f919.js"><link rel="prefetch" href="/assets/js/73.3dfd3590.js"><link rel="prefetch" href="/assets/js/74.f56c1f9b.js"><link rel="prefetch" href="/assets/js/75.59313a46.js"><link rel="prefetch" href="/assets/js/76.c051ff7e.js"><link rel="prefetch" href="/assets/js/77.78159be6.js"><link rel="prefetch" href="/assets/js/78.27138678.js"><link rel="prefetch" href="/assets/js/79.c8f6359c.js"><link rel="prefetch" href="/assets/js/8.ca5a883b.js"><link rel="prefetch" href="/assets/js/80.6bd6870d.js"><link rel="prefetch" href="/assets/js/81.6f775180.js"><link rel="prefetch" href="/assets/js/82.059d817e.js"><link rel="prefetch" href="/assets/js/83.2ce7e449.js"><link rel="prefetch" href="/assets/js/84.8e1b5d6b.js"><link rel="prefetch" href="/assets/js/85.c6c35d8e.js"><link rel="prefetch" href="/assets/js/86.3a9e6e9d.js"><link rel="prefetch" href="/assets/js/87.6e14f903.js"><link rel="prefetch" href="/assets/js/88.1e626988.js"><link rel="prefetch" href="/assets/js/89.944ef5f5.js"><link rel="prefetch" href="/assets/js/9.05040702.js"><link rel="prefetch" href="/assets/js/90.eb545609.js"><link rel="prefetch" href="/assets/js/91.df9eeac5.js"><link rel="prefetch" href="/assets/js/92.bb099835.js"><link rel="prefetch" href="/assets/js/93.ecad1db4.js"><link rel="prefetch" href="/assets/js/94.83d767ff.js"><link rel="prefetch" href="/assets/js/95.65f62b01.js"><link rel="prefetch" href="/assets/js/96.72eafffb.js"><link rel="prefetch" href="/assets/js/97.526ae33e.js"><link rel="prefetch" href="/assets/js/98.493e7e81.js"><link rel="prefetch" href="/assets/js/99.094f232d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.cdd53b27.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="某不知名博客" class="logo"> <span class="site-name can-hide">某不知名博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><!----> <span class="title" style="display:;">文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/vulcat/" class="nav-link">《vulcat文档》</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="个人学习历程" class="dropdown-title"><!----> <span class="title" style="display:;">个人学习历程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>云原生安全</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/cloud-native-security/docker/command-lists/" class="nav-link">《Docker命令大全》</a></li><li class="dropdown-subitem"><a href="/cloud-native-security/kubernetes/cks/" class="nav-link">《CKS考试学习指南》</a></li><li class="dropdown-subitem"><a href="/cloud-native-security/kubernetes/preface/" class="nav-link">《旧-Kubernetes教程》</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/vuln-db/" class="nav-link">漏洞库</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="知识库" class="dropdown-title"><a href="/knowledge/" class="link-title">知识库</a> <span class="title" style="display:none;">知识库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/knowledge/tools/homepage/" class="nav-link">《渗透工具大全》</a></li><li class="dropdown-item"><!----> <a href="/knowledge/cloud-security/concept/" class="nav-link">《云安全》</a></li></ul></div></div><div class="nav-item"><a href="/security-events/" class="nav-link">事件库</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/carsaid/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://avatars.githubusercontent.com/u/78483995"> <div class="blogger-info"><h3>Carsaid</h3> <span>安全界的小学生</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><!----> <span class="title" style="display:;">文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/vulcat/" class="nav-link">《vulcat文档》</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="个人学习历程" class="dropdown-title"><!----> <span class="title" style="display:;">个人学习历程</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>云原生安全</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/cloud-native-security/docker/command-lists/" class="nav-link">《Docker命令大全》</a></li><li class="dropdown-subitem"><a href="/cloud-native-security/kubernetes/cks/" class="nav-link">《CKS考试学习指南》</a></li><li class="dropdown-subitem"><a href="/cloud-native-security/kubernetes/preface/" class="nav-link">《旧-Kubernetes教程》</a></li></ul></li></ul></div></div><div class="nav-item"><a href="/vuln-db/" class="nav-link">漏洞库</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="知识库" class="dropdown-title"><a href="/knowledge/" class="link-title">知识库</a> <span class="title" style="display:none;">知识库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/knowledge/tools/homepage/" class="nav-link">《渗透工具大全》</a></li><li class="dropdown-item"><!----> <a href="/knowledge/cloud-security/concept/" class="nav-link">《云安全》</a></li></ul></div></div><div class="nav-item"><a href="/security-events/" class="nav-link">事件库</a></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/carsaid/" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前言</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>学习建议</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/cloud-native-security/docker/command-lists/" class="sidebar-link">Docker命令大全</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Kubernetes教程</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/cloud-native-security/kubernetes/preface/" class="sidebar-link">Kubernetes（K8s）学习教程 - 前言</a></li><li><a href="/cloud-native-security/kubernetes/01/" class="sidebar-link">第1章-Kubernetes集群部署</a></li><li><a href="/cloud-native-security/kubernetes/02/" class="sidebar-link">第2章-便捷性设置以及集群插件的安装</a></li><li><a href="/cloud-native-security/kubernetes/03/" class="sidebar-link">第3章-基础操作</a></li><li><a href="/cloud-native-security/kubernetes/04/" class="sidebar-link">第4章-集群升级</a></li><li><a href="/cloud-native-security/kubernetes/05/" class="sidebar-link">第5章-Pod</a></li><li><a href="/cloud-native-security/kubernetes/06/" class="sidebar-link">第6章-Pod生命周期与资源限制</a></li><li><a href="/cloud-native-security/kubernetes/07/" class="sidebar-link">第7章-Pod与节点</a></li><li><a href="/cloud-native-security/kubernetes/08/" aria-current="page" class="active sidebar-link">第8章-控制器Deployment</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/cloud-native-security/kubernetes/08/#_1-控制器deployment" class="sidebar-link">1. 控制器Deployment</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/08/#_1-1-什么是控制器" class="sidebar-link">1.1 什么是控制器？</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/08/#_1-2-deployment-的作用是什么" class="sidebar-link">1.2 deployment 的作用是什么？</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/cloud-native-security/kubernetes/08/#_2-创建deployment" class="sidebar-link">2. 创建Deployment</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/08/#_2-1-通过yaml文件创建deployment" class="sidebar-link">2.1 通过yaml文件创建Deployment</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/08/#_1-spec-replicas" class="sidebar-link">（1）spec.replicas</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/08/#_2-spec-template" class="sidebar-link">（2）spec.template</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/08/#_3-spec-selector-matchlabels" class="sidebar-link">（3）spec.selector.matchLabels</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/08/#_2-2-测试deployment" class="sidebar-link">2.2 测试Deployment</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/08/#_2-2-1-无法追踪pod的情况" class="sidebar-link">2.2.1 无法追踪Pod的情况</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/08/#_2-2-2-超出上限的时候" class="sidebar-link">2.2.2 超出上限的时候</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/08/#_2-4-删除deployment" class="sidebar-link">2.4 删除deployment</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/cloud-native-security/kubernetes/08/#_3-修改deployment副本数" class="sidebar-link">3. 修改deployment副本数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/08/#_3-1-通过命令行修改副本数" class="sidebar-link">3.1 通过命令行修改副本数</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/08/#_3-2-应用新的yaml配置" class="sidebar-link">3.2 应用新的yaml配置</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/08/#_3-3-编辑deployment运行属性" class="sidebar-link">3.3 编辑deployment运行属性</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/cloud-native-security/kubernetes/08/#_4-水平自动扩缩hpa" class="sidebar-link">4. 水平自动扩缩HPA</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/08/#_4-1-根据cpu负载情况自动扩缩" class="sidebar-link">4.1 根据CPU负载情况自动扩缩</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/08/#_4-1-1-配置hpa" class="sidebar-link">4.1.1 配置HPA</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/08/#_4-1-2-为控制器中的pod配置资源限制" class="sidebar-link">4.1.2 为控制器中的Pod配置资源限制</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/08/#_4-1-3-测试hpa" class="sidebar-link">4.1.3 测试HPA</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/08/#_4-2-hpa的v2版本" class="sidebar-link">4.2 HPA的v2版本</a></li><li class="sidebar-sub-header level3"><a href="/cloud-native-security/kubernetes/08/#_4-3-根据内存负载情况自动扩缩" class="sidebar-link">4.3 根据内存负载情况自动扩缩</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/08/#_4-3-1-阈值-百分比" class="sidebar-link">4.3.1 阈值-百分比</a></li><li class="sidebar-sub-header level4"><a href="/cloud-native-security/kubernetes/08/#_4-3-2-阈值-绝对数值" class="sidebar-link">4.3.2 阈值-绝对数值</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/cloud-native-security/kubernetes/08/#小结" class="sidebar-link">小结</a></li></ul></li><li><a href="/cloud-native-security/kubernetes/09/" class="sidebar-link">第9章-Deployment镜像变更和滚动更新</a></li><li><a href="/cloud-native-security/kubernetes/10/" class="sidebar-link">第10章-其他控制器-以及标签表达式</a></li><li><a href="/cloud-native-security/kubernetes/11/" class="sidebar-link">第11章-控制器与节点驱逐</a></li><li><a href="/cloud-native-security/kubernetes/999/" class="sidebar-link">暂缓更新</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>练习题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>常用命令及yaml配置</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CKS教程（翻译）</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/cloud-native-security/#云原生安全" data-v-06225672>云原生安全</a></li><li data-v-06225672><a href="/cloud-native-security/#Kubernetes教程" data-v-06225672>Kubernetes教程</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/carsaid" target="_blank" title="作者" class="beLink" data-v-06225672>carsaid</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-11-19</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">第8章-控制器Deployment<!----></h1>  <div class="theme-vdoing-content content__default"><div class="cardListContainer"><div class="card-list"><span class="card-item row-2" style="background-color:#F0DFB1;--random-color:#F0DFB1;color:#1078E6;"><div><p class="name">原创</p> <p class="desc">本博客原创文章，转载请注明出处</p></div></span></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 原创
  <span class="token key atrule">desc</span><span class="token punctuation">:</span> 本博客原创文章，转载请注明出处
  <span class="token key atrule">bgColor</span><span class="token punctuation">:</span> <span class="token string">'#F0DFB1'</span>
  <span class="token key atrule">textColor</span><span class="token punctuation">:</span> <span class="token string">'#1078E6'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></div><h1 id="第8章-控制器deployment"><a href="#第8章-控制器deployment" class="header-anchor">#</a> 第8章-控制器Deployment</h1> <table><thead><tr><th>本章要点</th></tr></thead> <tbody><tr><td>创建和删除 Deployment</td></tr> <tr><td>修改 Deployment 副本数</td></tr> <tr><td>为 Deployment 配置水平自动扩缩 HPA</td></tr></tbody></table> <h2 id="_1-控制器deployment"><a href="#_1-控制器deployment" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>1</span>1. 控制器Deployment</h2> <h3 id="_1-1-什么是控制器"><a href="#_1-1-什么是控制器" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>1.1</span>1.1 什么是控制器？</h3> <p>在之前的章节中，我们曾通过命令行或 yaml 文件的方式创建一个独立的 Pod。但这种 Pod 是不稳定、不健壮的，在运行过程中，一旦某个 Pod 被意外终止，那么这个 Pod 就是真的没了，它不会自己再创建并重新运行。</p> <p>控制器，顾名思义，这是一种用来控制集群资源的工具。在 k8s 中有很多种控制器，而 <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/" target="_blank" rel="noopener noreferrer">deployment<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（简称 deploy）是最常用的其中一种控制器。</p> <h3 id="_1-2-deployment-的作用是什么"><a href="#_1-2-deployment-的作用是什么" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>1.2</span>1.2 deployment 的作用是什么？</h3> <p>在某个命名空间中，你只需要告诉 deployment 你需要多少个 Pod，那么 deployment 就会帮你维持多少个 Pod。</p> <p>例如，你在命名空间<code>default</code>中始终需要 3 个 Pod 来承载业务：</p> <ul><li>deployment 会自动在<code>default</code>中创建 3 个 Pod，并确保 Pod 的数量始终保持在 3 个；</li> <li>假如其中的某一个 Pod 意外终止了（挂掉），那么 deployment 就会立马重新运行一个 Pod，以填补这个空缺</li></ul> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/01.png" alt="Not Found Image"> <h2 id="_2-创建deployment"><a href="#_2-创建deployment" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>2</span>2. 创建Deployment</h2> <p>和 Pod 一样，Deployment 也可以通过命令行工具<code>kubectl</code>进行创建。</p> <p>也和 Pod 一样，官方推荐你通过 yaml 文件的方式来创建 Deployment。</p> <p>从 kubernetes v1.18.x 版本开始，Deployment 在命令行中只支持<code>--image</code>选项，其余选项都不支持。所以，为了给 Deployment 配置更多的功能特性，我们只能选择 yaml 这一种方式了（官方强迫）。</p> <h3 id="_2-1-通过yaml文件创建deployment"><a href="#_2-1-通过yaml文件创建deployment" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>2.1</span>2.1 通过yaml文件创建Deployment</h3> <p>在之前的章节中，我们曾通过<code>--dry-run=client</code>和<code>-o yaml</code>选项，来快速生成一个 Pod 的 yaml 配置文件。就像这样：</p> <ul><li><code>--dry-run=client</code>：试运行，并不会真的创建资源</li> <li><code>-o yaml</code>：以 YAML 文件的格式输出该资源的配置信息</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl run pod1 <span class="token parameter variable">--image</span> nginx --dry-run<span class="token operator">=</span>client <span class="token parameter variable">-o</span> yaml <span class="token operator">&gt;</span> pod1.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>除了使用的子命令不同以外，我们也可以使用相同的选项来创建一个 Deployment 的 yaml 配置文件：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 格式</span>
kubectl create deployment <span class="token operator">&lt;</span>Deployment名称<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>选项<span class="token operator">&gt;</span>

<span class="token comment"># 例如</span>
kubectl create deployment deploy-test <span class="token parameter variable">--image</span> nginx --dry-run<span class="token operator">=</span>client <span class="token parameter variable">-o</span> yaml <span class="token operator">&gt;</span> deploy-test.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>创建一个名为<code>deploy-test</code>的 deployment，将其配置信息导出至<code>deploy-test.yaml</code>文件中。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/02.png" alt="Not Found Image"> <p>随后，我们打开这个 yaml 文件，你将看到以下内容：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>test
  <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>test
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>test
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>Deployment 的配置字段和我们之前看到的资源（例如 Pod 或 LimitRange）有一点不同：</p> <ul><li><code>apiVersion</code>：Deployment 的 API 版本是固定的<code>apps/v1</code></li> <li><code>kind</code>：写的是资源名称<code>Deployment</code></li> <li><code>metadata</code>和其他资源一样，包含当前资源的元数据信息</li> <li><code>spec</code>包含 Deployment 的具体配置内容</li></ul> <h4 id="_1-spec-replicas"><a href="#_1-spec-replicas" class="header-anchor">#</a> （1）spec.replicas</h4> <p>需要维持的 Pod 数量（副本数），你需要几个 Pod 就写几个。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_2-spec-template"><a href="#_2-spec-template" class="header-anchor">#</a> （2）spec.template</h4> <p>要创建的 Pod 模板，这部分内容和 Pod 的 yaml 配置完全一样，只不过除去了 Pod 的<code>apiVersion</code>和<code>kind</code>字段，只保留了 Pod 的元数据信息（<code>metadata</code>）和具体的配置项（<code>spec</code>）。</p> <p>还有一个小细节，这个 Pod 模板没有名称（<code>metadata.name</code>），因为 deployment 在创建 Pod 的时候，会自动赋予它们一个随机的名称。</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>test
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h4 id="_3-spec-selector-matchlabels"><a href="#_3-spec-selector-matchlabels" class="header-anchor">#</a> （3）spec.selector.matchLabels</h4> <p>由 Deployment 创建出来的 Pod 都具有相同的标签<code>app=deploy-test</code>，Deployment 刚好可以通过这个标签来识别和追踪这些 Pod。</p> <ul><li>如果 Pod 的标签和 Deployment 的追踪标签不匹配，那么 Deployment 就无法找到要维持的 Pod（相当于失去效果）</li> <li>Pod 可以同时具有多个标签，Deployment 的追踪标签只需要匹配<b>其中的一个标签</b>即可</li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h3 id="_2-2-测试deployment"><a href="#_2-2-测试deployment" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>2.2</span>2.2 测试Deployment</h3> <p>1、我们以上面的 yaml 文件为基础，对其进行一点小小的修改：</p> <ul><li>将需要维持的 Pod 数量（<code>spec.replicas</code>）修改为<code>3</code>个</li> <li>为 Pod 模板（<code>spec.template</code>）添加镜像下载策略<code>IfNotPresent</code></li></ul> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># deploy-test.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>test
  <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>test
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>test
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token key atrule">status</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>2、然后创建这个 deployment，并查看 Pod 的运行状态：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> deploy-test.yaml
kubectl get deployments

kubectl get pods <span class="token parameter variable">-o</span> wide
kubectl get pods --show-labels
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>如图所示，deployment 顺利地创建出了 3 个 Pod，并且这些 Pod 都具有相同的名称格式（<code>&lt;控制器名称&gt;-&lt;模板hash&gt;-&lt;随机的Pod名称&gt;</code>），且具有相同的两个标签。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/03.png" alt="Not Found Image"> <p>3、删除其中的某个 Pod，看看 deployment 是否会填补这个空缺。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl delete pods <span class="token operator">&lt;</span>Pod名称<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>可以看到，当我将 Pod <code>b8hqg</code>删除之后，deployment 立马创建了一个新的 Pod <code>vc9gn</code>来顶替它的位置。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/04.png" alt="Not Found Image"> <p>（和 1.2 小节的漫画一样）</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/05.png" alt="Not Found Image"> <h4 id="_2-2-1-无法追踪pod的情况"><a href="#_2-2-1-无法追踪pod的情况" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>2.2.1</span>2.2.1 无法追踪Pod的情况</h4> <p>前面介绍<code>spec.selector.matchLabels</code>字段的时候提到过，deployment 通过标签来追踪 Pod，这样它就知道哪些 Pod 是需要它来维持的。</p> <p>删除其中某个 Pod 的<code>app</code>标签，看看会发生什么：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 删除某个 Pod 上名为 app 标签</span>
kubectl label pods <span class="token operator">&lt;</span>Pod名称<span class="token operator">&gt;</span> app-
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>如图所示，当我把 Pod <code>9wp72</code>上的<code>app</code>标签删除之后，deployment 丢失了与这个 Pod 的连接。</p> <p>由于 deployment 找不到这个 Pod，因此它会认为这个 Pod 已经挂掉了，随后会创建一个新的 Pod <code>gw8qh</code>来顶替它的位置。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/06.png" alt="Not Found Image"> <p>（丢失一个 Pod，需要创建另一个 Pod 来填补空缺）</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/07.png" alt="Not Found Image"> <h4 id="_2-2-2-超出上限的时候"><a href="#_2-2-2-超出上限的时候" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>2.2.2</span>2.2.2 超出上限的时候</h4> <p>前面我们创建了一个名为<code>deploy-test</code>的 deployment，它通过标签<code>app=deploy-test</code>来追踪 Pod，并让这些 Pod 的数量始终保持在 3 个。</p> <p>在上一节中，我们删除了 Pod <code>9wp72</code>的<code>app</code>标签，导致 deployment 丢失了这个 Pod，并另外生成了一个新的 Pod。</p> <p>我们帮这个 Pod 把标签加回去，这样一来 deployment 就会得到 4 个 Pod：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl label pods <span class="token operator">&lt;</span>Pod名称<span class="token operator">&gt;</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>deploy-test
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如图所示，当 Pod <code>9wp72</code>回归这个大家庭后，就会超出 deployment 所维持的 Pod 数量上限，这时它将会删除其中的某个 Pod，将 Pod 数量缩减为 3 个。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/08.png" alt="Not Found Image"> <p>（突然多出一个 Pod，需要将 Pod 数量缩减为三个）</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/09.png" alt="Not Found Image"> <p>另外，你也可以单独创建一个 Pod，并为其设置标签<code>app=deploy-test</code>，这同样会超出数量上限，并产生相同的缩减效应。</p> <h3 id="_2-4-删除deployment"><a href="#_2-4-删除deployment" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>2.4</span>2.4 删除deployment</h3> <p>和其他的资源一样，有两种删除 Deployment 的方式：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 通过名称删除 Deployment</span>
kubectl delete deployments <span class="token operator">&lt;</span>资源名称<span class="token operator">&gt;</span>

<span class="token comment"># 通过原始文件删除 Deployment</span>
kubectl delete <span class="token parameter variable">-f</span> <span class="token operator">&lt;</span>文件名称<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这里我以文件的方式，删除刚刚创建出来的<code>deploy-test</code>：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl delete <span class="token parameter variable">-f</span> deploy-test.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>删除控制器之后，由该控制器创建出来的 Pod 也会一并被删除。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/10.png" alt="Not Found Image"> <h2 id="_3-修改deployment副本数"><a href="#_3-修改deployment副本数" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>3</span>3. 修改deployment副本数</h2> <p>由控制器维持的 Pod 数量上限，也被称为 Pod 的 “副本数”。</p> <p>在创建 deployment 的时候，我们可以通过修改<code>spec.replicas</code>字段来控制所产生的副本数。但当 deployment 被创建出来之后，我们如何修改这个数量呢？</p> <p>在这之前，我们先创建一个用于实验的新 deployment：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># deploy-rep.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>rep
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> run
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> run
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>这个 deployment 的初始副本数被设置为<code>2</code>个。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 创建控制器</span>
kubectl apply <span class="token parameter variable">-f</span> deploy-rep.yaml
kubectl get deployments
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/01.png" alt="Not Found Image"> <h3 id="_3-1-通过命令行修改副本数"><a href="#_3-1-通过命令行修改副本数" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>3.1</span>3.1 通过命令行修改副本数</h3> <p>这是最简单的一种修改方式，通过使用<code>kubectl scale</code>命令以及<code>--replicas</code>选项，即可轻松修改一个 deployment 的副本数。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl scale deployments <span class="token operator">&lt;</span>名称<span class="token operator">&gt;</span> <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token operator">&lt;</span>新的副本数<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>1、刚刚创建出来的 deployment 副本数为<code>2</code>个，最近双十一要到来了，两个 Pod 可能顶不住那么大的流量，我们将其副本数扩展为<code>5</code>个：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl scale deployment deploy-rep <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>2、如图所示，当扩展副本数为<code>5</code>个时，由于当前只有<code>2</code>个 Pod，所以 deployment 会依次创建三个新的 Pod，以填补这些位置的空缺。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/02.png" alt="Not Found Image"> <p>3、可以看到，有两个 Pod 的运行时间比较长（<code>4m39s</code>），它们就是最初的那两个 Pod。而新创建出来的三个 Pod 运行时间比较短（<code>2m4s</code>）。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/03.png" alt="Not Found Image"> <h3 id="_3-2-应用新的yaml配置"><a href="#_3-2-应用新的yaml配置" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>3.2</span>3.2 应用新的yaml配置</h3> <p>和其他资源（例如 Pod）一样，我们可以修改原始 yaml 配置文件，然后将新的配置应用到正在运行的资源上。</p> <p>双十一过完了，系统不再需要那么多的 Pod 了，于是打开这个 deployment 的原始配置文件，将副本数修改为<code>3</code>个：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> deploy-rep.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/04.png" alt="Not Found Image"> <p>然后应用修改过后的配置：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> deploy-rep.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>如果资源不存在，则<code>kubectl apply</code>会创建该资源。</p> <p>如果资源已经存在，则<code>kubectl apply</code>会根据 yaml 文件中的配置项，更新当前资源的对应信息。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/05.png" alt="Not Found Image"> <h3 id="_3-3-编辑deployment运行属性"><a href="#_3-3-编辑deployment运行属性" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>3.3</span>3.3 编辑deployment运行属性</h3> <p>k8s 允许你编辑某个正在运行的资源，你对其的修改会实时应用到当前资源中。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl edit deployment <span class="token operator">&lt;</span>名称<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>1、例如，我们可以对<code>deploy-rep</code>进行编辑：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl edit deployment deploy-rep
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>执行命令之后，你就会进入配置视图，当前资源的所有配置信息都会以 yaml 的格式向你展现。你可以修改其中的某些字段，当你保存退出之后，所做更改会自动应用到当前的资源中。</p> <p>这有点像编辑原始 yaml 文件，然后通过<code>apply</code>更新配置。而<code>edit</code>简化了这个过程。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/06.png" alt="Not Found Image"> <p>2、在配置视图中找到<code>spec.replicas</code>字段，将其修改为<code>4</code>，然后像使用 vim 一样保存退出。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/07.png" alt="Not Found Image"> <p>3、如图所示，成功通过<code>edit</code>将副本数修改为了<code>4</code>。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/08.png" alt="Not Found Image"> <h2 id="_4-水平自动扩缩hpa"><a href="#_4-水平自动扩缩hpa" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>4</span>4. 水平自动扩缩HPA</h2> <p>在上一节中，我们介绍了三种修改 deployment 副本数的方式。但是这种修改方式也存在缺点：</p> <ul><li>当业务量大的时候（例如遇到了双十一），管理员需要手动将副本数调高</li> <li>当业务量小的时候，管理员又需要手动将副本数调低</li></ul> <p>这是一个繁琐的修改过程。有没有一种方法，可以根据 Pod 的负载情况，自动扩展或缩减 Pod 数量呢？</p> <p>这时候就要用到 HPA（水平自动扩缩）了，它又被称为 “水平自动更新”。</p> <h3 id="_4-1-根据cpu负载情况自动扩缩"><a href="#_4-1-根据cpu负载情况自动扩缩" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>4.1</span>4.1 根据CPU负载情况自动扩缩</h3> <p>HPA 可以根据每个 Pod 的负载情况（CPU 使用率或内存使用率），自动对 Deployment 的副本数进行扩展或缩减。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 为 Deployment 设置 HPA 策略</span>
kubectl autoscale deployment <span class="token operator">&lt;</span>目标控制器名称<span class="token operator">&gt;</span> <span class="token parameter variable">--min</span><span class="token operator">=</span><span class="token operator">&lt;</span>最小Pod数<span class="token operator">&gt;</span> <span class="token parameter variable">--max</span><span class="token operator">=</span><span class="token operator">&lt;</span>最大Pod数<span class="token operator">&gt;</span> --cpu-percent<span class="token operator">=</span><span class="token operator">&lt;</span>CPU百分比<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="_4-1-1-配置hpa"><a href="#_4-1-1-配置hpa" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>4.1.1</span>4.1.1 配置HPA</h4> <p>1、我们先把之前那个 deployment 的副本数设置为<code>2</code>个，然后查看当前是否有 HPA。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 修改副本数</span>
kubectl scale deployment deploy-rep <span class="token parameter variable">--replicas</span><span class="token operator">=</span><span class="token number">2</span>
kubectl get deployments

<span class="token comment"># 列出 HPA</span>
kubectl get hpa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以看到，当前命名空间中没有 HPA。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/01.png" alt="Not Found Image"> <p>2、为<code>deploy-rep</code>创建一个 HPA 策略，这个 HPA 没有名称，且会自动绑定到所提供的 deployment 上。</p> <ul><li><code>--min=2</code>：这个 deployment 的副本数最少为<code>2</code>个</li> <li><code>--max=7</code>：这个 deployment 的副本数最多为<code>7</code>个</li> <li><code>--cpu-percent=60</code>：确保其中每个 Pod 的 CPU 使用率保持在<code>60%</code>以下</li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl autoscale deployment deploy-rep <span class="token parameter variable">--min</span><span class="token operator">=</span><span class="token number">2</span> <span class="token parameter variable">--max</span><span class="token operator">=</span><span class="token number">7</span> --cpu-percent<span class="token operator">=</span><span class="token number">60</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>例如，当前的 CPU 负载量为 90%，那么这两个 Pod 就会各自分担 45%。</p> <p>这个 HPA 会确保这些 Pod 的平均负载保持在 60% 以下，平均负载超过了 60%，那么 HPA 就会创建更多的 Pod 来分担负载量。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/02.png" alt="Not Found Image"> <p>此时，这个 HPA 的计量指标为<code>&lt;unknown&gt;/60%</code>，为什么这里显示的是<code>unknown</code>（未知）呢？这其中肯定存在问题。</p> <h4 id="_4-1-2-为控制器中的pod配置资源限制"><a href="#_4-1-2-为控制器中的pod配置资源限制" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>4.1.2</span>4.1.2 为控制器中的Pod配置资源限制</h4> <p>并不是创建 HPA 之后就万事大吉了，我们还需要为 deployment 所控制的 Pod 配置资源限制。</p> <p>我们刚刚通过选项<code>--cpu-percent=60</code>将扩展触发量定为了 60%，那么这个百分比计算的是哪个数值呢？这个数值和 Pod 的资源限制字段<code>spec.containers.resources</code>有关。例如，考虑一个这样的 Pod：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">...</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 400m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>在这个 Pod 当中，其 CPU 资源使用上限被设置成了<code>400</code>个 CPU 微核心。那么对于 HPA 来说，60% 的资源就相当于<code>400 * 0.6 = 240</code>个 CPU 微核心。</p> <p>也就是说，当这些 Pod 的平均 CPU 负载超过了<code>240m</code>的时候，HPA 就会通知 Deployment 扩展副本数，创建更多的 Pod 来分担业务量，将这些 Pod 的平均 CPU 负载降低至<code>240m</code>以下。</p> <p>1、通过<code>edit</code>命令编辑刚刚的 deployment，打开配置视图后，找到 Pod 模板的所在位置（<code>spec.template</code>）：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl edit deployment deploy-rep
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/03.png" alt="Not Found Image"> <p>2、为 Pod 模板添加资源限制，将 CPU 使用上限设置为<code>400m</code>，然后保存退出：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token punctuation">...</span>
<span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token key atrule">limits</span><span class="token punctuation">:</span>
    <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 400m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/04.png" alt="Not Found Image"> <p>3、可以看到，当你修改了 Pod 模板之后，deployment 会删除之前的 Pod，并根据新的模板重新创建 Pod。</p> <p>而且 HPA 的计量从之前的<code>unknown</code>（未知）变为了<code>0%</code>，说明它现在已经能够正确监测负载信息了。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/05.png" alt="Not Found Image"> <h4 id="_4-1-3-测试hpa"><a href="#_4-1-3-测试hpa" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>4.1.3</span>4.1.3 测试HPA</h4> <p>1、为了测试这个 deployment 的可扩展性，我们需要执行以下命令：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl expose deployment deploy-rep <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">80</span> --target-port<span class="token operator">=</span><span class="token number">80</span> <span class="token parameter variable">--type</span><span class="token operator">=</span>NodePort
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>该命令会为 deployment 创建一个网络服务，并为其分配一个 IP 地址（在这里为<code>10.106.94.87</code>）。deployment 在这里面充当了一个负载均衡器的角色，当你不断请求这个 IP 地址时，你的请求会被依次转发到 deployment 所控制的每个 Pod 中。</p> <p>你暂时不需要了解这其中的参数原理，这将在后面的章节中介绍，你只需要简单地执行这条命令即可。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/06.png" alt="Not Found Image"> <p>2、切换至任意工作节点，在主机上安装网络压力测试工具：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># worker</span>
yum <span class="token function">install</span> httpd-tools <span class="token parameter variable">-y</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/07.png" alt="Not Found Image"> <p>3、在安装了压力测试工具的主机上，对目标 deployment 发起大量网络请求，迫使其负载增加：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>ab <span class="token parameter variable">-t</span> <span class="token number">600</span> <span class="token parameter variable">-n</span> <span class="token number">1000000</span> <span class="token parameter variable">-c</span> <span class="token number">1000</span> http://<span class="token operator">&lt;</span>目标IP地址<span class="token operator">&gt;</span>/

<span class="token comment"># 例如</span>
ab <span class="token parameter variable">-t</span> <span class="token number">600</span> <span class="token parameter variable">-n</span> <span class="token number">1000000</span> <span class="token parameter variable">-c</span> <span class="token number">1000</span> http://10.106.94.87/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>4、回到 master 主机上，不断查看 Pod 负载信息以及 HPA 的情况：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl <span class="token function">top</span> pods <span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token punctuation">;</span> kubectl get hpa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>此时压力测试刚刚开始，两个 Pod 应付起来还能游刃有余。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/08.png" alt="Not Found Image"> <p>Pod 限制 CPU 资源使用上限为<code>400m</code>，HPA 保持 CPU 利用率为<code>60%</code>，所以阈值为<code>400m * 60% = 240m</code>。</p> <p>此时，这两个 Pod 的平均 CPU 负载都已经超过了阈值<code>240m</code>，因此 HPA 需要做出反应。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/09.png" alt="Not Found Image"> <p>稍后，HPA 将 deployment 的副本数扩展为了<code>4</code>个，此时有四个 Pod 分担业务流量，平均 CPU 负载为<code>81%</code>。</p> <p>还是超过了 HPA 所设定的阈值，四个 Pod 不够！</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/10.png" alt="Not Found Image"> <p>HPA 也意识到了这个问题，所以继续将副本数扩展至<code>6</code>个，用更多的 Pod 来分担业务流量。</p> <p>此时平均 CPU 负载为<code>61%</code>，HPA 还会继续扩展吗？</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/11.png" alt="Not Found Image"> <p>等待一会之后，平均 CPU 负载下降到了<code>51%</code>。从 Pod 负载信息中也可以看出，现在这六个 Pod 的 CPU 负载都位于<code>240m</code>以下，并没有超过阈值。</p> <p>HPA 并不会一股脑地增加 Pod 数量，而是循序渐进，并观察是否符合预期要求。在确认 CPU 平均利用率稳定下来之后，HPA 便不会再扩展副本数。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/12.png" alt="Not Found Image"> <p>过了一会之后，另一台主机上的压力测试工具也运行完毕了（你也可以<code>Ctrl+C</code>提前终止运行）。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/13.png" alt="Not Found Image"> <p>5、在压力测试工具停止以后，再次查看 Pod 以及 HPA 信息：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl <span class="token function">top</span> pods <span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token punctuation">;</span> kubectl get hpa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>此时平均 CPU 使用率已经降低至<code>0%</code>，而且所有 Pod 的 CPU 负载也都处于<code>0m</code>，说明没有业务流量需要处理。</p> <p>但 Pod 数量始终保持在<code>6</code>个，难道 HPA 只会扩不会缩？</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/14.png" alt="Not Found Image"> <p>其实这是 HPA 的一种防抖机制。</p> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>当平均负载超过阈值，HPA 会迅速扩展副本数，以应对即将到来的业务量。</p> <p>当平均负载低于阈值时，HPA 会等待一段时间（默认<code>5</code>分钟），确认平均负载不会再次升高以后，才会缩减副本数。这可以有效地防止 Pod 数量抖动。</p></div> <p>仔细想想，如果负载量一时高一时低，变来变去。而 Pod 一会被创建出来，没几秒又被删除，等会又被创建出来，又被删除......</p> <p>6、等待一段时间之后，再次查看 Pod 以及 HPA 信息：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl <span class="token function">top</span> pods <span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token punctuation">;</span> kubectl get hpa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>HPA 确认业务量稳定之后，已经将副本数缩减为了<code>2</code>个。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/15.png" alt="Not Found Image"> <p>7、本次实验成功，将这个 HPA 删除：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl delete hpa deploy-rep
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/16.png" alt="Not Found Image"> <h3 id="_4-2-hpa的v2版本"><a href="#_4-2-hpa的v2版本" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>4.2</span>4.2 HPA的v2版本</h3> <p>在 yaml 文件中，HPA 的<code>apiVersion</code>参数值为<code>autoscaling/v1</code>，例如：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 快速生成一个 HPA 的配置文件</span>
kubectl autoscale deployment deploy-rep <span class="token parameter variable">--min</span><span class="token operator">=</span><span class="token number">2</span> <span class="token parameter variable">--max</span><span class="token operator">=</span><span class="token number">7</span> --cpu-percent<span class="token operator">=</span><span class="token number">60</span> --dry-run<span class="token operator">=</span>client <span class="token parameter variable">-o</span> yaml <span class="token operator">&gt;</span> deploy-rep.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>rep
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">7</span>
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>rep
  <span class="token key atrule">targetCPUUtilizationPercentage</span><span class="token punctuation">:</span> <span class="token number">60</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>这是一代版本的 HPA，可以用于设置 CPU 阈值。当 Pod 平均 CPU 负载超过阈值时，HPA 就会自动扩展副本数。</p> <p>如果你曾运行过<code>kubectl api-versions</code>命令，你可能会发现 HPA 还有二代版本：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl api-versions
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/01.png" alt="Not Found Image"> <p>二代 HPA 无法通过命令行创建，但是可以通过 yaml 文件来生成：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>rep
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">7</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>rep
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Resource
    <span class="token key atrule">resource</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu
      <span class="token key atrule">target</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> Utilization
        <span class="token key atrule">averageUtilization</span><span class="token punctuation">:</span> <span class="token number">50</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>你看出一代和二代 yaml 文件之间的细微区别了吗？二代 HPA 在一代的基础上增加了很多新功能，包括对内存使用率的自动扩缩。</p> <h3 id="_4-3-根据内存负载情况自动扩缩"><a href="#_4-3-根据内存负载情况自动扩缩" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>4.3</span>4.3 根据内存负载情况自动扩缩</h3> <p>由于二代 HPA 无法通过命令行创建，<code>kubectl</code>也没有提供内存阈值的参数选项。</p> <p>所以，如果你想根据内存使用率对 deployment 进行自动扩缩，则必须通过 yaml 文件来创建二代 HPA。</p> <h4 id="_4-3-1-阈值-百分比"><a href="#_4-3-1-阈值-百分比" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>4.3.1</span>4.3.1 阈值-百分比</h4> <p>1、将 “4.2” 章节中展示的二代 HPA 另存至<code>rep-hpa2.yaml</code>文件当中：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span> rep-hpa2.yaml</span>
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: deploy-rep
spec:
  minReplicas: 2
  maxReplicas: 7
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: deploy-rep
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50
EOF</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/02.png" alt="Not Found Image"> <p>2、编辑<code>rep-hpa2.yaml</code>文件，将字段<code>spec.metrics.resource.name</code>修改为<code>memory</code>，然后保存退出：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> rep-hpa2.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/03.png" alt="Not Found Image"> <p>3、编辑控制器<code>deploy-rep</code>，在之前实验的基础上，为 Pod 模板添加内存资源限制，将内存使用上限设置为<code>100Mi</code>，然后保存退出：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl edit deployment deploy-rep
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/04.png" alt="Not Found Image"> <p>4、创建这个二代 HPA：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> rep-hpa2.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>由于 HPA 刚刚被创建出来，所以当前的内存使用率会显示为<code>&lt;unknown&gt;</code>（未知）。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/05.png" alt="Not Found Image"> <p>5、等待一段时间，再次查看 HPA：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl get hpa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>此时 HPA 已经正确识别了所有 Pod 的平均内存使用率，之前的<code>&lt;unknown&gt;</code>变为了<code>2%</code>。</p> <p>当两个 Pod 的平均内存使用率达到资源上限（<code>100Mi</code>）的<code>50%</code>（阈值<code>50Mi</code>）的时候，HPA 就会自动扩展 deployment 的副本数。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/06.png" alt="Not Found Image"> <h4 id="_4-3-2-阈值-绝对数值"><a href="#_4-3-2-阈值-绝对数值" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>4.3.2</span>4.3.2 阈值-绝对数值</h4> <p>前面的阈值都是通过<code>资源上限 * 百分比 = ?</code>来计算的，我能否提供一个具体的数值，而不是一个百分比？</p> <p>1、当然可以，我在<code>rep-hpa2.yaml</code>的基础上添加了 CPU 阈值，它是一个具体的值：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span> rep-hpa2.yaml
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token comment"># rep-hpa2.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> autoscaling/v2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> HorizontalPodAutoscaler
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>rep
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">7</span>
  <span class="token key atrule">scaleTargetRef</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
    <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
    <span class="token key atrule">name</span><span class="token punctuation">:</span> deploy<span class="token punctuation">-</span>rep
  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Resource
    <span class="token key atrule">resource</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> memory
      <span class="token key atrule">target</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> Utilization
        <span class="token key atrule">averageUtilization</span><span class="token punctuation">:</span> <span class="token number">50</span>
  <span class="token punctuation">-</span> <span class="token key atrule">type</span><span class="token punctuation">:</span> Resource
    <span class="token key atrule">resource</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> cpu
      <span class="token key atrule">target</span><span class="token punctuation">:</span>
        <span class="token key atrule">type</span><span class="token punctuation">:</span> AverageValue
        <span class="token key atrule">averageValue</span><span class="token punctuation">:</span> 280m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>你看出来两者的不同了吗？</p> <ul><li>对于百分比阈值，需要通过<code>type: Utilization</code>和<code>averageUtilization: &lt;百分比&gt;</code>来设置</li> <li>对于绝对数值，需要通过<code>type: AverageValue</code>和<code>averageValue: &lt;值&gt;</code>来设置</li></ul> <p>2、应用新的 yaml 配置：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl apply <span class="token parameter variable">-f</span> rep-hpa2.yaml
kubectl get hpa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>应用更改之后，现在 HPA 可以同时监测 CPU 和内存的平均使用率，从而动态扩缩 deployment 副本数。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/07.png" alt="Not Found Image"> <p>那么问题来了，扩缩的条件是超过一个阈值，还是同时超过两个阈值？</p> <p>3、让我们回到之前安装了压力测试工具的主机上，再次运行压力测试工具，对 deployment 网络服务的地址发起请求：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># worker</span>
ab <span class="token parameter variable">-t</span> <span class="token number">600</span> <span class="token parameter variable">-n</span> <span class="token number">1000000</span> <span class="token parameter variable">-c</span> <span class="token number">1000</span> http://10.106.94.87/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/08.png" alt="Not Found Image"> <p>4、在 master 上不断查看 HPA 情况：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl <span class="token function">top</span> pods <span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token punctuation">;</span> kubectl get hpa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>此时，两个 Pod 的平均 CPU 使用率已经超过了阈值，但 HPA 毫无动作。</p> <p>难道要同时满足两个条件？别急，再看看。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/09.png" alt="Not Found Image"> <p>等待一会之后，HPA 出手了。</p> <p>由于平均 CPU 负载过高，HPA 扩展了副本数，创建更多的 Pod 来分担业务量，将平均负载降到了<code>280m</code>以下。</p> <img src="https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/10.png" alt="Not Found Image"> <div class="custom-block note"><p class="custom-block-title">笔记</p> <p>如果 HPA 同时配置了 CPU 和内存阈值，则它们是 “或” 的关系。只要其中一个超出了阈值，就会自动扩展副本数。</p></div> <p>5、当平均负载稳定降下来之后，HPA 会等待一段时间（防抖期），然后缩减副本数。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl <span class="token function">top</span> pods <span class="token punctuation">;</span> <span class="token builtin class-name">echo</span> <span class="token punctuation">;</span> kubectl get hpa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>6、最后，删除 HPA、Deployment 和网络服务：</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>kubectl delete hpa deploy-rep
kubectl delete deployment deploy-rep
kubectl delete <span class="token function">service</span> deploy-rep
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="custom-block note"><p class="custom-block-title">学习更多</p> <ul><li><a href="https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale/" target="_blank" rel="noopener noreferrer">官方文档-Pod 水平自动扩缩<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/" target="_blank" rel="noopener noreferrer">官方文档-HorizontalPodAutoscaler 演练<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> <span class="badge error" style="vertical-align:top;" data-v-d5affa18>5</span>小结</h2> <p>本章对控制器 Deployment 做了一个了解，并学习了如何创建、删除和编辑 Deployment。</p> <p>还学习了如何为 Deployment 配置水平自动扩缩（HPA 和 HPAv2），通过 HPA 来监测 CPU 和内存平均使用情况，然后自动扩缩 Pod 数量。</p> <p>通过本章的学习，你应该掌握以下技能：</p> <ul><li>创建和删除 Deployment，根据标签来追踪 Pod 群体</li> <li>配置 Deployment 副本数和 Pod 模板</li> <li>编辑正在运行的 Deployment</li> <li>为一个 Deployment 配置水平自动更新 HPA</li> <li>二代 HPA 的使用</li></ul> <p>如果你已经掌握以上内容，可以去做些练习题巩固一下（<a href="/cloud-native-security/kubernetes/practice/06/">练习题-6</a>）。</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/carsaid/edit/master/docs/06.云原生安全/25.Kubernetes教程/2534.第8章-控制器Deployment.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <!----></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/cloud-native-security/kubernetes/07/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">第7章-Pod与节点</div></a> <a href="/cloud-native-security/kubernetes/09/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">第9章-Deployment镜像变更和滚动更新</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/cloud-native-security/kubernetes/07/" class="prev">第7章-Pod与节点</a></span> <span class="next"><a href="/cloud-native-security/kubernetes/09/">第9章-Deployment镜像变更和滚动更新</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/cloud-native-security/kubernetes/cks/devopscube.com/configure-ingress-tls-kubernetes/"><div>
            如何为Ingress配置TLS、SSL证书
            <!----></div></a> <span class="date">12-04</span></dt></dl><dl><dd>02</dd> <dt><a href="/cloud-native-security/kubernetes/config/view/"><div>
            kubectl config view
            <!----></div></a> <span class="date">12-04</span></dt></dl><dl><dd>03</dd> <dt><a href="/cloud-native-security/kubernetes/kubectl/top/"><div>
            kubectl top
            <!----></div></a> <span class="date">12-04</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/carsaid" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2023
    <span>Carsaid | <a href="https://github.com/xugaoyi/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6d8810e1.js" defer></script><script src="/assets/js/2.b3e685a4.js" defer></script><script src="/assets/js/21.10b4dc58.js" defer></script><script src="/assets/js/3.adb8ff64.js" defer></script>
  </body>
</html>
