(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{337:function(s,e,t){"use strict";t.r(e);var a=t(7),n=Object(a.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("div",{staticClass:"cardListContainer"},[e("div",{staticClass:"card-list"},[e("span",{staticClass:"card-item row-2",staticStyle:{"background-color":"#F0DFB1","--randomColor":"#F0DFB1",color:"#1078E6"}},[e("div",[e("p",{staticClass:"name"},[s._v("原创")]),s._v(" "),e("p",{staticClass:"desc"},[s._v("本博客原创文章，转载请注明出处")])])])]),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 原创\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("desc")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 本博客原创文章，转载请注明出处\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("bgColor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'#F0DFB1'")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("textColor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'#1078E6'")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])])]),e("h1",{attrs:{id:"第9章-deployment镜像变更和滚动更新"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第9章-deployment镜像变更和滚动更新"}},[s._v("#")]),s._v(" 第9章-Deployment镜像变更和滚动更新")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("本章要点")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("Deployment 镜像的变更和回滚")])]),s._v(" "),e("tr",[e("td",[s._v("Deployment 镜像的滚动更新")])])])]),s._v(" "),e("h2",{attrs:{id:"_1-deployment镜像变更"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-deployment镜像变更"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"1"}}),s._v("1. Deployment镜像变更")],1),s._v(" "),e("p",[s._v("当一个容器镜像有了新版本，我该如何将其应用到现有的 Deployment 及其 Pod 当中呢？难道要整个删了重建？")]),s._v(" "),e("p",[s._v("在开始实验之前，我们先下载几个不同版本的"),e("code",[s._v("nginx")]),s._v("镜像：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 已经有的镜像 就不用重复下载了")]),s._v("\nctr "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" k8s.io i pull docker.io/library/nginx:latest\nctr "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" k8s.io i pull docker.io/library/nginx:1.9\n\nctr "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" k8s.io i pull docker.io/library/nginx:1.8\nctr "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" k8s.io i pull docker.io/library/nginx:1.7.9\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("当前已经拥有了四个不同版本的"),e("code",[s._v("nginx")]),s._v("镜像。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("ctr "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" k8s.io i "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" nginx\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/image-alter/01.png",alt:"Not Found Image"}}),s._v(" "),e("h3",{attrs:{id:"_1-1-变更deployment镜像的三种方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-变更deployment镜像的三种方式"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"1.1"}}),s._v("1.1 变更Deployment镜像的三种方式")],1),s._v(" "),e("p",[s._v("和修改 Deployment 的副本数一样，修改镜像的方式也有三种：")]),s._v(" "),e("ul",[e("li",[s._v("通过命令行修改")]),s._v(" "),e("li",[s._v("通过"),e("code",[s._v("kubectl edit")]),s._v("编辑 Deployment 的运行信息")]),s._v(" "),e("li",[s._v("修改原始 yaml 配置文件，然后通过"),e("code",[s._v("kubectl apply")]),s._v("更新配置")])]),s._v(" "),e("p",[s._v("但在这里，将仅介绍第一种方式——通过命令行修改 Deployment 的镜像。这是因为，通过命令行修改镜像时可以产生"),e("b",[s._v("镜像变更历史记录")]),s._v("，这对于回滚镜像有着至关重要的作用。")]),s._v(" "),e("p",[s._v("在这之前，我们先创建一个 Deployment：")]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# deploy-update.yaml")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("update\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" update\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" update\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("latest\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("p",[s._v("创建这个控制器：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl apply "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" deploy-update.yaml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/image-alter/02.png",alt:"Not Found Image"}}),s._v(" "),e("h3",{attrs:{id:"_1-2-通过命令行变更镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-通过命令行变更镜像"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"1.2"}}),s._v("1.2 通过命令行变更镜像")],1),s._v(" "),e("h4",{attrs:{id:"_1-2-1-变更镜像"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-1-变更镜像"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"1.2.1"}}),s._v("1.2.1 变更镜像")],1),s._v(" "),e("p",[s._v("基本语法：")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("--record")]),s._v("：记录镜像变更信息")])]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" image deployment "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("控制器名称"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("容器名称"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("新镜像"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--record")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("如果不添加"),e("code",[s._v("--record")]),s._v("选项，则当前变更会在历史记录中显示为"),e("code",[s._v("<none>")]),s._v("（空），所以推荐每次都加上该选项。")]),s._v(" "),e("p",[s._v("1、我们可以通过"),e("code",[s._v("-o wide")]),s._v("选项来列出 deployment 的详细信息：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl get deployments "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" wide\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("多出了三列信息：")]),s._v(" "),e("ul",[e("li",[s._v("“CONTAINERS”：容器名称")]),s._v(" "),e("li",[s._v("“IMAGES”：当前使用的镜像")]),s._v(" "),e("li",[s._v("“SELECTOR”：通过哪些标签来追踪 Pod")])]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/image-alter/03.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("2、然后通过命令"),e("code",[s._v("kubectl set image")]),s._v("将这个 deployment 的镜像变更为"),e("code",[s._v("nginx:1.8")]),s._v("，同时使用"),e("code",[s._v("--record")]),s._v("选项来记录本次变更：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" image deployment deploy-update "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("nginx")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx:1.8 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--record")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("命令执行成功，该 deployment 的镜像变更为了"),e("code",[s._v("nginx:1.8")]),s._v("，随后它会删除之前的 Pod，并使用新镜像创建两个新的 Pod。")]),s._v(" "),e("p",[s._v("在不删除控制器的情况下，我们成功更换了 Pod 所使用的镜像版本。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/image-alter/04.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("同时，在执行命令之后，你可能会看到一条突兀的提示信息：")]),s._v(" "),e("div",{staticClass:"language-text line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("Flag --record has been deprecated, --record will be removed in the future\n\n选项 --record 已被弃用，--record 将在未来被删除\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("这其实是高版本 k8s 的一个改动，选项"),e("code",[s._v("--record")]),s._v("即将被移除。你不必担心，因为我将在后面介绍一个替代方案。")]),s._v(" "),e("h4",{attrs:{id:"_1-2-2-查看镜像变更记录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-2-查看镜像变更记录"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"1.2.2"}}),s._v("1.2.2 查看镜像变更记录")],1),s._v(" "),e("p",[s._v("基本语法：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl rollout "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("history")]),s._v(" deployment "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("控制器名称"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("1、例如，查看"),e("code",[s._v("deploy-update")]),s._v("的镜像变更记录：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl rollout "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("history")]),s._v(" deployment deploy-update\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("我们可以看到两条历史记录：")]),s._v(" "),e("ul",[e("li",[s._v("记录 1（初始记录）：这条记录是 deployment 被创建出来的那一刻自动产生的，并没有记录变更信息")]),s._v(" "),e("li",[s._v("记录 2：这是我们在 “1.2.1” 小节中所做的变更，将原本的镜像变更为了"),e("code",[s._v("nginx:1.8")])])]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/image-alter/05.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("2、我们再次将 deployment 的镜像变更为"),e("code",[s._v("nginx:1.9")]),s._v("，但这次不添加"),e("code",[s._v("--record")]),s._v("选项：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" image deployment deploy-update "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("nginx")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx:1.9\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("变更成功。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/image-alter/06.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("3、再次查看镜像变更历史记录：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl rollout "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("history")]),s._v(" deployment deploy-update\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("这时有人会说了：诶？这个 “记录 3” 里面不是有变更记录吗？")]),s._v(" "),e("p",[s._v("你再仔细看看，这条变更记录和上一次的相同，都是 nginx:"),e("code",[s._v("1.8")]),s._v("。我们刚刚变更的目标镜像明明是 nginx:"),e("code",[s._v("1.9")]),s._v("，但是这两条记录都是"),e("code",[s._v("1.8")]),s._v("？")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/image-alter/07.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("4、我们验证一下，将镜像变更为 nginx:"),e("code",[s._v("1.7.9")]),s._v("，且不记录变更：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" image deployment deploy-update "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("nginx")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx:1.7.9\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 再次查看记录")]),s._v("\nkubectl rollout "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("history")]),s._v(" deployment deploy-update\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("可以看到，虽然变更的镜像为 nginx:"),e("code",[s._v("1.7.9")]),s._v("，但由于没有添加"),e("code",[s._v("--record")]),s._v("选项，本次历史记录会"),e("b",[s._v("沿用上一次的变更信息")]),s._v("。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/image-alter/08.png",alt:"Not Found Image"}}),s._v(" "),e("h4",{attrs:{id:"_1-2-3-record替代方案"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-3-record替代方案"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"1.2.3"}}),s._v("1.2.3 --record替代方案")],1),s._v(" "),e("p",[s._v("在 “1.2.1” 小节中得知"),e("code",[s._v("--record")]),s._v("选项即将被移除，那么它的替代方案是什么呢？")]),s._v(" "),e("p",[s._v("1、我们来查看一下 deployment 的详细信息：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl describe deployment deploy-update "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("head")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-10")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("这个 deployment 有两条注释信息：")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("deployment.kubernetes.io/revision: 4")]),s._v("（镜像变更记录数为 4）")]),s._v(" "),e("li",[e("code",[s._v("kubernetes.io/change-cause: ...")]),s._v("（镜像变更信息）")])]),s._v(" "),e("p",[s._v("没错，在高版本的 k8s 中，选项"),e("code",[s._v("--record")]),s._v("的替代方案就是"),e("b",[s._v("注释")]),s._v("。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/image-alter/09.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("2、修改注释信息"),e("code",[s._v("kubernetes.io/change-cause")]),s._v("，看看能否产生新的历史记录：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl annotate deployment deploy-update kubernetes.io/change-cause"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Update image to nginx:1.7.9"')]),s._v("\n\nkubectl rollout "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("history")]),s._v(" deployment deploy-update\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("在改变了注释信息"),e("code",[s._v("kubernetes.io/change-cause")]),s._v("的内容之后，记录 4 的历史变更信息也发生了改变。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/image-alter/10.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("那么，如果我想修改记录 3 的变更信息该怎么办呢？诶嘿，改不了！改不了！")]),s._v(" "),e("p",[s._v("在官方文档中，我暂未找到修改前置记录的方法。而在 k8s 的官方论坛中，我遇到了一个具有相同问题的帖子：")]),s._v(" "),e("p",[s._v("（但该帖子已发布接近两年，至今零回复。难道官方还没开发出这种功能？）")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/image-alter/11.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("3、所以，在没有"),e("code",[s._v("--record")]),s._v("选项的情况下，每当你变更一次镜像之后，就必须手动修改一次注释......就像这样：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" image deployment deploy-update "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("nginx")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx:latest\n\nkubectl annotate deployment deploy-update kubernetes.io/change-cause"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Update image to nginx:latest"')]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/image-alter/12.png",alt:"Not Found Image"}}),s._v(" "),e("div",{staticClass:"custom-block note"},[e("p",{staticClass:"custom-block-title"},[s._v("笔记")]),s._v(" "),e("p",[s._v("未来"),e("code",[s._v("--record")]),s._v("注定会被抛弃，所以从现在开始要养成良好习惯。")]),s._v(" "),e("p",[s._v("每当执行变更命令之后，都手动记录一下注释信息"),e("code",[s._v('kubernetes.io/change-cause="<变更原因>"')])])]),s._v(" "),e("p",[s._v("如果你没有添加"),e("code",[s._v("--record")]),s._v("选项，又没有手动修改注释信息。那不好意思，本次变更将不会记录新信息。")]),s._v(" "),e("h2",{attrs:{id:"_2-deployment镜像回滚"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-deployment镜像回滚"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"2"}}),s._v("2. Deployment镜像回滚")],1),s._v(" "),e("p",[s._v("当你变更了一个 deployment 的镜像之后，发现这个镜像有 BUG，或者遇到了不兼容当前业务之类的情况，该如何将镜像还原到之前的版本呢？")]),s._v(" "),e("p",[s._v("在列出镜像变更历史记录的时候，你可以通过"),e("code",[s._v("--revision")]),s._v("选项查看某次变更的详细信息。")]),s._v(" "),e("p",[s._v("1、例如，查看记录 3 的变更详情：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl rollout "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("history")]),s._v(" deployment deploy-update "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--revision")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("成功列出了记录 3 的变更详情，虽然注释信息里写的是"),e("code",[s._v("... nginx=nginx:1.8")]),s._v("，但是实际变更的还是 nginx:"),e("code",[s._v("1.9")]),s._v("版本。这印证了之前说过的一句话 “注释只是对集群资源的解释和说明，旨在提高阅读性，不会被作用于任何方面”。")]),s._v(" "),e("p",[s._v("所以，就算你忘记为某一条记录设置注释了，也不会对那一次的实际变更产生影响。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/image-undo/01.png",alt:"Not Found Image"}}),s._v(" "),e("p",[e("code",[s._v("history")]),s._v("命令和"),e("code",[s._v("--revision")]),s._v("选项可以列出某条记录的详情。如果想要回滚镜像，则需要使用"),e("code",[s._v("undo")]),s._v("命令和"),e("code",[s._v("--to-revision")]),s._v("选项。")]),s._v(" "),e("p",[s._v("2、例如，将这个控制器的镜像回滚至记录 3 的状态：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl rollout undo deployment deploy-update --to-revision"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("成功将其镜像回滚到了记录 3 所设置的镜像"),e("code",[s._v("nginx:1.9")]),s._v("。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/image-undo/02.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("3、再次查看镜像变更记录：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl rollout "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("history")]),s._v(" deployment deploy-update\n\nkubectl rollout "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("history")]),s._v(" deployment deploy-update "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--revision")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("我们刚刚执行的明明是 “回滚” 操作，但却离奇多出了一条 “变更” 记录 6。")]),s._v(" "),e("p",[s._v("查看记录 6 的详情之后你会发现，所谓的 “回滚”，原来就是 k8s 自动帮你执行了一条变更命令，将状态改回去。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/image-undo/03.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("好嘛，原来回滚（"),e("code",[s._v("rollout undo")]),s._v("）里面包装了一个变更（"),e("code",[s._v("set image")]),s._v("），那我自己变回去不也是一样的？为啥还要回滚？")]),s._v(" "),e("p",[s._v("其实，在查看 变更详情 的时候你应该注意到了，能够 “变更” 的参数不止镜像一个。当变更的参数多起来时，你也需要添加更多的参数选项。")]),s._v(" "),e("p",[s._v("一条命令的参数选项越多，出错的几率也越大。而 “回滚” 可以识别历史变更记录，然后自动为你执行 “变更” 命令，这有助于节省工作量。")]),s._v(" "),e("div",{staticClass:"custom-block note"},[e("p",{staticClass:"custom-block-title"},[s._v("笔记")]),s._v(" "),e("p",[s._v("“回滚” 是简洁化的 “变更”。")])]),s._v(" "),e("h2",{attrs:{id:"_3-deployment镜像滚动更新"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-deployment镜像滚动更新"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"3"}}),s._v("3. Deployment镜像滚动更新")],1),s._v(" "),e("h3",{attrs:{id:"_3-1-为什么需要滚动更新"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-为什么需要滚动更新"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"3.1"}}),s._v("3.1 为什么需要滚动更新")],1),s._v(" "),e("p",[s._v("在 “1.2.1” 小节中我们得知，当 deployment 的镜像被变更之后，它会删除旧的 Pod，然后使用新镜像来创建新的 Pod。")]),s._v(" "),e("p",[s._v("假设有一个 deployment 控制了五个 Pod，默认情况下，当它的镜像被变更之后，它会立马删除"),e("b",[s._v("五个")]),s._v(" Pod，然后再创建另外"),e("b",[s._v("五个")]),s._v("新的 Pod。")]),s._v(" "),e("p",[s._v("这种默认的变更方式有点粗暴，这五个 Pod 在同一时间被删除，而重新创建和运行肯定需要一些时间，在此期间业务都会处于中断状态。")]),s._v(" "),e("p",[s._v("这时候就需要用到滚动更新。")]),s._v(" "),e("h3",{attrs:{id:"_3-2-配置滚动更新"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-配置滚动更新"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"3.2"}}),s._v("3.2 配置滚动更新")],1),s._v(" "),e("p",[s._v("在创建 deployment 时可以通过"),e("code",[s._v("spec.strategy")]),s._v("字段来为其配置滚动更新：")]),s._v(" "),e("ul",[e("li",[e("code",[s._v("maxSurge")]),s._v("：当镜像被变更时，依次创建"),e("code",[s._v("25%")]),s._v("个新的 Pod，直到新的 Pod 数量达到控制器上限")]),s._v(" "),e("li",[e("code",[s._v("maxUnavailable")]),s._v("：当镜像被变更时，依次删除"),e("code",[s._v("25%")]),s._v("个旧的 Pod，直到旧的 Pod 全部被删光")])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("strategy")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rollingUpdate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("maxSurge")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 25%\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("maxUnavailable")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 25%\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" RollingUpdate\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("1、为了更好地看出效果，先将"),e("code",[s._v("deploy-update")]),s._v("的副本数修改为"),e("code",[s._v("4")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl scale deployment deploy-update "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--replicas")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/rolling-update/01.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("2、由于我们的 deployment 已经处于运行状态，所以通过"),e("code",[s._v("edit")]),s._v("命令来编辑它，然后为其添加滚动更新:")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl edit deployment deploy-update\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("刚想编辑，发现这个 deployment 已经配置了滚动更新。可是我们之前创建这个 deployment 的时候明明没有为其配置？")]),s._v(" "),e("p",[s._v("k8s 想的很周到，如果你没有为 deployment 配置滚动更新，那么它就会提供一个默认值：依次删除"),e("code",[s._v("25%")]),s._v("个旧的 Pod、并依次创建"),e("code",[s._v("25%")]),s._v("个新的 Pod。这个百分比是根据 副本数 来计算具体数量的。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/rolling-update/02.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("我们刚刚将 deployment 的副本数调整为了"),e("code",[s._v("4")]),s._v("个，也就是说，当这个 deployment 的镜像被变更时，它会依次删除"),e("code",[s._v("1")]),s._v("个旧的 Pod、并依次创建"),e("code",[s._v("1")]),s._v("个新的 Pod，直到所有的 Pod 都完成镜像变更。")]),s._v(" "),e("p",[s._v("3、此外，如果你不想使用百分比，你也可以提供一个绝对数值：")]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("strategy")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rollingUpdate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("maxSurge")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n      "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("maxUnavailable")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" RollingUpdate\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("p",[s._v("如图所示，不用改变字段名称，直接将 值 修改为数字即可。")]),s._v(" "),e("p",[s._v("然后保存退出。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/rolling-update/03.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("4、然后变更其镜像，并不断查看 Pod 情况：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" image deployment deploy-update "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("nginx")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx:1.7.9\n\nkubectl get pods\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("删除和创建 Pod 的速度很快，但看得还是很清楚。")]),s._v(" "),e("ul",[e("li",[s._v("第一次查看时\n"),e("ul",[e("li",[s._v("已经有三个新的 Pod 被创建出来，其中一个刚刚进入 “Running” 状态")]),s._v(" "),e("li",[s._v("已经有一个旧的 Pod 被删除；一个旧的 Pod 正处于删除状态（Terminating）；还有两个旧的 Pod 处于运行状态，等着被删除")])])]),s._v(" "),e("li",[s._v("第二次查看时\n"),e("ul",[e("li",[s._v("新的 Pod 已经全部创建完成，并进入运行状态，它们接手了之前的工作任务")]),s._v(" "),e("li",[s._v("旧的 Pod 即将被完全删除，还剩下一个")])])]),s._v(" "),e("li",[s._v("第三次查看时，滚动更新已经完成")])]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/rolling-update/04.png",alt:"Not Found Image"}}),s._v(" "),e("div",{staticClass:"custom-block note"},[e("p",{staticClass:"custom-block-title"},[s._v("笔记")]),s._v(" "),e("p",[s._v("在执行滚动更新时，创建新 Pod 和删除旧 Pod 这两个操作是同时进行的，并不存在先后顺序。")])]),s._v(" "),e("h2",{attrs:{id:"_4-一个常见疑惑"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_4-一个常见疑惑"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"4"}}),s._v("4. 一个常见疑惑")],1),s._v(" "),e("p",[s._v("我们前面变更镜像，都只是单纯地更改了 nginx 镜像的版本号，能否将 nginx 镜像修改为其它镜像？")]),s._v(" "),e("p",[s._v("1、当然可以，还是以之前的 deployment 为例，将其镜像变更为"),e("code",[s._v("alpine")]),s._v("：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("set")]),s._v(" image deployment deploy-update "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("nginx")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("alpine\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("成功将镜像"),e("code",[s._v("nginx:1.7.9")]),s._v("变更为了"),e("code",[s._v("alpine")]),s._v("。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/different-image/01.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("在查看 Pod 信息时，你会发现两个新创建出来的 Pod 貌似遇到了错误，状态一直停留在 “CrashLoopBackOff”。")]),s._v(" "),e("p",[s._v("别担心，这其实是 Pod 生命周期的缘故，由于镜像"),e("code",[s._v("alpine")]),s._v("默认不会在容器中执行任何启动命令，所以 Pod 的生命周期会很快结束，然后状态会被标记为 “Completed”（运行完毕）。")]),s._v(" "),e("p",[s._v("而由于 滚动更新 的存在，如果 deployment 在创建新的 Pod 时遇到了错误，便会停止变更。可想而知，如果此时没有滚动更新，那么所有的 Pod 都将处于不可用状态，这会对业务造成多大的影响？")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/different-image/02.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("2、如果你想解决这个问题，可以编辑 deployment 中的 Pod 模板，为其添加"),e("code",[s._v("spec.containers.command")]),s._v("（启动时命令）：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl edit deployment deploy-update\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这将使容器休眠 9999999 秒")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sh'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-c'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sleep 9999999'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/different-image/03.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("保存退出之后，由于"),e("code",[s._v("sleep")]),s._v("命令使 Pod 生命周期得到了延长，错误得以解决，所以滚动更新会继续进行。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deploy-image-alter/different-image/04.png",alt:"Not Found Image"}}),s._v(" "),e("h2",{attrs:{id:"_5-小结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_5-小结"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"5"}}),s._v("5. 小结")],1),s._v(" "),e("p",[s._v("本章内容较为简单，但你仍需掌握：")]),s._v(" "),e("ul",[e("li",[s._v("通过命令行变更 deployment 的镜像")]),s._v(" "),e("li",[s._v("通过注释来记录变更信息")]),s._v(" "),e("li",[s._v("查看历史变更记录（列表）")]),s._v(" "),e("li",[s._v("查看历史变更记录（详情）")]),s._v(" "),e("li",[s._v("回滚镜像")]),s._v(" "),e("li",[s._v("配置滚动更新")])]),s._v(" "),e("p",[s._v("去做一些练习吧（"),e("RouterLink",{attrs:{to:"/cloud-native-security/kubernetes/practice/07/"}},[s._v("练习题-7")]),s._v("），这肯定难不到你。")],1)])}),[],!1,null,null,null);e.default=n.exports}}]);