(window.webpackJsonp=window.webpackJsonp||[]).push([[24],{338:function(s,a,t){"use strict";t.r(a);var e=t(7),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("div",{staticClass:"cardListContainer"},[a("div",{staticClass:"card-list"},[a("span",{staticClass:"card-item row-2",staticStyle:{"background-color":"#F0DFB1","--randomColor":"#F0DFB1",color:"#1078E6"}},[a("div",[a("p",{staticClass:"name"},[s._v("原创")]),s._v(" "),a("p",{staticClass:"desc"},[s._v("本博客原创文章，转载请注明出处")])])])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 原创\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("desc")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 本博客原创文章，转载请注明出处\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("bgColor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'#F0DFB1'")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("textColor")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'#1078E6'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])])]),a("h1",{attrs:{id:"第11章-控制器与节点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#第11章-控制器与节点"}},[s._v("#")]),s._v(" 第11章-控制器与节点")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("本章要点")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("掌握节点的停止、恢复、驱逐和删除")])]),s._v(" "),a("tr",[a("td",[s._v("了解驱逐特性")])]),s._v(" "),a("tr",[a("td",[s._v("了解停止、驱逐和删除这三者之间的区别")])])])]),s._v(" "),a("p",[s._v("在第 3 章和第 4 章中，我们曾通过"),a("code",[s._v("kubectl drain")]),s._v("命令将节点设置成维护模式。现在，将详细介绍其作用，以及这些命令之间的区别。")]),s._v(" "),a("h2",{attrs:{id:"_1-创建测试pod和deployment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-创建测试pod和deployment"}},[s._v("#")]),s._v(" "),a("Badge",{attrs:{type:"error",text:"1"}}),s._v("1. 创建测试Pod和Deployment")],1),s._v(" "),a("p",[s._v("在开始实验之前，我们先创建一些独立的 Pod 和控制器 Deployment：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pod1.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodeSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetes.io/hostname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" www.k11.com\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" c1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod2\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodeSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetes.io/hostname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" www.k12.com\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" c2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# d-test.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" d"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cc\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("创建以上 Pod 和控制器：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" pod1.yaml,pod2.yaml,d-test.yaml\n\nkubectl get pods "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" wide\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("现在，节点 worker01 和 worker02 上各有三个 Pod。")]),s._v(" "),a("ul",[a("li",[s._v("其中两个是独立的 Pod")]),s._v(" "),a("li",[s._v("其中四个是由控制器所控制的 Pod")])]),s._v(" "),a("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/node-delete/01.png",alt:"Not Found Image"}}),s._v(" "),a("h2",{attrs:{id:"_2-节点的停止-封锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-节点的停止-封锁"}},[s._v("#")]),s._v(" "),a("Badge",{attrs:{type:"error",text:"2"}}),s._v("2. 节点的停止（封锁）")],1),s._v(" "),a("p",[s._v("如果你想停止调度一个节点，让"),a("b",[s._v("后续")]),s._v("创建的 Pod 都不会在其上运行，则可以使用以下命令：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl cordon "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("节点名称"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("cordon")]),s._v("又叫 “封锁”，所以"),a("code",[s._v("kubectl cordon")]),s._v("又被称为 “封锁节点”。")]),s._v(" "),a("p",[s._v("1、下面尝试停止 worker02 节点：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl cordon www.k12.com\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("停止 worker02 节点后，状态栏中会多出一个状态值 “SchedulingDisabled”（禁止调度）。")]),s._v(" "),a("p",[s._v("在 worker02 节点上，原来已经存在的 Pod 依然会正常运行，不会受到影响。而后续创建的 Pod 不会在其上运行。")]),s._v(" "),a("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/node-delete/02.png",alt:"Not Found Image"}}),s._v(" "),a("p",[s._v("2、我们来验证一下 “后续创建的 Pod 不会在其上运行” 这段话。创建以下 Pod，通过字段"),a("code",[s._v("nodeSelector")]),s._v("和标签"),a("code",[s._v("kubernetes.io/hostname")]),s._v("，强制该 Pod 运行在 worker02 节点上：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cordon-test.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cordon"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodeSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetes.io/hostname")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" www.k12.com\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cordon"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl apply "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" cordon-test.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("创建这个 Pod 之后，可以看到这个 Pod 的状态一直停留在 “Pending”（等待）。")]),s._v(" "),a("p",[s._v("由于 worker02 节点被停止调度，其他的节点又无法满足"),a("code",[s._v("nodeSelector")]),s._v("所设置的条件，所以该 Pod 会一直处于 “Pending” 状态，直到出现合适的节点。")]),s._v(" "),a("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/node-delete/03.png",alt:"Not Found Image"}}),s._v(" "),a("h2",{attrs:{id:"_3-节点的恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-节点的恢复"}},[s._v("#")]),s._v(" "),a("Badge",{attrs:{type:"error",text:"3"}}),s._v("3. 节点的恢复")],1),s._v(" "),a("p",[s._v("恢复一个节点的使用状态：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl uncordon "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("节点名称"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("恢复 worker02 节点，将其转变为可调度状态：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl uncordon www.k12.com\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("执行命令后，worker02 节点的 “SchedulingDisabled”（禁止调度）状态消失了，并且"),a("code",[s._v("cordon-test")]),s._v("的状态也从 “Pending” 变为了 “Running”。")]),s._v(" "),a("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/node-delete/04.png",alt:"Not Found Image"}}),s._v(" "),a("h3",{attrs:{id:"_4-节点的驱逐"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-节点的驱逐"}},[s._v("#")]),s._v(" "),a("Badge",{attrs:{type:"error",text:"4"}}),s._v("4. 节点的驱逐")],1),s._v(" "),a("p",[s._v("这个命令在之前的章节中使用过：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl drain "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("节点名称"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("code",[s._v("drain")]),s._v("类似于"),a("code",[s._v("cordon")]),s._v("，都可以用于停止一个节点。但是"),a("code",[s._v("drain")]),a("b",[s._v("多了一个操作：驱逐")]),s._v("。")]),s._v(" "),a("p",[s._v("什么意思呢？")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("cordon")]),s._v("会停止一个节点，已经运行在该节点上的 Pod 不受影响，会继续正常运行。")]),s._v(" "),a("li",[a("code",[s._v("drain")]),s._v("除了停止一个节点之外，还会将该节点上的 Pod 全部"),a("b",[s._v("驱逐")]),s._v("到其他节点上运行。这可以"),a("b",[s._v("完全清空")]),s._v("一个节点。")])]),s._v(" "),a("p",[s._v("1、我们来尝试一下，通过"),a("code",[s._v("drain")]),s._v("停止 worker02 节点，并驱逐上面运行的所有 Pod：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl drain www.k12.com\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("第一次执行"),a("code",[s._v("drain")]),s._v("命令，你会发现返回了一堆错误信息。但此时 worker02 节点的状态已经变为 “停止调度” 了，看起来貌似没什么问题？")]),s._v(" "),a("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/node-delete/05.png",alt:"Not Found Image"}}),s._v(" "),a("p",[s._v("2、查看 Pod，发现这些 Pod 依然运行在 worker02 节点上，为什么？答案就在错误信息中：")]),s._v(" "),a("ul",[a("li",[s._v("无法删除没有控制器的 Pod，你可以使用"),a("code",[s._v("--force")]),s._v("（强制删除）来执行操作。")]),s._v(" "),a("li",[s._v("无法删除由 DaemonSet 所管理的 Pod，你可以使用"),a("code",[s._v("--ignore-daemonsets")]),s._v("选项来忽略这些 Pod，因为 DaemonSet 一般是用于监控节点、维护节点通信的，所以不能删除 要忽略。")]),s._v(" "),a("li",[s._v("无法删除某些 Pod，因为这些 Pod 在所运行的节点上创建了一些临时数据，你需要使用选项"),a("code",[s._v("--delete-emptydir-data")]),s._v("来删除这些临时数据（删除后一般不影响集群运行）。")])]),s._v(" "),a("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/node-delete/06.png",alt:"Not Found Image"}}),s._v(" "),a("p",[s._v("3、重新执行命令，驱逐 worker02 节点上的所有 Pod：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 再次驱逐节点")]),s._v("\nkubectl drain www.k12.com "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--force")]),s._v(" --ignore-daemonsets --delete-emptydir-data\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/node-delete/07.png",alt:"Not Found Image"}}),s._v(" "),a("p",[s._v("4、再次查看 Pod：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl get pods "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" wide\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("你会发现，原本位于 worker02 上的独立 Pod "),a("code",[s._v("pod2")]),s._v("已经被删除了。")]),s._v(" "),a("p",[s._v("而原本位于 worker02 上拥有控制器的 Pod，被驱逐至 worker01 节点上运行了（两个运行时间为"),a("code",[s._v("40s")]),s._v("的 Pod）。这些 Pod 并不是被 “移动” 到 worker01 节点上的，而是被 Deployment 新创建出来的。")]),s._v(" "),a("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/node-delete/08.png",alt:"Not Found Image"}}),s._v(" "),a("div",{staticClass:"custom-block note"},[a("p",{staticClass:"custom-block-title"},[s._v("驱逐原理")]),s._v(" "),a("p",[s._v("驱逐一个节点，其实就是将节点设置为不可用状态，然后删除这个节点上所有 Pod。")]),s._v(" "),a("ul",[a("li",[a("b",[s._v("对于独立创建的 Pod")]),s._v("，它会被彻底删除。这是个敏感操作，所以 k8s 要求你添加选项"),a("code",[s._v("--force")]),s._v("（强制删除）来确认操作。")]),s._v(" "),a("li",[a("b",[s._v("对于拥有控制器的 Pod")]),s._v("，并不是小心翼翼地 “移动” 这些 Pod 到另一个节点之上，也是直接删除这些 Pod，当控制器 Deployment 监测到 Pod 数量变少了的时候，它就会自动创建新的 Pod 以填补副本数的空缺。此时 worker02 节点已经处于不可用状态了，所以这些新的 Pod 会被调度到 worker01 节点上运行。")]),s._v(" "),a("li",[a("b",[s._v("对于控制器类型为 DaemonSet 的 Pod")]),s._v("，这类 Pod 一般被用于集群自身的运行，所以需要使用"),a("code",[s._v("--ignore-daemonsets")]),s._v("选项来忽略它们。")]),s._v(" "),a("li",[a("b",[s._v("对于存储了临时数据的 Pod")]),s._v("，也是个敏感操作，所以 k8s 要求你添加选项"),a("code",[s._v("--delete-emptydir-data")]),s._v("（删除临时数据）来确认操作。")])])]),s._v(" "),a("p",[s._v("5、“驱逐节点” 只不过是在 “停止节点” 的基础之上增加了一个驱逐 Pod 的操作而已，所以该节点同样可以使用"),a("code",[s._v("uncordon")]),s._v("命令来恢复运行：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl uncordon www.k12.com\nkubectl get nodes\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("但原本运行在 worker02 节点上的 Pod 不会自己跑回去。")]),s._v(" "),a("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/node-delete/09.png",alt:"Not Found Image"}}),s._v(" "),a("h2",{attrs:{id:"_5-节点的删除"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-节点的删除"}},[s._v("#")]),s._v(" "),a("Badge",{attrs:{type:"error",text:"5"}}),s._v("5. 节点的删除")],1),s._v(" "),a("p",[s._v("这个命令在之前也使用过：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("kubectl delete nodes "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("节点名称"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("1、你可以在节点处于运行状态的时候，直接删除节点，这比较简单粗暴：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 不推荐直接删除节点")]),s._v("\nkubectl delete ndoes "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("节点名称"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("如果你直接删除了节点，而没有清空上面的 Pod，则这些 Pod 都会被强制删除。")]),s._v(" "),a("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/node-delete/10.png",alt:"Not Found Image"}}),s._v(" "),a("p",[s._v("2、正常来说，我们会先 “驱逐” 一个节点以清空其上运行的所有 Pod，最后再删除节点：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 推荐")]),s._v("\nkubectl drain "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("节点名称"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\nkubectl delete ndoes "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("节点名称"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("3、被删除的节点可以通过"),a("code",[s._v("kubeadm join")]),s._v("命令重新加入集群：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# （1）在 master 上获取一个新的加入命令")]),s._v("\nkubeadm token create --print-join-command\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# （2）在 worker 上初始化原来的集群设置，然后加入集群")]),s._v("\nkubeadm reset\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# （3）在 worker 上重新配置内核参数")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF"),a("span",{pre:!0,attrs:{class:"token bash punctuation"}},[s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/sysctl.d/k8s.conf")]),s._v("\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nnet.ipv4.ip_forward = 1\nEOF")]),s._v("\nmodprobe br_netfilter\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sysctl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" /etc/sysctl.d/k8s.conf\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# （4）在 worker 上重新加入集群")]),s._v("\nkubeadm "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".80.10:6443 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--token")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("你的集群令牌"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" --discovery-token-ca-cert-hash "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("你的集群证书哈希"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("p",[s._v("worker 重置集群设置。")]),s._v(" "),a("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/node-delete/11.png",alt:"Not Found Image"}}),s._v(" "),a("p",[s._v("worker 重新设置内核参数。")]),s._v(" "),a("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/node-delete/12.png",alt:"Not Found Image"}}),s._v(" "),a("p",[s._v("worker 加入集群。")]),s._v(" "),a("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/node-delete/13.png",alt:"Not Found Image"}}),s._v(" "),a("p",[s._v("master 查看节点。")]),s._v(" "),a("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/node-delete/14.png",alt:"Not Found Image"}}),s._v(" "),a("h2",{attrs:{id:"_6-小结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6-小结"}},[s._v("#")]),s._v(" "),a("Badge",{attrs:{type:"error",text:"6"}}),s._v("6. 小结")],1),s._v(" "),a("p",[s._v("本章内容较为简单，只需要掌握节点的三停（停止、驱逐、删除）和一复（恢复）即可。")]),s._v(" "),a("p",[s._v("本章没有练习，只需要熟读 2~5 小节的内容、并进行相应的实操即可。")])])}),[],!1,null,null,null);a.default=n.exports}}]);