(window.webpackJsonp=window.webpackJsonp||[]).push([[204],{521:function(s,a,t){"use strict";t.r(a);var e=t(7),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"个人模拟考试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#个人模拟考试"}},[s._v("#")]),s._v(" 个人模拟考试")]),s._v(" "),a("p",[s._v("这是我在 2023 年 1 月份做的一次 CKA 模拟考试，基于 kubernetes v1.26 版本。")]),s._v(" "),a("p",[s._v("这次模拟考试提供了 25 道题目（总分 125 分）、以及 2 道附加题目、3 道预习题目。（真实考试是 15~20 道题，总分 100 分）")]),s._v(" "),a("p",[s._v("模拟考试比真实的认证更难，如果你能够通过模拟考试，则说明你有了挑战真实考试的水平。")]),s._v(" "),a("p",[s._v("以下是模拟考试的内容：")]),s._v(" "),a("h2",{attrs:{id:"考前设置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考前设置"}},[s._v("#")]),s._v(" 考前设置")]),s._v(" "),a("h3",{attrs:{id:"命令行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#命令行"}},[s._v("#")]),s._v(" 命令行")]),s._v(" "),a("p",[s._v("一旦你获得了对终端的访问权，花 1 分钟来设置你的环境可能是明智的。你可以设置这些：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("alias")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("k")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubectl                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# will already be pre-configured")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("do")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--dry-run=client -o yaml"')]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# k create deploy nginx --image=nginx $do")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("now")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"--force --grace-period 0"')]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# k delete pod x $now")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"vim"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#vim"}},[s._v("#")]),s._v(" vim")]),s._v(" "),a("p",[s._v("以下设置已在真实环境的"),a("code",[s._v("~/.vimrc")]),s._v("中进行配置。但是，输入这些内容永远不会有什么坏处：")]),s._v(" "),a("div",{staticClass:"language-conf line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("set tabstop=2\n\nset expandtab\n\nset shiftwidth=2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("更多的设置建议在提示部分。")]),s._v(" "),a("h2",{attrs:{id:"模拟考题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#模拟考题"}},[s._v("#")]),s._v(" 模拟考题")]),s._v(" "),a("h3",{attrs:{id:"考题-1-集群上下文"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-1-集群上下文"}},[s._v("#")]),s._v(" 考题-1 | 集群上下文")]),s._v(" "),a("p",[s._v("任务权重：1%")]),s._v(" "),a("p",[s._v("你可以通过"),a("code",[s._v("kubectl")]),s._v("从主终端访问多个集群上下文。将所有这些上下文名称写入"),a("code",[s._v("/opt/course/1/contexts")]),s._v("。")]),s._v(" "),a("p",[s._v("接下来，在"),a("code",[s._v("/opt/course/1/context_default_kubectl.sh")]),s._v("中写入一个命令以显示当前上下文，该命令应该使用"),a("code",[s._v("kubectl")]),s._v("。")]),s._v(" "),a("p",[s._v("最后，将执行相同操作的第二个命令写入"),a("code",[s._v("/opt/course/1/context_default_no_kubectl.sh")]),s._v("，但不使用"),a("code",[s._v("kubectl")]),s._v("。")]),s._v(" "),a("h4",{attrs:{id:"解答"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k config get-contexts "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 手动复制")]),s._v("\n\nk config get-contexts "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /opt/course/1/contexts\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("然后，内容应该如下所示：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/1/contexts")]),s._v("\nk8s-c1-H\nk8s-c2-AC\nk8s-c3-CCC\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("接下来创建第一个命令：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/1/context_default_kubectl.sh")]),s._v("\nkubectl config current-context\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" /opt/course/1/context_default_kubectl.sh\nk8s-c1-H\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("第二个：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/1/context_default_no_kubectl.sh")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" ~/.kube/config "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" current "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sed")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-e")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"s/current-context: //"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" /opt/course/1/context_default_no_kubectl.sh\nk8s-c1-H\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"考题-2-调度控制平面节点上的pod"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-2-调度控制平面节点上的pod"}},[s._v("#")]),s._v(" 考题-2 | 调度控制平面节点上的Pod")]),s._v(" "),a("p",[s._v("任务权重：3%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("在 Namespace "),a("code",[s._v("default")]),s._v("中创建镜像为"),a("code",[s._v("httpd:2.4.41-alpine")]),s._v("的单个 Pod。这个 Pod 应该被命名为"),a("code",[s._v("pod1")]),s._v("，容器应该被命名为"),a("code",[s._v("pod1-container")]),s._v("。这个 Pod 应该"),a("b",[s._v("只")]),s._v("调度在控制平面节点上，不要在任何节点上添加新标签。")]),s._v(" "),a("h4",{attrs:{id:"解答-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-2"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("p",[s._v("首先，我们找到控制平面节点及其污点：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k get "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 找到控制平面节点")]),s._v("\n\nk describe "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" cluster1-controlplane1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" Taint "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取控制平面节点的污点")]),s._v("\n\nk get "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" cluster1-controlplane1 --show-labels "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取控制平面节点的标签")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("接下来我们创建 Pod 模板：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 检查本文档最顶部的建议，以便我们可以使用 $do")]),s._v("\nk run pod1 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("httpd:2.4.41-alpine "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".yaml\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("手动执行必要的更改。使用 Kubernetes 文档并搜索 tolerations 和 nodeSelector 以查找示例：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 2.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod1\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" httpd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("2.4.41"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("container                       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dnsPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterFirst\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restartPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Always\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tolerations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("effect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NoSchedule                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("role.kubernetes.io/control"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("plane "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodeSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("node-role.kubernetes.io/control-plane")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("p",[s._v("这里很重要，要添加在控制平面节点上运行的容限，还要添加 nodeSelector，以确保它只在控制平面节点上运行。如果我们只指定一个容忍，则 Pod 会被调度在控制平面 或 工作节点上。")]),s._v(" "),a("p",[s._v("现在我们创建它：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(".yaml create\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("让我们检查一下 pod 是否已被调度：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get pod pod1 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" wide\nNAME   READY   STATUS    RESTARTS   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".    NODE                     NOMINATED NODE\npod1   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".    cluster1-controlplane1   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"考题-3-缩减-statefulset"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-3-缩减-statefulset"}},[s._v("#")]),s._v(" 考题-3 | 缩减 StatefulSet")]),s._v(" "),a("p",[s._v("任务权重：1%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("在命名空间"),a("code",[s._v("project-c13")]),s._v("中有两个名为"),a("code",[s._v("o3db-*")]),s._v("的 Pod。现在 C13 管理层要求您将 Pod 缩减到一个副本以节省资源。")]),s._v(" "),a("h4",{attrs:{id:"解答-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-3"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("p",[s._v("找出 StatefulSet：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-c13 get pod "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" o3db\no3db-0                                  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          52s\no3db-1                                  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          42s\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-c13 get deploy,ds,sts "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" o3db\nstatefulset.apps/o3db   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     2m56s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("要完成任务，我们只需运行：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-c13 scale sts o3db "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--replicas")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\nstatefulset.apps/o3db scaled\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-c13 get sts o3db\nNAME   READY   AGE\no3db   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     4m39s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("C13 管理层再次感到高兴。")]),s._v(" "),a("h3",{attrs:{id:"考题-4-pod就绪-如果服务可达"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-4-pod就绪-如果服务可达"}},[s._v("#")]),s._v(" 考题-4 | Pod就绪（如果服务可达）")]),s._v(" "),a("p",[s._v("任务权重：4%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("在命名空间"),a("code",[s._v("default")]),s._v("中执行以下操作。创建一个名为"),a("code",[s._v("ready-if-service-ready")]),s._v("镜像为"),a("code",[s._v("nginx:1.16.1-alpine")]),s._v("的 pod 。配置一个 LivenessProbe，它只执行命令"),a("code",[s._v("true")]),s._v("。还要配置一个 ReadinessProbe，它会检查 url "),a("code",[s._v("http://service-am-i-ready:80")]),s._v("是否可访问，为此可以使用"),a("code",[s._v("wget -T2 -O- http://service-am-i-ready:80")]),s._v("。启动 Pod 并确认它尚未准备就绪，因为 ReadinessProbe 的存在。")]),s._v(" "),a("p",[s._v("创建第二个名为"),a("code",[s._v("am-i-ready")]),s._v("的 pod，镜像为"),a("code",[s._v("nginx:1.16.1-alpine")]),s._v("，标签为"),a("code",[s._v("id: cross-server-ready")]),s._v("。已经存在的 Service "),a("code",[s._v("service-am-i-ready")]),s._v("现在应该将第二个 Pod 作为端点。")]),s._v(" "),a("h4",{attrs:{id:"解答-4"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-4"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("p",[s._v("一个 Pod 使用探测器检查另一个 Pod 是否准备好是一种反模式，因此通常可用的"),a("code",[s._v("readinessProbe.httpGet")]),a("b",[s._v("不适用")]),s._v("于绝对远程 url。尽管如此，此任务中请求的解决方法应显示探测器和 Pod<->Service 通信的工作原理。")]),s._v(" "),a("p",[s._v("首先，我们创建第一个 Pod：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k run ready-if-service-ready "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx:1.16.1-alpine "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" 4_pod1.yaml\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" 4_pod1.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("接下来手动执行必要的添加：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 4_pod1.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ready"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("if"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ready\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ready"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("if"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ready\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("1.16.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ready"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("if"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ready\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("livenessProbe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 从这里开始添加")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("exec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'true'")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("readinessProbe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("exec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" sh\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("c\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'wget -T2 -O- http://service-am-i-ready:80'")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一直到这里")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dnsPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterFirst\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restartPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Always\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("p",[s._v("然后创建 Pod，并确认它处于非就绪状态：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" 4_pod1.yaml create\n\n➜ k get pod ready-if-service-ready\nNAME                     READY   STATUS    RESTARTS   AGE\nready-if-service-ready   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          7s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("现在我们创建第二个 Pod：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k run am-i-ready "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx:1.16.1-alpine "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--labels")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"id=cross-server-ready"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("已经存在的 Service "),a("code",[s._v("service-am-i-ready")]),s._v("现在应该会提供一个端点：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k describe svc service-am-i-ready\nk get ep "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 也是可能的")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("这将导致我们的第一个 Pod 准备就绪，只需给它一分钟时间让 Readiness 探测器再次检查：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get pod ready-if-service-ready\nNAME                     READY   STATUS    RESTARTS   AGE\nready-if-service-ready   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          53s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("看看这些 Pod 的协同工作！")]),s._v(" "),a("h3",{attrs:{id:"考题-5-kubectl排序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-5-kubectl排序"}},[s._v("#")]),s._v(" 考题-5 | Kubectl排序")]),s._v(" "),a("p",[s._v("任务权重：1%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("所有命名空间中都有各种 Pod。在"),a("code",[s._v("/opt/course/5/find_pods.sh")]),s._v("中写入一个命令，其中列出了按 AGE（"),a("code",[s._v("metadata.creationTimestamp")]),s._v("）排序的所有 Pod。")]),s._v(" "),a("p",[s._v("在"),a("code",[s._v("/opt/course/5/find_pods_uid.sh")]),s._v("中写入第二个命令，其中列出了按字段"),a("code",[s._v("metadata.uid")]),s._v("排序的所有 Pod。对这两个命令都使用"),a("code",[s._v("kubectl")]),s._v("排序。")]),s._v(" "),a("h4",{attrs:{id:"解答-5"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-5"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/5/find_pods.sh")]),s._v("\nkubectl get pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" --sort-by"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(".metadata.creationTimestamp\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("对于第二个命令：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/5/find_pods_uid.sh")]),s._v("\nkubectl get pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" --sort-by"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(".metadata.uid\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"考题-6-储存、pv、pvc、pod挂载"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-6-储存、pv、pvc、pod挂载"}},[s._v("#")]),s._v(" 考题-6 | 储存、PV、PVC、Pod挂载")]),s._v(" "),a("p",[s._v("任务权重：8%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("创建一个名为"),a("code",[s._v("safari-pv")]),s._v("的新 PersistentVolume。它的容量应为 2Gi、访问模式为 ReadWriteOnce、hostPath 为"),a("code",[s._v("/Volumes/Data")]),s._v("，并且未定义 storageClassName。")]),s._v(" "),a("p",[s._v("接下来，在命名空间"),a("code",[s._v("project-tiger")]),s._v("中创建一个名为"),a("code",[s._v("safari-pvc")]),s._v("的新 PersistentVolumeClaim。它应该请求 2Gi 存储、访问模式 ReadWriteOnce，并且不应定义 storageClassName。PVC 应正确绑定到 PV。")]),s._v(" "),a("p",[s._v("最后，在命名空间"),a("code",[s._v("project-tiger")]),s._v("中创建一个名为"),a("code",[s._v("safari")]),s._v("的新 Deployment，它将该卷挂载到"),a("code",[s._v("/tmp/safari-data")]),s._v("。该 Deployment 的 Pod 镜像应为"),a("code",[s._v("httpd:2.4.41-alpine")]),s._v("。")]),s._v(" "),a("h4",{attrs:{id:"解答-6"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-6"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" 6_pv.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 6_pv.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" PersistentVolume\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" safari"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pv\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("capacity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 2Gi\n "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("accessModes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ReadWriteOnce\n "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/Volumes/Data"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("然后创建它：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" 6_pv.yaml create\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 6_pvc.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" PersistentVolumeClaim\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" safari"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pvc\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("tiger\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("accessModes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" ReadWriteOnce\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n     "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("storage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 2Gi\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" 6_pvc.yaml create\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("并检查两者是否都具有 Bound 状态：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-tiger get pv,pvc\nNAME                         CAPACITY  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". STATUS   CLAIM                    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\npersistentvolume/safari-pv   2Gi       "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". Bound    project-tiger/safari-pvc "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\nNAME                               STATUS   VOLUME      CAPACITY "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\npersistentvolumeclaim/safari-pvc   Bound    safari-pv   2Gi      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("接下来，我们创建一个 Deployment 并挂载该卷：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-tiger create deploy safari "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("httpd:2.4.41-alpine "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" 6_dep.yaml\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" 6_dep.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 6_dep.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" safari\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" safari\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("tiger\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" safari\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("strategy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" safari\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" data                                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("persistentVolumeClaim")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("claimName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" safari"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pvc                     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" httpd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("2.4.41"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" container\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" data                                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /tmp/safari"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" 6_dep.yaml create\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-tiger describe pod safari-5cbf46d6d-mjhsb  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A2")]),s._v(" Mounts:   \n    Mounts:\n      /tmp/safari-data from data "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("rw"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# there it is")]),s._v("\n      /var/run/secrets/kubernetes.io/serviceaccount from default-token-n2sjj "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ro"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h3",{attrs:{id:"考题-7-node和pod资源使用情况"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-7-node和pod资源使用情况"}},[s._v("#")]),s._v(" 考题-7 | Node和Pod资源使用情况")]),s._v(" "),a("p",[s._v("任务权重：1%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("metrics-server 已安装在集群中。你的学院想知道 kubectl 命令：")]),s._v(" "),a("ol",[a("li",[s._v("显示节点资源使用情况")]),s._v(" "),a("li",[s._v("显示 Pod 及其容器资源使用情况")])]),s._v(" "),a("p",[s._v("请将命令写入"),a("code",[s._v("/opt/course/7/node.sh")]),s._v("和"),a("code",[s._v("/opt/course/7/pod.sh")]),s._v("。")]),s._v(" "),a("h4",{attrs:{id:"解答-7"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-7"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/7/node.sh")]),s._v("\nkubectl "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/7/pod.sh")]),s._v("\nkubectl "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--containers")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("true\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"考题-8-获取控制平面信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-8-获取控制平面信息"}},[s._v("#")]),s._v(" 考题-8 | 获取控制平面信息")]),s._v(" "),a("p",[s._v("任务权重：2%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("使用"),a("code",[s._v("ssh cluster1-controlplane1")]),s._v("通过 SSH 连接到控制平面节点。检查控制平面组件的 kubelet、kube-apiserver、kube-scheduler、kube-controller-manager 和 etcd 是如何在控制平面节点上启动 / 安装的。此外，找出 DNS 应用程序的名称以及它在控制平面节点上的启动 / 安装方式。")]),s._v(" "),a("p",[s._v("将您的发现写入文件"),a("code",[s._v("/opt/course/8/controlplane-components.txt")]),s._v("。该文件的结构应如下所示：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/8/controlplane-components.txt")]),s._v("\nkubelet: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("TYPE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nkube-apiserver: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("TYPE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nkube-scheduler: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("TYPE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nkube-controller-manager: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("TYPE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\netcd: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("TYPE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\ndns: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("TYPE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[a("code",[s._v("[TYPE]")]),s._v("选项包括："),a("code",[s._v("not-installed")]),s._v("、"),a("code",[s._v("process")]),s._v("、"),a("code",[s._v("static-pod")]),s._v("、"),a("code",[s._v("pod")])]),s._v(" "),a("h4",{attrs:{id:"解答-8"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-8"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("p",[s._v("我们可以从查找请求组件的进程开始，尤其是 kubelet：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster1-controlplane1\n\nroot@cluster1-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps aux | grep kubelet # shows kubelet process")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("我们可以查看"),a("code",[s._v("/etc/systemd/system")]),s._v("目录，查看通过 systemd 控制哪些组件：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster1-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# find /etc/systemd/system/ | grep kube")]),s._v("\n/etc/systemd/system/kubelet.service.d\n/etc/systemd/system/kubelet.service.d/10-kubeadm.conf\n/etc/systemd/system/multi-user.target.wants/kubelet.service\n\n➜ root@cluster1-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# find /etc/systemd/system/ | grep etcd")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("这表明 kubelet 是通过 systemd 控制的，但没有其他名为 kube 或 etcd 的服务。看起来这个集群是使用 kubeadm 设置的，所以我们检查默认的 manifests 目录：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster1-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# find /etc/kubernetes/manifests/")]),s._v("\n/etc/kubernetes/manifests/\n/etc/kubernetes/manifests/kube-controller-manager.yaml\n/etc/kubernetes/manifests/etcd.yaml\n/etc/kubernetes/manifests/kube-apiserver.yaml\n/etc/kubernetes/manifests/kube-scheduler.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("（kubelet 也可以通过其 systemd 启动配置中的参数"),a("code",[s._v("--pod-manifest-path")]),s._v("指定不同的清单目录）")]),s._v(" "),a("p",[s._v("这意味着主要的 4 个控制平面服务被设置为静态 Pod。实际上，让我们检查一下在控制平面节点上的"),a("code",[s._v("kube-system")]),s._v("命名空间中运行的所有 Pod：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster1-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n kube-system get pod -o wide | grep controlplane1")]),s._v("\ncoredns-5644d7b6d9-c4f68                            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster1-controlplane1\ncoredns-5644d7b6d9-t84sc                            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster1-controlplane1\netcd-cluster1-controlplane1                         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster1-controlplane1\nkube-apiserver-cluster1-controlplane1               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster1-controlplane1\nkube-controller-manager-cluster1-controlplane1      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster1-controlplane1\nkube-proxy-q955p                                    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster1-controlplane1\nkube-scheduler-cluster1-controlplane1               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster1-controlplane1\nweave-net-mwj47                                     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster1-controlplane1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("在那里，我们看到 5 个静态 pod，后缀为"),a("code",[s._v("-cluster1-controlplane1")]),s._v("。")]),s._v(" "),a("p",[s._v("我们也看到 dns 应用程序似乎是 coredns，但它是如何控制的呢？")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster1-controlplane1$ kubectl "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" kube-system get ds\nNAME         DESIRED   CURRENT   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   NODE SELECTOR            AGE\nkube-proxy   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   kubernetes.io/os"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("linux   155m\nweave-net    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("                   155m\n\n➜ root@cluster1-controlplane1$ kubectl "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" kube-system get deploy\nNAME      READY   UP-TO-DATE   AVAILABLE   AGE\ncoredns   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("           155m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("coredns 似乎是通过 Deployment 控制的。我们将我们的发现合并到所需的文件中：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/8/controlplane-components.txt")]),s._v("\nkubelet: process\nkube-apiserver: static-pod\nkube-scheduler: static-pod\nkube-controller-manager: static-pod\netcd: static-pod\ndns: pod coredns\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("您应该能够轻松地调查正在运行的集群，了解如何设置集群 及其 部署服务的不同方法，并能够进行故障排除和查找错误源。")]),s._v(" "),a("h3",{attrs:{id:"考题-9-杀死调度器-手动调度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-9-杀死调度器-手动调度"}},[s._v("#")]),s._v(" 考题-9 | 杀死调度器，手动调度")]),s._v(" "),a("p",[s._v("任务权重：5%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c2-AC")])]),s._v(" "),a("p",[s._v("使用"),a("code",[s._v("ssh cluster2-controlplane1")]),s._v("通过 SSH 连接到控制平面节点。"),a("b",[s._v("暂时")]),s._v("停止 kube-scheduler，这意味着您可以在之后再次启动它。")]),s._v(" "),a("p",[s._v("创建一个名为"),a("code",[s._v("manual-schedule")]),s._v("且镜像为"),a("code",[s._v("httpd:2.4-alpine")]),s._v("的 Pod，确认它已创建但未在任何节点上调度。")]),s._v(" "),a("p",[s._v("现在假设你是调度器，并拥有它的所有功能，在节点 cluster2-controlplane1 上手动调度该 Pod。确保它正在运行。")]),s._v(" "),a("p",[s._v("再次启动 kube-scheduler 并创建镜像为"),a("code",[s._v("httpd:2.4-alpine")]),s._v("的第二个名为"),a("code",[s._v("manual-schedule2")]),s._v("的 Pod 来确认它运行正常，并检查它是否在 cluster2-node1 上运行。")]),s._v(" "),a("h4",{attrs:{id:"解答-9"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-9"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("h5",{attrs:{id:"暂停调度器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#暂停调度器"}},[s._v("#")]),s._v(" 暂停调度器")]),s._v(" "),a("p",[s._v("首先，我们找到控制平面节点：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\nNAME                     STATUS   ROLES           AGE   VERSION\ncluster2-controlplane1   Ready    control-plane   26h   v1.26.0\ncluster2-node1           Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          26h   v1.26.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("然后我们连接并检查调度程序是否正在运行：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster2-controlplane1\n\n➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n kube-system get pod | grep schedule")]),s._v("\nkube-scheduler-cluster2-controlplane1            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          6s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("杀死调度器（暂时）：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /etc/kubernetes/manifests/")]),s._v("\n\n➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv kube-scheduler.yaml ..")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("它应该已被停止：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n kube-system get pod | grep schedule")]),s._v("\n\n➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h5",{attrs:{id:"创建pod"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建pod"}},[s._v("#")]),s._v(" 创建Pod")]),s._v(" "),a("p",[s._v("现在我们创建Pod：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k run manual-schedule "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("httpd:2.4-alpine\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("并确认它没有分配节点：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get pod manual-schedule "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" wide\nNAME              READY   STATUS    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   NODE     NOMINATED NODE\nmanual-schedule   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/1     Pending   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h5",{attrs:{id:"手动调度pod"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#手动调度pod"}},[s._v("#")]),s._v(" 手动调度Pod")]),s._v(" "),a("p",[s._v("让我们现在充当调度程序：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k get pod manual-schedule "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" yaml "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(".yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 9.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodeName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cluster2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("controlplane1        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 添加控制平面节点的名称")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" httpd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("2.4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" manual"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("schedule\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("调度程序唯一做的事情就是为 Pod 声明设置 nodeName。它如何找到正确的节点进行调度，这是一个非常复杂的问题，需要考虑许多变量。")]),s._v(" "),a("p",[s._v("由于我们不能"),a("code",[s._v("kubectl apply")]),s._v("或"),a("code",[s._v("kubectl edit")]),s._v("，在这种情况下，我们需要删除然后重新创建，或者使用替换：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),s._v(".yaml replace "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--force")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("看起来怎么样？")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get pod manual-schedule "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" wide\nNAME              READY   STATUS    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   NODE            \nmanual-schedule   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster2-controlplane1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("看起来我们的 Pod 现在正在按要求在控制平面上运行，尽管没有指定容忍度。只有调度程序在查找正确的节点名时才会考虑 tains/tolerations/affinity。这就是为什么仍然可以直接手动将 Pod 分配给控制平面节点并跳过调度程序。")]),s._v(" "),a("h5",{attrs:{id:"再次启动调度程序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#再次启动调度程序"}},[s._v("#")]),s._v(" 再次启动调度程序")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster2-controlplane1\n\n➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /etc/kubernetes/manifests/")]),s._v("\n\n➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv ../kube-scheduler.yaml .")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("检查它正在运行：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n kube-system get pod | grep schedule")]),s._v("\nkube-scheduler-cluster2-controlplane1            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          16s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("调度第二个测试 Pod：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k run manual-schedule2 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("httpd:2.4-alpine\n\n➜ k get pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" wide "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" schedule\nmanual-schedule    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster2-controlplane1\nmanual-schedule2   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster2-node1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("恢复正常。")]),s._v(" "),a("h3",{attrs:{id:"考题-10-rbac-serviceaccount-role-rolebinding"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-10-rbac-serviceaccount-role-rolebinding"}},[s._v("#")]),s._v(" 考题-10 | RBAC ServiceAccount Role RoleBinding")]),s._v(" "),a("p",[s._v("任务权重：6%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("在命名空间"),a("code",[s._v("project-hamster")]),s._v("中创建新的 ServiceAccount "),a("code",[s._v("processor")]),s._v("。创建一个 Role 和 RoleBinding，这两个名称也都命名为"),a("code",[s._v("processor")]),s._v("。这些应该允许新的 SA 只在该命名空间中创建 Secret 和 ConfigMap。")]),s._v(" "),a("h4",{attrs:{id:"解答-10"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-10"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("h5",{attrs:{id:"让我们稍微讨论一下rbac资源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#让我们稍微讨论一下rbac资源"}},[s._v("#")]),s._v(" 让我们稍微讨论一下RBAC资源")]),s._v(" "),a("p",[s._v("ClusterRole|Role 定义了一组权限及其"),a("b",[s._v("可用范围")]),s._v("，是在整个集群中 还是 仅在单个命名空间中。")]),s._v(" "),a("p",[s._v("ClusterRoleBinding|RoleBinding 将一组权限与帐户连接起来，并定义"),a("b",[s._v("应用权限的位置")]),s._v("，是在整个群集中还是仅在单个命名空间中。")]),s._v(" "),a("p",[s._v("因此，有 4 种不同的 RBAC 组合和 3 种有效的组合：")]),s._v(" "),a("ol",[a("li",[s._v("Role + RoleBinding（可在单个空间中使用，在单个命名空间中应用）")]),s._v(" "),a("li",[s._v("ClusterRole + ClusterRoleBinding（群集范围内可用，群集范围内应用）")]),s._v(" "),a("li",[s._v("ClusterRole + RoleBinding（群集范围内可用，应用于单个命名空间）")]),s._v(" "),a("li",[s._v("Role + ClusterRoleBinding（"),a("b",[s._v("不可能")]),s._v("：在单个命名空间中可用，在群集范围内应用）")])]),s._v(" "),a("h5",{attrs:{id:"前往解决方案"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前往解决方案"}},[s._v("#")]),s._v(" 前往解决方案")]),s._v(" "),a("p",[s._v("我们首先创建 ServiceAccount 和 Role：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-hamster create sa processor\nserviceaccount/processor created\n\nk "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-hamster create role processor "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--verb")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("create "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--resource")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("secret "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--resource")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("configmap\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("这将创建一个角色，例如：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n project-hamster create role processor --verb=create --resource=secret --resource=configmap")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Role\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" processor\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("hamster\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("rules")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiGroups")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" secrets\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" configmaps\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("verbs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" create\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("现在我们将 Role 绑定到 ServiceAccount：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-hamster create rolebinding processor "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--role")]),s._v(" processor "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--serviceaccount")]),s._v(" project-hamster:processor\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("这将创建一个 RoleBinding，如下所示：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n project-hamster create rolebinding processor --role processor --serviceaccount project-hamster:processor")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" RoleBinding\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" processor\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("hamster\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("roleRef")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiGroup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" rbac.authorization.k8s.io\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Role\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" processor\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("subjects")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ServiceAccount\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" processor\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("hamster\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("想要测试我们的 RBAC 设置，我们可以使用"),a("code",[s._v("kubectl auth can-i")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-hamster auth can-i create secret "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--as")]),s._v(" system:serviceaccount:project-hamster:processor\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-hamster auth can-i create configmap "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--as")]),s._v(" system:serviceaccount:project-hamster:processor\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-hamster auth can-i create pod "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--as")]),s._v(" system:serviceaccount:project-hamster:processor\nno\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-hamster auth can-i delete secret "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--as")]),s._v(" system:serviceaccount:project-hamster:processor\nno\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-hamster auth can-i get configmap "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--as")]),s._v(" system:serviceaccount:project-hamster:processor\nno\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("h3",{attrs:{id:"考题-11-所有节点上的daemonset"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-11-所有节点上的daemonset"}},[s._v("#")]),s._v(" 考题-11 | 所有节点上的DaemonSet")]),s._v(" "),a("p",[s._v("任务权重：4%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("将命名空间"),a("code",[s._v("project-tiger")]),s._v("用于以下目的。创建一个名为"),a("code",[s._v("ds-important")]),s._v("的 DaemonSet，其镜像为"),a("code",[s._v("httpd:2.4-alpine")]),s._v("，标签为"),a("code",[s._v("id=ds-important")]),s._v("和"),a("code",[s._v("uuid=18426a0b-5f59-4e10-923f-c0e078e82462")]),s._v("。它创建的 Pod 应该请求 10 毫核 cpu 和 10 兆字节内存。该 DaemonSet 的 Pod 应该在所有节点上运行，包括控制平面。")]),s._v(" "),a("h4",{attrs:{id:"解答-11"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-11"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("p",[s._v("到目前为止，我们还不能直接使用"),a("code",[s._v("kubectl")]),s._v("创建 DaemonSet，因此我们创建了一个 Deployment 并对其进行更改：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-tiger create deployment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("httpd:2.4-alpine ds-important "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(".yaml\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(".yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("然后我们调整 yaml 为：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 11.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" DaemonSet                                     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change from Deployment to Daemonset")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("important                                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("uuid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 18426a0b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("5f59"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("4e10"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("923f"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("c0e078e82462      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("important\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("tiger                          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# important")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#replicas: 1                                      # remove")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("important                              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("uuid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 18426a0b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("5f59"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("4e10"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("923f"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("c0e078e82462    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#strategy: {}                                     # remove")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("important                            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("uuid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 18426a0b"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("5f59"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("4e10"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("923f"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("c0e078e82462  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" httpd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("2.4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ds"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("important\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10m                                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10Mi                            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tolerations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("effect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NoSchedule                          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("role.kubernetes.io/control"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("plane  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#status: {}                                         # remove")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br")])]),a("p",[s._v("要求 DaemonSet 在所有节点上运行，因此我们需要为此指定容忍度。")]),s._v(" "),a("p",[s._v("让我们确认一下：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(".yaml create\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-tiger get ds\nNAME           DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE\nds-important   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("           "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          8s\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-tiger get pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ds-important "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" wide\nNAME                      READY   STATUS          NODE\nds-important-6pvgm        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster1-node1\nds-important-lh5ts        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster1-controlplane1\nds-important-qhjcq        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster1-node2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h3",{attrs:{id:"考题-12-所有节点上的deployment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-12-所有节点上的deployment"}},[s._v("#")]),s._v(" 考题-12 | 所有节点上的Deployment")]),s._v(" "),a("p",[s._v("任务权重：6%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("将命名空间"),a("code",[s._v("project-tiger")]),s._v("用于以下目的。创建一个名为"),a("code",[s._v("deploy-important")]),s._v("的 Deployment，标签为"),a("code",[s._v("id=very-important")]),s._v("（"),a("code",[s._v("Pods")]),s._v("也应该有这个标签）和 3 个副本。它应该包含两个容器，第一个名为"),a("code",[s._v("container1")]),s._v("，镜像为"),a("code",[s._v("nginx:1.17.6-alpine")]),s._v("，第二个名为"),a("code",[s._v("container2")]),s._v("，镜像为"),a("code",[s._v("kubernetes/pause")]),s._v("。")]),s._v(" "),a("p",[s._v("该 Deployment 的单个 Pod 应该只在一个工作节点上运行。我们有两个工作节点："),a("code",[s._v("cluster1-node1")]),s._v("和"),a("code",[s._v("cluster1-node2")]),s._v("。因为 Deployment 有三个副本，所以结果应该是在两个节点上都运行着一个 Pod。除非添加新的工作节点，否则不会调度第三个 Pod。")]),s._v(" "),a("p",[s._v("在某种程度上，我们在这里模拟了 "),a("b",[s._v("DaemonSet")]),s._v(" 的行为，但使用了 "),a("b",[s._v("Deployment")]),s._v(" 和固定数量的副本。")]),s._v(" "),a("h4",{attrs:{id:"解答-12"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-12"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("p",[s._v("有两种可能的方法，一种使用"),a("code",[s._v("podAntiAffinity")]),s._v("，另一种使用"),a("code",[s._v("topologySpreadConstraint")]),s._v("。")]),s._v(" "),a("h5",{attrs:{id:"podantiaffinity"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#podantiaffinity"}},[s._v("#")]),s._v(" PodAntiAffinity")]),s._v(" "),a("p",[s._v("这里的想法是，我们创建了一个 “Pod 之间的反亲和性” ，它允许我们让一个 Pod 应该只调度在一个节点上，而另一个特定标签（这里是同一个标签）的 Pod 还没有运行。")]),s._v(" "),a("p",[s._v("让我们从创建 Deployment 模板开始开始：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-tiger create deployment "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx:1.17.6-alpine deploy-important "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(".yaml\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(".yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 12.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" very"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("important                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("important\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("tiger              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# important")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" very"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("important                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("strategy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" very"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("important              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("1.17.6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" container1                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes/pause         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" container2                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("affinity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podAntiAffinity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requiredDuringSchedulingIgnoredDuringExecution")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labelSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchExpressions")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n              "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" id                                     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("operator")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" In                                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" very"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("important                            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("topologyKey")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes.io/hostname             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br")])]),a("p",[s._v("指定一个 topologyKey，这是一个预填充的 Kubernetes 标签，你可以通过描述节点来找到它。")]),s._v(" "),a("h5",{attrs:{id:"topologyspreadconstraints"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#topologyspreadconstraints"}},[s._v("#")]),s._v(" TopologySpreadConstraints")]),s._v(" "),a("p",[s._v("我们可以用"),a("code",[s._v("topologySpreadConstraints")]),s._v("实现同样的目标。最好同时尝试一下两者。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 12.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" very"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("important                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("important\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("tiger              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# important")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" very"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("important                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("strategy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" very"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("important              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("1.17.6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" container1                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes/pause         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" container2                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("topologySpreadConstraints")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("maxSkew")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("                               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("topologyKey")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes.io/hostname      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("whenUnsatisfiable")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" DoNotSchedule         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labelSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" very"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("important                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br")])]),a("h5",{attrs:{id:"应用并运行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#应用并运行"}},[s._v("#")]),s._v(" 应用并运行")]),s._v(" "),a("p",[s._v("让我们运行它，然后我们检查 Deployment 状态，其中显示 2/3 就绪计数：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(".yaml create\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-tiger get deploy "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("very-important\nNAME               READY   UP-TO-DATE   AVAILABLE   AGE\ndeploy-important   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/3     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("           2m35s\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-tiger get pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" wide "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("id")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("very-important\nNAME                                READY   STATUS    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   NODE             \ndeploy-important-58db9db6fc-9ljpw   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster1-node1\ndeploy-important-58db9db6fc-lnxdb   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("/2     Pending   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          \ndeploy-important-58db9db6fc-p2rz8   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   cluster1-node2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("如果我们 kubectl 描述 Pod "),a("code",[s._v("deploy-important-58db9db6fc-lnxdb")]),s._v("，它将向我们展示不调度的原因是我们实现的"),a("code",[s._v("podAntiAffinity")]),s._v("规则：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Warning  FailedScheduling  63s (x3 over 65s)  default-scheduler  0/3 nodes are available: 1 node(s) had taint {node-role.kubernetes.io/control-plane: }, that the pod didn't tolerate, 2 node(s) didn't match pod affinity/anti-affinity, 2 node(s) didn't satisfy existing pods anti-affinity rules.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("或者我们的拓扑约束：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("Warning  FailedScheduling  16s   default-scheduler  0/3 nodes are available: 1 node(s) had taint {node-role.kubernetes.io/control-plane: }, that the pod didn't tolerate, 2 node(s) didn't match pod topology spread constraints.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"考题-13-多容器-pod-共享卷"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-13-多容器-pod-共享卷"}},[s._v("#")]),s._v(" 考题-13 | 多容器 Pod 共享卷")]),s._v(" "),a("p",[s._v("任务权重：4%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("在命名空间"),a("code",[s._v("default")]),s._v("中创建一个名为"),a("code",[s._v("multi-container-playground")]),s._v("的 Pod，其中包含三个容器，分别名为"),a("code",[s._v("c1")]),s._v("、"),a("code",[s._v("c2")]),s._v("和"),a("code",[s._v("c3")]),s._v("。应该有一个卷附加到该 Pod 并挂载到每个容器中，但该卷不应持久化或与其他 Pod 共享。")]),s._v(" "),a("p",[s._v("容器"),a("code",[s._v("c1")]),s._v("的镜像应为"),a("code",[s._v("nginx:1.17.6-alpine")]),s._v("，并且运行该 Pod 的节点名称可作为环境变量"),a("code",[s._v("MY_NODE_NAME")]),s._v("。")]),s._v(" "),a("p",[s._v("容器"),a("code",[s._v("c2")]),s._v("的镜像应为"),a("code",[s._v("busybox:1.31.1")]),s._v("，并且每秒将"),a("code",[s._v("date")]),s._v("命令的输出写入共享卷中的"),a("code",[s._v("date.log")]),s._v("文件。您可以使用"),a("code",[s._v("while true; do date >> /your/vol/path/date.log; sleep 1; done")]),s._v("来完成。")]),s._v(" "),a("p",[s._v("容器"),a("code",[s._v("c3")]),s._v("的镜像应为"),a("code",[s._v("busybox:1.31.1")]),s._v("，并不断将文件"),a("code",[s._v("date.log")]),s._v("的内容从共享卷发送到标准输出。为此，您可以使用"),a("code",[s._v("tail -f /your/vol/path/date.log")]),s._v("来完成。")]),s._v(" "),a("p",[s._v("检查容器"),a("code",[s._v("c3")]),s._v("的日志以确认设置正确。")]),s._v(" "),a("h4",{attrs:{id:"解答-13"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-13"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("p",[s._v("首先我们创建 Pod 模板：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k run multi-container-playground "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx:1.17.6-alpine "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(".yaml\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(".yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 13.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" multi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("container"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("playground\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" multi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("container"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("playground\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("1.17.6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" c1                                                                      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                                                          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" MY_NODE_NAME                                                          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("valueFrom")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                                                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("fieldRef")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                                                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("fieldPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" spec.nodeName                                                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                                                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" vol                                                                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /vol                                                             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" busybox"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("1.31.1                                                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" c2                                                                      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sh"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-c"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"while true; do date >> /vol/date.log; sleep 1; done"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                                                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" vol                                                                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /vol                                                             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" busybox"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("1.31.1                                                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" c3                                                                      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sh"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-c"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"tail -f /vol/date.log"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("                                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                                                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" vol                                                                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /vol                                                             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dnsPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterFirst\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restartPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Always\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                                                        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" vol                                                                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("emptyDir")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("                                                                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br")])]),a("p",[s._v("哦，天哪，很多要求的东西。我们检查 Pod 是否一切正常：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(".yaml create\n\n➜ k get pod multi-container-playground\nNAME                         READY   STATUS    RESTARTS   AGE\nmulti-container-playground   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("/3     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          95s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("很好，然后我们检查容器 c1 是否将请求的节点名称作为 env 变量：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" multi-container-playground "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" c1 -- "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" MY\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("MY_NODE_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("cluster1-node2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("最后，我们检查日志：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k logs multi-container-playground "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" c3\nSat Dec  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":05:10 UTC "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2077")]),s._v("\nSat Dec  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":05:11 UTC "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2077")]),s._v("\nSat Dec  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":05:12 UTC "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2077")]),s._v("\nSat Dec  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":05:13 UTC "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2077")]),s._v("\nSat Dec  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":05:14 UTC "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2077")]),s._v("\nSat Dec  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":05:15 UTC "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2077")]),s._v("\nSat Dec  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":05:16 UTC "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2077")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h3",{attrs:{id:"考题-14-了解群集信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-14-了解群集信息"}},[s._v("#")]),s._v(" 考题-14 | 了解群集信息")]),s._v(" "),a("p",[s._v("任务权重：2%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("系统会要求您了解有关集群"),a("code",[s._v("k8s-c1-H")]),s._v("的以下信息：")]),s._v(" "),a("ol",[a("li",[s._v("有多少控制平面节点可用？")]),s._v(" "),a("li",[s._v("有多少工作节点可用？")]),s._v(" "),a("li",[s._v("服务的 CIDR（网段）是多少？")]),s._v(" "),a("li",[s._v("配置了哪个网络（或 CNI 插件），其配置文件在哪里？")]),s._v(" "),a("li",[s._v("在 cluster1-node1 上运行的静态 pod 会有哪个后缀？")])]),s._v(" "),a("p",[s._v("将答案写入文件"),a("code",[s._v("/opt/course/14/cluster-info")]),s._v("，结构如下：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/14/cluster-info")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ANSWER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ANSWER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ANSWER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ANSWER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ANSWER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h4",{attrs:{id:"解答-14"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-14"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("h5",{attrs:{id:"有多少控制平面和工作节点可用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#有多少控制平面和工作节点可用"}},[s._v("#")]),s._v(" 有多少控制平面和工作节点可用？")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\nNAME                    STATUS   ROLES          AGE   VERSION\ncluster1-controlplane1  Ready    control-plane  27h   v1.26.0\ncluster1-node1          Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("         27h   v1.26.0\ncluster1-node2          Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("         27h   v1.26.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("我们看到一个控制平面和两个 worker。")]),s._v(" "),a("h5",{attrs:{id:"服务的-cidr-网段-是多少"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务的-cidr-网段-是多少"}},[s._v("#")]),s._v(" 服务的 CIDR（网段）是多少？")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster1-controlplane1\n\n➜ root@cluster1-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep range")]),s._v("\n    - --service-cluster-ip-range"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.0/12\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h5",{attrs:{id:"配置了哪个网络-或-cni-插件-其配置文件在哪里"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置了哪个网络-或-cni-插件-其配置文件在哪里"}},[s._v("#")]),s._v(" 配置了哪个网络（或 CNI 插件），其配置文件在哪里？")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster1-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# find /etc/cni/net.d/")]),s._v("\n/etc/cni/net.d/\n/etc/cni/net.d/10-weave.conflist\n\n➜ root@cluster1-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/cni/net.d/10-weave.conflist")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"cniVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"0.3.0"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"weave"')]),s._v(",\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("默认情况下，kubelet 会检测"),a("code",[s._v("/etc/cni/net.d")]),s._v("以发现 CNI 插件。这在每个控制平面和工作器节点上都是相同的。")]),s._v(" "),a("h5",{attrs:{id:"在-cluster1-node1-上运行的静态-pod-会有哪个后缀"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在-cluster1-node1-上运行的静态-pod-会有哪个后缀"}},[s._v("#")]),s._v(" 在 cluster1-node1 上运行的静态 pod 会有哪个后缀？")]),s._v(" "),a("p",[s._v("后缀是带有前导连字符的节点主机名。在早期的 Kubernetes 版本中，它曾经是"),a("code",[s._v("-static")]),s._v("。")]),s._v(" "),a("h5",{attrs:{id:"结果"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#结果"}},[s._v("#")]),s._v(" 结果")]),s._v(" "),a("p",[s._v("生成的"),a("code",[s._v("/opt/course/14/cluster-info")]),s._v("可能如下所示：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/14/cluster-info")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# How many controlplane nodes are available?")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# How many worker nodes are available?")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# What is the Service CIDR?")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.96")]),s._v(".0.0/12\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Which Networking (or CNI Plugin) is configured and where is its config file?")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(": Weave, /etc/cni/net.d/10-weave.conflist\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Which suffix will static pods have that run on cluster1-node1?")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(": -cluster1-node1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br")])]),a("h3",{attrs:{id:"考题-15-群集事件日志记录"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-15-群集事件日志记录"}},[s._v("#")]),s._v(" 考题-15 | 群集事件日志记录")]),s._v(" "),a("p",[s._v("任务权重：3%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c2-AC")])]),s._v(" "),a("p",[s._v("在"),a("code",[s._v("/opt/course/15/cluster_events.sh")]),s._v("中写入一个命令，该命令显示整个集群中按时间排序的最新事件 （"),a("code",[s._v("metadata.creationTimestamp")]),s._v("）。使用"),a("code",[s._v("kubectl")]),s._v("来获取它。")]),s._v(" "),a("p",[s._v("现在终止在节点 cluster2-node1 上运行的 Pod "),a("code",[s._v("kube-proxy")]),s._v("，并将这导致的事件写入"),a("code",[s._v("/opt/course/15/pod_kill.log")]),s._v("。")]),s._v(" "),a("p",[s._v("最后，在节点 cluster2-node1 上杀死 Pod "),a("code",[s._v("kube-proxy")]),s._v("的 containerd 容器，并将事件写入"),a("code",[s._v("/opt/course/15/container_kill.log")]),s._v("。")]),s._v(" "),a("p",[s._v("你是否注意到这两种行为引起的事件的不同之处？")]),s._v(" "),a("h4",{attrs:{id:"解答-15"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-15"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/15/cluster_events.sh")]),s._v("\nkubectl get events "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" --sort-by"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(".metadata.creationTimestamp\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("现在我们杀死 kube-proxy Pod：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" kube-system get pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" wide "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" proxy "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# find pod running on cluster2-node1")]),s._v("\n\nk "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" kube-system delete pod kube-proxy-z64cg\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("现在检查事件：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" /opt/course/15/cluster_events.sh\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("将停止引起的事件写入"),a("code",[s._v("/opt/course/15/pod_kill.log")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/15/pod_kill.log")]),s._v("\nkube-system   9s          Normal    Killing           pod/kube-proxy-jsv7t   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nkube-system   3s          Normal    SuccessfulCreate  daemonset/kube-proxy   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nkube-system   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("unknown"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   Normal    Scheduled         pod/kube-proxy-m52sx   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\ndefault       2s          Normal    Starting          node/cluster2-node1  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nkube-system   2s          Normal    Created           pod/kube-proxy-m52sx   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nkube-system   2s          Normal    Pulled            pod/kube-proxy-m52sx   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nkube-system   2s          Normal    Started           pod/kube-proxy-m52sx   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("最后，我们将尝试通过杀死属于 kube-proxy Pod 的容器来引发事件：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster2-node1\n\n➜ root@cluster2-node1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# crictl ps | grep kube-proxy")]),s._v("\n1e020b43c4423   36c4ebbc9d979   About an hour ago   Running   kube-proxy     "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\n➜ root@cluster2-node1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# crictl rm 1e020b43c4423")]),s._v("\n1e020b43c4423\n\n➜ root@cluster2-node1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# crictl ps | grep kube-proxy")]),s._v("\n0ae4245707910   36c4ebbc9d979   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),s._v(" seconds ago      Running   kube-proxy     "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".     \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("我们终止了主容器（1e020b43c4423），但也注意到直接创建了一个新容器（0ae4245707910）。谢谢 Kubernetes！")]),s._v(" "),a("p",[s._v("现在我们看看这是否再次引起了事件，并将其写入第二个文件：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" /opt/course/15/cluster_events.sh\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/15/container_kill.log")]),s._v("\nkube-system   13s         Normal    Created      pod/kube-proxy-m52sx    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nkube-system   13s         Normal    Pulled       pod/kube-proxy-m52sx    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nkube-system   13s         Normal    Started      pod/kube-proxy-m52sx    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("比较这些事件，我们看到，当我们删除整个 Pod 时，有更多的事情要做，因此有更多的事件。例如，游戏中的 DaemonSet 用于重新创建丢失的 Pod。当我们手动杀死 Pod 的主容器时，Pod 仍然存在，但只需要重新创建它的容器，因此事件更少。")]),s._v(" "),a("h3",{attrs:{id:"考题-16-命名空间和api资源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-16-命名空间和api资源"}},[s._v("#")]),s._v(" 考题-16 | 命名空间和API资源")]),s._v(" "),a("p",[s._v("任务权重：2%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("将所有命名空间的 Kubernetes 资源（如 Pod、Secret、ConfigMap 等）的名称写入"),a("code",[s._v("/opt/course/16/resources.txt")]),s._v("。")]),s._v(" "),a("p",[s._v("找到定义了最多 Role 数量的"),a("code",[s._v("project-*")]),s._v("命名空间，并将其名称和角色数量写入"),a("code",[s._v("/opt/course/16/crowded-namespace.txt")]),s._v("。")]),s._v(" "),a("h4",{attrs:{id:"解答-16"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-16"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("h5",{attrs:{id:"命名空间和资源"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#命名空间和资源"}},[s._v("#")]),s._v(" 命名空间和资源")]),s._v(" "),a("p",[s._v("现在我们可以得到所有资源的列表，如：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k api-resources    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# shows all")]),s._v("\n\nk api-resources "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-h")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# help always good")]),s._v("\n\nk api-resources "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--namespaced")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" name "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /opt/course/16/resources.txt\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("这将导致文件：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/16/resources.txt")]),s._v("\nbindings\nconfigmaps\nendpoints\nevents\nlimitranges\npersistentvolumeclaims\npods\npodtemplates\nreplicationcontrollers\nresourcequotas\nsecrets\nserviceaccounts\nservices\ncontrollerrevisions.apps\ndaemonsets.apps\ndeployments.apps\nreplicasets.apps\nstatefulsets.apps\nlocalsubjectaccessreviews.authorization.k8s.io\nhorizontalpodautoscalers.autoscaling\ncronjobs.batch\njobs.batch\nleases.coordination.k8s.io\nevents.events.k8s.io\ningresses.extensions\ningresses.networking.k8s.io\nnetworkpolicies.networking.k8s.io\npoddisruptionbudgets.policy\nrolebindings.rbac.authorization.k8s.io\nroles.rbac.authorization.k8s.io\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br")])]),a("h5",{attrs:{id:"最多role的命名空间"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#最多role的命名空间"}},[s._v("#")]),s._v(" 最多Role的命名空间")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-c13 get role --no-headers "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v("\nNo resources found "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" project-c13 namespace.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-c14 get role --no-headers "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v("\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-hamster get role --no-headers "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v("\nNo resources found "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" project-hamster namespace.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-snake get role --no-headers "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v("\nNo resources found "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" project-snake namespace.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-tiger get role --no-headers "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("wc")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v("\nNo resources found "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" project-tiger namespace.\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("最后，我们将名称和数量写入文件：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/16/crowded-namespace.txt")]),s._v("\nproject-c14 with "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v(" resources\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"考题-17-找到pod的容器并检查信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-17-找到pod的容器并检查信息"}},[s._v("#")]),s._v(" 考题-17 | 找到Pod的容器并检查信息")]),s._v(" "),a("p",[s._v("任务权重：3%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("在命名空间"),a("code",[s._v("project-tiger")]),s._v("中，创建一个名为"),a("code",[s._v("tigers-reunite")]),s._v("的 Pod，其镜像为"),a("code",[s._v("httpd:2.4.41-alpine")]),s._v("，标签为"),a("code",[s._v("pod=container")]),s._v("和"),a("code",[s._v("container=pod")]),s._v("。找出 Pod 被调度在哪个节点上。通过 SSH 连接到该节点并找到属于该 Pod 的 containerd 容器。")]),s._v(" "),a("p",[s._v("使用命令"),a("code",[s._v("crictl")]),s._v("：")]),s._v(" "),a("ol",[a("li",[s._v("将容器的 ID 和"),a("code",[s._v("info.runtimeType")]),s._v("写入"),a("code",[s._v("/opt/course/17/pod-container.txt")])]),s._v(" "),a("li",[s._v("将容器的日志写入"),a("code",[s._v("/opt/course/17/pod-container.log")])])]),s._v(" "),a("h4",{attrs:{id:"解答-17"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-17"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("p",[s._v("首先，我们创建 Pod：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-tiger run tigers-reunite "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("httpd:2.4.41-alpine "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--labels")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pod=container,container=pod"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("接下来，我们找出它被调度的节点：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-tiger get pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" wide\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# or fancy:")]),s._v("\nk "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-tiger get pod tigers-reunite "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("jsonpath")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"{.spec.nodeName}"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("然后我们通过 ssh 连接该节点并检查容器信息：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster1-node2\n\n➜ root@cluster1-node2:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# crictl ps | grep tigers-reunite")]),s._v("\nb01edbe6f89ed    54b0995a63052    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" seconds ago    Running        tigers-reunite "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\n➜ root@cluster1-node2:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# crictl inspect b01edbe6f89ed | grep runtimeType")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"runtimeType"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"io.containerd.runc.v2"')]),s._v(",\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("然后我们填写请求的文件（在主终端上）：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/17/pod-container.txt")]),s._v("\nb01edbe6f89ed io.containerd.runc.v2\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("最后，我们在第二个文件中写入容器日志：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster1-node2 "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'crictl logs b01edbe6f89ed'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v(" /opt/course/17/pod-container.log\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("上述命令中的"),a("code",[s._v("&>")]),s._v("会重定向标准输出和标准错误。")]),s._v(" "),a("p",[s._v("您也可以简单地在节点上运行"),a("code",[s._v("crictl logs")]),s._v("并手动复制内容（如果不是很多的话）。该文件应如下所示：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/17/pod-container.log")]),s._v("\nAH00558: httpd: Could not reliably determine the server"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'s fully qualified domain name, using 10.44.0.37. Set the '")]),s._v("ServerName"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("' directive globally to suppress this message\nAH00558: httpd: Could not reliably determine the server'")]),s._v("s fully qualified domain name, using "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.37. Set the "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ServerName'")]),s._v(" directive globally to suppress this message\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Mon Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":32:18.555280 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mpm_event:notice"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(":tid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("139929534545224")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" AH00489: Apache/2.4.41 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Unix"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" configured -- resuming normal operations\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Mon Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":32:18.555610 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("core:notice"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(":tid "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("139929534545224")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" AH00094: Command line: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'httpd -D FOREGROUND'")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"考题-18-修复kubelet"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-18-修复kubelet"}},[s._v("#")]),s._v(" 考题-18 | 修复Kubelet")]),s._v(" "),a("p",[s._v("任务权重：8%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c3-CCC")])]),s._v(" "),a("p",[s._v("kubelet 似乎存在问题，无法在"),a("code",[s._v("cluster3-node1")]),s._v("上运行。修复它，然后确认群集的节点"),a("code",[s._v("cluster3-node1")]),s._v("处于 “Ready” 状态。之后，您应该能够在"),a("code",[s._v("cluster3-node1")]),s._v("上调度一个 Pod。")]),s._v(" "),a("p",[s._v("将问题的原因写入"),a("code",[s._v("/opt/course/18/reason.txt")]),s._v("。")]),s._v(" "),a("h4",{attrs:{id:"解答-18"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-18"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("p",[s._v("像这样的任务的过程应该是检查 kubelet 是否正在运行，如果没有则启动它，然后检查它的日志并纠正错误（如果有的话）。")]),s._v(" "),a("p",[s._v("检查其他集群是否已经定义并运行了某些组件总是很有帮助的，这样您就可以复制和使用现有的配置文件。但在这种情况下，它可能不需要是必要的。")]),s._v(" "),a("p",[s._v("检查节点状态：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\nNAME                     STATUS     ROLES           AGE   VERSION\ncluster3-controlplane1   Ready      control-plane   14d   v1.26.0\ncluster3-node1           NotReady   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          14d   v1.26.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("首先，我们检查 kubelet 是否正在运行：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster3-node1\n\n➜ root@cluster3-node1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ps aux | grep kubelet")]),s._v("\nroot     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("29294")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.2")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14856")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1016")]),s._v(" pts/0    S+   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":30   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":00 "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--color")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("auto kubelet\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("没有，所以我们检查它是否使用 systemd 作为服务配置：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster3-node1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service kubelet status")]),s._v("\n● kubelet.service - kubelet: The Kubernetes Node Agent\n   Loaded: loaded "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("/lib/systemd/system/kubelet.service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" enabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" vendor preset: enabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  Drop-In: /etc/systemd/system/kubelet.service.d\n           └─10-kubeadm.conf\n   Active: inactive "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("dead"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" since Sun "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2019")]),s._v("-12-08 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(":30:06 UTC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 50min 52s ago\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("是的，它在"),a("code",[s._v("/etc/systemd/system/kubelet.service.d/10-kubeadm.conf")]),s._v("中被配置为服务，但我们看到它处于非活动状态。让我们试着开始它：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster3-node1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service kubelet start")]),s._v("\n\n➜ root@cluster3-node1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service kubelet status")]),s._v("\n● kubelet.service - kubelet: The Kubernetes Node Agent\n   Loaded: loaded "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("/lib/systemd/system/kubelet.service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" enabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" vendor preset: enabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n  Drop-In: /etc/systemd/system/kubelet.service.d\n           └─10-kubeadm.conf\n   Active: activating "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("auto-restart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Result: exit-code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" since Thu "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-04-30 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":03:10 UTC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 3s ago\n     Docs: https://kubernetes.io/docs/home/\n  Process: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5989")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/local/bin/kubelet "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_KUBECONFIG_ARGS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_CONFIG_ARGS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_KUBEADM_ARGS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_EXTRA_ARGS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("code"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exited, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("203")]),s._v("/EXEC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n Main PID: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5989")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("code"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exited, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("203")]),s._v("/EXEC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nApr "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":03:10 cluster3-node1 systemd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5989")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": kubelet.service: Failed at step EXEC spawning /usr/local/bin/kubelet: No such "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" or directory\nApr "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":03:10 cluster3-node1 systemd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": kubelet.service: Main process exited, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("code")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exited, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("203")]),s._v("/EXEC\nApr "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),s._v(":03:10 cluster3-node1 systemd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": kubelet.service: Failed with result "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'exit-code'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("我们看到它正在尝试使用其服务配置文件中定义的一些参数执行"),a("code",[s._v("/usr/local/bin/kubelet")]),s._v("。查找错误和获取更多日志的一个好方法是手动运行命令（通常也使用其参数）。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster3-node1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /usr/local/bin/kubelet")]),s._v("\n-bash: /usr/local/bin/kubelet: No such "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" or directory\n\n➜ root@cluster3-node1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# whereis kubelet")]),s._v("\nkubelet: /usr/bin/kubelet\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("另一种方法是查看服务的扩展日志记录，例如使用"),a("code",[s._v("journalctl -u kubelet")]),s._v("。")]),s._v(" "),a("p",[s._v("好吧，我们知道了，它指定了错误的路径。更正文件"),a("code",[s._v("/etc/systemd/system/kubelet.service.d/10-kubeadm.conf")]),s._v("中的路径并运行：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" /etc/systemd/system/kubelet.service.d/10-kubeadm.conf "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fix")]),s._v("\n\nsystemctl daemon-reload "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" systemctl restart kubelet\n\nsystemctl status kubelet  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# should now show running")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("此外，该节点应该可供 api 服务器使用，请给它一点时间：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\nNAME                     STATUS   ROLES           AGE   VERSION\ncluster3-controlplane1   Ready    control-plane   14d   v1.26.0\ncluster3-node1           Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          14d   v1.26.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("最后，我们将原因写入文件：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/18/reason.txt")]),s._v("\nwrong path to kubelet binary specified "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" config\n（服务配置中指定的kubelet二进制文件的路径错误）\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h3",{attrs:{id:"考题-19-创建secret并挂载到pod"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-19-创建secret并挂载到pod"}},[s._v("#")]),s._v(" 考题-19 | 创建Secret并挂载到Pod")]),s._v(" "),a("p",[s._v("任务权重：3%")]),s._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("只有当问题 18 或 20 已成功实现并且 k8s-c3-CCC 集群具有正常运行的工作节点时，才能解决此任务")])]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c3-CCC")])]),s._v(" "),a("p",[s._v("在新的命名空间"),a("code",[s._v("secret")]),s._v("中执行以下操作。创建一个名为"),a("code",[s._v("secret-pod")]),s._v("且镜像为"),a("code",[s._v("busybox:1.31.1")]),s._v("的 pod ，它应该会持续运行一段时间。")]),s._v(" "),a("p",[s._v("在"),a("code",[s._v("/opt/course/19/secret1.yaml")]),s._v("中有一个现有的 Secret，在命名空间"),a("code",[s._v("secret")]),s._v("中创建它，并以只读方式将其挂载到 Pod 的"),a("code",[s._v("/tmp/secret1")]),s._v("中。")]),s._v(" "),a("p",[s._v("在命名空间"),a("code",[s._v("secret")]),s._v("中创建一个名为"),a("code",[s._v("secret2")]),s._v("的新密钥，该密钥应包含"),a("code",[s._v("user=user1")]),s._v("和"),a("code",[s._v("pass=1234")]),s._v("。这些条目应该作为环境变量"),a("code",[s._v("APP_USER")]),s._v("和"),a("code",[s._v("APP_PASS")]),s._v("在 Pod 的容器中可用。")]),s._v(" "),a("p",[s._v("确认一切正常。")]),s._v(" "),a("h4",{attrs:{id:"解答-19"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-19"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("p",[s._v("首先，我们创建一个共享空间和请求的 Secrets：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k create ns secret\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" /opt/course/19/secret1.yaml 19_secret1.yaml\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" 19_secret1.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 19_secret1.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("halt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IyEgL2Jpbi9zaAo"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Secret\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" secret1\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" secret           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" 19_secret1.yaml create\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("接下来我们创建第二个 Secret：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" secret create secret generic secret2 --from-literal"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("user"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("user1 --from-literal"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pass"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1234")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("现在我们创建 Pod 模板：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" secret run secret-pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("busybox:1.31.1 "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$do")]),s._v(" -- "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sleep 5d"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(".yaml\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(".yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 19.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" secret                       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("args")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" sh\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("c\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" sleep 1d\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" busybox"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("1.31.1\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" secret"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("env")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" APP_USER                      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("valueFrom")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("secretKeyRef")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" secret2                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" user                       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" APP_PASS                      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("valueFrom")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("secretKeyRef")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" secret2                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pass                       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" secret1                       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /tmp/secret1             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("readOnly")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("                      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dnsPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterFirst\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restartPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Always\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" secret1                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("secret")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("secretName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" secret1                 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br")])]),a("p",[s._v("在当前的 K8s 版本中，可能没有必要指定"),a("code",[s._v("readOnly: true")]),s._v("，因为它无论如何都是默认设置。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),s._v(".yaml create\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("最后，我们来看看是否一切都是正确的：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" secret "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" secret-pod -- "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("env")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" APP\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("APP_PASS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1234")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("APP_USER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("user1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" secret "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" secret-pod -- "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("find")]),s._v(" /tmp/secret1\n/tmp/secret1\n/tmp/secret1/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("data\n/tmp/secret1/halt\n/tmp/secret1/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("2019_12_08_12_15_39.463036797\n/tmp/secret1/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("2019_12_08_12_15_39.463036797/halt\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" secret "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" secret-pod -- "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /tmp/secret1/halt\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#! /bin/sh")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("### BEGIN INIT INFO")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Provides:          halt")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Required-Start:")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Required-Stop:")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Default-Start:")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Default-Stop:      0")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Short-Description: Execute the halt command.")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Description:")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("一切都很好。")]),s._v(" "),a("h3",{attrs:{id:"考题-20-更新kubernetes版本并加入集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-20-更新kubernetes版本并加入集群"}},[s._v("#")]),s._v(" 考题-20 | 更新Kubernetes版本并加入集群")]),s._v(" "),a("p",[s._v("任务权重：10%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c3-CCC")])]),s._v(" "),a("p",[s._v("你的同事说节点"),a("code",[s._v("cluster3-node2")]),s._v("运行的是较旧的 Kubernetes 版本，甚至不是集群的一部分。将该节点上的 Kubernetes 更新为"),a("code",[s._v("cluster3-controlplane1")]),s._v("上运行的确切版本。然后将此节点添加到群集中。为此，请使用 kubeadm。")]),s._v(" "),a("h4",{attrs:{id:"解答-20"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-20"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("h5",{attrs:{id:"升级-kubernetes-到符合cluster3-controlplane1的版本。"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#升级-kubernetes-到符合cluster3-controlplane1的版本。"}},[s._v("#")]),s._v(" 升级 Kubernetes 到符合"),a("code",[s._v("cluster3-controlplane1")]),s._v("的版本。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\nNAME                     STATUS   ROLES           AGE   VERSION\ncluster3-controlplane1   Ready    control-plane   22h   v1.26.0\ncluster3-node1           Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          22h   v1.26.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("控制平面节点似乎正在运行 Kubernetes 1.26.0，并且"),a("code",[s._v("cluster3-node2")]),s._v("还不是集群的一部分。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster3-node2\n\n➜ root@cluster3-node2:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm version")]),s._v("\nkubeadm version: "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("version.Info"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("Major:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"1"')]),s._v(", Minor:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"26"')]),s._v(", GitVersion:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v1.26.0"')]),s._v(", GitCommit:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"b46a3f887ca979b1a5d14fd39cb1af43e7e5d12d"')]),s._v(", GitTreeState:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"clean"')]),s._v(", BuildDate:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2022-12-08T19:57:06Z"')]),s._v(", GoVersion:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"go1.19.4"')]),s._v(", Compiler:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"gc"')]),s._v(", Platform:"),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"linux/amd64"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n➜ root@cluster3-node2:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl version --short")]),s._v("\nClient Version: v1.25.5\nKustomize Version: v4.5.7\n\n➜ root@cluster3-node2:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubelet --version")]),s._v("\nKubernetes v1.25.5\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("p",[s._v("这里的 kubeadm 已经安装了预期的版本，所以我们不需要安装它。因此我们可以运行：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster3-node2:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm upgrade node")]),s._v("\ncouldn't create a Kubernetes client from "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/etc/kubernetes/kubelet.conf"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" failed to load admin kubeconfig: "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" /etc/kubernetes/kubelet.conf: no such "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" or directory\nTo see the stack trace of this error execute with "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--v")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" or higher\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("这通常是升级节点的正确命令。但是这个错误意味着这个节点甚至从未被初始化过，所以这里没有什么要更新的。稍后将使用"),a("code",[s._v("kubeadm join")]),s._v("完成此操作。现在我们可以继续使用 kubelet 和 kubectl：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster3-node2:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# apt update")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nFetched "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5,775")]),s._v(" kB "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" 2s "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2,313")]),s._v(" kB/s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("                               \nReading package lists"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". Done\nBuilding dependency tree       \nReading state information"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". Done\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("90")]),s._v(" packages can be upgraded. Run "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'apt list --upgradable'")]),s._v(" to see them.\n\n➜ root@cluster3-node2:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# apt show kubectl -a | grep 1.26")]),s._v("\nVersion: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.26")]),s._v(".0-00\n\n➜ root@cluster3-node2:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# apt install kubectl=1.26.0-00 kubelet=1.26.0-00")]),s._v("\nReading package lists"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". Done\nBuilding dependency tree       \nReading state information"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". Done\nThe following packages will be upgraded:\n  kubectl kubelet\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" upgraded, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" newly installed, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" to remove and "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("135")]),s._v(" not upgraded.\nNeed to get "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30.5")]),s._v(" MB of archives.\nAfter this operation, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9,996")]),s._v(" kB of additional disk space will be used.\nGet:1 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubectl amd64 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.26")]),s._v(".0-00 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.1")]),s._v(" MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nGet:2 https://packages.cloud.google.com/apt kubernetes-xenial/main amd64 kubelet amd64 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.26")]),s._v(".0-00 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20.5")]),s._v(" MB"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nFetched "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("30.5")]),s._v(" MB "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" 1s "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("29.7")]),s._v(" MB/s"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Reading database "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(". "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("112508")]),s._v(" files and directories currently installed."),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nPreparing to unpack "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("./kubectl_1.26.0-00_amd64.deb "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nUnpacking kubectl "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.26")]),s._v(".0-00"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" over "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.25")]),s._v(".5-00"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nPreparing to unpack "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v("./kubelet_1.26.0-00_amd64.deb "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nUnpacking kubelet "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.26")]),s._v(".0-00"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" over "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.25")]),s._v(".5-00"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nSetting up kubectl "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.26")]),s._v(".0-00"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nSetting up kubelet "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.26")]),s._v(".0-00"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\n➜ root@cluster3-node2:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubelet --version")]),s._v("\nKubernetes v1.26.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br")])]),a("p",[s._v("现在我们来看看 kubeadm、kubectl 和 kubelet。重启 kubelet：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster3-node2:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service kubelet restart")]),s._v("\n\n➜ root@cluster3-node2:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service kubelet status")]),s._v("\n● kubelet.service - kubelet: The Kubernetes Node Agent\n     Loaded: loaded "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("/lib/systemd/system/kubelet.service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" enabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" vendor preset: enabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    Drop-In: /etc/systemd/system/kubelet.service.d\n             └─10-kubeadm.conf\n     Active: activating "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("auto-restart"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Result: exit-code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" since Wed "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-12-21 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":29:26 UTC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 5s ago\n       Docs: https://kubernetes.io/docs/home/\n    Process: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("32111")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ExecStart")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/usr/bin/kubelet "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_KUBECONFIG_ARGS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_CONFIG_ARGS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_KUBEADM_ARGS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$KUBELET_EXTRA_ARGS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("code"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exited, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/FAILURE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n   Main PID: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("32111")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("code"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exited, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/FAILURE"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\nDec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":29:26 cluster3-node2 systemd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": kubelet.service: Main process exited, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("code")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("exited, "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/FAILURE\nDec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":29:26 cluster3-node2 systemd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(": kubelet.service: Failed with result "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'exit-code'")]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br")])]),a("p",[s._v("之所以出现这些错误，是因为我们仍然需要运行"),a("code",[s._v("kubeadm join")]),s._v("将节点加入集群。让我们在下一步中执行此操作。")]),s._v(" "),a("h5",{attrs:{id:"将cluster-3-node2添加到集群"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#将cluster-3-node2添加到集群"}},[s._v("#")]),s._v(" 将cluster 3-node2添加到集群")]),s._v(" "),a("p",[s._v("首先，我们登录到 controlplane1 并生成一个新的 TLS 引导令牌，同时打印出 join 命令：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster3-controlplane1\n\n➜ root@cluster3-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm token create --print-join-command")]),s._v("\nkubeadm "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".100.31:6443 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--token")]),s._v(" rbhrjh.4o93r31o18an6dll --discovery-token-ca-cert-hash sha256:d94524f9ab1eed84417414c7def5c1608f84dbf04437d9f5f73eb6255dafdb18\n\n➜ root@cluster3-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm token list")]),s._v("\nTOKEN                     TTL         EXPIRES                "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n44dz0t.2lgmone0i1o5z9fe   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("forever"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("never"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n4u477f.nmpq48xmpjt6weje   1h          "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-12-21T18:14:30Z\nrbhrjh.4o93r31o18an6dll   23h         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-12-22T16:29:58Z\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("可以看到我们的 token 在 23 小时内到期，我们可以通过传递 ttl 参数来调整它。")]),s._v(" "),a("p",[s._v("接下来，我们再次连接到 cluster3-node2 并简单地执行 join 命令：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster3-node2\n\n➜ root@cluster3-node2:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm join 192.168.100.31:6443 --token rbhrjh.4o93r31o18an6dll --discovery-token-ca-cert-hash sha256:d94524f9ab1eed84417414c7def5c1608f84dbf04437d9f5f73eb6255dafdb18")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("preflight"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Running pre-flight checks\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("preflight"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Reading configuration from the cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("preflight"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" FYI: You can "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("look")]),s._v(" at this config "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" with "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubectl -n kube-system get cm kubeadm-config -o yaml'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Writing kubelet configuration to "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/lib/kubelet/config.yaml"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Writing kubelet environment "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" with flags to "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/var/lib/kubelet/kubeadm-flags.env"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Starting the kubelet\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("kubelet-start"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Waiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" the kubelet to perform the TLS Bootstrap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\nThis "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'kubectl get nodes'")]),s._v(" on the control-plane to see this "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" the cluster.\n\n\n➜ root@cluster3-node2:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# service kubelet status")]),s._v("\n● kubelet.service - kubelet: The Kubernetes Node Agent\n     Loaded: loaded "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("/lib/systemd/system/kubelet.service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" enabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" vendor preset: enabled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    Drop-In: /etc/systemd/system/kubelet.service.d\n             └─10-kubeadm.conf\n     Active: active "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("running"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" since Wed "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("-12-21 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":32:19 UTC"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" 1min 4s ago\n       Docs: https://kubernetes.io/docs/home/\n   Main PID: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("32510")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("kubelet"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n      Tasks: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("limit: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("462")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n     Memory: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("55")]),s._v(".2M\n     CGroup: /system.slice/kubelet.service\n             └─32510 /usr/bin/kubelet --bootstrap-kubeconfig"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/bootstrap-kubelet.conf "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--kubeconfig")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/kubelet.conf "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--config")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/lib/kubelet/config.yaml --container-runti"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br")])]),a("p",[s._v("如果您在使用"),a("code",[s._v("kubeadm join")]),s._v("时遇到问题，您可能需要运行"),a("code",[s._v("kubeadm reset")]),s._v("。")]),s._v(" "),a("p",[s._v("不过，对我们来说很不错。最后，我们回到主终端并检查节点状态：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\nNAME                     STATUS     ROLES           AGE   VERSION\ncluster3-controlplane1   Ready      control-plane   22h   v1.26.0\ncluster3-node1           Ready      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          22h   v1.26.0\ncluster3-node2           NotReady   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          22h   v1.26.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("给予一点时间，直到节点准备好。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\nNAME                     STATUS   ROLES           AGE   VERSION\ncluster3-controlplane1   Ready    control-plane   22h   v1.26.0\ncluster3-node1           Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          22h   v1.26.0\ncluster3-node2           Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          22h   v1.26.0\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("我们看到"),a("code",[s._v("cluster3-node2")]),s._v("现已可用且是最新的。")]),s._v(" "),a("h3",{attrs:{id:"考题-21-创建静态pod和服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-21-创建静态pod和服务"}},[s._v("#")]),s._v(" 考题-21 | 创建静态Pod和服务")]),s._v(" "),a("p",[s._v("任务权重：2%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c3-CCC")])]),s._v(" "),a("p",[s._v("在"),a("code",[s._v("cluster3-controlplane1")]),s._v("节点的命名空间"),a("code",[s._v("default")]),s._v("中创建一个名为"),a("code",[s._v("my-static-pod")]),s._v("的静态 Pod。它应该是镜像"),a("code",[s._v("nginx:1.16-alpine")]),s._v("，并且有"),a("code",[s._v("10m")]),s._v(" CPU 和"),a("code",[s._v("20Mi")]),s._v("内存的资源请求。")]),s._v(" "),a("p",[s._v("然后创建一个名为"),a("code",[s._v("static-pod-service")]),s._v("的"),a("code",[s._v("NodePort")]),s._v("服务，该服务在端口"),a("code",[s._v("80")]),s._v("上公开该静态 Pod，并检查它是否有端点，以及它是否可以通过"),a("code",[s._v("cluster3-controlplane1")]),s._v("内网 IP 地址访问。您可以从主终端连接到内网节点 IP。")]),s._v(" "),a("h4",{attrs:{id:"解答-21"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-21"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster3-controlplane1\n\n➜ root@cluster1-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /etc/kubernetes/manifests/")]),s._v("\n\n➜ root@cluster1-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl run my-static-pod \\")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx:1.16-alpine "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" yaml --dry-run"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("client "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" my-static-pod.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /etc/kubernetes/manifests/my-static-pod.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" my"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("static"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" my"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("static"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("1.16"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" my"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("static"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10m\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 20Mi\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dnsPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterFirst\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restartPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Always\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br")])]),a("p",[s._v("并确保它运行：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" my-static\nNAMESPACE     NAME                                   READY   STATUS   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   AGE\ndefault       my-static-pod-cluster3-controlplane1   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".   22s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("现在我们公开静态 Pod：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k expose pod my-static-pod-cluster3-controlplane1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" static-pod-service "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--type")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NodePort "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--port")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("这将生成一个服务，如：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl expose pod my-static-pod-cluster3-controlplane1 --name static-pod-service --type=NodePort --port 80")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" my"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("static"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" static"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" my"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("static"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NodePort\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("loadBalancer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br")])]),a("p",[s._v("然后运行并测试：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get svc,ep "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("my-static-pod\nNAME                         TYPE       CLUSTER-IP      EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("        AGE\nservice/static-pod-service   NodePort   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.99")]),s._v(".168.252   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(":30352/TCP   30s\n\nNAME                           ENDPOINTS      AGE\nendpoints/static-pod-service   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.32")]),s._v(".0.4:80   30s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("看起来不错。")]),s._v(" "),a("h3",{attrs:{id:"考题-22-检查证书的有效期"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-22-检查证书的有效期"}},[s._v("#")]),s._v(" 考题-22 | 检查证书的有效期")]),s._v(" "),a("p",[s._v("任务权重：2%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c2-AC")])]),s._v(" "),a("p",[s._v("检查 kube-apiserver 服务器证书在"),a("code",[s._v("cluster2-controlplane1")]),s._v("上的有效期。使用 openssl 或 cfssl 执行此操作。将 exipiration 日期写入"),a("code",[s._v("/opt/course/22/expiration")]),s._v("。")]),s._v(" "),a("p",[s._v("此外，运行正确的"),a("code",[s._v("kubeadm")]),s._v("命令以列出到期日期，并确认两种方法显示相同的日期。")]),s._v(" "),a("p",[s._v("将更新 apiserver 服务器证书的正确"),a("code",[s._v("kubeadm")]),s._v("命令写入"),a("code",[s._v("/opt/course/22/kubeadm-renew-certs.sh")]),s._v("中。")]),s._v(" "),a("h4",{attrs:{id:"解答-22"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-22"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("p",[s._v("首先，我们来看看这个证书：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster2-controlplane1\n\n➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# find /etc/kubernetes/pki | grep apiserver")]),s._v("\n/etc/kubernetes/pki/apiserver.crt\n/etc/kubernetes/pki/apiserver-etcd-client.crt\n/etc/kubernetes/pki/apiserver-etcd-client.key\n/etc/kubernetes/pki/apiserver-kubelet-client.crt\n/etc/kubernetes/pki/apiserver.key\n/etc/kubernetes/pki/apiserver-kubelet-client.key\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("接下来，我们使用 openssl 来找出到期日期：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl x509  -noout -text -in /etc/kubernetes/pki/apiserver.crt | grep Validity -A2")]),s._v("\n        Validity\n            Not Before: Dec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":05:20 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v(" GMT\n            Not After "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Dec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":05:20 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2023")]),s._v(" GMT\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("我们有了它，所以我们把它写在主终端上所需的位置：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/22/expiration")]),s._v("\nDec "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":05:20 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2023")]),s._v(" GMT\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("我们也使用 kubeadm 的功能来获取过期时间：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm certs check-expiration | grep apiserver")]),s._v("\napiserver                Jan "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":49 UTC   363d        ca               no      \napiserver-etcd-client    Jan "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":49 UTC   363d        etcd-ca          no      \napiserver-kubelet-client Jan "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),s._v(":49 UTC   363d        ca               no \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("看起来不错最后，我们将更新所有证书的命令写入请求的位置：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/22/kubeadm-renew-certs.sh")]),s._v("\nkubeadm certs renew apiserver\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"考题-23-kubelet-客户端-服务器证书信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-23-kubelet-客户端-服务器证书信息"}},[s._v("#")]),s._v(" 考题-23 | Kubelet 客户端/服务器证书信息")]),s._v(" "),a("p",[s._v("任务权重：2%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c2-AC")])]),s._v(" "),a("p",[s._v("节点"),a("code",[s._v("cluster2-node1")]),s._v("已使用"),a("code",[s._v("kubeadm")]),s._v("和 TLS 引导添加到集群中。")]),s._v(" "),a("p",[s._v("找到 cluster 2-node1 的 “Issuer” 和 “Extended Key Usage” 值：")]),s._v(" "),a("ol",[a("li",[s._v("kubelet 客户端证书，用于与 kube-apiserver 的传出连接。")]),s._v(" "),a("li",[s._v("kubelet 服务器证书，用于从 kube-apiserver 传入连接的证书。")])]),s._v(" "),a("p",[s._v("将信息写入文件"),a("code",[s._v("/opt/course/23/certificate-info.txt")]),s._v("。")]),s._v(" "),a("p",[s._v("比较两个证书的 “Issuer” 和 “Extended Key Usage” 字段并理解它们。")]),s._v(" "),a("h4",{attrs:{id:"解答-23"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-23"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("p",[s._v("要找到正确的 kubelet 证书目录，我们可以查找 kubelet 的"),a("code",[s._v("--cert-dir")]),s._v("参数的默认值。为此，请在 Kubernetes 文档中搜索 “kubelet”："),a("a",{attrs:{href:"https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet"),a("OutboundLink")],1),s._v("。我们可以使用"),a("code",[s._v("ps aux")]),s._v("或在"),a("code",[s._v("/etc/systemd/system/kubelet.service.d/10-kubeadm.conf")]),s._v("中检查是否配置了另一个证书目录。")]),s._v(" "),a("p",[s._v("首先我们检查 kubelet 客户端证书：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster2-node1\n\n➜ root@cluster2-node1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl x509  -noout -text -in /var/lib/kubelet/pki/kubelet-client-current.pem | grep Issuer")]),s._v("\n        Issuer: CN "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" kubernetes\n        \n➜ root@cluster2-node1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# openssl x509  -noout -text -in /var/lib/kubelet/pki/kubelet-client-current.pem | grep "Extended Key Usage" -A1')]),s._v("\n            X509v3 Extended Key Usage: \n                TLS Web Client Authentication\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("接下来我们检查 kubelet 服务器证书：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster2-node1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl x509  -noout -text -in /var/lib/kubelet/pki/kubelet.crt | grep Issuer")]),s._v("\n          Issuer: CN "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cluster2-node1-ca@1588186506\n\n➜ root@cluster2-node1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# openssl x509  -noout -text -in /var/lib/kubelet/pki/kubelet.crt | grep "Extended Key Usage" -A1')]),s._v("\n            X509v3 Extended Key Usage: \n                TLS Web Server Authentication\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("我们看到服务器证书是在工作节点本身上生成的，客户端证书是由 Kubernetes API 颁发的。“Extended Key Usage” 显示了它是用于客户端还是服务器身份验证。")]),s._v(" "),a("p",[s._v("更多信息："),a("a",{attrs:{href:"https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://kubernetes.io/docs/reference/command-line-tools-reference/kubelet-tls-bootstrapping"),a("OutboundLink")],1)]),s._v(" "),a("h3",{attrs:{id:"考题-24-networkpolicy"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-24-networkpolicy"}},[s._v("#")]),s._v(" 考题-24 | NetworkPolicy")]),s._v(" "),a("p",[s._v("任务权重：9%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("发生了一起安全事件，入侵者能够从一个被黑客入侵的后端 Pod 访问整个集群。")]),s._v(" "),a("p",[s._v("为了防止这种情况，请在命名空间"),a("code",[s._v("project-snake")]),s._v("中创建一个名为"),a("code",[s._v("np-backend")]),s._v("的 NetworkPolicy。它应该只允许后端 Pod 执行以下操作：")]),s._v(" "),a("ul",[a("li",[s._v("连接到"),a("code",[s._v("db1-*")]),s._v(" Pods 的"),a("code",[s._v("1111")]),s._v("端口")]),s._v(" "),a("li",[s._v("连接到"),a("code",[s._v("db2-*")]),s._v(" Pods 的"),a("code",[s._v("2222")]),s._v("端口")])]),s._v(" "),a("p",[s._v("在策略中使用 Pods 的"),a("code",[s._v("app")]),s._v("标签。")]),s._v(" "),a("p",[s._v("在实现之后，从"),a("code",[s._v("backend-*")]),s._v(" Pod 到"),a("code",[s._v("vault-*")]),s._v(" Pod 在端口"),a("code",[s._v("3333")]),s._v("上的连接应该不再有效。")]),s._v(" "),a("h4",{attrs:{id:"解答-24"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-24"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("h5",{attrs:{id:"正确实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#正确实现"}},[s._v("#")]),s._v(" 正确实现")]),s._v(" "),a("p",[s._v("首先，我们来看看现有的 Pod 及其标签：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-snake get pod\nNAME        READY   STATUS    RESTARTS   AGE\nbackend-0   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          8s\ndb1-0       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          8s\ndb2-0       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          10s\nvault-0     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          10s\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-snake get pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-L")]),s._v(" app\nNAME        READY   STATUS    RESTARTS   AGE     APP\nbackend-0   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3m15s   backend\ndb1-0       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3m15s   db1\ndb2-0       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3m17s   db2\nvault-0     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          3m17s   vault\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("我们测试了当前的连接情况，发现没有任何限制：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-snake get pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" wide\nNAME        READY   STATUS    RESTARTS   AGE     IP          "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nbackend-0   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4m14s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.24  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\ndb1-0       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4m14s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.25  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\ndb2-0       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4m16s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.23  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nvault-0     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          4m16s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.22  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-snake "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" backend-0 -- "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.25:1111\ndatabase one\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-snake "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" backend-0 -- "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.23:2222\ndatabase two\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-snake "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" backend-0 -- "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.22:3333\nvault secret storage\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("现在我们通过从 k8s 文档中复制并更改一个示例来创建 NP：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" 24_np.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 24_np.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NetworkPolicy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" np"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("backend\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("snake\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backend\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policyTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Egress                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# policy is only about Egress")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("egress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# first rule")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("to")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# first condition "to"')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" db1\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# second condition "port"')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1111")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# second rule")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("to")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# first condition "to"')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" db2\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# second condition "port"')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2222")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br")])]),a("h5",{attrs:{id:"错误的例子"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#错误的例子"}},[s._v("#")]),s._v(" 错误的例子")]),s._v(" "),a("p",[s._v("现在让我们来看看一个错误的例子：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 错误")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" networking.k8s.io/v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NetworkPolicy\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" np"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("backend\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("snake\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" backend\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("policyTypes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" Egress\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("egress")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# first rule")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("to")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# first condition "to"')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# first "to" possibility')]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" db1\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSelector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# second "to" possibility')]),s._v("\n          "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" db2\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("                        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# second condition "ports"')]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# first "ports" possibility')]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1111")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# second "ports" possibility')]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2222")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("p",[s._v("如果使用了这个错误的 NP，则 "),a("code",[s._v("backend-*")]),s._v(" Pod 仍然可以连接到"),a("code",[s._v("db2-*")]),s._v(" Pod 上的端口"),a("code",[s._v("1111")]),s._v("，这应该被禁止。")]),s._v(" "),a("h5",{attrs:{id:"创建网络策略"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建网络策略"}},[s._v("#")]),s._v(" 创建网络策略")]),s._v(" "),a("p",[s._v("我们创建正确的 NP：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" 24_np.yaml create\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("再次测试：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-snake "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" backend-0 -- "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.25:1111\ndatabase one\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-snake "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" backend-0 -- "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.23:2222\ndatabase two\n\n➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-snake "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" backend-0 -- "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.22:3333\n^C\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("在 NP 上使用"),a("code",[s._v("kubectl describe")]),s._v("来查看 k8s 如何解释策略也很有帮助。")]),s._v(" "),a("p",[s._v("很好，看起来更安全了。任务完成。")]),s._v(" "),a("h3",{attrs:{id:"考题-25-etcd快照保存和恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#考题-25-etcd快照保存和恢复"}},[s._v("#")]),s._v(" 考题-25 | Etcd快照保存和恢复")]),s._v(" "),a("p",[s._v("任务权重：8%")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c3-CCC")])]),s._v(" "),a("p",[s._v("备份在"),a("code",[s._v("cluster3-controlplane1")]),s._v("上运行的 etcd，并将其保存在控制平面节点的"),a("code",[s._v("/tmp/etcd-backup.db")]),s._v("中。")]),s._v(" "),a("p",[s._v("然后在集群中创建一个属于你的 Pod。")]),s._v(" "),a("p",[s._v("最后恢复备份，确认集群仍在工作，并且创建的 Pod 不再与我们在一起。")]),s._v(" "),a("h4",{attrs:{id:"解答-25"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-25"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("h5",{attrs:{id:"etcd备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#etcd备份"}},[s._v("#")]),s._v(" Etcd备份")]),s._v(" "),a("p",[s._v("首先，我们登录到控制平面，并尝试创建一个 etcd 的快照：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster3-controlplane1\n\n➜ root@cluster3-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ETCDCTL_API=3 etcdctl snapshot save /tmp/etcd-backup.db")]),s._v("\nError:  rpc error: code "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" Unavailable desc "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" transport is closing\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("但它失败了，因为我们需要验证自己。对于必要的信息，我们可以检查 etc 清单：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster3-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/kubernetes/manifests/etcd.yaml")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("我们只检查"),a("code",[s._v("etcd.yaml")]),s._v("以获取必要的信息，我们不会更改它。")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /etc/kubernetes/manifests/etcd.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("component")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tier")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" control"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("plane\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" etcd\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("advertise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("urls=https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//192.168.100.31"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2379")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/etcd/server.crt                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# use")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("auth=true\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dir=/var/lib/etcd\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("initial"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("advertise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("peer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("urls=https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//192.168.100.31"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2380")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("initial"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cluster=cluster3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("controlplane1=https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//192.168.100.31"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2380")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/etcd/server.key                            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# use")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("listen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("urls=https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//127.0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2379")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//192.168.100.31"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2379")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# use")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("listen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("metrics"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("urls=http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//127.0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2381")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("listen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("peer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("urls=https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//192.168.100.31"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2380")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("name=cluster3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("controlplane1\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("peer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/etcd/peer.crt\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("peer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("auth=true\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("peer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/etcd/peer.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("peer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("trusted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/etcd/ca.crt                    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# use")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("count=10000\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("trusted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/etcd/ca.crt\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" k8s.gcr.io/etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("3.3.15"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("livenessProbe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("failureThreshold")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("httpGet")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("host")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 127.0.0.1\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /health\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2381")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("scheme")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" HTTP\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("initialDelaySeconds")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("timeoutSeconds")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumeMounts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/lib/etcd\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/pki/etcd\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("certs\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostNetwork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("priorityClassName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("critical\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/pki/etcd\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" DirectoryOrCreate\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("certs\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/lib/etcd                                                     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# important")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" DirectoryOrCreate\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br")])]),a("p",[s._v("但是我们也知道 api-server 正在连接 etcd，所以我们可以检查它的 manifest 是如何配置的：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster3-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /etc/kubernetes/manifests/kube-apiserver.yaml | grep etcd")]),s._v("\n    - --etcd-cafile"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/ca.crt\n    - --etcd-certfile"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/apiserver-etcd-client.crt\n    - --etcd-keyfile"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/apiserver-etcd-client.key\n    - --etcd-servers"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://127.0.0.1:2379\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("我们使用身份验证信息并将其传递给 etcdctl：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster3-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ETCDCTL_API=3 etcdctl snapshot save /tmp/etcd-backup.db \\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cacert")]),s._v(" /etc/kubernetes/pki/etcd/ca.crt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cert")]),s._v(" /etc/kubernetes/pki/etcd/server.crt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--key")]),s._v(" /etc/kubernetes/pki/etcd/server.key\n\nSnapshot saved at /tmp/etcd-backup.db\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("不要使用"),a("code",[s._v("snapshot status")]),s._v("，因为它可能会更改快照文件并使其无效。")])]),s._v(" "),a("h5",{attrs:{id:"etcd恢复"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#etcd恢复"}},[s._v("#")]),s._v(" Etcd恢复")]),s._v(" "),a("p",[s._v("现在在集群中创建一个 Pod 并等待它运行：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster3-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl run test --image=nginx")]),s._v("\npod/test created\n\n➜ root@cluster3-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod -l run=test -w")]),s._v("\nNAME   READY   STATUS    RESTARTS   AGE\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("test")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          60s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("如果您没有解决问题 18 或 20，并且 cluster3 没有就绪的工作节点，则创建的 Pod 可能会保持 Pending 状态。对于此任务，这仍然可以。")])]),s._v(" "),a("p",[s._v("接下来，我们停止所有控制平面组件：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("root@cluster3-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cd /etc/kubernetes/manifests/")]),s._v("\n\nroot@cluster3-controlplane1:/etc/kubernetes/manifests"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv * ..")]),s._v("\n\nroot@cluster3-controlplane1:/etc/kubernetes/manifests"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# watch crictl ps")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("现在我们将快照恢复到特定目录：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster3-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ETCDCTL_API=3 etcdctl snapshot restore /tmp/etcd-backup.db \\")]),s._v("\n--data-dir /var/lib/etcd-backup "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cacert")]),s._v(" /etc/kubernetes/pki/etcd/ca.crt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cert")]),s._v(" /etc/kubernetes/pki/etcd/server.crt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--key")]),s._v(" /etc/kubernetes/pki/etcd/server.key\n\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-09-04 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":50:19.650804 I "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" mvcc: restore compact to "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9935")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2020")]),s._v("-09-04 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),s._v(":50:19.659095 I "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" etcdserver/membership: added member 8e9e05c52164694d "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("http://localhost:2380"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" to cluster cdf818194e3a8c32\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("我们可以使用"),a("code",[s._v("etcdctl --endpoints http://IP")]),s._v("指定另一台主机进行备份，但这里我们只使用默认值："),a("code",[s._v("http://127.0.0.1:2379,http://127.0.0.1:4001")]),s._v("。")]),s._v(" "),a("p",[s._v("恢复的文件位于新文件夹"),a("code",[s._v("/var/lib/etcd-backup")]),s._v("中，现在我们必须告诉 etcd 使用该目录：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster3-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/kubernetes/etcd.yaml")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /etc/kubernetes/etcd.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("component")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tier")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" control"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("plane\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mountPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/pki/etcd\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("certs\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostNetwork")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("priorityClassName")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" system"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("critical\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("volumes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/pki/etcd\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" DirectoryOrCreate\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("certs\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hostPath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/lib/etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("backup                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" DirectoryOrCreate\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("p",[s._v("现在，我们再次将所有控制平面 yaml 移动到 manifest 目录中。给予它一点时间（最多几分钟）让 etcd 重新启动，让 api-server 再次可以访问：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("root@cluster3-controlplane1:/etc/kubernetes/manifests"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# mv ../*.yaml .")]),s._v("\n\nroot@cluster3-controlplane1:/etc/kubernetes/manifests"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# watch crictl ps")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("然后我们再次检查 Pod：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster3-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl get pod -l run=test")]),s._v("\nNo resources found "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" default namespace.\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("太棒了，备份和恢复成功工作了，因为我们的 Pod 不见了。")]),s._v(" "),a("h2",{attrs:{id:"附加题目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#附加题目"}},[s._v("#")]),s._v(" 附加题目")]),s._v(" "),a("h3",{attrs:{id:"附题-1-查找需要第一个终止的pod"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#附题-1-查找需要第一个终止的pod"}},[s._v("#")]),s._v(" 附题-1 | 查找需要第一个终止的Pod")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("检查命名空间"),a("code",[s._v("project-c13")]),s._v("中所有可用的 Pod，并找到那些在节点耗尽资源（cpu 或内存）来调度所有 Pod 时可能首先终止的 Pod 的名称。将 Pod 名称写入"),a("code",[s._v("/opt/course/e1/pods-not-stable.txt")]),s._v("。")]),s._v(" "),a("h4",{attrs:{id:"解答-26"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-26"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("p",[s._v("当节点上的可用 CPU 或内存资源达到极限时，Kubernetes 将查找使用比请求更多资源的 Pod。他们将是第一批被解雇的候选人。如果某些 Pod 容器没有设置资源请求 / 限制，那么默认情况下，这些容器被认为使用了超过请求的资源。")]),s._v(" "),a("p",[s._v("Kubernetes 根据定义的资源和限制为 Pod 分配服务质量类，请在此处阅读更多内容："),a("a",{attrs:{href:"https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("因此，我们应该寻找没有定义资源请求的 Pod，我们可以通过手动方法来做到这一点：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-c13 describe pod "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("less")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" Requests "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# describe all pods and highlight Requests")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("或者我们这样做：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-c13 describe pod "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("egrep")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"^(Name:|    Requests:)"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("我们看到 Deployment "),a("code",[s._v("c13-3cc-runner-heavy")]),s._v("的 Pod 没有指定任何资源请求。因此，我们的答案是：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/e1/pods-not-stable.txt")]),s._v("\nc13-3cc-runner-heavy-65588d7d6-djtv9map\nc13-3cc-runner-heavy-65588d7d6-v8kf5map\nc13-3cc-runner-heavy-65588d7d6-wwpb4map\no3db-0\no3db-1 "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果已通过先前的方案删除，则可能不存在")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("要自动化这个过程，你可以像这样使用 jsonpath：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-c13 get pod "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("jsonpath")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"{range .items[*]} {.metadata.name}{.spec.containers[*].resources}{'"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("'}\"")]),s._v("\n\n c13-2x3-api-86784557bd-cgs8gmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:50m memory:20Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-2x3-api-86784557bd-lnxvjmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:50m memory:20Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-2x3-api-86784557bd-mnp77map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:50m memory:20Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-2x3-web-769c989898-6hbgtmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:50m memory:10Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-2x3-web-769c989898-g57nqmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:50m memory:10Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-2x3-web-769c989898-hfd5vmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:50m memory:10Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-2x3-web-769c989898-jfx64map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:50m memory:10Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-2x3-web-769c989898-r89mgmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:50m memory:10Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-2x3-web-769c989898-wtgxlmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:50m memory:10Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-3cc-runner-98c8b5469-dzqhrmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:30m memory:10Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-3cc-runner-98c8b5469-hbtdvmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:30m memory:10Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-3cc-runner-98c8b5469-n9lswmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:30m memory:10Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-3cc-runner-heavy-65588d7d6-djtv9map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-3cc-runner-heavy-65588d7d6-v8kf5map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-3cc-runner-heavy-65588d7d6-wwpb4map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-3cc-web-675456bcd-glpq6map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:50m memory:10Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-3cc-web-675456bcd-knlpxmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:50m memory:10Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-3cc-web-675456bcd-nfhp9map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:50m memory:10Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n c13-3cc-web-675456bcd-twn7mmap"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("requests:map"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("cpu:50m memory:10Mi"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n o3db-0"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n o3db-1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[s._v("这列出了所有 Pod 的名称及其请求 / 限制，因此我们看到了三个没有定义的 Pod。")]),s._v(" "),a("p",[s._v("或者我们寻找服务质量类：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get pods "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-c13 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("jsonpath")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"{range .items[*]}{.metadata.name} {.status.qosClass}{'"),a("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[s._v("\\n")]),s._v("'}\"")]),s._v("\n\nc13-2x3-api-86784557bd-cgs8g Burstable\nc13-2x3-api-86784557bd-lnxvj Burstable\nc13-2x3-api-86784557bd-mnp77 Burstable\nc13-2x3-web-769c989898-6hbgt Burstable\nc13-2x3-web-769c989898-g57nq Burstable\nc13-2x3-web-769c989898-hfd5v Burstable\nc13-2x3-web-769c989898-jfx64 Burstable\nc13-2x3-web-769c989898-r89mg Burstable\nc13-2x3-web-769c989898-wtgxl Burstable\nc13-3cc-runner-98c8b5469-dzqhr Burstable\nc13-3cc-runner-98c8b5469-hbtdv Burstable\nc13-3cc-runner-98c8b5469-n9lsw Burstable\nc13-3cc-runner-heavy-65588d7d6-djtv9 BestEffort\nc13-3cc-runner-heavy-65588d7d6-v8kf5 BestEffort\nc13-3cc-runner-heavy-65588d7d6-wwpb4 BestEffort\nc13-3cc-web-675456bcd-glpq6 Burstable\nc13-3cc-web-675456bcd-knlpx Burstable\nc13-3cc-web-675456bcd-nfhp9 Burstable\nc13-3cc-web-675456bcd-twn7m Burstable\no3db-0 BestEffort\no3db-1 BestEffort\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br")])]),a("p",[s._v("这里我们看到了三个 BestEffort，这些 Pod 没有定义任何内存或 CPU 限制/请求。")]),s._v(" "),a("p",[s._v("一个好的做法是始终设置资源请求和限制。如果您不知道容器应该具有的值，则可以使用 Prometheus 等度量工具来了解这一点。您还可以在容器中使用"),a("code",[s._v("kubectl top pod")]),s._v("甚至"),a("code",[s._v("kubectl exec")]),s._v("，并使用和"),a("code",[s._v("top")]),s._v("类似的工具。")]),s._v(" "),a("h3",{attrs:{id:"附题-2-curl-手动联系-api"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#附题-2-curl-手动联系-api"}},[s._v("#")]),s._v(" 附题-2 | Curl 手动联系 API")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("命名空间"),a("code",[s._v("project-hamster")]),s._v("中有一个现有的 ServiceAccount "),a("code",[s._v("secret-reader")]),s._v("。创建一个名为"),a("code",[s._v("tmp-api-contact")]),s._v("、镜像为"),a("code",[s._v("curlimages/curl:7.65.3")]),s._v("的 Pod，它使用此 ServiceAccount。确保容器保持运行。")]),s._v(" "),a("p",[s._v("通过 Exec 进入 Pod 并使用"),a("code",[s._v("curl")]),s._v("手动访问该集群的 Kubernetes Api，并列出所有可用的 secret。您可以忽略不安全的 https 连接。将此命令写入文件"),a("code",[s._v("/opt/course/e4/list-secrets.sh")]),s._v("。")]),s._v(" "),a("h4",{attrs:{id:"解答-27"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-27"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://kubernetes.io/docs/tasks/run-application/access-api-from-pod",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://kubernetes.io/docs/tasks/run-application/access-api-from-pod"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("了解 Kubernetes API 的工作原理非常重要。为此，它有助于手动连接到 API，例如使用 curl。例如，您可以通过在 Kubernetes 文档中搜索 “curl API” 来快速查找该信息。")]),s._v(" "),a("p",[s._v("首先，我们创建 Pod：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k run tmp-api-contact "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("curlimages/curl:7.65.3 "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--command")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" e2.yaml -- "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sleep 1d'")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" e2.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("添加服务帐户名称和命名空间：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# e2.yaml")]),s._v("\napiVersion: v1\nkind: Pod\nmetadata:\n  creationTimestamp: null\n  labels:\n    run: tmp-api-contact\n  name: tmp-api-contact\n  namespace: project-hamster          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\nspec:\n  serviceAccountName: secret-reader   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n  containers:\n  - command:\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v("\n    - "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v("\n    - "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),s._v(" 1d\n    image: curlimages/curl:7.65.3\n    name: tmp-api-contact\n    resources: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  dnsPolicy: ClusterFirst\n  restartPolicy: Always\nstatus: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])]),a("p",[s._v("然后运行并执行：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v(".yaml create\n\nk "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-hamster "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" tmp-api-contact "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" -- "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("进入容器后，我们可以尝试使用"),a("code",[s._v("curl")]),s._v("连接到 api，该 api 一般通过命名空间"),a("code",[s._v("default")]),s._v("中名为"),a("code",[s._v("kubernetes")]),s._v("的服务提供（您应该知道 dns 解析如何跨命名空间工作）。否则，我们可以通过运行"),a("code",[s._v("env")]),s._v("命令并从环境变量中找到端点 IP。")]),s._v(" "),a("p",[s._v("现在我们可以做：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" https://kubernetes.default\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-k")]),s._v(" https://kubernetes.default "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 忽略工单说明中允许的不安全")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-k")]),s._v(" https://kubernetes.default/api/v1/secrets "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示禁止访问403")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("最后一个命令显示 403 禁止，这是因为我们没有向我们传递任何授权信息。Kubernetes Api 服务器认为我们以"),a("code",[s._v("system:anonymous")]),s._v("身份进行连接。我们想改变这一点，并使用名为"),a("code",[s._v("secret-reader")]),s._v("的 Pods ServiceAccount 进行连接。")]),s._v(" "),a("p",[s._v("我们在"),a("code",[s._v("/var/run/secrets/kubernetes.io/serviceaccount")]),s._v("的挂载文件夹中找到了令牌，因此我们这样做：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TOKEN")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /var/run/secrets/kubernetes.io/serviceaccount/token"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-k")]),s._v(" https://kubernetes.default/api/v1/secrets "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TOKEN}")]),s._v('"')]),s._v("\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" --:--:-- --:--:-- --:--:--     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"kind"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"SecretList"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"apiVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"v1"')]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"metadata"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"selfLink"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/api/v1/secrets"')]),s._v(",\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resourceVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10697"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(",\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"items"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"metadata"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"name"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default-token-5zjbd"')]),s._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"namespace"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"default"')]),s._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"selfLink"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/api/v1/namespaces/default/secrets/default-token-5zjbd"')]),s._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"uid"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"315dbfd9-d235-482b-8bfc-c6167e7c1461"')]),s._v(",\n        "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"resourceVersion"')]),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"342"')]),s._v(",\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("p",[s._v("现在，我们可以列出所有 Secret，我们的 Pod 在注册为 ServiceAccount 的"),a("code",[s._v("secret-reader")]),s._v("下运行。")]),s._v(" "),a("p",[s._v("要使用加密的 https 连接，我们可以运行：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("CACERT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cacert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${CACERT}")]),s._v(" https://kubernetes.default/api/v1/secrets "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TOKEN}")]),s._v('"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("对于故障排除，我们还可以检查 ServiceAccount 是否能够使用以下命令列出 Secrets：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k auth can-i get secret "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--as")]),s._v(" system:serviceaccount:project-hamster:secret-reader\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("最后，将命令写入请求的位置：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/e4/list-secrets.sh")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("TOKEN")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /var/run/secrets/kubernetes.io/serviceaccount/token"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-k")]),s._v(" https://kubernetes.default/api/v1/secrets "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-H")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Authorization: Bearer '),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TOKEN}")]),s._v('"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h2",{attrs:{id:"预习题目"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#预习题目"}},[s._v("#")]),s._v(" 预习题目")]),s._v(" "),a("h3",{attrs:{id:"预览题-1"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#预览题-1"}},[s._v("#")]),s._v(" 预览题-1")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c2-AC")])]),s._v(" "),a("p",[s._v("集群管理员要求您查找以下有关在"),a("code",[s._v("cluster2-controlplane1")]),s._v("上运行的 etcd 的信息：")]),s._v(" "),a("ul",[a("li",[s._v("服务器私钥位置")]),s._v(" "),a("li",[s._v("服务器证书到期日期")]),s._v(" "),a("li",[s._v("是否已启用客户端证书身份验证")])]),s._v(" "),a("p",[s._v("将这些信息写入"),a("code",[s._v("/opt/course/p1/etcd-info.txt")])]),s._v(" "),a("p",[s._v("最后，系统会要求您在"),a("code",[s._v("cluster2-controlplane1")]),s._v("上的"),a("code",[s._v("/etc/etcd-snapshot.db")]),s._v("中保存一个 etcd 快照并显示其状态。")]),s._v(" "),a("h4",{attrs:{id:"解答-28"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-28"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("h5",{attrs:{id:"查询etcd信息"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查询etcd信息"}},[s._v("#")]),s._v(" 查询ETCD信息")]),s._v(" "),a("p",[s._v("让我们检查节点：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\nNAME                     STATUS   ROLES           AGE    VERSION\ncluster2-controlplane1   Ready    control-plane   89m   v1.23.1\ncluster2-node1           Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          87m   v1.23.1\n\n➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster2-controlplane1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("首先，我们来看看 etcd 是如何在这个集群中设置的：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n kube-system get pod")]),s._v("\nNAME                                                READY   STATUS    RESTARTS   AGE\ncoredns-66bff467f8-k8f48                            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          26h\ncoredns-66bff467f8-rn8tr                            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          26h\netcd-cluster2-controlplane1                         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          26h\nkube-apiserver-cluster2-controlplane1               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          26h\nkube-controller-manager-cluster2-controlplane1      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          26h\nkube-proxy-qthfg                                    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          25h\nkube-proxy-z55lp                                    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          26h\nkube-scheduler-cluster2-controlplane1               "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("          26h\nweave-net-cqdvt                                     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          26h\nweave-net-dxzgh                                     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("/2     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("          25h\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("我们看到它作为一个 Pod 运行，更具体地说，是一个静态 Pod。因此，我们检查静态清单的默认 kubelet 目录：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# find /etc/kubernetes/manifests/")]),s._v("\n/etc/kubernetes/manifests/\n/etc/kubernetes/manifests/kube-controller-manager.yaml\n/etc/kubernetes/manifests/kube-apiserver.yaml\n/etc/kubernetes/manifests/etcd.yaml\n/etc/kubernetes/manifests/kube-scheduler.yaml\n\n➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/kubernetes/manifests/etcd.yaml")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("因此，我们来看看 yaml 中 etcd 启动时使用的参数：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /etc/kubernetes/manifests/etcd.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("component")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tier")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" control"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("plane\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" etcd\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" etcd\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("advertise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("urls=https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//192.168.102.11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2379")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/etcd/server.crt              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# server certificate")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("auth=true                                      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# enabled")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dir=/var/lib/etcd\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("initial"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("advertise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("peer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("urls=https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//192.168.102.11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2380")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("initial"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cluster=cluster2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("controlplane1=https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//192.168.102.11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2380")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/etcd/server.key               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# server private key")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("listen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("urls=https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//127.0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2379")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//192.168.102.11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2379")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("listen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("metrics"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("urls=http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//127.0.0.1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2381")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("listen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("peer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("urls=https"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("//192.168.102.11"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2380")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("name=cluster2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("controlplane1\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("peer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/etcd/peer.crt\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("peer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("auth=true\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("peer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/etcd/peer.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("peer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("trusted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/etcd/ca.crt\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("snapshot"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("count=10000\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("trusted"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/etcd/ca.crt\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br")])]),a("p",[s._v("我们看到客户端身份验证已启用，并且还请求了服务器私钥的路径，现在让我们看看服务器证书的过期时间：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# openssl x509  -noout -text -in /etc/kubernetes/pki/etcd/server.crt | grep Validity -A2")]),s._v("\n        Validity\n            Not Before: Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":01:31 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2021")]),s._v(" GMT\n            Not After "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v(" Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":01:31 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v(" GMT\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("这样就可以了。让我们将信息写入请求的文件：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /opt/course/p1/etcd-info.txt")]),s._v("\nServer private key location: /etc/kubernetes/pki/etcd/server.key\nServer certificate expiration date: Sep "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(":01:31 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v(" GMT\nIs client certificate authentication enabled: "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("yes")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h5",{attrs:{id:"创建etcd快照"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建etcd快照"}},[s._v("#")]),s._v(" 创建etcd快照")]),s._v(" "),a("p",[s._v("首先，我们尝试：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCDCTL_API")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" etcdctl snapshot save /etc/etcd-snapshot.db\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("我们也从 yaml 中得到端点。但是我们需要指定更多的参数，所有这些我们都可以在上面的 yaml 声明中找到：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("ETCDCTL_API")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" etcdctl snapshot save /etc/etcd-snapshot.db "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cacert")]),s._v(" /etc/kubernetes/pki/etcd/ca.crt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cert")]),s._v(" /etc/kubernetes/pki/etcd/server.crt "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("\\")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--key")]),s._v(" /etc/kubernetes/pki/etcd/server.key\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("这一招奏效了。现在我们可以输出备份文件的状态：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ETCDCTL_API=3 etcdctl snapshot status /etc/etcd-snapshot.db")]),s._v("\n4d4e953, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7213")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1291")]),s._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.7")]),s._v(" MB\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("状态显示：")]),s._v(" "),a("ul",[a("li",[s._v("哈希: 4d4e953")]),s._v(" "),a("li",[s._v("校订版本: 7213")]),s._v(" "),a("li",[s._v("总数据量: 1291")]),s._v(" "),a("li",[s._v("总大小: 2.7 MB")])]),s._v(" "),a("h3",{attrs:{id:"预览题-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#预览题-2"}},[s._v("#")]),s._v(" 预览题-2")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c1-H")])]),s._v(" "),a("p",[s._v("系统会要求您确认 kube-proxy 在所有节点上都正常运行。为此，请在命名空间"),a("code",[s._v("project-hamster")]),s._v("中执行以下操作：")]),s._v(" "),a("p",[s._v("创建一个名为"),a("code",[s._v("p2-pod")]),s._v("的新 Pod，其中包含两个容器，一个是镜像"),a("code",[s._v("nginx:1.21.3-alpine")]),s._v("，另一个是镜像"),a("code",[s._v("busybox:1.31")]),s._v("。确保 busybox 容器保持运行一段时间。")]),s._v(" "),a("p",[s._v("创建一个名为"),a("code",[s._v("p2-service")]),s._v("的新 Service，该 Service 在集群内部的端口"),a("code",[s._v("3000->80")]),s._v("上公开该 Pod。")]),s._v(" "),a("p",[s._v("在所有节点"),a("code",[s._v("cluster1-controlplane1")]),s._v("、"),a("code",[s._v("cluster1-node1")]),s._v("和"),a("code",[s._v("cluster1-node2")]),s._v("上找到 kube-proxy 容器，并确保它使用的是 iptables。为此，请使用命令"),a("code",[s._v("crictl")]),s._v("。")]),s._v(" "),a("p",[s._v("将属于所创建服务"),a("code",[s._v("p2-service")]),s._v("的所有节点的 iptables 规则写入文件"),a("code",[s._v("/opt/course/p2/iptables.txt")]),s._v("。")]),s._v(" "),a("p",[s._v("最后删除 Service 并确认 iptables 规则从所有节点中消失。")]),s._v(" "),a("h4",{attrs:{id:"解答-29"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-29"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("h5",{attrs:{id:"创建pod-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建pod-2"}},[s._v("#")]),s._v(" 创建Pod")]),s._v(" "),a("p",[s._v("首先，我们创建 Pod：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# check out export statement on top which allows us to use $do")]),s._v("\nk run p2-pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("nginx:1.21.3-alpine "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$do")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" p2.yaml\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" p2.yaml\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# p2.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" p2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" p2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("hamster             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("1.21.3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("alpine\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" p2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" busybox"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.31")]),s._v("                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" c2                             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sh"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-c"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sleep 1d"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# add")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dnsPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterFirst\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restartPolicy")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Always\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" p2.yaml create\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h5",{attrs:{id:"创建服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建服务"}},[s._v("#")]),s._v(" 创建服务")]),s._v(" "),a("p",[s._v("接下来我们创建服务：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-hamster expose pod p2-pod "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" p2-service "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--port")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v(" --target-port "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("这将创建一个如下所示的 yaml：")]),s._v(" "),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Service\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2020-04-30T20:58:14Z"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" p2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("managedFields")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("operation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Update\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("time")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"2020-04-30T20:58:14Z"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" p2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("hamster\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resourceVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"11071"')]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selfLink")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /api/v1/namespaces/project"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("hamster/services/p2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("uid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 2a1c0842"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("7fb6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("4e94"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("8cdb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("1602a3b1e7d2\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("clusterIP")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10.97.45.18\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ports")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("protocol")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" TCP\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetPort")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" p2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("sessionAffinity")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" None\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterIP\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("status")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("loadBalancer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])]),a("p",[s._v("我们应该确认 Pod 和服务是连接的，因此服务应该有端点。")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-hamster get pod,svc,ep\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h5",{attrs:{id:"确认kube-proxy正在运行并且正在使用iptables"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#确认kube-proxy正在运行并且正在使用iptables"}},[s._v("#")]),s._v(" 确认kube-proxy正在运行并且正在使用iptables")]),s._v(" "),a("p",[s._v("首先，我们获取集群中的节点：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\nNAME                     STATUS   ROLES           AGE   VERSION\ncluster1-controlplane1   Ready    control-plane   98m   v1.23.1\ncluster1-node1           Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          96m   v1.23.1\ncluster1-node2           Ready    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("          95m   v1.23.1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("这里的想法是登录到每个节点，找到 kube-proxy 容器并检查其日志：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster1-controlplane1\n\n➜ root@cluster1-controlplane1$ crictl "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" kube-proxy\n27b6a18c0f89c       36c4ebbc9d979       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" hours ago         Running             kube-proxy\n\n➜ root@cluster1-controlplane1~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# crictl logs 27b6a18c0f89c")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nI0913 "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),s._v(":53:03.096620       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" server_others.go:212"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Using iptables Proxier.\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("这应该在每个节点上重复，并产生相同的输出"),a("code",[s._v("Using iptables Proxier")]),s._v("。")]),s._v(" "),a("h5",{attrs:{id:"检查kube-proxy是否正在创建iptables规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#检查kube-proxy是否正在创建iptables规则"}},[s._v("#")]),s._v(" 检查kube-proxy是否正在创建iptables规则")]),s._v(" "),a("p",[s._v("现在，我们首先手动检查每个节点上的 iptables 规则：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster1-controlplane1 iptables-save "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" p2-service\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" KUBE-SEP-6U447UXLLQIKP7BB "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.20/32 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" comment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--comment")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-hamster/p2-service:"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j")]),s._v(" KUBE-MARK-MASQ\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" KUBE-SEP-6U447UXLLQIKP7BB "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" comment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--comment")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-hamster/p2-service:"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j")]),s._v(" DNAT --to-destination "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.20:80\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" KUBE-SERVICES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".0.0/16 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.97")]),s._v(".45.18/32 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" comment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--comment")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-hamster/p2-service: cluster IP"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--dport")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j")]),s._v(" KUBE-MARK-MASQ\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" KUBE-SERVICES "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.97")]),s._v(".45.18/32 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" comment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--comment")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-hamster/p2-service: cluster IP"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--dport")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j")]),s._v(" KUBE-SVC-2A6FNMCK6FDH7PJH\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" KUBE-SVC-2A6FNMCK6FDH7PJH "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" comment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--comment")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-hamster/p2-service:"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j")]),s._v(" KUBE-SEP-6U447UXLLQIKP7BB\n\n➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster1-node1 iptables-save "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" p2-service\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" KUBE-SEP-6U447UXLLQIKP7BB "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.20/32 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" comment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--comment")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-hamster/p2-service:"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j")]),s._v(" KUBE-MARK-MASQ\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" KUBE-SEP-6U447UXLLQIKP7BB "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" comment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--comment")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-hamster/p2-service:"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j")]),s._v(" DNAT --to-destination "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.20:80\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" KUBE-SERVICES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".0.0/16 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.97")]),s._v(".45.18/32 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" comment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--comment")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-hamster/p2-service: cluster IP"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--dport")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j")]),s._v(" KUBE-MARK-MASQ\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" KUBE-SERVICES "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.97")]),s._v(".45.18/32 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" comment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--comment")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-hamster/p2-service: cluster IP"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--dport")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j")]),s._v(" KUBE-SVC-2A6FNMCK6FDH7PJH\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" KUBE-SVC-2A6FNMCK6FDH7PJH "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" comment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--comment")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-hamster/p2-service:"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j")]),s._v(" KUBE-SEP-6U447UXLLQIKP7BB\n\n➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster1-node2 iptables-save "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" p2-service\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" KUBE-SEP-6U447UXLLQIKP7BB "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.20/32 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" comment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--comment")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-hamster/p2-service:"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j")]),s._v(" KUBE-MARK-MASQ\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" KUBE-SEP-6U447UXLLQIKP7BB "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" comment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--comment")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-hamster/p2-service:"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j")]),s._v(" DNAT --to-destination "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.20:80\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" KUBE-SERVICES "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-s")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.244")]),s._v(".0.0/16 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.97")]),s._v(".45.18/32 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" comment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--comment")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-hamster/p2-service: cluster IP"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--dport")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j")]),s._v(" KUBE-MARK-MASQ\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" KUBE-SERVICES "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-d")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.97")]),s._v(".45.18/32 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-p")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" comment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--comment")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-hamster/p2-service: cluster IP"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" tcp "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--dport")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j")]),s._v(" KUBE-SVC-2A6FNMCK6FDH7PJH\n"),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-A")]),s._v(" KUBE-SVC-2A6FNMCK6FDH7PJH "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-m")]),s._v(" comment "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--comment")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"project-hamster/p2-service:"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-j")]),s._v(" KUBE-SEP-6U447UXLLQIKP7BB\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("p",[s._v("太好了现在让我们将这些日志写入请求的文件：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster1-controlplane1 iptables-save "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" p2-service "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /opt/course/p2/iptables.txt\n➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster1-node1 iptables-save "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" p2-service "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /opt/course/p2/iptables.txt\n➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster1-node2 iptables-save "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" p2-service "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /opt/course/p2/iptables.txt\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("h5",{attrs:{id:"删除服务并确认iptables规则已消失"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#删除服务并确认iptables规则已消失"}},[s._v("#")]),s._v(" 删除服务并确认iptables规则已消失")]),s._v(" "),a("p",[s._v("删除服务：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" project-hamster delete svc p2-service\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("并确认 iptables 规则已经消失：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster1-controlplane1 iptables-save "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" p2-service\n➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster1-node1 iptables-save "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" p2-service\n➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster1-node2 iptables-save "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" p2-service\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("结束。")]),s._v(" "),a("p",[s._v("Kubernetes 服务在所有节点上使用 iptables 规则（默认配置）实现。每当一个 Service 被修改、创建、删除或者一个 Service 的端点发生变化时，kube-apiserver 都会联系每个节点的 kube-proxy，根据当前状态更新 iptables 规则。")]),s._v(" "),a("h3",{attrs:{id:"预览题-3"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#预览题-3"}},[s._v("#")]),s._v(" 预览题-3")]),s._v(" "),a("p",[s._v("切换集群："),a("code",[s._v("kubectl config use-context k8s-c2-AC")])]),s._v(" "),a("p",[s._v("在命名空间"),a("code",[s._v("default")]),s._v("中使用镜像"),a("code",[s._v("httpd:2.4.41-alpine")]),s._v("创建一个名为"),a("code",[s._v("check-ip")]),s._v("的 Pod。在端口 80 上将其公开为名为"),a("code",[s._v("check-ip-service")]),s._v("的 ClusterIP 服务。记住/输出该服务的 IP。")]),s._v(" "),a("p",[s._v("将集群的服务 CIDR 更改为"),a("code",[s._v("11.96.0.0/12")]),s._v("。")]),s._v(" "),a("p",[s._v("然后创建另一个名为"),a("code",[s._v("check-ip-service2")]),s._v("的 Service，指向同一个 Pod，以检查您的设置是否生效。最后，检查第一个服务的 IP 是否已更改。")]),s._v(" "),a("h4",{attrs:{id:"解答-30"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#解答-30"}},[s._v("#")]),s._v(" 解答")]),s._v(" "),a("p",[s._v("让我们创建Pod并公开它：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k run check-ip "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("httpd:2.4.41-alpine\n\nk expose pod check-ip "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" check-ip-service "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--port")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("检查 Pod 和 Service ips：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get svc,ep "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("check-ip\nNAME                       TYPE        CLUSTER-IP    EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   AGE\nservice/check-ip-service   ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.104")]),s._v(".3.45   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("/TCP    8s\n\nNAME                         ENDPOINTS      AGE\nendpoints/check-ip-service   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.3:80   7s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("现在我们在 kube-apiserver 上更改 Service CIDR：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("ssh")]),s._v(" cluster2-controlplane1\n\n➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/kubernetes/manifests/kube-apiserver.yaml")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /etc/kubernetes/manifests/kube-apiserver.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("component")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("apiserver\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tier")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" control"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("plane\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("apiserver\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("apiserver\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("advertise"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("address=192.168.100.21\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("account"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/sa.pub\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("range=11.96.0.0/12             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("tls"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/apiserver.crt\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("tls"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("private"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/apiserver.key\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br")])]),a("h5",{attrs:{id:"给予一点时间-让-kube-apiserver-和管理器重新启动"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#给予一点时间-让-kube-apiserver-和管理器重新启动"}},[s._v("#")]),s._v(" 给予一点时间，让 kube-apiserver 和管理器重新启动")]),s._v(" "),a("p",[s._v("等待 API 再次启动：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubectl -n kube-system get pod | grep api")]),s._v("\nkube-apiserver-cluster2-controlplane1            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("              49s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("现在我们对控制管理器执行相同的操作：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# vim /etc/kubernetes/manifests/kube-controller-manager.yaml")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-yaml line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# /etc/kubernetes/manifests/kube-controller-manager.yaml")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("component")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("controller"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("manager\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("tier")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" control"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("plane\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("controller"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("manager\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("system\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" kube"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("controller"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("manager\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("allocate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cidrs=true\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("authentication"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("kubeconfig=/etc/kubernetes/controller"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("manager.conf\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("authorization"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("kubeconfig=/etc/kubernetes/controller"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("manager.conf\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("bind"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("address=127.0.0.1\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/ca.crt\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cidr=10.244.0.0/16\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("name=kubernetes\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("signing"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/ca.crt\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("signing"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/ca.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("controllers=*"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("bootstrapsigner"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("tokencleaner\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("kubeconfig=/etc/kubernetes/controller"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("manager.conf\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("leader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("elect=true\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("node"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cidr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("mask"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("size=24\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("requestheader"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/front"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("proxy"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ca.crt\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("root"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/ca.crt\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("account"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("private"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("file=/etc/kubernetes/pki/sa.key\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("cluster"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("range=11.96.0.0/12         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# change")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("use"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("account"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("credentials=true\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br")])]),a("h5",{attrs:{id:"给予它一点时间让调度程序重新启动。"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#给予它一点时间让调度程序重新启动。"}},[s._v("#")]),s._v(" 给予它一点时间让调度程序重新启动。")]),s._v(" "),a("p",[s._v("我们可以使用"),a("code",[s._v("crictl")]),s._v("检查它是否重新启动：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ root@cluster2-controlplane1:~"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# crictl ps | grep scheduler")]),s._v("\n3d258934b9fd6    aca5ededae9c8    About a minute ago   Running    kube-scheduler "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("再次检查我们现有的 Pod 和服务：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get pod,svc "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("check-ip\nNAME           READY   STATUS    RESTARTS   AGE\npod/check-ip   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("/1     Running   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("          21m\n\nNAME                       TYPE        CLUSTER-IP     EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   AGE\nservice/check-ip-service   ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.99")]),s._v(".32.177   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("/TCP    21m\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("到目前为止没有任何变化。现在，我们像以前一样创建另一个服务：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("k expose pod check-ip "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--name")]),s._v(" check-ip-service2 "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--port")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("再检查一遍：")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("➜ k get svc,ep "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-l")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("check-ip\nNAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("S"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("   AGE\nservice/check-ip-service    ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.109")]),s._v(".222.111   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("/TCP    8m\nservice/check-ip-service2   ClusterIP   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11.111")]),s._v(".108.194   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("none"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("/TCP    6m32s\n\nNAME                          ENDPOINTS      AGE\nendpoints/check-ip-service    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.1:80   8m\nendpoints/check-ip-service2   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.44")]),s._v(".0.1:80   6m13s\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("好了，新服务获得了分配的新指定范围的 ip。我们还看到，这两个 Service 都将我们的 Pod 作为端点。")])])}),[],!1,null,null,null);a.default=n.exports}}]);