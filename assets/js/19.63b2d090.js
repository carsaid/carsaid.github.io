(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{333:function(s,t,a){"use strict";a.r(t);var e=a(7),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("div",{staticClass:"cardListContainer"},[t("div",{staticClass:"card-list"},[t("span",{staticClass:"card-item row-2",staticStyle:{"background-color":"#F0DFB1","--randomColor":"#F0DFB1",color:"#1078E6"}},[t("div",[t("p",{staticClass:"name"},[s._v("原创")]),s._v(" "),t("p",{staticClass:"desc"},[s._v("本博客原创文章，转载请注明出处")])])])]),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 原创\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("desc")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 本博客原创文章，转载请注明出处\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("bgColor")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'#F0DFB1'")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("textColor")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'#1078E6'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])]),t("h1",{attrs:{id:"第6章-pod生命周期与资源限制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第6章-pod生命周期与资源限制"}},[s._v("#")]),s._v(" 第6章-Pod生命周期与资源限制")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("本章要点")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("Pod 的生命周期（lifecycle）和钩子的使用")])]),s._v(" "),t("tr",[t("td",[s._v("Pod 的资源限制")])]),s._v(" "),t("tr",[t("td",[s._v("创建和删除 LimitRange")])]),s._v(" "),t("tr",[t("td",[s._v("创建和删除 ResourceQuota")])])])]),s._v(" "),t("h2",{attrs:{id:"_1-pod生命周期"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-pod生命周期"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"1"}}),s._v("1. Pod生命周期")],1),s._v(" "),t("h3",{attrs:{id:"_1-1-概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-概念"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"1.1"}}),s._v("1.1 概念")],1),s._v(" "),t("h4",{attrs:{id:"_1-生命周期"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-生命周期"}},[s._v("#")]),s._v(" （1）生命周期")]),s._v(" "),t("p",[s._v("当 Pod 成功运行容器的那一刻起，这个 Pod 的生命周期就开始了，这是创建和启动 Pod。")]),s._v(" "),t("p",[s._v("当 Pod 中的所有容器都终止运行了，那么这个 Pod 的生命周期也就结束了，这是停止和删除 Pod。")]),s._v(" "),t("h4",{attrs:{id:"_2-pod延期删除"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-pod延期删除"}},[s._v("#")]),s._v(" （2）Pod延期删除")]),s._v(" "),t("p",[s._v("有时，删除 Pod 的时候如果不添加"),t("code",[s._v("--force")]),s._v("（强制删除）选项的话，删除 Pod 的时间就会明显变长。这是因为 k8s 在删除 Pod 的时候会有一个"),t("b",[s._v("延迟删除期")]),s._v("（"),t("b",[s._v("宽限期")]),s._v("），宽限的时间一般为"),t("code",[s._v("30")]),s._v("秒。")]),s._v(" "),t("p",[s._v("（第一次画图，有点潦草，请见谅）")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/01.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("一个 Pod 正在处理某些任务，此时你发出了删除命令，有宽限期的情况下：")]),s._v(" "),t("ul",[t("li",[s._v("这个 Pod 并不会被立即删除，它的状态会被标记为 “terminating”")]),s._v(" "),t("li",[s._v("然后等待这个 Pod 继续将手头上的任务处理完成")]),s._v(" "),t("li",[s._v("如果在 30 秒内完成处理，则 Pod 会被自动删除")]),s._v(" "),t("li",[s._v("如果处理超过了 30 秒，则 Pod 会被强制删除")])]),s._v(" "),t("p",[s._v("如果没有宽限期：")]),s._v(" "),t("ul",[t("li",[s._v("这个 Pod 会被立即删除，而不管它是否正在处理任务")]),s._v(" "),t("li",[s._v("可能会造成连接中断、数据丢失等影响")])]),s._v(" "),t("p",[s._v("前者被称为 “优雅地删除 Pod”，后者被称为 “粗暴地删除 Pod”。作为一个优秀的 k8s 工程师，当然是想要前者了。")]),s._v(" "),t("div",{staticClass:"custom-block note"},[t("p",{staticClass:"custom-block-title"},[s._v("学习更多")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://juejin.cn/post/7032577879712104456",target:"_blank",rel:"noopener noreferrer"}},[s._v("什么是优雅关闭？"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("举个例子：")]),s._v(" "),t("ul",[t("li",[s._v("优雅地关闭：通过 “关机” 按钮来关闭计算机")]),s._v(" "),t("li",[s._v("粗暴地关闭：直接拔电源 或者 拆掉电池")])])]),s._v(" "),t("h3",{attrs:{id:"_1-2-指定宽限期"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-指定宽限期"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"1.2"}}),s._v("1.2 指定宽限期")],1),s._v(" "),t("p",[s._v("在创建 Pod 的 yaml 文件中，你可以通过"),t("code",[s._v("spec.terminationGracePeriodSeconds")]),s._v("参数来指定宽限时间，单位是 “秒”。")]),s._v(" "),t("p",[s._v("（吐槽：这参数的名称为啥那么长，不好记啊）")]),s._v(" "),t("p",[s._v("以下 yaml 文件指定宽限时间为 15 秒（默认为 30 秒），")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("terminationGracePeriodSeconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" alpine\n\t"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sh"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-c"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"echo hello && sleep 9999"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("以上 Pod 在创建之后，会通过"),t("code",[s._v("echo")]),s._v("命令打印字符串 “hello”，然后通过"),t("code",[s._v("sleep")]),s._v("命令休眠 9999 秒。这意味着该 Pod 会在 9999 秒后终止，但是这超过了 15 秒的宽限时间，所以这个 Pod 会被强制删除。")]),s._v(" "),t("p",[s._v("此外，如果你将宽限期设置为零的话（"),t("code",[s._v("spec.terminationGracePeriodSeconds: 0")]),s._v("），意味着没有宽限期（禁用宽限期），这会导致 Pod 被立即删除。")]),s._v(" "),t("h2",{attrs:{id:"_2-pod-hook-钩子"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-pod-hook-钩子"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"2"}}),s._v("2 Pod hook（钩子）")],1),s._v(" "),t("h3",{attrs:{id:"_2-1-钩子概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-钩子概念"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"2.1"}}),s._v("2.1 钩子概念")],1),s._v(" "),t("p",[s._v("虽然可以为 Pod 指定宽限期，实现 “优雅地删除 Pod”。")]),s._v(" "),t("p",[s._v("但是，某些运行在 Pod 中的服务进程，并不会使用这个宽限期。")]),s._v(" "),t("p",[s._v("拿"),t("code",[s._v("nginx")]),s._v("容器来说，由于 nginx 进程处理信号的方式和 k8s 的处理方式不太一样，所以当你向 nginx 容器发出删除信号时，Pod 中的 nginx 进程会很快关闭，Pod 也会被直接删除。这个 Pod 并不会使用 k8s 提供的宽限期，由此造成了一个 “粗暴地删除 Pod”。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/02.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("nginx 容器通常用于处理客户端连接，如果在处理任务时被粗暴删除，则客户端可能会访问报错。而钩子可用于解决这类问题。")]),s._v(" "),t("p",[s._v("在 Pod 生命周期中，k8s 提供了两个钩子："),t("code",[s._v("postStart")]),s._v("和"),t("code",[s._v("preStop")]),s._v("。两个钩子在 yaml 文件中的参数路径：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("spec.containers.lifecycle.postStart")])]),s._v(" "),t("li",[t("code",[s._v("spec.containers.lifecycle.preStop")])])]),s._v(" "),t("h3",{attrs:{id:"prestop钩子-结束钩子"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#prestop钩子-结束钩子"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"2.2"}}),s._v("preStop钩子（结束钩子）")],1),s._v(" "),t("p",[s._v("preStop 钩子会在容器关闭"),t("b",[s._v("之前")]),s._v("运行，只有当 preStop 运行完毕，容器/Pod 才会被关闭和删除。")]),s._v(" "),t("ul",[t("li",[s._v("preStop 中的任务也必须在延迟删除期（宽限期）之前完成处理，否则 Pod 一样会被强制删除")])]),s._v(" "),t("div",{staticClass:"custom-block note"},[t("p",{staticClass:"custom-block-title"},[s._v("学习更多")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/#discussion",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档中关于 preStop 的讨论"),t("OutboundLink")],1)])]),s._v(" "),t("p",[s._v("使用 preStop 钩子可以解决 “nginx容器无法优雅关闭” 的问题。")]),s._v(" "),t("p",[s._v("创建以下 yaml 文件：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("spec.containers.lifecycle.preStop")]),s._v("用于设置容器生命周期中的 preStop 钩子")]),s._v(" "),t("li",[t("code",[s._v("preStop.exec")]),s._v("：钩子要处理的任务项")]),s._v(" "),t("li",[t("code",[s._v("preStop.exec.command")]),s._v("：通过钩子在容器中执行命令，这和"),t("code",[s._v("spec.containers.command")]),s._v("是一样的")])]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prestop"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("terminationGracePeriodSeconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("180")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" prestop"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lifecycle")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("preStop")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("exec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sh'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-c'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/usr/sbin/nginx -s quit'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("以上钩子在容器关闭之前运行命令"),t("code",[s._v("sh -c /usr/sbin/nginx -s quit")]),s._v("，这里直接通过 nginx 可执行程序运行了 “quit”（退出）指令，是一种优雅关闭 nginx 服务的方式。")]),s._v(" "),t("div",{staticClass:"custom-block note"},[t("p",{staticClass:"custom-block-title"},[s._v("笔记")]),s._v(" "),t("p",[s._v("退出命令"),t("code",[s._v("nginx -s quit")]),s._v("运行之后，会等待 nginx 处理完现有任务，然后再关闭 nginx 进程。")]),s._v(" "),t("p",[s._v("除此之外，还有一个退出命令"),t("code",[s._v("nginx -s stop")]),s._v("（快速关闭 nginx），这是一种粗暴关闭 nginx 的方式，因为该命令不会等待 nginx，而是直接关闭它。")])]),s._v(" "),t("p",[s._v("创建这个 Pod。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/03.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("当你删除这个 Pod 的时候：")]),s._v(" "),t("ul",[t("li",[s._v("Pod 的状态会被标记为 “terminating”")]),s._v(" "),t("li",[s._v("删除信号发送至 preStop 钩子，命令"),t("code",[s._v("sh -c /usr/sbin/nginx -s quit")]),s._v("会被执行")]),s._v(" "),t("li",[t("code",[s._v("nginx -s quit")]),s._v("执行后，会等待 nginx 处理完手头上的任务，然后再关闭 nginx 进程")]),s._v(" "),t("li",[s._v("nginx 进程被关闭后，preStop 钩子的使命也完成了，Pod 会被继续删除")])]),s._v(" "),t("p",[s._v("宽限期可以尽量设置的高一点（此处为 180 秒），好让 preStop 钩子有足够的时间去处理任务。")]),s._v(" "),t("h3",{attrs:{id:"poststart钩子-启动钩子"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#poststart钩子-启动钩子"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"2.3"}}),s._v("postStart钩子（启动钩子）")],1),s._v(" "),t("p",[s._v("postStart 钩子会在容器创建"),t("b",[s._v("之后")]),s._v("，跟随容器主进程一同运行，没有先后顺序之分（两者异步运行）。postStart 钩子有点类似于初始化容器，但它们有不同点。")]),s._v(" "),t("div",{staticClass:"custom-block note"},[t("p",{staticClass:"custom-block-title"},[s._v("学习更多")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/#discussion",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档中关于 postStart 的讨论"),t("OutboundLink")],1)])]),s._v(" "),t("h4",{attrs:{id:"_1-poststart正常运行"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-poststart正常运行"}},[s._v("#")]),s._v(" （1）postStart正常运行")]),s._v(" "),t("p",[s._v("创建以下 yaml 文件：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" poststart"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" poststart"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("pod\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lifecycle")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("postStart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("exec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sh'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-c'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'echo \"Hello k8s, I am postStart\" > /opt/hello.txt'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("以上钩子在容器启动的同时，使用"),t("code",[s._v("echo")]),s._v("命令将字符串 “Hello k8s, I am postStart” 输出到文件"),t("code",[s._v("/opt/hello.txt")]),s._v("中。")]),s._v(" "),t("p",[s._v("创建 Pod 之后，通过"),t("code",[s._v("kubectl exec")]),s._v("获取容器的终端，在"),t("code",[s._v("/opt")]),s._v("目录下可以找到所生成的文件。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/04.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("这和初始化容器不太一样，初始化容器在普通容器之前运行，并且拥有一个独立的容器来运行初始化任务。只有当初始化容器全部完成运行，普通容器才会被创建和启动。初始化完毕后，初始化容器会被删除。")]),s._v(" "),t("p",[s._v("postStart 钩子和当前容器一起被创建出来，并且和主进程一起在普通容器中运行，所做的操作和更改 会应用到当前容器中。")]),s._v(" "),t("h4",{attrs:{id:"_2-poststart运行错误"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-poststart运行错误"}},[s._v("#")]),s._v(" （2）postStart运行错误")]),s._v(" "),t("p",[s._v("如果 postStart 钩子运行出错会发生什么？这里我故意将"),t("code",[s._v("echo")]),s._v("命令打错成"),t("code",[s._v("ehco")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# poststart-error.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" poststart"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("error\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" poststart"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("error\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lifecycle")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("postStart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("exec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sh'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-c'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ehco \"Hello k8s, I am postStart\" > /opt/hello.txt'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("创建 Pod 后可以看到状态为 “PostStartHookError”（postStart钩子错误），由于 Pod 重启策略默认为 “Always”（遇到错误时总是重启），所以 Pod 会一直通过重启来试图解决错误。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/05.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("你以为我会说 “这和初始化容器一样”？")]),s._v(" "),t("p",[s._v("其实不一样，还是有根本上的区别：")]),s._v(" "),t("ul",[t("li",[s._v("初始化容器 单独创建另一个容器 来执行任务，如果"),t("b",[s._v("初始化容器运行出错")]),s._v("，则后续的普通容器"),t("b",[s._v("不会")]),s._v("被创建和启动")]),s._v(" "),t("li",[s._v("创建普通容器之后，postStart 会和主进程一起异步运行，由于 postStart 是在当前容器中执行的，所以 postStart 运行出错意味着"),t("b",[s._v("普通容器运行出错")]),s._v("。此时的容器其实"),t("b",[s._v("已经")]),s._v("被创建出来了，只不过运行期间出现了错误")])]),s._v(" "),t("h4",{attrs:{id:"_3-poststart阻塞"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-poststart阻塞"}},[s._v("#")]),s._v(" （3）postStart阻塞")]),s._v(" "),t("p",[s._v("postStart 处理函数与容器的代码是异步执行的，但 Kubernetes 的容器管理逻辑会一直阻塞等待 postStart 处理函数执行完毕。只有 postStart 处理函数执行完毕，容器的状态才会变成 RUNNING。")]),s._v(" "),t("p",[s._v("以上是官方文档中的一段话，我们通过以下 yaml 文件来验证这段话：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# poststart-sleep.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" poststart"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("sleep\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" poststart"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("sleep\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lifecycle")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("postStart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("exec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sh'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-c'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sleep 15'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("以上钩子会在容器创建之后，使用"),t("code",[s._v("sleep")]),s._v("命令休眠 15 秒。")]),s._v(" "),t("p",[s._v("从图中可以看到，在 15s 之前，Pod 状态为 “ContainerCreating”（容器创建），说明 k8s 正在等待 postStart 执行完毕。")]),s._v(" "),t("p",[s._v("而在 15s 后，也就是 postStart 执行完毕之后，Pod 状态正常变为了 “RUNNING”。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/06.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("也是和初始化容器不太一样：")]),s._v(" "),t("ul",[t("li",[s._v("初始化容器没有运行完毕，则普通容器不会被创建和运行")]),s._v(" "),t("li",[s._v("postStart 没有运行完毕，此时普通容器已经被创建，但它的状态会停留在 “ContainerCreating”，当 postStart 运行完毕之后才会变为 “RUNNING”。")])]),s._v(" "),t("h3",{attrs:{id:"_2-4-钩子练习"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-钩子练习"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"2.4"}}),s._v("2.4 钩子练习")],1),s._v(" "),t("p",[s._v("以上两个钩子可以结合使用，下面来做个练习。")]),s._v(" "),t("p",[s._v("创建以下 yaml 文件：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("life\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("terminationGracePeriodSeconds")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("120")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("life\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("lifecycle")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("postStart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("exec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sh'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-c'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'echo \"<h1>Hello nginx! I am postStart.</h1>\" > /usr/share/nginx/html/index.html'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("preStop")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("exec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sh'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-c'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'/usr/sbin/nginx -s quit'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("postStart 钩子使用"),t("code",[s._v("echo")]),s._v("将字符串 “Hello nginx! I am postStart.” 输出到 nginx 的默认首页文件当中，这将会覆盖默认的 Web 页面内容。")]),s._v(" "),t("p",[s._v("preStop 钩子则在删除 Pod 之前，通过 nginx 可执行程序运行退出命令，以优雅地关闭 nginx 进程。此外还给予了 120s 的宽限期，使钩子有足够的时间去完成关闭任务。")]),s._v(" "),t("p",[s._v("创建 Pod 之后，通过"),t("code",[s._v("-o wide")]),s._v("选项查看这个 Pod 的 IP 地址。然后使用"),t("code",[s._v("curl")]),s._v("命令发送一个 HTTP 请求，以访问网站首页。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/07.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("最后教你一招，通过 yaml 文件一次性删除多个 Pod：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v(".")]),s._v("点表示当前目录下的所有文件名称")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl delete "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("删除过程中遇到的错误会被忽略，不会影响后续删除的执行。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/life/08.png",alt:"Not Found Image"}}),s._v(" "),t("h2",{attrs:{id:"_3-pod资源限制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-pod资源限制"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"3"}}),s._v("3. Pod资源限制")],1),s._v(" "),t("p",[s._v("Pod 中运行的是容器，由于默认没有资源限制，容器会毫无节制地使用物理机中的 CPU 和内存等资源。由此一来，物理机很容易卡顿甚至宕机，这是一个安全隐患。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/01.png",alt:"Not Found Image"}}),s._v(" "),t("h3",{attrs:{id:"_3-1-resources参数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-resources参数"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"3.1"}}),s._v("3.1 resources参数")],1),s._v(" "),t("p",[s._v("以下 yaml 文件展示了通过"),t("code",[s._v("resources.limits")]),s._v("参数进行资源限制：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pod-re.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("re\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("re\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 100m\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 500Mi\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[s._v("这里需要注意 CPU 和内存的计量单位。")]),s._v(" "),t("h4",{attrs:{id:"cpu-内存计量单位"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#cpu-内存计量单位"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"3.1.1"}}),s._v("CPU/内存计量单位")],1),s._v(" "),t("p",[s._v("如果 CPU 不带单位，例如"),t("code",[s._v("cpu: 2")]),s._v("则表示两个 CPU 核心，如果带单位例如"),t("code",[s._v("cpu: 500m")]),s._v("则表示 500 个 CPU 微核心。")]),s._v(" "),t("ul",[t("li",[s._v("1 核心等于 1000 微核心")]),s._v(" "),t("li",[s._v("500m 相当于 0.5 个核心，250m 相当于 0.25 个核心")]),s._v(" "),t("li",[s._v("你也可以不指定单位，直接用"),t("code",[s._v("cpu: 0.5")]),s._v("表示半个核心。但官方推荐你使用"),t("code",[s._v("cpu: 500m")]),s._v("，因为这更加精细")])]),s._v(" "),t("p",[s._v("对于内存，你可以使用十进制的计算机存储单位"),t("code",[s._v("E")]),s._v("、"),t("code",[s._v("P")]),s._v("、"),t("code",[s._v("T")]),s._v("、"),t("code",[s._v("G")]),s._v("、"),t("code",[s._v("M")]),s._v("、"),t("code",[s._v("k")]),s._v("，它们分别表示 EB、PB、TB、GB、MB 和 kB。还可以使用二进制的存储单位"),t("code",[s._v("Ei")]),s._v("、"),t("code",[s._v("Pi")]),s._v("、"),t("code",[s._v("Ti")]),s._v("、"),t("code",[s._v("Gi")]),s._v("、"),t("code",[s._v("Mi")]),s._v("、"),t("code",[s._v("Ki")]),s._v("，分别表示 EiB、PiB、TiB、GiB、MiB 和 KiB。")]),s._v(" "),t("p",[t("b",[s._v("内存单位中间的 “i” 有啥区别？")]),s._v("不知道你是否买过 U 盘，存储容量总是缺斤少两，其实是生产 U 盘的厂商，使用了一种和计算机不同的存储计量方式：")]),s._v(" "),t("ul",[t("li",[s._v("我们平时说的 GB 指的是十进制存储单位："),t("code",[s._v("1GB=1000MB")]),s._v("。U 盘采用的就是十进制存储单位，一个"),t("code",[s._v("32GB")]),s._v("的 U 盘大小是"),t("code",[s._v("32000 MB")])]),s._v(" "),t("li",[s._v("而计算机使用的是 GiB 二进制存储单位："),t("code",[s._v("1GiB=1024MiB")]),s._v("。如果有的话，一个"),t("code",[s._v("32GiB")]),s._v("的 U 盘大小应该为"),t("code",[s._v("32768 MiB")])])]),s._v(" "),t("p",[t("del",[s._v("然后一堆借口，说会有损耗啥啥啥的，导致 32GB 的 U 盘最后只剩下二十多......")])]),s._v(" "),t("p",[s._v("在 k8s 中，推荐使用带 “i” 的单位，因为这兼容计算机存储标准，不容易缺斤少两和产生错误。在以上 yaml 文件中，将资源限制为了"),t("code",[s._v("100")]),s._v("个 CPU 微核心（"),t("code",[s._v("0.1")]),s._v("个核心）以及"),t("code",[s._v("500 MiB")]),s._v("的内存。")]),s._v(" "),t("div",{staticClass:"custom-block note"},[t("p",{staticClass:"custom-block-title"},[s._v("学习更多")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://kubernetes.io/zh-cn/docs/concepts/configuration/manage-resources-containers/#meaning-of-cpu",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档-CPU资源单位"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://kubernetes.io/zh-cn/docs/concepts/configuration/manage-resources-containers/#meaning-of-memory",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档-内存资源单位"),t("OutboundLink")],1)])])]),s._v(" "),t("h3",{attrs:{id:"_3-2-测试资源限制有效性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-测试资源限制有效性"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"3.2"}}),s._v("3.2 测试资源限制有效性")],1),s._v(" "),t("p",[s._v("为了测试资源限制的有效性，我们待会创建一个 Pod，在其中安装并运行 CPU 和内存压力测试工具，看看资源限制是否生效。")]),s._v(" "),t("h4",{attrs:{id:"_1-下载容器镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-下载容器镜像"}},[s._v("#")]),s._v(" （1）下载容器镜像")]),s._v(" "),t("p",[s._v("这里使用的镜像是"),t("code",[s._v("centos")]),s._v("，因为需要通过 Centos 系统中的 rpm 包管理软件来安装内存测试工具。你可以通过以下命令 提前拉取该镜像：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载速度可能较慢, 需要耐心等待")]),s._v("\nctr "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" k8s.io i pull docker.io/library/centos:latest\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/02.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("查看镜像是否存在。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("ctr "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" k8s.io i "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("ls")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" centos\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/03.png",alt:"Not Found Image"}}),s._v(" "),t("h4",{attrs:{id:"_2-下载cpu-内存压力测试工具"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-下载cpu-内存压力测试工具"}},[s._v("#")]),s._v(" （2）下载CPU/内存压力测试工具")]),s._v(" "),t("p",[s._v("CPU 压力测试工具可以在此处下载："),t("a",{attrs:{href:"https://pkgs.org/download/stress",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://pkgs.org/download/stress"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("刚刚下载的镜像系统版本是 Centos 8，我的电脑架构是 x86，所以点击中间的 “Centos 8 --\x3e EPEL x86_64” 进入详情页。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/04.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("进入详情页后，在 “Download” 栏目中找到安装包下载链接。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/05.png",alt:"Not Found Image"}}),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载到 master 节点中")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://dl.fedoraproject.org/pub/epel/8/Everything/x86_64/Packages/s/stress-1.0.4-24.el8.x86_64.rpm\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("内存压力测试工具："),t("a",{attrs:{href:"../memload-7.0-1.r29766.x86_64.rpm"}},[s._v("点我下载")])]),s._v(" "),t("p",[s._v("此处使用的工具是 memload，这工具贼难找，也不知道是不是绝迹了。在我的博客上面留个备份吧，反正也不大（6.5 KB）。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下载到 master 节点中")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://carsaid.github.io/cloud-native-security/kubernetes/memload-7.0-1.r29766.x86_64.rpm\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("将这两个工具下载到 master 主机上。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/06.png",alt:"Not Found Image"}}),s._v(" "),t("h4",{attrs:{id:"_3-没有资源限制时的压力测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-没有资源限制时的压力测试"}},[s._v("#")]),s._v(" （3）没有资源限制时的压力测试")]),s._v(" "),t("p",[s._v("先创建一个"),t("b",[s._v("没有")]),s._v("资源限制的 Pod：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pod-undo.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("undo\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" centos\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("undo\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sh'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-c'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sleep 9999999'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("创建 Pod，将两个工具安装包拷贝到容器中。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl apply "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" pod-undo.yaml\n\nkubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" ./stress-1.0.4-24.el8.x86_64.rpm pod-undo:/opt/\nkubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" ./memload-7.0-1.r29766.x86_64.rpm pod-undo:/opt/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/07.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("进入容器，然后通过"),t("code",[s._v("rpm")]),s._v("命令安装两个工具。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" pod-undo -- "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ivh")]),s._v(" stress-1.0.4-24.el8.x86_64.rpm\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ivh")]),s._v(" memload-7.0-1.r29766.x86_64.rpm\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/08.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("在容器中运行"),t("code",[s._v("memload")]),s._v("工具，消耗 800M 内存进行压力测试，这将会模拟一个算力计算。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("memload "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("800")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/09.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("由于运行压力测试工具期间，终端窗口无法动弹。所以此处另外开一个窗口并连接到 master 节点上，查看 Pod 负载信息。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" pods\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("从图中可以看到，实际资源占用情况为"),t("code",[s._v("996")]),s._v("个 CPU 微核心和"),t("code",[s._v("814")]),s._v(" MiB 的内存。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/10.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("回到前一个终端窗口，通过组合键"),t("code",[s._v("Ctrl+C")]),s._v("终止"),t("code",[s._v("memload")]),s._v("工具的运行。然后使用"),t("code",[s._v("stress")]),s._v("工具来消耗 8 个 CPU 核心（如果有那么多的话）进行压力测试。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("stress "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cpu")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/11.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("切换至另一个终端窗口，查看 Pod 负载信息。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" pods\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("占用了"),t("code",[s._v("1946")]),s._v("个 CPU 微核心，大约等同于 2 个 CPU 核心。我这台虚拟机也才 2 个核心啊......")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/12.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("切换至 Pod 所在的节点，通过"),t("code",[s._v("top")]),s._v("命令查看资源使用情况，发现 CPU 使用率高达"),t("code",[s._v("99.3%")]),s._v("。")]),s._v(" "),t("p",[s._v("这要是一台真的服务器，估计早炸了。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/13.png",alt:"Not Found Image"}}),s._v(" "),t("h4",{attrs:{id:"_4-存在资源限制时的压力测试"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-存在资源限制时的压力测试"}},[s._v("#")]),s._v(" （4）存在资源限制时的压力测试")]),s._v(" "),t("p",[s._v("在原有 Pod 的基础上，添加"),t("code",[s._v("resources.limits")]),s._v("参数：")]),s._v(" "),t("ul",[t("li",[s._v("限制 CPU 使用上限为"),t("code",[s._v("300")]),s._v("个微核心，也就是"),t("code",[s._v("0.3")]),s._v("个 CPU")]),s._v(" "),t("li",[s._v("限制内存使用上限为"),t("code",[s._v("500")]),s._v(" MiB")])]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# pod-do.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("do\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" centos\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("do\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sh'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'-c'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sleep 9999999'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 300m\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 500Mi\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[s._v("创建 Pod，将两个工具安装包拷贝到容器中。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl apply "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" pod-do.yaml\n\nkubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" ./stress-1.0.4-24.el8.x86_64.rpm pod-do:/opt/\nkubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" ./memload-7.0-1.r29766.x86_64.rpm pod-do:/opt/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/14.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("进入容器，然后通过"),t("code",[s._v("rpm")]),s._v("命令安装两个工具。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" pod-do -- "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ivh")]),s._v(" stress-1.0.4-24.el8.x86_64.rpm\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ivh")]),s._v(" memload-7.0-1.r29766.x86_64.rpm\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/15.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("在 pod-do 中运行内存压力测试工具，消耗 800M 内存：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("memload "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("800")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("执行以上命令之后，你会发现一直提示 “Killed”，并且工具被自动中断。")]),s._v(" "),t("p",[s._v("这说明工具"),t("code",[s._v("memload")]),s._v("无法申请到 800M 的内存，内存限制生效了。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/16.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("降低内存量，改为消耗 450M 内存：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("memload "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("450")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("这次执行成功了。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/17.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("切换至另一个 master 连接窗口，查看 Pod 负载信息。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" pods\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("你会发现 CPU 一直被限制在"),t("code",[s._v("300m")]),s._v("，没有前一个 Pod 那么高的使用率。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/18.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("同样是 CPU 杀手：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("stress "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--cpu")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/19.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("CPU 使用率还是乖乖地待在"),t("code",[s._v("300m")]),s._v("附近，没有严重超出。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/20.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("在 Pod 所处节点上运行"),t("code",[s._v("top")]),s._v("命令，查看主机资源使用率。CPU 使用率稳定徘徊在"),t("code",[s._v("16%")]),s._v("左右，没有之前那夸张的 90+% 了。")]),s._v(" "),t("p",[s._v("成功通过"),t("code",[s._v("resources")]),s._v("参数限制了 Pod/容器 的资源使用上限。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resources/21.png",alt:"Not Found Image"}}),s._v(" "),t("h2",{attrs:{id:"_4-通过limitrange进行资源限制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-通过limitrange进行资源限制"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"4"}}),s._v("4. 通过LimitRange进行资源限制")],1),s._v(" "),t("p",[s._v("虽然可以通过"),t("code",[s._v("resources.limits")]),s._v("参数对 Pod 进行资源限制，但是该参数需要单独为每个容器进行配置。Pod 数量一旦多起来，不仅配置繁琐、修改麻烦，还容易出错，工作量很大。")]),s._v(" "),t("p",[s._v("有没有一种办法，我只需要设置一次资源限制，就能自动应用到所有 Pod 当中呢？")]),s._v(" "),t("p",[s._v("这时候就需要用到 kubernetes 中的另一种资源类型：LimitRange")]),s._v(" "),t("h3",{attrs:{id:"_4-1-创建一个limitrange"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-创建一个limitrange"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"4.1"}}),s._v("4.1 创建一个LimitRange")],1),s._v(" "),t("p",[s._v("LimitRange 并不是某个参数，而是 k8s 中一个单独的资源类型，它也需要通过 yaml 文件来创建：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# limit1.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" LimitRange\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" limit"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("range"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("max")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 400m\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 512Mi\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Container\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("p",[s._v("和 Pod 一样，参数"),t("code",[s._v("apiVersion")]),s._v("用于指定 LimitRange 的 API 版本，一般也是固定的"),t("code",[s._v("v1")]),s._v("。")]),s._v(" "),t("p",[t("code",[s._v("kind")]),s._v("指定了当前 yaml 文件所要创建的 k8s 资源类型，此处为"),t("code",[s._v("LimitRange")]),s._v("。")]),s._v(" "),t("p",[t("code",[s._v("metadata.name")]),s._v("是当前资源的名称。")]),s._v(" "),t("p",[t("code",[s._v("spec.limits.max")]),s._v("用于限制资源使用上限。")]),s._v(" "),t("p",[t("code",[s._v("spec.limits.type")]),s._v("表示当前 LimitRange 限制的对象是谁，此处为"),t("code",[s._v("Container")]),s._v("，意思是对 “容器” 施加资源限制。")]),s._v(" "),t("p",[s._v("LimitRange 的创建方式和 Pod 一样：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl apply "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" limit1.yaml\n\nkubectl get limitranges\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/01.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("然后我们通过命令行创建一个 Pod，并在其中安装内存压力测试工具：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl run pod-test "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),s._v(" centos --image-pull-policy"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("IfNotPresent -- "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"sleep 9999999"')]),s._v("\nkubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" memload-7.0-1.r29766.x86_64.rpm pod-test:/opt\nkubectl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" pod-test -- "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ivh")]),s._v(" memload-7.0-1.r29766.x86_64.rpm\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/02.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("尝试消耗 800M 内存，失败。改为消耗 480M 内存。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("memload "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("800")]),s._v("\n\nmemload "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("480")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/03.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("切换至另一个 master 终端窗口，查看 Pod 负载信息。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" pods\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("CPU 使用率被限制在"),t("code",[s._v("400m")]),s._v("。")]),s._v(" "),t("p",[s._v("成功通过 LimitRange 限制了容器的资源使用上限。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/04.png",alt:"Not Found Image"}}),s._v(" "),t("h3",{attrs:{id:"_4-2-删除limitrange"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-删除limitrange"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"4.2"}}),s._v("4.2 删除LimitRange")],1),s._v(" "),t("p",[s._v("如果在 Pod 已经创建的情况下，把 LimitRange 给删除，资源限制策略还会存在吗？")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl delete limitranges limit-range-1\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/05.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("删除 LimitRange 之后，再次进入 pod-test 运行"),t("code",[s._v("memload")]),s._v("工具消耗 800M 内存。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("memload "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("800")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("结果你会发现，消耗 800M 失败了！")]),s._v(" "),t("p",[s._v("那改为消耗 470M。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/06.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("查看 Pod 负载信息，发现 CPU 使用率依旧被限制在"),t("code",[s._v("400m")]),s._v("。")]),s._v(" "),t("p",[s._v("这说明，即使 LimitRange 被删除了，之前创建的 Pod 依然会受到限制。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/07.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("然后我新创建了一个 Pod，并尝试消耗 800M 内存，成功了。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/08.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("资源使用率也同样是飙升。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/09.png",alt:"Not Found Image"}}),s._v(" "),t("div",{staticClass:"custom-block note"},[t("p",{staticClass:"custom-block-title"},[s._v("笔记")]),s._v(" "),t("p",[s._v("当 LimitRange 存在时，每一个"),t("b",[s._v("新创建")]),s._v("的 Pod 都会被施加资源限制策略。即使该 LimitRange 之后被删除了，资源限制策略也会一直作用于这些 Pod。")])]),s._v(" "),t("p",[s._v("LimitRange 只会对"),t("b",[s._v("新创建")]),s._v("的 Pod 施加资源限制策略，在 LimitRange 创建之前已经存在的 Pod 不会被施加策略。")]),s._v(" "),t("p",[s._v("如图所示，"),t("code",[s._v("pod-after")]),s._v("在 LimitRange 之前就已经创建，但依然能够消耗 800M 的内存。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/10.png",alt:"Not Found Image"}}),s._v(" "),t("h3",{attrs:{id:"_4-3-limitrange作用范围"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-limitrange作用范围"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"4.3"}}),s._v("4.3 LimitRange作用范围")],1),s._v(" "),t("p",[s._v("上面创建的 LimitRange 位于命名空间"),t("code",[s._v("default")]),s._v("，它能否作用于其他命名空间呢？")]),s._v(" "),t("p",[s._v("此时，命名空间"),t("code",[s._v("default")]),s._v("中已经创建了一个名为"),t("code",[s._v("limit-range-1")]),s._v("的 LimitRange。")]),s._v(" "),t("p",[s._v("然后，在命名空间"),t("code",[s._v("ns1")]),s._v("中创建一个名为"),t("code",[s._v("pod-ns1")]),s._v("的新 Pod，看看资源限制策略能否应用到该 Pod 中。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl run pod-ns1 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),s._v(" centos --image-pull-policy"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("IfNotPresent "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" ns1 -- "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sh")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'sleep 999999'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/11.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("在 Pod 中安装内存压力测试工具，并尝试消耗 800M 内存。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" ns1 memload-7.0-1.r29766.x86_64.rpm pod-ns1:/opt\nkubectl "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("exec")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" ns1 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-it")]),s._v(" pod-ns1 -- "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /opt\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-ivh")]),s._v(" memload-7.0-1.r29766.x86_64.rpm\nmemload "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("800")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("消耗成功了。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/12.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("可以看到"),t("code",[s._v("pod-ns1")]),s._v("没有被施加资源限制策略。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/13.png",alt:"Not Found Image"}}),s._v(" "),t("div",{staticClass:"custom-block note"},[t("p",{staticClass:"custom-block-title"},[s._v("笔记")]),s._v(" "),t("p",[s._v("LimitRange 只能对当前命名空间中的 k8s 资源施加限制策略，对其他命名空间不起效果。")])]),s._v(" "),t("p",[s._v("最后，删除这个 LimitRange，防止影响后续实验。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl delete "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" limit1.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/limit-range/14.png",alt:"Not Found Image"}}),s._v(" "),t("h3",{attrs:{id:"_4-4-limitrange作用对象"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-4-limitrange作用对象"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"4.4"}}),s._v("4.4 LimitRange作用对象")],1),s._v(" "),t("p",[s._v("在以上 yaml 文件中，我们通过"),t("code",[s._v("spec.limits.type: Container")]),s._v("指定了资源限制对象为 “容器”。")]),s._v(" "),t("p",[s._v("除了容器之外，LimitRange 还可以用于限制其他 k8s 资源对象。这将在后续的章节中进行介绍。")]),s._v(" "),t("h2",{attrs:{id:"_5-通过resourcequota实现资源调度上限"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-通过resourcequota实现资源调度上限"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"5"}}),s._v("5. 通过ResourceQuota实现资源调度上限")],1),s._v(" "),t("p",[s._v("参数"),t("code",[s._v("spec.containers.resources")]),s._v("用于限制单个容器中的资源使用上限。")]),s._v(" "),t("p",[s._v("集群 LimitRange 用于在单个命名空间中，限制某个集群对象的资源使用上限。")]),s._v(" "),t("p",[s._v("而 ResourceQuota 用于在单个命名空间中，限制某个集群对象的数量。")]),s._v(" "),t("h3",{attrs:{id:"_5-1-创建一个resourcequota"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-创建一个resourcequota"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"5.1"}}),s._v("5.1 创建一个ResourceQuota")],1),s._v(" "),t("p",[s._v("多说无益，来看个示例吧。创建以下 yaml 文件：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# re-quota.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ResourceQuota\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" re"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("quota\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hard")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("pods")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("参数"),t("code",[s._v("apiVersion")]),s._v("和"),t("code",[s._v("metadata.name")]),s._v("应该很熟悉了吧，不多讲。")]),s._v(" "),t("p",[t("code",[s._v("kind")]),s._v("指定当前 yaml 文件所要创建的集群资源类型，此处为"),t("code",[s._v("ResourceQuota")]),s._v("。")]),s._v(" "),t("p",[t("code",[s._v("spec.hard")]),s._v("用于设置集群资源调度上限。参数"),t("code",[s._v("pods: 2")]),s._v("的意思是——当前命名空间中，最多只能存在 2 个 Pod。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建ResourceQuota")]),s._v("\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" re-quota.yaml\n\nkubectl get resourcequotas\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("可以看到条目"),t("code",[s._v("pods: 0/2")]),s._v("，意思是当前命名空间存在"),t("code",[s._v("0")]),s._v("个 Pod，上限为"),t("code",[s._v("2")]),s._v("个 Pod。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resource-quota/01.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("通过命令行创建两个 Pod：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl run pod1 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),s._v(" nginx --image-pull-policy"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("IfNotPresent\nkubectl run pod2 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),s._v(" nginx --image-pull-policy"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("IfNotPresent\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("此时"),t("code",[s._v("re-quota")]),s._v("的上限来到了"),t("code",[s._v("2/2")]),s._v("，如果再创建一个 Pod 会发生什么？")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resource-quota/02.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("说干就干，创建第三个 Pod。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl run pod3 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),s._v(" nginx --image-pull-policy"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("IfNotPresent\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("创建失败，超出了"),t("code",[s._v("re-quota")]),s._v("的配额，上限为"),t("code",[s._v("pods=2")]),s._v("（最多两个 Pod）。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resource-quota/03.png",alt:"Not Found Image"}}),s._v(" "),t("h3",{attrs:{id:"_5-2-删除resourcequota"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-删除resourcequota"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"5.2"}}),s._v("5.2 删除ResourceQuota")],1),s._v(" "),t("p",[s._v("删除"),t("code",[s._v("re-quota")]),s._v("，并创建第三个 Pod。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl delete "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" re-quota.yaml\n\nkubectl run pod3 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),s._v(" nginx --image-pull-policy"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("IfNotPresent\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resource-quota/04.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("此时已经有三个 Pod 存在，如果再次创建"),t("code",[s._v("re-quota")]),s._v("并把 Pod 上限设置为"),t("code",[s._v("2")]),s._v("个，会发生什么？")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl apply "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" re-quota.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("可以看到条目"),t("code",[s._v("pods: 3/2")]),s._v("，Pod 的数量超出了配额，但是 Pod 依然正常运行。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resource-quota/05.png",alt:"Not Found Image"}}),s._v(" "),t("div",{staticClass:"custom-block note"},[t("p",{staticClass:"custom-block-title"},[s._v("笔记")]),s._v(" "),t("p",[s._v("和 LimitRange 一样，ResourceQuota 只会作用于后续新创建的 Pod，不会对已创建的 Pod 造成影响。")])]),s._v(" "),t("h3",{attrs:{id:"_5-3-resourcequota作用范围"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-resourcequota作用范围"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"5.3"}}),s._v("5.3 ResourceQuota作用范围")],1),s._v(" "),t("p",[s._v("和 LimitRange 一样，ResourceQuota 只在单个命名空间中生效。")]),s._v(" "),t("p",[s._v("如果你想在其他命名空间中实现资源配额，则需要在对应的命名空间中创建新的 ResourceQuota。你可以在 yaml 文件中添加"),t("code",[s._v("metadata.spacename")]),s._v("参数来实现。例如：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ResourceQuota\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" quota"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("ns1\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("namespace")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ns1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hard")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("pods")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/resource-quota/06.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("最后，记得删除这些 ResourceQuota，防止影响后续实验。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl delete "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" re-quota.yaml\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 如果有的话")]),s._v("\nkubectl delete "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" quota-ns1.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h2",{attrs:{id:"_6-kubectl-explain命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-kubectl-explain命令"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"6"}}),s._v("6. kubectl explain命令")],1),s._v(" "),t("p",[s._v("现在介绍这个命令正合时宜。")]),s._v(" "),t("h3",{attrs:{id:"_6-1-yaml文件的参数复杂性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-yaml文件的参数复杂性"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"6.1"}}),s._v("6.1 yaml文件的参数复杂性")],1),s._v(" "),t("p",[s._v("上一章学习了 Pod，以及通过 yaml 文件创建 Pod 的方式，一个简单的 yaml 文件可能看起来像这样：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Pod\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" pod"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("虽然看起来简单，但是创建 Pod 的参数可不止那么一点，诸如"),t("code",[s._v("metadata.labels")]),s._v("、"),t("code",[s._v("metadata.namespace")]),s._v("之类的参数可能会经常用到。还有本章刚刚才学习过的"),t("code",[s._v("spec.container.lifecycle")]),s._v("和"),t("code",[s._v("spec.containers.resources")]),s._v("。")]),s._v(" "),t("p",[s._v("除了 Pod 之外，本章又学习了两个新的集群资源，它们的 yaml 文件长这样：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一个LimitRange")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" LimitRange\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" my"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("limit\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("max")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 300m\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 1Gi\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Container\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 一个ResourceQuota")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ResourceQuota\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" my"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("quota\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("hard")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("pods")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br")])]),t("p",[s._v("随着学习的深入，接触的集群资源和 yaml 文件参数也越来越多。")]),s._v(" "),t("ul",[t("li",[s._v("对于一个资深 k8s 专家来说，也许他可以记住所有的配置参数。")]),s._v(" "),t("li",[s._v("但对于一个刚入门的小白来说，如何记住这么庞大的内容呢？")])]),s._v(" "),t("p",[s._v("多学？多背？多练？多写写 yaml 文件？")]),s._v(" "),t("h3",{attrs:{id:"_6-2-yaml配置参数查询"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-yaml配置参数查询"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"6.2"}}),s._v("6.2 yaml配置参数查询")],1),s._v(" "),t("p",[s._v("其实 k8s 提供了一个命令"),t("code",[s._v("kubectl explain")]),s._v("，可以用来查询 yaml 配置参数。")]),s._v(" "),t("p",[s._v("例如，我想知道一个 Pod 的 yaml 文件是由哪几个部分组成的，可以运行以下命令：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl explain pod\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("列出了五个字段，字段名称的右边标注了字段类型。例如"),t("code",[s._v("apiVersion")]),s._v("是一个字符串，"),t("code",[s._v("metadata")]),s._v("是一个对象，"),t("code",[s._v("spec")]),s._v("是 Pod 策略。")]),s._v(" "),t("p",[s._v("而在字段的上方，k8s 很贴心地标注了"),t("code",[s._v("KIND: Pod")]),s._v("和"),t("code",[s._v("VERSION: v1")]),s._v("，以此来提醒你资源类型应该写成"),t("code",[s._v("Pod")]),s._v("，而 API 版本应该写成"),t("code",[s._v("v1")]),s._v("。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/kubectl-explain/01.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("如果我想看 Pod 的"),t("code",[s._v("spec")]),s._v("字段下面有什么呢？只需要用点"),t("code",[s._v(".")]),s._v("隔开每个字段即可，就像这样：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl explain pod.spec\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("和上个命令一样，列出了"),t("code",[s._v("spec")]),s._v("下的所有可用字段。在其中我们可以看到熟悉的"),t("code",[s._v("spec.containers")]),s._v("。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/kubectl-explain/02.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("既然提到了"),t("code",[s._v("spec.containers")]),s._v("，那不妨来看看容器的生命周期：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl explain pod.spec.containers.lifecycle\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("噢，原来在容器的生命周期中，可以使用"),t("code",[s._v("postStart")]),s._v("和"),t("code",[s._v("preStop")]),s._v("钩子呀，差点忘了。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/kubectl-explain/04.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("命令"),t("code",[s._v("kubectl explain")]),s._v("可以无限嵌套，只要存在这个字段：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl explain pod.spec.containers.lifecycle.postStart\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("你可能会看见许多陌生的字段，不用着急，这些字段在后续的章节中都会一一讲解，你将会逐步掌握它们。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/kubectl-explain/05.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("你可能已经发现了，命令的格式是这样的：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl explain "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("资源类型"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("."),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("字段"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("看看 LimitRange 的"),t("code",[s._v("spec.limits")]),s._v("字段。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/kubectl-explain/06.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("看看 ResourceQuota 的"),t("code",[s._v("metadata")]),s._v("字段")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/pod-lifecycle-and-resources/kubectl-explain/07.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("你不必特意花费大量的时间去记 yaml 参数，只需要掌握"),t("code",[s._v("kubectl explain")]),s._v("命令，然后多做做练习题就可以了。")]),s._v(" "),t("h2",{attrs:{id:"_7-小结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_7-小结"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"7"}}),s._v("7. 小结")],1),s._v(" "),t("p",[s._v("本章对 Pod 生命周期做了一个简单的认识，然后学习了钩子的使用方法。还通过 yaml 文件中的参数字段以及外部集群资源对 Pod 施加了资源限制。通过本章的学习，你应该掌握以下技能：")]),s._v(" "),t("ul",[t("li",[s._v("宽限期的设置")]),s._v(" "),t("li",[s._v("“启动钩子” 和 “结束钩子” 的使用")]),s._v(" "),t("li",[s._v("通过 yaml 文件中的"),t("code",[s._v("resources")]),s._v("对容器施加资源限制")]),s._v(" "),t("li",[s._v("通过 LimitRange 对集群对象施加资源限制")]),s._v(" "),t("li",[s._v("通过 ResourceQuota 对命名空间施加资源调度限制")]),s._v(" "),t("li",[s._v("使用"),t("code",[s._v("kubectl explain")]),s._v("命令查看 yaml 参数字段")])]),s._v(" "),t("p",[s._v("如果你准备好了，可以试着去完成一些练习（"),t("RouterLink",{attrs:{to:"/cloud-native-security/kubernetes/practice/04/"}},[s._v("练习题-4")]),s._v("）。")],1)])}),[],!1,null,null,null);t.default=n.exports}}]);