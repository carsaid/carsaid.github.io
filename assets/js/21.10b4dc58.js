(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{337:function(s,t,a){"use strict";a.r(t);var e=a(7),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("div",{staticClass:"cardListContainer"},[t("div",{staticClass:"card-list"},[t("span",{staticClass:"card-item row-2",staticStyle:{"background-color":"#F0DFB1","--randomColor":"#F0DFB1",color:"#1078E6"}},[t("div",[t("p",{staticClass:"name"},[s._v("原创")]),s._v(" "),t("p",{staticClass:"desc"},[s._v("本博客原创文章，转载请注明出处")])])])]),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 原创\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("desc")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 本博客原创文章，转载请注明出处\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("bgColor")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'#F0DFB1'")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("textColor")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'#1078E6'")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])])]),t("h1",{attrs:{id:"第8章-控制器deployment"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#第8章-控制器deployment"}},[s._v("#")]),s._v(" 第8章-控制器Deployment")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("本章要点")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("创建和删除 Deployment")])]),s._v(" "),t("tr",[t("td",[s._v("修改 Deployment 副本数")])]),s._v(" "),t("tr",[t("td",[s._v("为 Deployment 配置水平自动扩缩 HPA")])])])]),s._v(" "),t("h2",{attrs:{id:"_1-控制器deployment"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-控制器deployment"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"1"}}),s._v("1. 控制器Deployment")],1),s._v(" "),t("h3",{attrs:{id:"_1-1-什么是控制器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-什么是控制器"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"1.1"}}),s._v("1.1 什么是控制器？")],1),s._v(" "),t("p",[s._v("在之前的章节中，我们曾通过命令行或 yaml 文件的方式创建一个独立的 Pod。但这种 Pod 是不稳定、不健壮的，在运行过程中，一旦某个 Pod 被意外终止，那么这个 Pod 就是真的没了，它不会自己再创建并重新运行。")]),s._v(" "),t("p",[s._v("控制器，顾名思义，这是一种用来控制集群资源的工具。在 k8s 中有很多种控制器，而 "),t("a",{attrs:{href:"https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/",target:"_blank",rel:"noopener noreferrer"}},[s._v("deployment"),t("OutboundLink")],1),s._v("（简称 deploy）是最常用的其中一种控制器。")]),s._v(" "),t("h3",{attrs:{id:"_1-2-deployment-的作用是什么"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-deployment-的作用是什么"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"1.2"}}),s._v("1.2 deployment 的作用是什么？")],1),s._v(" "),t("p",[s._v("在某个命名空间中，你只需要告诉 deployment 你需要多少个 Pod，那么 deployment 就会帮你维持多少个 Pod。")]),s._v(" "),t("p",[s._v("例如，你在命名空间"),t("code",[s._v("default")]),s._v("中始终需要 3 个 Pod 来承载业务：")]),s._v(" "),t("ul",[t("li",[s._v("deployment 会自动在"),t("code",[s._v("default")]),s._v("中创建 3 个 Pod，并确保 Pod 的数量始终保持在 3 个；")]),s._v(" "),t("li",[s._v("假如其中的某一个 Pod 意外终止了（挂掉），那么 deployment 就会立马重新运行一个 Pod，以填补这个空缺")])]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/01.png",alt:"Not Found Image"}}),s._v(" "),t("h2",{attrs:{id:"_2-创建deployment"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-创建deployment"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"2"}}),s._v("2. 创建Deployment")],1),s._v(" "),t("p",[s._v("和 Pod 一样，Deployment 也可以通过命令行工具"),t("code",[s._v("kubectl")]),s._v("进行创建。")]),s._v(" "),t("p",[s._v("也和 Pod 一样，官方推荐你通过 yaml 文件的方式来创建 Deployment。")]),s._v(" "),t("p",[s._v("从 kubernetes v1.18.x 版本开始，Deployment 在命令行中只支持"),t("code",[s._v("--image")]),s._v("选项，其余选项都不支持。所以，为了给 Deployment 配置更多的功能特性，我们只能选择 yaml 这一种方式了（官方强迫）。")]),s._v(" "),t("h3",{attrs:{id:"_2-1-通过yaml文件创建deployment"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-通过yaml文件创建deployment"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"2.1"}}),s._v("2.1 通过yaml文件创建Deployment")],1),s._v(" "),t("p",[s._v("在之前的章节中，我们曾通过"),t("code",[s._v("--dry-run=client")]),s._v("和"),t("code",[s._v("-o yaml")]),s._v("选项，来快速生成一个 Pod 的 yaml 配置文件。就像这样：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("--dry-run=client")]),s._v("：试运行，并不会真的创建资源")]),s._v(" "),t("li",[t("code",[s._v("-o yaml")]),s._v("：以 YAML 文件的格式输出该资源的配置信息")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl run pod1 "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),s._v(" nginx --dry-run"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("client "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" yaml "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" pod1.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("除了使用的子命令不同以外，我们也可以使用相同的选项来创建一个 Deployment 的 yaml 配置文件：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 格式")]),s._v("\nkubectl create deployment "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Deployment名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("选项"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 例如")]),s._v("\nkubectl create deployment deploy-test "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--image")]),s._v(" nginx --dry-run"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("client "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" yaml "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" deploy-test.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("创建一个名为"),t("code",[s._v("deploy-test")]),s._v("的 deployment，将其配置信息导出至"),t("code",[s._v("deploy-test.yaml")]),s._v("文件中。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/02.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("随后，我们打开这个 yaml 文件，你将看到以下内容：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("strategy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br")])]),t("p",[s._v("Deployment 的配置字段和我们之前看到的资源（例如 Pod 或 LimitRange）有一点不同：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("apiVersion")]),s._v("：Deployment 的 API 版本是固定的"),t("code",[s._v("apps/v1")])]),s._v(" "),t("li",[t("code",[s._v("kind")]),s._v("：写的是资源名称"),t("code",[s._v("Deployment")])]),s._v(" "),t("li",[t("code",[s._v("metadata")]),s._v("和其他资源一样，包含当前资源的元数据信息")]),s._v(" "),t("li",[t("code",[s._v("spec")]),s._v("包含 Deployment 的具体配置内容")])]),s._v(" "),t("h4",{attrs:{id:"_1-spec-replicas"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1-spec-replicas"}},[s._v("#")]),s._v(" （1）spec.replicas")]),s._v(" "),t("p",[s._v("需要维持的 Pod 数量（副本数），你需要几个 Pod 就写几个。")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h4",{attrs:{id:"_2-spec-template"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-spec-template"}},[s._v("#")]),s._v(" （2）spec.template")]),s._v(" "),t("p",[s._v("要创建的 Pod 模板，这部分内容和 Pod 的 yaml 配置完全一样，只不过除去了 Pod 的"),t("code",[s._v("apiVersion")]),s._v("和"),t("code",[s._v("kind")]),s._v("字段，只保留了 Pod 的元数据信息（"),t("code",[s._v("metadata")]),s._v("）和具体的配置项（"),t("code",[s._v("spec")]),s._v("）。")]),s._v(" "),t("p",[s._v("还有一个小细节，这个 Pod 模板没有名称（"),t("code",[s._v("metadata.name")]),s._v("），因为 deployment 在创建 Pod 的时候，会自动赋予它们一个随机的名称。")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("h4",{attrs:{id:"_3-spec-selector-matchlabels"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-spec-selector-matchlabels"}},[s._v("#")]),s._v(" （3）spec.selector.matchLabels")]),s._v(" "),t("p",[s._v("由 Deployment 创建出来的 Pod 都具有相同的标签"),t("code",[s._v("app=deploy-test")]),s._v("，Deployment 刚好可以通过这个标签来识别和追踪这些 Pod。")]),s._v(" "),t("ul",[t("li",[s._v("如果 Pod 的标签和 Deployment 的追踪标签不匹配，那么 Deployment 就无法找到要维持的 Pod（相当于失去效果）")]),s._v(" "),t("li",[s._v("Pod 可以同时具有多个标签，Deployment 的追踪标签只需要匹配"),t("b",[s._v("其中的一个标签")]),s._v("即可")])]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("h3",{attrs:{id:"_2-2-测试deployment"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-测试deployment"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"2.2"}}),s._v("2.2 测试Deployment")],1),s._v(" "),t("p",[s._v("1、我们以上面的 yaml 文件为基础，对其进行一点小小的修改：")]),s._v(" "),t("ul",[t("li",[s._v("将需要维持的 Pod 数量（"),t("code",[s._v("spec.replicas")]),s._v("）修改为"),t("code",[s._v("3")]),s._v("个")]),s._v(" "),t("li",[s._v("为 Pod 模板（"),t("code",[s._v("spec.template")]),s._v("）添加镜像下载策略"),t("code",[s._v("IfNotPresent")])])]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# deploy-test.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("strategy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("status")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br")])]),t("p",[s._v("2、然后创建这个 deployment，并查看 Pod 的运行状态：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl apply "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" deploy-test.yaml\nkubectl get deployments\n\nkubectl get pods "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" wide\nkubectl get pods --show-labels\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("如图所示，deployment 顺利地创建出了 3 个 Pod，并且这些 Pod 都具有相同的名称格式（"),t("code",[s._v("<控制器名称>-<模板hash>-<随机的Pod名称>")]),s._v("），且具有相同的两个标签。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/03.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("3、删除其中的某个 Pod，看看 deployment 是否会填补这个空缺。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl delete pods "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Pod名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("可以看到，当我将 Pod "),t("code",[s._v("b8hqg")]),s._v("删除之后，deployment 立马创建了一个新的 Pod "),t("code",[s._v("vc9gn")]),s._v("来顶替它的位置。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/04.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("（和 1.2 小节的漫画一样）")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/05.png",alt:"Not Found Image"}}),s._v(" "),t("h4",{attrs:{id:"_2-2-1-无法追踪pod的情况"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-1-无法追踪pod的情况"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"2.2.1"}}),s._v("2.2.1 无法追踪Pod的情况")],1),s._v(" "),t("p",[s._v("前面介绍"),t("code",[s._v("spec.selector.matchLabels")]),s._v("字段的时候提到过，deployment 通过标签来追踪 Pod，这样它就知道哪些 Pod 是需要它来维持的。")]),s._v(" "),t("p",[s._v("删除其中某个 Pod 的"),t("code",[s._v("app")]),s._v("标签，看看会发生什么：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 删除某个 Pod 上名为 app 标签")]),s._v("\nkubectl label pods "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Pod名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" app-\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("如图所示，当我把 Pod "),t("code",[s._v("9wp72")]),s._v("上的"),t("code",[s._v("app")]),s._v("标签删除之后，deployment 丢失了与这个 Pod 的连接。")]),s._v(" "),t("p",[s._v("由于 deployment 找不到这个 Pod，因此它会认为这个 Pod 已经挂掉了，随后会创建一个新的 Pod "),t("code",[s._v("gw8qh")]),s._v("来顶替它的位置。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/06.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("（丢失一个 Pod，需要创建另一个 Pod 来填补空缺）")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/07.png",alt:"Not Found Image"}}),s._v(" "),t("h4",{attrs:{id:"_2-2-2-超出上限的时候"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-2-超出上限的时候"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"2.2.2"}}),s._v("2.2.2 超出上限的时候")],1),s._v(" "),t("p",[s._v("前面我们创建了一个名为"),t("code",[s._v("deploy-test")]),s._v("的 deployment，它通过标签"),t("code",[s._v("app=deploy-test")]),s._v("来追踪 Pod，并让这些 Pod 的数量始终保持在 3 个。")]),s._v(" "),t("p",[s._v("在上一节中，我们删除了 Pod "),t("code",[s._v("9wp72")]),s._v("的"),t("code",[s._v("app")]),s._v("标签，导致 deployment 丢失了这个 Pod，并另外生成了一个新的 Pod。")]),s._v(" "),t("p",[s._v("我们帮这个 Pod 把标签加回去，这样一来 deployment 就会得到 4 个 Pod：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl label pods "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("Pod名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("app")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("deploy-test\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("如图所示，当 Pod "),t("code",[s._v("9wp72")]),s._v("回归这个大家庭后，就会超出 deployment 所维持的 Pod 数量上限，这时它将会删除其中的某个 Pod，将 Pod 数量缩减为 3 个。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/08.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("（突然多出一个 Pod，需要将 Pod 数量缩减为三个）")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/09.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("另外，你也可以单独创建一个 Pod，并为其设置标签"),t("code",[s._v("app=deploy-test")]),s._v("，这同样会超出数量上限，并产生相同的缩减效应。")]),s._v(" "),t("h3",{attrs:{id:"_2-4-删除deployment"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-删除deployment"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"2.4"}}),s._v("2.4 删除deployment")],1),s._v(" "),t("p",[s._v("和其他的资源一样，有两种删除 Deployment 的方式：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通过名称删除 Deployment")]),s._v("\nkubectl delete deployments "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("资源名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 通过原始文件删除 Deployment")]),s._v("\nkubectl delete "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("文件名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("这里我以文件的方式，删除刚刚创建出来的"),t("code",[s._v("deploy-test")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl delete "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" deploy-test.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("删除控制器之后，由该控制器创建出来的 Pod 也会一并被删除。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/create/10.png",alt:"Not Found Image"}}),s._v(" "),t("h2",{attrs:{id:"_3-修改deployment副本数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-修改deployment副本数"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"3"}}),s._v("3. 修改deployment副本数")],1),s._v(" "),t("p",[s._v("由控制器维持的 Pod 数量上限，也被称为 Pod 的 “副本数”。")]),s._v(" "),t("p",[s._v("在创建 deployment 的时候，我们可以通过修改"),t("code",[s._v("spec.replicas")]),s._v("字段来控制所产生的副本数。但当 deployment 被创建出来之后，我们如何修改这个数量呢？")]),s._v(" "),t("p",[s._v("在这之前，我们先创建一个用于实验的新 deployment：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# deploy-rep.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rep\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("replicas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("selector")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("matchLabels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" run\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("template")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("labels")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("app")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" run\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imagePullPolicy")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" IfNotPresent\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" nginx\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br")])]),t("p",[s._v("这个 deployment 的初始副本数被设置为"),t("code",[s._v("2")]),s._v("个。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建控制器")]),s._v("\nkubectl apply "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" deploy-rep.yaml\nkubectl get deployments\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/01.png",alt:"Not Found Image"}}),s._v(" "),t("h3",{attrs:{id:"_3-1-通过命令行修改副本数"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-通过命令行修改副本数"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"3.1"}}),s._v("3.1 通过命令行修改副本数")],1),s._v(" "),t("p",[s._v("这是最简单的一种修改方式，通过使用"),t("code",[s._v("kubectl scale")]),s._v("命令以及"),t("code",[s._v("--replicas")]),s._v("选项，即可轻松修改一个 deployment 的副本数。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl scale deployments "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--replicas")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("新的副本数"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("1、刚刚创建出来的 deployment 副本数为"),t("code",[s._v("2")]),s._v("个，最近双十一要到来了，两个 Pod 可能顶不住那么大的流量，我们将其副本数扩展为"),t("code",[s._v("5")]),s._v("个：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl scale deployment deploy-rep "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--replicas")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("2、如图所示，当扩展副本数为"),t("code",[s._v("5")]),s._v("个时，由于当前只有"),t("code",[s._v("2")]),s._v("个 Pod，所以 deployment 会依次创建三个新的 Pod，以填补这些位置的空缺。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/02.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("3、可以看到，有两个 Pod 的运行时间比较长（"),t("code",[s._v("4m39s")]),s._v("），它们就是最初的那两个 Pod。而新创建出来的三个 Pod 运行时间比较短（"),t("code",[s._v("2m4s")]),s._v("）。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/03.png",alt:"Not Found Image"}}),s._v(" "),t("h3",{attrs:{id:"_3-2-应用新的yaml配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-应用新的yaml配置"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"3.2"}}),s._v("3.2 应用新的yaml配置")],1),s._v(" "),t("p",[s._v("和其他资源（例如 Pod）一样，我们可以修改原始 yaml 配置文件，然后将新的配置应用到正在运行的资源上。")]),s._v(" "),t("p",[s._v("双十一过完了，系统不再需要那么多的 Pod 了，于是打开这个 deployment 的原始配置文件，将副本数修改为"),t("code",[s._v("3")]),s._v("个：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" deploy-rep.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/04.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("然后应用修改过后的配置：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl apply "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" deploy-rep.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("如果资源不存在，则"),t("code",[s._v("kubectl apply")]),s._v("会创建该资源。")]),s._v(" "),t("p",[s._v("如果资源已经存在，则"),t("code",[s._v("kubectl apply")]),s._v("会根据 yaml 文件中的配置项，更新当前资源的对应信息。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/05.png",alt:"Not Found Image"}}),s._v(" "),t("h3",{attrs:{id:"_3-3-编辑deployment运行属性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-编辑deployment运行属性"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"3.3"}}),s._v("3.3 编辑deployment运行属性")],1),s._v(" "),t("p",[s._v("k8s 允许你编辑某个正在运行的资源，你对其的修改会实时应用到当前资源中。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl edit deployment "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("1、例如，我们可以对"),t("code",[s._v("deploy-rep")]),s._v("进行编辑：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl edit deployment deploy-rep\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("执行命令之后，你就会进入配置视图，当前资源的所有配置信息都会以 yaml 的格式向你展现。你可以修改其中的某些字段，当你保存退出之后，所做更改会自动应用到当前的资源中。")]),s._v(" "),t("p",[s._v("这有点像编辑原始 yaml 文件，然后通过"),t("code",[s._v("apply")]),s._v("更新配置。而"),t("code",[s._v("edit")]),s._v("简化了这个过程。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/06.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("2、在配置视图中找到"),t("code",[s._v("spec.replicas")]),s._v("字段，将其修改为"),t("code",[s._v("4")]),s._v("，然后像使用 vim 一样保存退出。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/07.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("3、如图所示，成功通过"),t("code",[s._v("edit")]),s._v("将副本数修改为了"),t("code",[s._v("4")]),s._v("。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/modify/08.png",alt:"Not Found Image"}}),s._v(" "),t("h2",{attrs:{id:"_4-水平自动扩缩hpa"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-水平自动扩缩hpa"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"4"}}),s._v("4. 水平自动扩缩HPA")],1),s._v(" "),t("p",[s._v("在上一节中，我们介绍了三种修改 deployment 副本数的方式。但是这种修改方式也存在缺点：")]),s._v(" "),t("ul",[t("li",[s._v("当业务量大的时候（例如遇到了双十一），管理员需要手动将副本数调高")]),s._v(" "),t("li",[s._v("当业务量小的时候，管理员又需要手动将副本数调低")])]),s._v(" "),t("p",[s._v("这是一个繁琐的修改过程。有没有一种方法，可以根据 Pod 的负载情况，自动扩展或缩减 Pod 数量呢？")]),s._v(" "),t("p",[s._v("这时候就要用到 HPA（水平自动扩缩）了，它又被称为 “水平自动更新”。")]),s._v(" "),t("h3",{attrs:{id:"_4-1-根据cpu负载情况自动扩缩"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-根据cpu负载情况自动扩缩"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"4.1"}}),s._v("4.1 根据CPU负载情况自动扩缩")],1),s._v(" "),t("p",[s._v("HPA 可以根据每个 Pod 的负载情况（CPU 使用率或内存使用率），自动对 Deployment 的副本数进行扩展或缩减。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 为 Deployment 设置 HPA 策略")]),s._v("\nkubectl autoscale deployment "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("目标控制器名称"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--min")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("最小Pod数"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--max")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("最大Pod数"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" --cpu-percent"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("CPU百分比"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h4",{attrs:{id:"_4-1-1-配置hpa"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-1-配置hpa"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"4.1.1"}}),s._v("4.1.1 配置HPA")],1),s._v(" "),t("p",[s._v("1、我们先把之前那个 deployment 的副本数设置为"),t("code",[s._v("2")]),s._v("个，然后查看当前是否有 HPA。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改副本数")]),s._v("\nkubectl scale deployment deploy-rep "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--replicas")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\nkubectl get deployments\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 列出 HPA")]),s._v("\nkubectl get hpa\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("可以看到，当前命名空间中没有 HPA。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/01.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("2、为"),t("code",[s._v("deploy-rep")]),s._v("创建一个 HPA 策略，这个 HPA 没有名称，且会自动绑定到所提供的 deployment 上。")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("--min=2")]),s._v("：这个 deployment 的副本数最少为"),t("code",[s._v("2")]),s._v("个")]),s._v(" "),t("li",[t("code",[s._v("--max=7")]),s._v("：这个 deployment 的副本数最多为"),t("code",[s._v("7")]),s._v("个")]),s._v(" "),t("li",[t("code",[s._v("--cpu-percent=60")]),s._v("：确保其中每个 Pod 的 CPU 使用率保持在"),t("code",[s._v("60%")]),s._v("以下")])]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl autoscale deployment deploy-rep "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--min")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--max")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" --cpu-percent"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("例如，当前的 CPU 负载量为 90%，那么这两个 Pod 就会各自分担 45%。")]),s._v(" "),t("p",[s._v("这个 HPA 会确保这些 Pod 的平均负载保持在 60% 以下，平均负载超过了 60%，那么 HPA 就会创建更多的 Pod 来分担负载量。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/02.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("此时，这个 HPA 的计量指标为"),t("code",[s._v("<unknown>/60%")]),s._v("，为什么这里显示的是"),t("code",[s._v("unknown")]),s._v("（未知）呢？这其中肯定存在问题。")]),s._v(" "),t("h4",{attrs:{id:"_4-1-2-为控制器中的pod配置资源限制"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-2-为控制器中的pod配置资源限制"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"4.1.2"}}),s._v("4.1.2 为控制器中的Pod配置资源限制")],1),s._v(" "),t("p",[s._v("并不是创建 HPA 之后就万事大吉了，我们还需要为 deployment 所控制的 Pod 配置资源限制。")]),s._v(" "),t("p",[s._v("我们刚刚通过选项"),t("code",[s._v("--cpu-percent=60")]),s._v("将扩展触发量定为了 60%，那么这个百分比计算的是哪个数值呢？这个数值和 Pod 的资源限制字段"),t("code",[s._v("spec.containers.resources")]),s._v("有关。例如，考虑一个这样的 Pod：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("containers")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 400m\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("在这个 Pod 当中，其 CPU 资源使用上限被设置成了"),t("code",[s._v("400")]),s._v("个 CPU 微核心。那么对于 HPA 来说，60% 的资源就相当于"),t("code",[s._v("400 * 0.6 = 240")]),s._v("个 CPU 微核心。")]),s._v(" "),t("p",[s._v("也就是说，当这些 Pod 的平均 CPU 负载超过了"),t("code",[s._v("240m")]),s._v("的时候，HPA 就会通知 Deployment 扩展副本数，创建更多的 Pod 来分担业务量，将这些 Pod 的平均 CPU 负载降低至"),t("code",[s._v("240m")]),s._v("以下。")]),s._v(" "),t("p",[s._v("1、通过"),t("code",[s._v("edit")]),s._v("命令编辑刚刚的 deployment，打开配置视图后，找到 Pod 模板的所在位置（"),t("code",[s._v("spec.template")]),s._v("）：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl edit deployment deploy-rep\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/03.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("2、为 Pod 模板添加资源限制，将 CPU 使用上限设置为"),t("code",[s._v("400m")]),s._v("，然后保存退出：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("...")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 400m\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/04.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("3、可以看到，当你修改了 Pod 模板之后，deployment 会删除之前的 Pod，并根据新的模板重新创建 Pod。")]),s._v(" "),t("p",[s._v("而且 HPA 的计量从之前的"),t("code",[s._v("unknown")]),s._v("（未知）变为了"),t("code",[s._v("0%")]),s._v("，说明它现在已经能够正确监测负载信息了。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/05.png",alt:"Not Found Image"}}),s._v(" "),t("h4",{attrs:{id:"_4-1-3-测试hpa"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-3-测试hpa"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"4.1.3"}}),s._v("4.1.3 测试HPA")],1),s._v(" "),t("p",[s._v("1、为了测试这个 deployment 的可扩展性，我们需要执行以下命令：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl expose deployment deploy-rep "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--port")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" --target-port"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--type")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NodePort\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("该命令会为 deployment 创建一个网络服务，并为其分配一个 IP 地址（在这里为"),t("code",[s._v("10.106.94.87")]),s._v("）。deployment 在这里面充当了一个负载均衡器的角色，当你不断请求这个 IP 地址时，你的请求会被依次转发到 deployment 所控制的每个 Pod 中。")]),s._v(" "),t("p",[s._v("你暂时不需要了解这其中的参数原理，这将在后面的章节中介绍，你只需要简单地执行这条命令即可。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/06.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("2、切换至任意工作节点，在主机上安装网络压力测试工具：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# worker")]),s._v("\nyum "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" httpd-tools "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/07.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("3、在安装了压力测试工具的主机上，对目标 deployment 发起大量网络请求，迫使其负载增加：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("ab "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000000")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" http://"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("目标IP地址"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 例如")]),s._v("\nab "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000000")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" http://10.106.94.87/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("4、回到 master 主机上，不断查看 Pod 负载信息以及 HPA 的情况：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" pods "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" kubectl get hpa\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("此时压力测试刚刚开始，两个 Pod 应付起来还能游刃有余。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/08.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("Pod 限制 CPU 资源使用上限为"),t("code",[s._v("400m")]),s._v("，HPA 保持 CPU 利用率为"),t("code",[s._v("60%")]),s._v("，所以阈值为"),t("code",[s._v("400m * 60% = 240m")]),s._v("。")]),s._v(" "),t("p",[s._v("此时，这两个 Pod 的平均 CPU 负载都已经超过了阈值"),t("code",[s._v("240m")]),s._v("，因此 HPA 需要做出反应。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/09.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("稍后，HPA 将 deployment 的副本数扩展为了"),t("code",[s._v("4")]),s._v("个，此时有四个 Pod 分担业务流量，平均 CPU 负载为"),t("code",[s._v("81%")]),s._v("。")]),s._v(" "),t("p",[s._v("还是超过了 HPA 所设定的阈值，四个 Pod 不够！")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/10.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("HPA 也意识到了这个问题，所以继续将副本数扩展至"),t("code",[s._v("6")]),s._v("个，用更多的 Pod 来分担业务流量。")]),s._v(" "),t("p",[s._v("此时平均 CPU 负载为"),t("code",[s._v("61%")]),s._v("，HPA 还会继续扩展吗？")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/11.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("等待一会之后，平均 CPU 负载下降到了"),t("code",[s._v("51%")]),s._v("。从 Pod 负载信息中也可以看出，现在这六个 Pod 的 CPU 负载都位于"),t("code",[s._v("240m")]),s._v("以下，并没有超过阈值。")]),s._v(" "),t("p",[s._v("HPA 并不会一股脑地增加 Pod 数量，而是循序渐进，并观察是否符合预期要求。在确认 CPU 平均利用率稳定下来之后，HPA 便不会再扩展副本数。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/12.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("过了一会之后，另一台主机上的压力测试工具也运行完毕了（你也可以"),t("code",[s._v("Ctrl+C")]),s._v("提前终止运行）。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/13.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("5、在压力测试工具停止以后，再次查看 Pod 以及 HPA 信息：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" pods "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" kubectl get hpa\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("此时平均 CPU 使用率已经降低至"),t("code",[s._v("0%")]),s._v("，而且所有 Pod 的 CPU 负载也都处于"),t("code",[s._v("0m")]),s._v("，说明没有业务流量需要处理。")]),s._v(" "),t("p",[s._v("但 Pod 数量始终保持在"),t("code",[s._v("6")]),s._v("个，难道 HPA 只会扩不会缩？")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/14.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("其实这是 HPA 的一种防抖机制。")]),s._v(" "),t("div",{staticClass:"custom-block note"},[t("p",{staticClass:"custom-block-title"},[s._v("笔记")]),s._v(" "),t("p",[s._v("当平均负载超过阈值，HPA 会迅速扩展副本数，以应对即将到来的业务量。")]),s._v(" "),t("p",[s._v("当平均负载低于阈值时，HPA 会等待一段时间（默认"),t("code",[s._v("5")]),s._v("分钟），确认平均负载不会再次升高以后，才会缩减副本数。这可以有效地防止 Pod 数量抖动。")])]),s._v(" "),t("p",[s._v("仔细想想，如果负载量一时高一时低，变来变去。而 Pod 一会被创建出来，没几秒又被删除，等会又被创建出来，又被删除......")]),s._v(" "),t("p",[s._v("6、等待一段时间之后，再次查看 Pod 以及 HPA 信息：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" pods "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" kubectl get hpa\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("HPA 确认业务量稳定之后，已经将副本数缩减为了"),t("code",[s._v("2")]),s._v("个。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/15.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("7、本次实验成功，将这个 HPA 删除：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl delete hpa deploy-rep\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v1/16.png",alt:"Not Found Image"}}),s._v(" "),t("h3",{attrs:{id:"_4-2-hpa的v2版本"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-hpa的v2版本"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"4.2"}}),s._v("4.2 HPA的v2版本")],1),s._v(" "),t("p",[s._v("在 yaml 文件中，HPA 的"),t("code",[s._v("apiVersion")]),s._v("参数值为"),t("code",[s._v("autoscaling/v1")]),s._v("，例如：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 快速生成一个 HPA 的配置文件")]),s._v("\nkubectl autoscale deployment deploy-rep "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--min")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--max")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v(" --cpu-percent"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v(" --dry-run"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("client "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-o")]),s._v(" yaml "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" deploy-rep.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" autoscaling/v1\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" HorizontalPodAutoscaler\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("creationTimestamp")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token null important"}},[s._v("null")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rep\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("maxReplicas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("minReplicas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("scaleTargetRef")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rep\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("targetCPUUtilizationPercentage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("这是一代版本的 HPA，可以用于设置 CPU 阈值。当 Pod 平均 CPU 负载超过阈值时，HPA 就会自动扩展副本数。")]),s._v(" "),t("p",[s._v("如果你曾运行过"),t("code",[s._v("kubectl api-versions")]),s._v("命令，你可能会发现 HPA 还有二代版本：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl api-versions\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/01.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("二代 HPA 无法通过命令行创建，但是可以通过 yaml 文件来生成：")]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" autoscaling/v2\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" HorizontalPodAutoscaler\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rep\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("minReplicas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("maxReplicas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("scaleTargetRef")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rep\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metrics")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Resource\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resource")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cpu\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Utilization\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("averageUtilization")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br")])]),t("p",[s._v("你看出一代和二代 yaml 文件之间的细微区别了吗？二代 HPA 在一代的基础上增加了很多新功能，包括对内存使用率的自动扩缩。")]),s._v(" "),t("h3",{attrs:{id:"_4-3-根据内存负载情况自动扩缩"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-根据内存负载情况自动扩缩"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"4.3"}}),s._v("4.3 根据内存负载情况自动扩缩")],1),s._v(" "),t("p",[s._v("由于二代 HPA 无法通过命令行创建，"),t("code",[s._v("kubectl")]),s._v("也没有提供内存阈值的参数选项。")]),s._v(" "),t("p",[s._v("所以，如果你想根据内存使用率对 deployment 进行自动扩缩，则必须通过 yaml 文件来创建二代 HPA。")]),s._v(" "),t("h4",{attrs:{id:"_4-3-1-阈值-百分比"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-1-阈值-百分比"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"4.3.1"}}),s._v("4.3.1 阈值-百分比")],1),s._v(" "),t("p",[s._v("1、将 “4.2” 章节中展示的二代 HPA 另存至"),t("code",[s._v("rep-hpa2.yaml")]),s._v("文件当中：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF"),t("span",{pre:!0,attrs:{class:"token bash punctuation"}},[s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" rep-hpa2.yaml")]),s._v("\napiVersion: autoscaling/v2\nkind: HorizontalPodAutoscaler\nmetadata:\n  name: deploy-rep\nspec:\n  minReplicas: 2\n  maxReplicas: 7\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: deploy-rep\n  metrics:\n  - type: Resource\n    resource:\n      name: cpu\n      target:\n        type: Utilization\n        averageUtilization: 50\nEOF")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/02.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("2、编辑"),t("code",[s._v("rep-hpa2.yaml")]),s._v("文件，将字段"),t("code",[s._v("spec.metrics.resource.name")]),s._v("修改为"),t("code",[s._v("memory")]),s._v("，然后保存退出：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" rep-hpa2.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/03.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("3、编辑控制器"),t("code",[s._v("deploy-rep")]),s._v("，在之前实验的基础上，为 Pod 模板添加内存资源限制，将内存使用上限设置为"),t("code",[s._v("100Mi")]),s._v("，然后保存退出：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl edit deployment deploy-rep\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/04.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("4、创建这个二代 HPA：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl apply "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" rep-hpa2.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("由于 HPA 刚刚被创建出来，所以当前的内存使用率会显示为"),t("code",[s._v("<unknown>")]),s._v("（未知）。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/05.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("5、等待一段时间，再次查看 HPA：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl get hpa\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("此时 HPA 已经正确识别了所有 Pod 的平均内存使用率，之前的"),t("code",[s._v("<unknown>")]),s._v("变为了"),t("code",[s._v("2%")]),s._v("。")]),s._v(" "),t("p",[s._v("当两个 Pod 的平均内存使用率达到资源上限（"),t("code",[s._v("100Mi")]),s._v("）的"),t("code",[s._v("50%")]),s._v("（阈值"),t("code",[s._v("50Mi")]),s._v("）的时候，HPA 就会自动扩展 deployment 的副本数。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/06.png",alt:"Not Found Image"}}),s._v(" "),t("h4",{attrs:{id:"_4-3-2-阈值-绝对数值"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-2-阈值-绝对数值"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"4.3.2"}}),s._v("4.3.2 阈值-绝对数值")],1),s._v(" "),t("p",[s._v("前面的阈值都是通过"),t("code",[s._v("资源上限 * 百分比 = ?")]),s._v("来计算的，我能否提供一个具体的数值，而不是一个百分比？")]),s._v(" "),t("p",[s._v("1、当然可以，我在"),t("code",[s._v("rep-hpa2.yaml")]),s._v("的基础上添加了 CPU 阈值，它是一个具体的值：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" rep-hpa2.yaml\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# rep-hpa2.yaml")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" autoscaling/v2\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" HorizontalPodAutoscaler\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metadata")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rep\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("spec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("minReplicas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("maxReplicas")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("scaleTargetRef")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" apps/v1\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Deployment\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" deploy"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("rep\n  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("metrics")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Resource\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resource")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" memory\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Utilization\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("averageUtilization")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" Resource\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resource")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cpu\n      "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("target")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" AverageValue\n        "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("averageValue")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 280m\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br")])]),t("p",[s._v("你看出来两者的不同了吗？")]),s._v(" "),t("ul",[t("li",[s._v("对于百分比阈值，需要通过"),t("code",[s._v("type: Utilization")]),s._v("和"),t("code",[s._v("averageUtilization: <百分比>")]),s._v("来设置")]),s._v(" "),t("li",[s._v("对于绝对数值，需要通过"),t("code",[s._v("type: AverageValue")]),s._v("和"),t("code",[s._v("averageValue: <值>")]),s._v("来设置")])]),s._v(" "),t("p",[s._v("2、应用新的 yaml 配置：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl apply "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-f")]),s._v(" rep-hpa2.yaml\nkubectl get hpa\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("应用更改之后，现在 HPA 可以同时监测 CPU 和内存的平均使用率，从而动态扩缩 deployment 副本数。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/07.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("那么问题来了，扩缩的条件是超过一个阈值，还是同时超过两个阈值？")]),s._v(" "),t("p",[s._v("3、让我们回到之前安装了压力测试工具的主机上，再次运行压力测试工具，对 deployment 网络服务的地址发起请求：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# worker")]),s._v("\nab "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-t")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-n")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000000")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-c")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v(" http://10.106.94.87/\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/08.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("4、在 master 上不断查看 HPA 情况：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" pods "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" kubectl get hpa\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("此时，两个 Pod 的平均 CPU 使用率已经超过了阈值，但 HPA 毫无动作。")]),s._v(" "),t("p",[s._v("难道要同时满足两个条件？别急，再看看。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/09.png",alt:"Not Found Image"}}),s._v(" "),t("p",[s._v("等待一会之后，HPA 出手了。")]),s._v(" "),t("p",[s._v("由于平均 CPU 负载过高，HPA 扩展了副本数，创建更多的 Pod 来分担业务量，将平均负载降到了"),t("code",[s._v("280m")]),s._v("以下。")]),s._v(" "),t("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/deployment/hpa-v2/10.png",alt:"Not Found Image"}}),s._v(" "),t("div",{staticClass:"custom-block note"},[t("p",{staticClass:"custom-block-title"},[s._v("笔记")]),s._v(" "),t("p",[s._v("如果 HPA 同时配置了 CPU 和内存阈值，则它们是 “或” 的关系。只要其中一个超出了阈值，就会自动扩展副本数。")])]),s._v(" "),t("p",[s._v("5、当平均负载稳定降下来之后，HPA 会等待一段时间（防抖期），然后缩减副本数。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("top")]),s._v(" pods "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" kubectl get hpa\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("6、最后，删除 HPA、Deployment 和网络服务：")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("kubectl delete hpa deploy-rep\nkubectl delete deployment deploy-rep\nkubectl delete "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("service")]),s._v(" deploy-rep\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("div",{staticClass:"custom-block note"},[t("p",{staticClass:"custom-block-title"},[s._v("学习更多")]),s._v(" "),t("ul",[t("li",[t("a",{attrs:{href:"https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale/",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档-Pod 水平自动扩缩"),t("OutboundLink")],1)]),s._v(" "),t("li",[t("a",{attrs:{href:"https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale-walkthrough/",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方文档-HorizontalPodAutoscaler 演练"),t("OutboundLink")],1)])])]),s._v(" "),t("h2",{attrs:{id:"小结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[s._v("#")]),s._v(" "),t("Badge",{attrs:{type:"error",text:"5"}}),s._v("小结")],1),s._v(" "),t("p",[s._v("本章对控制器 Deployment 做了一个了解，并学习了如何创建、删除和编辑 Deployment。")]),s._v(" "),t("p",[s._v("还学习了如何为 Deployment 配置水平自动扩缩（HPA 和 HPAv2），通过 HPA 来监测 CPU 和内存平均使用情况，然后自动扩缩 Pod 数量。")]),s._v(" "),t("p",[s._v("通过本章的学习，你应该掌握以下技能：")]),s._v(" "),t("ul",[t("li",[s._v("创建和删除 Deployment，根据标签来追踪 Pod 群体")]),s._v(" "),t("li",[s._v("配置 Deployment 副本数和 Pod 模板")]),s._v(" "),t("li",[s._v("编辑正在运行的 Deployment")]),s._v(" "),t("li",[s._v("为一个 Deployment 配置水平自动更新 HPA")]),s._v(" "),t("li",[s._v("二代 HPA 的使用")])]),s._v(" "),t("p",[s._v("如果你已经掌握以上内容，可以去做些练习题巩固一下（"),t("RouterLink",{attrs:{to:"/cloud-native-security/kubernetes/practice/06/"}},[s._v("练习题-6")]),s._v("）。")],1)])}),[],!1,null,null,null);t.default=n.exports}}]);