(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{331:function(s,e,t){"use strict";t.r(e);var a=t(7),r=Object(a.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("div",{staticClass:"cardListContainer"},[e("div",{staticClass:"card-list"},[e("span",{staticClass:"card-item row-2",staticStyle:{"background-color":"#F0DFB1","--randomColor":"#F0DFB1",color:"#1078E6"}},[e("div",[e("p",{staticClass:"name"},[s._v("原创")]),s._v(" "),e("p",{staticClass:"desc"},[s._v("本博客原创文章，转载请注明出处")])])])]),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 原创\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("desc")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 本博客原创文章，转载请注明出处\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("bgColor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'#F0DFB1'")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("textColor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'#1078E6'")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])])]),e("h1",{attrs:{id:"第4章-kubernetes集群升级"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#第4章-kubernetes集群升级"}},[s._v("#")]),s._v(" 第4章-Kubernetes集群升级")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("本章要点")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("了解 Kubernetes 的升级步骤")])]),s._v(" "),e("tr",[e("td",[s._v("实施 Kubernetes 的升级")])])])]),s._v(" "),e("h2",{attrs:{id:"_1-升级说明"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-升级说明"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"1"}}),s._v("1. 升级说明")],1),s._v(" "),e("h3",{attrs:{id:"_1-1-为什么要升级-kubernetes"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-为什么要升级-kubernetes"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"1.1"}}),s._v("1.1 为什么要升级 Kubernetes？")],1),s._v(" "),e("p",[s._v("每个 Kubernetes 版本的生命周期很短，在官方发布的"),e("a",{attrs:{href:"https://kubernetes.io/zh-cn/releases/",target:"_blank",rel:"noopener noreferrer"}},[s._v("发行版本历史"),e("OutboundLink")],1),s._v("以及"),e("a",{attrs:{href:"https://kubernetes.io/releases/patch-releases/",target:"_blank",rel:"noopener noreferrer"}},[s._v("版本排期表"),e("OutboundLink")],1),s._v("中可以看到，现在 Kubernetes 每年都会更新迭代，每个新版本的使用寿命只有 1.5 年左右。")]),s._v(" "),e("ul",[e("li",[s._v("在今年 6 月份的时候，最新的 Kubernetes 版本是 1.27.3")]),s._v(" "),e("li",[s._v("现在是 10 月份，最新版本是 1.27.6 和 1.28.2")]),s._v(" "),e("li",[s._v("甚至 1.29 都快出来了")])]),s._v(" "),e("p",[s._v("为了获得官方对 Kubernetes 的支持（例如安全补丁），我们每隔一段时间就需要更新 Kubernetes，以"),e("b",[s._v("提高集群的安全性，并获取高版本中的新特性")]),s._v("。")]),s._v(" "),e("h3",{attrs:{id:"_1-2-kubernetes的升级限制和顺序"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-kubernetes的升级限制和顺序"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"1.2"}}),s._v("1.2 Kubernetes的升级限制和顺序")],1),s._v(" "),e("p",[s._v("Kubernetes 的升级并不是随意的，需要遵循一些规则。")]),s._v(" "),e("h4",{attrs:{id:"不能跨版本升级"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#不能跨版本升级"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"1.2.1"}}),s._v("不能跨版本升级")],1),s._v(" "),e("p",[s._v("Kubernetes 不能跨版本升级，当前版本只能升级到下一个版本。")]),s._v(" "),e("ul",[e("li",[s._v("例如 v1.26 版本可以升级到 v1.27")]),s._v(" "),e("li",[s._v("但是 v1.26 版本不能升级到 v1.28")])]),s._v(" "),e("p",[s._v("也就是说，如果你想将 1.26 升级到 1.28，则你需要进行两次升级，第一次先升级到 1.27，第二次再升级到 1.28。")]),s._v(" "),e("h4",{attrs:{id:"升级顺序"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#升级顺序"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"1.2.2"}}),s._v("升级顺序")],1),s._v(" "),e("p",[s._v("Kubernetes 需要按顺序升级。")]),s._v(" "),e("p",[e("b",[s._v("节点的升级顺序：")])]),s._v(" "),e("ol",[e("li",[s._v("先升级 master")]),s._v(" "),e("li",[s._v("如果有多台 master，则需要一台一台地升级")]),s._v(" "),e("li",[s._v("最后才升级 worker")])]),s._v(" "),e("p",[e("b",[s._v("软件的升级顺序：")])]),s._v(" "),e("ol",[e("li",[s._v("先升级 kubeadm。前面提到过，kubeadm用于部署和管理整个集群，所以要优先升级它")]),s._v(" "),e("li",[s._v("升级集群组件")]),s._v(" "),e("li",[s._v("升级 kubectl 和 kubelet")])]),s._v(" "),e("p",[e("b",[s._v("具体的升级过程：")])]),s._v(" "),e("ol",[e("li",[s._v("升级 master 上的 kubeadm")]),s._v(" "),e("li",[s._v("升级 master 上的集群组件")]),s._v(" "),e("li",[s._v("升级 master 上的 kubectl 和 kubelet")]),s._v(" "),e("li",[s._v("升级 worker 上的 kubeadm")]),s._v(" "),e("li",[s._v("升级 worker 上的集群组件")]),s._v(" "),e("li",[s._v("升级 worker 上的 kubectl 和 kubeclet")])]),s._v(" "),e("h2",{attrs:{id:"_2-集群升级"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-集群升级"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"2"}}),s._v("2. 集群升级")],1),s._v(" "),e("p",[s._v("在升级之前，先查看一下 master 当前的版本：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl get nodes\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或")]),s._v("\nkubectl version "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--short")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("master 在集群中显示的版本为 v1.26.5，软件版本也为 v1.26.5。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/master/01.png",alt:"Not Found Image"}}),s._v(" "),e("h3",{attrs:{id:"_2-1-升级-master"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-升级-master"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"2.1"}}),s._v("2.1 升级 master")],1),s._v(" "),e("h4",{attrs:{id:"升级-master-的-kubeadm"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#升级-master-的-kubeadm"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"2.1.1"}}),s._v("升级 master 的 kubeadm")],1),s._v(" "),e("p",[s._v("此处通过 yum 来升级 kubeadm 软件包。")]),s._v(" "),e("p",[s._v("查看 kubeadm 的版本列表：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("yum list kubeadm "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--showduplicates")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("绿色代表你当前已安装的版本。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/master/02.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("将 kubeadm 升级为 v1.27.6 版本：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("yum "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" kubeadm-1.27.6-0 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--disableexcludes")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("确认无误后，输入 “y” 并回车，以确认安装。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/master/03.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("安装完成后，查看 kubeadm 软件的当前版本：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubeadm version\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("软件更新成功，已经变成了 v1.27.6 版本。但是集群中的版本信息还没有变化，不用担心，这是正常的。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/master/04.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("成功更新 kubeadm 软件之后，我们可以查看 kubernetes 集群的更新计划：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubeadm upgrade plan\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("从图中可以看到，我们的集群目前处于 v1.26.5 版本，你可以将其更新为 v1.26.9 版本。")]),s._v(" "),e("p",[s._v("此外，上方还有一条提示信息 “remote version is much newer: v1.28.2; falling back to: stable-1.27”。意思是说：发现了最新版本 v1.28.2，但是你首先需要更新为 1.27 版本，才能进一步更新为 v1.28。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/master/05.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("命令行的输出信息很多，继续往下拉，看到了另一个可更新的版本 v1.27.6，这正是我们想要的。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/master/06.png",alt:"Not Found Image"}}),s._v(" "),e("h4",{attrs:{id:"升级-master-的集群组件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#升级-master-的集群组件"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"2.1.2"}}),s._v("升级 master 的集群组件")],1),s._v(" "),e("p",[s._v("在更新集群组件之前，需要先将 master 节点设置成维护模式：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl drain www.k10.com --ignore-daemonsets\n\nkubectl get nodes\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/master/07.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("确保 master 已经处于维护模式，然后更新集群：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubeadm upgrade apply v1.27.6\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("确认无误后，输入 “y” 并回车，以确认操作。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/master/08.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("此外，更新集群的同时还会更新 etcd 组件，该组件保存了集群的各种状态信息，例如配置信息、运行信息、网络信息等。")]),s._v(" "),e("p",[s._v("如果你担心 etcd 在更新的过程中发生什么闪失，导致信息丢失，则你可以添加标志符"),e("code",[s._v("--etcd-upgrade=false")]),s._v("以禁止 etcd 组件的更新：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubeadm upgrade apply v1.27.6 --etcd-upgrade"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("false\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("集群的更新时间比较长，因为更新的过程中 需要下载镜像文件，具体的时间长短 取决于你的网络速度。在更新集群之前，你也可以执行命令"),e("code",[s._v("kubeadm config images pull")]),s._v("来提前下载镜像文件。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/master/09.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("当你看到 “[upgrade/successful]” 字样的时候，说明升级成功。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/master/10.png",alt:"Not Found Image"}}),s._v(" "),e("h4",{attrs:{id:"升级-master-的-kubectl和kubelet"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#升级-master-的-kubectl和kubelet"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"2.1.3"}}),s._v("升级 master 的 kubectl和kubelet")],1),s._v(" "),e("p",[s._v("kubeadm 软件和相关集群组件都已经升级完毕，下一步是升级 kubectl 和 kubelet 软件。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/master/11.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("将 kubectl 和 kubelet 升级至 v1.27.6 版本：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("yum "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" kubectl-1.27.6-0 kubelet-1.27.6-0 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--disableexcludes")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("确认无误后，输入 “y” 并回车，以确认操作。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/master/12.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("安装完毕后，重载并重启 kubelet 服务：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重载并重启服务")]),s._v("\nsystemctl daemon-reload\nsystemctl restart kubelet\n\nsystemctl status kubelet\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("此时 kubelet 服务的状态为 “active（running）”。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/master/13.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("取消 master 节点的维护模式：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl uncordon www.k10.com\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("通过"),e("code",[s._v("kubectl get nodes")]),s._v("再次查看集群信息，可以看到 master 节点的版本已经变更为了 v1.27.6。")]),s._v(" "),e("p",[s._v("master 升级成功！")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/master/14.png",alt:"Not Found Image"}}),s._v(" "),e("h3",{attrs:{id:"_2-2-升级-worker"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-升级-worker"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"2.2"}}),s._v("2.2 升级 worker")],1),s._v(" "),e("p",[s._v("worker 的升级步骤和 master 相同，都是三步：")]),s._v(" "),e("ul",[e("li",[s._v("升级 kubeadm")]),s._v(" "),e("li",[s._v("升级集群组件")]),s._v(" "),e("li",[s._v("升级 kubectl 和 kubelet")])]),s._v(" "),e("p",[s._v("只有一点不同，那就是 master 在升级集群组件时的命令是：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# master升级集群组件")]),s._v("\nkubeadm upgrade apply v1.27.6\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("而 worker 升级集群组件时，则需要使用另一个命令：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# worker升级集群组件")]),s._v("\nkubeadm upgrade "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("master 和 worker 之间除了升级组件的命令不同之外，其余的命令和操作完全一致。")]),s._v(" "),e("h4",{attrs:{id:"升级-worker-的-kubeadm"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#升级-worker-的-kubeadm"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"2.2.1"}}),s._v("升级 worker 的 kubeadm")],1),s._v(" "),e("p",[s._v("在升级之前，先查看版本列表，确认是否有我们所需要的版本：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("yum list kubeadm "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--showduplicates")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("发现最高的软件版本只有 1.27.2，并没有我们需要的 1.27.6。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker1/01.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("不用慌，可能是 yum 软件列表太旧了，更新一下信息即可：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 获取有关于 kubeadm 的最新软件包信息")]),s._v("\nyum update kubeadm\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新所有软件包信息，速度可能较慢，不推荐")]),s._v("\nyum update\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[s._v("注意！！！这里要输入 “n” 取消更新，因为我们只是要获取版本信息，并不需要更新。")]),s._v(" "),e("p",[s._v("如果你输入了 “y” 则你的 kubeadm 会自动更新为最新的 v1.28.2 版本。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker1/02.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("成功获取版本信息，现在可以看到 1.27.6 版本的 kubeadm 了。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker1/03.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("安装：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("yum "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" kubeadm-1.27.6-0 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--disableexcludes")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker1/04.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("确认下版本：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubeadm version\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker1/05.png",alt:"Not Found Image"}}),s._v(" "),e("h4",{attrs:{id:"升级-worker-的集群组件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#升级-worker-的集群组件"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"2.2.2"}}),s._v("升级 worker 的集群组件")],1),s._v(" "),e("p",[s._v("回到 master 节点，将需要升级的 worker 设置成维护模式（升级哪个就维护哪个）：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl drain www.k11.com --ignore-daemonsets --delete-emptydir-data\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("成功将该 worker 设置成维护模式。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker1/07.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("回到 worker 主机，更新组件：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubeadm upgrade "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("worker 更新组件的速度特别快，快到你差点以为出错了，和 master 的更新速度形成了鲜明对比。")]),s._v(" "),e("p",[s._v("看到 “successfully updated!” 字样说明更新成功。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker1/08.png",alt:"Not Found Image"}}),s._v(" "),e("h4",{attrs:{id:"升级-worker-的-kubectl和kubelet"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#升级-worker-的-kubectl和kubelet"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"2.2.3"}}),s._v("升级 worker 的 kubectl和kubelet")],1),s._v(" "),e("p",[s._v("更新 kubectl 和 kubelet：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("yum "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" kubectl-1.27.6-0 kubelet-1.27.6-0 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--disableexcludes")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker1/09.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("更新完毕后，重载和重启 kubelet 服务：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("systemctl daemon-reload\nsystemctl restart kubelet\n\nsystemctl status kubelet\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("服务状态为 “active（running）” 说明正常。")]),s._v(" "),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker1/10.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("回到 master 主机，取消 worker 节点的维护模式。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("kubectl uncordon www.k11.com\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker1/11.png",alt:"Not Found Image"}}),s._v(" "),e("h3",{attrs:{id:"_2-3-升级另一台worker"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-升级另一台worker"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"2.3"}}),s._v("2.3 升级另一台worker")],1),s._v(" "),e("p",[s._v("快速过一遍。")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新kubeadm")]),s._v("\nyum "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" kubeadm-1.27.6-0 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--disableexcludes")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker2/01.png",alt:"Not Found Image"}}),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看版本")]),s._v("\nkubeadm version\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker2/02.png",alt:"Not Found Image"}}),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在master上，将worker设置成维护模式")]),s._v("\nkubectl drain www.k12.com "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--force")]),s._v(" --ignore-daemonsets --delete-emptydir-data\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker2/03.png",alt:"Not Found Image"}}),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新组件")]),s._v("\nkubeadm upgrade "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("node")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker2/04.png",alt:"Not Found Image"}}),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 更新kubectl和kubelet")]),s._v("\nyum "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" kubectl-1.27.6-0 kubelet-1.27.6-0 "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--disableexcludes")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubernetes "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-y")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker2/05.png",alt:"Not Found Image"}}),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 重载和重启服务")]),s._v("\nsystemctl daemon-reload\nsystemctl restart kubelet\n\nsystemctl status kubelet\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker2/06.png",alt:"Not Found Image"}}),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 在master上，取消worker的维护模式")]),s._v("\nkubectl uncordon www.k12.com\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("img",{attrs:{src:"https://fastly.statically.io/gh/clincat/blog-imgs@main/vuepress/static/imgs/docs/cloud-native-security/kubernetes/update/worker2/07.png",alt:"Not Found Image"}}),s._v(" "),e("p",[s._v("至此，三个节点都已完成升级。")]),s._v(" "),e("h2",{attrs:{id:"_3-结语"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_3-结语"}},[s._v("#")]),s._v(" "),e("Badge",{attrs:{type:"error",text:"3"}}),s._v("3. 结语")],1),s._v(" "),e("p",[s._v("你应该学会如何升级 kubernetes 集群了吧？")]),s._v(" "),e("p",[s._v("我为你准备了一些练习（练习-2），去试试吧！")])])}),[],!1,null,null,null);e.default=r.exports}}]);